[{"path":"https://pachterlab.github.io/voyager/articles/chromium_landing.html","id":"analysis-workflows","dir":"Articles","previous_headings":"","what":"Analysis Workflows","title":"10X Chromium Single Cell 3’ v3 Processing Workflows with Voyager","text":"analysis tasks include basic quality control, spatial exploratory data analysis, identification spatially variable genes, computation global local spatial statistics. Accompanying Colab notebooks linked available.","code":""},{"path":"https://pachterlab.github.io/voyager/articles/cosmx_landing.html","id":"getting-started","dir":"Articles","previous_headings":"","what":"Getting Started","title":"CosMX Processing Workflows with Voyager","text":"Nanostring released CosMX FFPE dataset website. tutorial processing output various spatial transcriptomics technologies, including CosMX, SpatialFeatureExperiment(SFE) object use Voyager Getting Started page. vignette linked provides technology specific notes data downloaded Nanostring. Nanostring provides cell segmentation data images, cell centroid coordinates provided metadata.","code":""},{"path":"https://pachterlab.github.io/voyager/articles/cosmx_landing.html","id":"analysis-workflows","dir":"Articles","previous_headings":"","what":"Analysis Workflows","title":"CosMX Processing Workflows with Voyager","text":"vignettes demonstrate workflows can implemented Voyager using data generated CosMX SMI. publicly available CosMX dataset profiles 960 genes across 8 non-small-cell lung cancer (NSCLC) samples.","code":""},{"path":"https://pachterlab.github.io/voyager/articles/create_sfe.html","id":"visium-space-ranger-output","dir":"Articles","previous_headings":"","what":"Visium Space Ranger output","title":"Create a SpatialFeatureExperiment object","text":"10x Genomics Space Ranger output Visium experiment can read similar manner SpatialExperiment; SpatialFeatureExperiment SFE object spotPoly column geometry spot polygons. filtered matrix (.e. spots tissue) read , column graph called visium also present spatial neighborhood graph Visium spots tissue. graph computed spots read regardless whether tissue. results tissue capture outs directory. Inside outs directory two directories: raw_reature_bc_matrix unfiltered gene count matrix, spatial spatial information. DropletUtils package function read10xCounts() reads gene count matrix. SPE reads spatial information, SFE uses spatial information construct Visium spot polygons spatial neighborhood graphs. Inside spatial directory: tissue_lowres_image.png low resolution image tissue. Inside scalefactors_json.json file: spot_diameter_fullres diameter Visium spot full resolution H&E image pixels. tissue_hires_scalef tissue_lowres_scalef ratio size high resolution (full resolution) low resolution H&E image full resolution image. fiducial_diameter_fullres diameter fiducial spot used align spots H&E image pixels full resolution image. tissue_positions_list.csv file contains information spatial coordinates spots whether spot tissue automatically detected Space Ranger manually annotated Loupe browser. polygon tissue boundary available, whether image processing manual annotation, geometric operations supported SFE package, based sf package, can used find spots intersect tissue spots contained tissue. Geometric operations can also find polygons intersections spots tissue, results can get messy since intersections can polygons also points lines. Now read toy data Space Ranger output format. load argument indicates whether images loaded memory. SFE package work image present, load = FALSE. Space Ranger output includes gene count matrix, spot coordinates, spot diameter. Space Ranger output include nuclei segmentation pathologist annotation histological regions. Extra image processing, ImageJ QuPath, required geometries.","code":"# Example from SpatialExperiment dir <- system.file(   file.path(\"extdata\", \"10xVisium\"),    package = \"SpatialExperiment\")    sample_ids <- c(\"section1\", \"section2\") (samples <- file.path(dir, sample_ids, \"outs\")) #> [1] \"/Users/runner/work/_temp/Library/SpatialExperiment/extdata/10xVisium/section1/outs\" #> [2] \"/Users/runner/work/_temp/Library/SpatialExperiment/extdata/10xVisium/section2/outs\" list.files(samples[1]) #> [1] \"raw_feature_bc_matrix\" \"spatial\" list.files(file.path(samples[1], \"spatial\")) #> [1] \"scalefactors_json.json\"    \"tissue_lowres_image.png\"   #> [3] \"tissue_positions_list.csv\" fromJSON(file = file.path(samples[1], \"spatial\", \"scalefactors_json.json\")) #> $spot_diameter_fullres #> [1] 89.44476 #>  #> $tissue_hires_scalef #> [1] 0.1701114 #>  #> $fiducial_diameter_fullres #> [1] 144.4877 #>  #> $tissue_lowres_scalef #> [1] 0.05103343 (sfe3 <- read10xVisiumSFE(samples, sample_ids, type = \"sparse\", data = \"raw\",                          load = FALSE)) #> Warning: as(<dgTMatrix>, \"dgCMatrix\") is deprecated since Matrix 1.5-0; do #> as(., \"CsparseMatrix\") instead  #> Warning: as(<dgTMatrix>, \"dgCMatrix\") is deprecated since Matrix 1.5-0; do #> as(., \"CsparseMatrix\") instead #> class: SpatialFeatureExperiment  #> dim: 50 99  #> metadata(0): #> assays(1): counts #> rownames(50): ENSMUSG00000051951 ENSMUSG00000089699 ... #>   ENSMUSG00000005886 ENSMUSG00000101476 #> rowData names(1): symbol #> colnames(99): AAACAACGAATAGTTC-1 AAACAAGTATCTCCCA-1 ... #>   AAAGTCGACCCTCAGT-1-1 AAAGTGCCATCAATTA-1-1 #> colData names(4): in_tissue array_row array_col sample_id #> reducedDimNames(0): #> mainExpName: NULL #> altExpNames(0): #> spatialCoords names(2) : pxl_row_in_fullres pxl_col_in_fullres #> imgData names(4): sample_id image_id data scaleFactor #>  #> Geometries: #> colGeometries: spotPoly (POLYGON)  #>  #> Graphs: #> section1:  #> section2:"},{"path":"https://pachterlab.github.io/voyager/articles/create_sfe.html","id":"create-sfe-object-from-scratch","dir":"Articles","previous_headings":"","what":"Create SFE object from scratch","title":"Create a SpatialFeatureExperiment object","text":"SFE object can constructed scratch assay matrices metadata. toy example, dgCMatrix used, since SFE inherits SingleCellExperiment (SCE), types arrays supported SCE delayed arrays also work. sufficient create SPE object, SFE object, even though sf data frame constructed geometries. constructor behaves similarly SPE constructor. centroid coordinates Visium spots example can converted spot polygons spotDiameter argument, can also relevant technologies round spots beads, Slide-seq. Spot diameter pixels full resolution images can found scalefactors_json.json file Space Ranger output. geometries spatial graphs can added calling constructor. Geometries can also supplied constructor.","code":"# Visium barcode location from Space Ranger data(\"visium_row_col\") coords1 <- visium_row_col[visium_row_col$col < 6 & visium_row_col$row < 6,] coords1$row <- coords1$row * sqrt(3)  # Random toy sparse matrix set.seed(29) col_inds <- sample(1:13, 13) row_inds <- sample(1:5, 13, replace = TRUE) values <- sample(1:5, 13, replace = TRUE) mat <- sparseMatrix(i = row_inds, j = col_inds, x = values) colnames(mat) <- coords1$barcode rownames(mat) <- sample(LETTERS, 5) sfe3 <- SpatialFeatureExperiment(list(counts = mat), colData = coords1,                                 spatialCoordsNames = c(\"col\", \"row\"),                                 spotDiameter = 0.7) # Convert regular data frame with coordinates to sf data frame cg <- df2sf(coords1[,c(\"col\", \"row\")], c(\"col\", \"row\"), spotDiameter = 0.7) rownames(cg) <- colnames(mat) sfe3 <- SpatialFeatureExperiment(list(counts = mat), colGeometries = list(foo = cg))"},{"path":[]},{"path":"https://pachterlab.github.io/voyager/articles/create_sfe.html","id":"gene-count-matrix-and-cell-metadata","dir":"Articles","previous_headings":"Create SFE object from scratch > Technology specific notes","what":"Gene count matrix and cell metadata","title":"Create a SpatialFeatureExperiment object","text":"gene count matrix cell metadata (including cell centroid coordinates) example datasets technologies CosMX Vizgen CSV files. recommend vroom package quickly read large CSV files. CSV files read data frames. gene count matrix, can converted matrix sparse dgCMatrix. matrix may need transposed genes rows cells columns. smFISH based data tend less sparse scRNA-seq data, using sparse matrix worthwhile since matrix still 50% zero. Vizgen MERFISH, first column cell ID doesn’t column name. cell IDs numbers 30 digits long. ’s read numbers, values change R doesn’t support long integers, instead read character. example : mat <- vroom(\"Liver1Slice1_cell_by_gene.csv\", col_types = cols(...1 = \"c\")), ...1 name vroom gives first column doesn’t column name, “c” specifies type character. Note Xenium Beta might soon change 10x Genomics’ new single cell resolution technology Xenium, gene count matrix h5 file, can read R SCE object DropletUtils::read10xCounts(). can converted SpatialExperiment, SpatialFeatureExperiment. gene count matrix DelayedArray, data loaded memory operations matrix performed chunks. DelayedArray converted dgCMatrix memory. cell metadata available CSV format, ’s also parquet format compact disk, can read R data frame arrow::read_parquet(). Example code:","code":"library(DropletUtils) library(arrow) sce <- read10xCounts(\"Xenium_FFPE_Human_Breast_Cancer_Rep1_cell_feature_matrix.h5\") cell_info <- read_parquet(\"Xenium_FFPE_Human_Breast_Cancer_Rep1_cells.parquet\") # Add the centroid coordinates to colData colData(sce) <- cbind(colData(sce), cell_info[,-1]) spe <- toSpatialExperiment(sce, spatialCoordsNames = c(\"x_centroid\", \"y_centroid\")) sfe <- toSpatialFeatureExperiment(spe)"},{"path":"https://pachterlab.github.io/voyager/articles/create_sfe.html","id":"cell-polygons","dir":"Articles","previous_headings":"Create SFE object from scratch > Technology specific notes","what":"Cell polygons","title":"Create a SpatialFeatureExperiment object","text":"File format cell polygons (available) different formats different technology. cell polygons sf data frames put colGeometries() SFE object. section explains number smFISH-based technologies. Note Xenium Beta might soon change Xenium, cell polygons come CSV parquet files can directly read R data frame, 2 columns x y coordinates, one indicating cell coordinates belong . Change name cell ID column “ID”, use SpatialFeatureExperiment::df2sf() convert data frame sf data frame POLYGON geometry. Example code: CoxMX, cell polygons CSV files. Besides two coordinates columns, ’s column field view (FOV) another cell ID. However, unlike Xenium, cell IDs unique FOV, concatenated FOV make unique. df2sf() can also used convert regular data frame sf. Example code: Vizgen MERFISH, cell polygons HDF5 files, one HDF5 file per FOV. HDF5 file seems contain 7 z-planes, least mouse liver MERFISH dataset SFEData, 7 z-planes polygons effect cell segmentation available one z-plane. Example code convert sf: See code used construct example datasets SFEData examples. Use sf::st_is_valid() check polygons valid. Polygons self-intersection valid, throw error geometric operations. common reason polygons invalid protruding line, can eliminated sf::st_buffer(cell_sf, dist = 0). Use sf::st_is_valid(cell_sf, reason = TRUE), plot invalid polygons, find polygons valid.","code":"library(arrow) cell_poly <- read_parquet(\"Xenium_FFPE_Human_Breast_Cancer_Rep2_cell_boundaries.parquet\") # Here the first column is cell ID names(cell_poly)[1] <- \"ID\" # \"vertex_x\" and \"vertex_y\" are the column names for coordinates here cell_sf <- df2sf(cell_poly, c(\"vertex_x\", \"vertex_y\"), geometryType = \"POLYGON\") library(vroom) library(tidyr) cell_poly <- vroom(\"Lung5_Rep1-polygons.csv\") cell_poly <- cell_poly |>      unite(\"ID\", fov:cellID) cell_sf <- df2sf(cell_poly, spatialCoordsNames = c(\"x_global_px\", \"y_global_px\"),                  geometryType = \"POLYGON\") library(rhdf5) library(dplyr) library(BiocParallel) h52poly_fov <- function(fn, i) {     l <- rhdf5::h5dump(fn)[[1]]     cell_ids <- names(l)     geometries <- lapply(l, function(m)         sf::st_polygon(list(t(m[[\"zIndex_0\"]]$p_0$coordinates[,,1]))))     df <- data.frame(geometry = sf::st_sfc(geometries),                      ID = cell_ids,                      fov = i)     sf::st_sf(df) } # Those hdf5 files are in the directory cell_boundaries fns <- list.files(\"cell_boundaries\", \"*.hdf5\", full.names = TRUE) # Multicore as there're over 1000 FOVs in this dataset # I ran this on a server.  # Use parallel::detectCores() to find how many CPU cores you have. cell_sfs <- bpmapply(h52poly_fov, fn = fns, i = seq_along(fns), SIMPLIFY = FALSE,                       BPPARAM = SnowParam(20, progressbar = TRUE)) # dplyr::bind_rows is much faster than base R's rbind cell_sf <- do.call(bind_rows, cell_sfs)"},{"path":"https://pachterlab.github.io/voyager/articles/create_sfe.html","id":"session-info","dir":"Articles","previous_headings":"","what":"Session info","title":"Create a SpatialFeatureExperiment object","text":"","code":"sessionInfo() #> R version 4.2.2 (2022-10-31) #> Platform: x86_64-apple-darwin17.0 (64-bit) #> Running under: macOS Big Sur ... 10.16 #>  #> Matrix products: default #> BLAS:   /Library/Frameworks/R.framework/Versions/4.2/Resources/lib/libRblas.0.dylib #> LAPACK: /Library/Frameworks/R.framework/Versions/4.2/Resources/lib/libRlapack.dylib #>  #> locale: #> [1] en_US.UTF-8/en_US.UTF-8/en_US.UTF-8/C/en_US.UTF-8/en_US.UTF-8 #>  #> attached base packages: #> [1] stats     graphics  grDevices utils     datasets  methods   base      #>  #> other attached packages: #> [1] Matrix_1.5-3                   rjson_0.2.21                   #> [3] SpatialFeatureExperiment_1.0.3 Voyager_1.0.8                  #>  #> loaded via a namespace (and not attached): #>   [1] bitops_1.0-7                matrixStats_0.63.0          #>   [3] fs_1.6.0                    sf_1.0-9                    #>   [5] rprojroot_2.0.3             GenomeInfoDb_1.34.7         #>   [7] tools_4.2.2                 bslib_0.4.2                 #>   [9] utf8_1.2.2                  R6_2.5.1                    #>  [11] KernSmooth_2.23-20          HDF5Array_1.26.0            #>  [13] colorspace_2.1-0            spData_2.2.1                #>  [15] DBI_1.1.3                   BiocGenerics_0.44.0         #>  [17] rhdf5filters_1.10.0         sp_1.6-0                    #>  [19] tidyselect_1.2.0            compiler_4.2.2              #>  [21] textshaping_0.3.6           cli_3.6.0                   #>  [23] Biobase_2.58.0              BiocNeighbors_1.16.0        #>  [25] desc_1.4.2                  DelayedArray_0.24.0         #>  [27] sass_0.4.5                  scales_1.2.1                #>  [29] classInt_0.4-8              proxy_0.4-27                #>  [31] pkgdown_2.0.7               systemfonts_1.0.4           #>  [33] stringr_1.5.0               digest_0.6.31               #>  [35] SpatialExperiment_1.8.0     rmarkdown_2.20              #>  [37] R.utils_2.12.2              XVector_0.38.0              #>  [39] pkgconfig_2.0.3             htmltools_0.5.4             #>  [41] scico_1.3.1                 sparseMatrixStats_1.10.0    #>  [43] MatrixGenerics_1.10.0       fastmap_1.1.0               #>  [45] limma_3.54.1                rlang_1.0.6                 #>  [47] DelayedMatrixStats_1.20.0   jquerylib_0.1.4             #>  [49] generics_0.1.3              jsonlite_1.8.4              #>  [51] BiocParallel_1.32.5         spdep_1.2-7                 #>  [53] dplyr_1.0.10                R.oo_1.25.0                 #>  [55] RCurl_1.98-1.10             magrittr_2.0.3              #>  [57] GenomeInfoDbData_1.2.9      scuttle_1.8.4               #>  [59] s2_1.1.2                    patchwork_1.1.2             #>  [61] munsell_0.5.0               Rcpp_1.0.10                 #>  [63] S4Vectors_0.36.1            Rhdf5lib_1.20.0             #>  [65] fansi_1.0.4                 ggnewscale_0.4.8            #>  [67] lifecycle_1.0.3             R.methodsS3_1.8.2           #>  [69] stringi_1.7.12              yaml_2.3.7                  #>  [71] edgeR_3.40.2                SummarizedExperiment_1.28.0 #>  [73] zlibbioc_1.44.0             rhdf5_2.42.0                #>  [75] grid_4.2.2                  parallel_4.2.2              #>  [77] dqrng_0.3.0                 deldir_1.0-6                #>  [79] lattice_0.20-45             beachmat_2.14.0             #>  [81] locfit_1.5-9.7              magick_2.7.3                #>  [83] knitr_1.42                  pillar_1.8.1                #>  [85] igraph_1.3.5                GenomicRanges_1.50.2        #>  [87] boot_1.3-28.1               codetools_0.2-18            #>  [89] stats4_4.2.2                wk_0.7.1                    #>  [91] glue_1.6.2                  evaluate_0.20               #>  [93] vctrs_0.5.2                 gtable_0.3.1                #>  [95] purrr_1.0.1                 assertthat_0.2.1            #>  [97] ggplot2_3.4.0               cachem_1.0.6                #>  [99] xfun_0.36                   DropletUtils_1.18.1         #> [101] e1071_1.7-12                ragg_1.2.5                  #> [103] class_7.3-21                SingleCellExperiment_1.20.0 #> [105] tibble_3.1.8                memoise_2.0.1               #> [107] IRanges_2.32.0              cluster_2.1.4               #> [109] units_0.8-1                 bluster_1.8.0"},{"path":"https://pachterlab.github.io/voyager/articles/create_sfe_v2.html","id":"downloading-the-data","dir":"Articles","previous_headings":"","what":"Downloading the data","title":"How to create a SpatialFeatureExperiment object","text":"data used recent publication, High Resolution Slide-seqV2 Spatial Transcriptomics Enables Discovery Disease-Specific Cell Neighborhoods Pathways available download GEO (Accession Number: GSE190094. demonstrate use ffq access FTP links downloading relevant data. download data single WT sample. commented line shows install ffq R terminal. output command metadata GSM5713341. can use cURL wget download files FTP links one--one. Files beginning ftp:// can read directly R package vroom. Files uncompressed reading. files automatically downloaded uncompressed. use method , commented lines show download files using cURL.","code":"# system(\"pip install ffq\") system(\"ffq -l1 GSM5713341\") # system(\"curl -O ftp://ftp.ncbi.nlm.nih.gov/geo/samples/GSM5713nnn/GSM5713341/suppl/GSM5713341_Puck_191112_04_MappedDGEForR.csv.gz\")  # system(\"curl -O ftp://ftp.ncbi.nlm.nih.gov/geo/samples/GSM5713nnn/GSM5713341/suppl/GSM5713341_Puck_191112_04_BeadLocationsForR.csv.gz\")  # list.files(pattern = \"*.gz\")"},{"path":"https://pachterlab.github.io/voyager/articles/create_sfe_v2.html","id":"reading-in-the-data","dir":"Articles","previous_headings":"","what":"Reading in the data","title":"How to create a SpatialFeatureExperiment object","text":"","code":"mtx <- vroom(\"ftp://ftp.ncbi.nlm.nih.gov/geo/samples/GSM5713nnn/GSM5713341/suppl/GSM5713341_Puck_191112_04_MappedDGEForR.csv.gz\")  centroids <- vroom(\"ftp://ftp.ncbi.nlm.nih.gov/geo/samples/GSM5713nnn/GSM5713341/suppl/GSM5713341_Puck_191112_04_BeadLocationsForR.csv.gz\")"},{"path":"https://pachterlab.github.io/voyager/articles/create_sfe_v2.html","id":"construct-a-sfe-object","dir":"Articles","previous_headings":"","what":"Construct a SFE object","title":"How to create a SpatialFeatureExperiment object","text":"count matrix bead locations provided authors. pass constructor SpatialFeatureExperiment object. files read data frames. convert gene count matrix matrix sparse dgCMatrix. , spot locations provided CSV file. two columns particular interest, namely xcoord ycoord. barcode column corresponds barcodes count matrix. calling SpatialFeatureExperiment constructor, spatial coordinates must converted sf data frame using df2sf(). coordinates centroid positions, indicate geometryType=\"POINT\". Now ingredients create SFE object. values assays colGeometries arguments must passed list shown .","code":"rn <- mtx$Row mtx <- as.matrix(mtx[,-1])  rownames(mtx) <- rn mtx <- as(mtx, \"dgCMatrix\") colnames(centroids)[1] <- \"ID\"  centroids <- df2sf(   centroids, geometryType = \"POINT\",   spatialCoordsNames=c(\"xcoord\",\"ycoord\")) sfe <- SpatialFeatureExperiment(   assays = list(counts = mtx),   colGeometries = list(centroids = centroids) )  sfe"},{"path":"https://pachterlab.github.io/voyager/articles/create_sfe_v2.html","id":"session-info","dir":"Articles","previous_headings":"","what":"Session info","title":"How to create a SpatialFeatureExperiment object","text":"","code":"sessionInfo()"},{"path":"https://pachterlab.github.io/voyager/articles/merfish_landing.html","id":"getting-started","dir":"Articles","previous_headings":"","what":"Getting Started","title":"MERFISH Processing Workflows with Voyager","text":"Several MERFISH datasets generated MERSCOPE Platform publicly available Vizgen website. provide examples available processing output various spatial transcriptomics technologies SpatialFeatureExperiment(SFE) object use Voyager Getting Started page. vignette linked provides technology specific notes data downloaded Vizgen. Briefly, Vizgen provides cell metadata gene count matrix CSV files can read quickly vroom package. Cell segmentation data provided HDF5 files delineated field view.","code":""},{"path":"https://pachterlab.github.io/voyager/articles/merfish_landing.html","id":"analysis-workflows","dir":"Articles","previous_headings":"","what":"Analysis Workflows","title":"MERFISH Processing Workflows with Voyager","text":"vignettes demonstrate workflows can implemented Voyager using data generated MERFISH technology. publicly available MERFISH datasets profile hundreds genes hundreds thousands millions cells. Thus, vignettes linked can provide context capabilities Voyager moderate large datasets.","code":""},{"path":"https://pachterlab.github.io/voyager/articles/nonspatial.html","id":"introduction","dir":"Articles","previous_headings":"","what":"Introduction","title":"Apply spatial analyses to non-spatial scRNA-seq data","text":"areal spatial data, spatial neighborhood graph used indicate proximity, required spatial analysis methods package spdep. One methods find spatial neighborhood graph k nearest neighbors, also commonly used gene expression PCA space graph-based clustering cells non-spatial scRNA-seq data. use k nearest neighbors graph PCA space rather histological space “spatial” analyses non-spatial scRNA-seq data? try analysis human peripheral blood mononuclear cells (PBMC) scRNA-seq dataset, doesn’t originally histological spatial organization. packages loaded analysis: download filtered Cell Ranger gene count matrix 10X website. empty droplets already removed. loaded R SingleCellExperiment (SCE) object.","code":"library(Voyager) library(SpatialFeatureExperiment) library(SpatialExperiment) #> Loading required package: SingleCellExperiment #> Loading required package: SummarizedExperiment #> Loading required package: MatrixGenerics #> Loading required package: matrixStats #>  #> Attaching package: 'MatrixGenerics' #> The following objects are masked from 'package:matrixStats': #>  #>     colAlls, colAnyNAs, colAnys, colAvgsPerRowSet, colCollapse, #>     colCounts, colCummaxs, colCummins, colCumprods, colCumsums, #>     colDiffs, colIQRDiffs, colIQRs, colLogSumExps, colMadDiffs, #>     colMads, colMaxs, colMeans2, colMedians, colMins, colOrderStats, #>     colProds, colQuantiles, colRanges, colRanks, colSdDiffs, colSds, #>     colSums2, colTabulates, colVarDiffs, colVars, colWeightedMads, #>     colWeightedMeans, colWeightedMedians, colWeightedSds, #>     colWeightedVars, rowAlls, rowAnyNAs, rowAnys, rowAvgsPerColSet, #>     rowCollapse, rowCounts, rowCummaxs, rowCummins, rowCumprods, #>     rowCumsums, rowDiffs, rowIQRDiffs, rowIQRs, rowLogSumExps, #>     rowMadDiffs, rowMads, rowMaxs, rowMeans2, rowMedians, rowMins, #>     rowOrderStats, rowProds, rowQuantiles, rowRanges, rowRanks, #>     rowSdDiffs, rowSds, rowSums2, rowTabulates, rowVarDiffs, rowVars, #>     rowWeightedMads, rowWeightedMeans, rowWeightedMedians, #>     rowWeightedSds, rowWeightedVars #> Loading required package: GenomicRanges #> Loading required package: stats4 #> Loading required package: BiocGenerics #>  #> Attaching package: 'BiocGenerics' #> The following objects are masked from 'package:stats': #>  #>     IQR, mad, sd, var, xtabs #> The following objects are masked from 'package:base': #>  #>     anyDuplicated, aperm, append, as.data.frame, basename, cbind, #>     colnames, dirname, do.call, duplicated, eval, evalq, Filter, Find, #>     get, grep, grepl, intersect, is.unsorted, lapply, Map, mapply, #>     match, mget, order, paste, pmax, pmax.int, pmin, pmin.int, #>     Position, rank, rbind, Reduce, rownames, sapply, setdiff, sort, #>     table, tapply, union, unique, unsplit, which.max, which.min #> Loading required package: S4Vectors #>  #> Attaching package: 'S4Vectors' #> The following objects are masked from 'package:base': #>  #>     expand.grid, I, unname #> Loading required package: IRanges #> Loading required package: GenomeInfoDb #> Loading required package: Biobase #> Welcome to Bioconductor #>  #>     Vignettes contain introductory material; view with #>     'browseVignettes()'. To cite Bioconductor, see #>     'citation(\"Biobase\")', and for packages 'citation(\"pkgname\")'. #>  #> Attaching package: 'Biobase' #> The following object is masked from 'package:MatrixGenerics': #>  #>     rowMedians #> The following objects are masked from 'package:matrixStats': #>  #>     anyMissing, rowMedians library(DropletUtils) library(BiocNeighbors) library(scater) #> Loading required package: scuttle #> Loading required package: ggplot2 library(scran) library(bluster) library(BiocParallel) library(scuttle) library(stringr) library(BiocSingular) library(spdep) #> Loading required package: sp #>  #> Attaching package: 'sp' #> The following object is masked from 'package:IRanges': #>  #>     %over% #> The following object is masked from 'package:SpatialFeatureExperiment': #>  #>     bbox #> Loading required package: spData #> To access larger datasets in this package, install the spDataLarge #> package with: `install.packages('spDataLarge', #> repos='https://nowosad.github.io/drat/', type='source')` #> Loading required package: sf #> Linking to GEOS 3.10.2, GDAL 3.4.2, PROJ 8.2.1; sf_use_s2() is TRUE library(patchwork) library(dplyr) #>  #> Attaching package: 'dplyr' #> The following object is masked from 'package:Biobase': #>  #>     combine #> The following objects are masked from 'package:GenomicRanges': #>  #>     intersect, setdiff, union #> The following object is masked from 'package:GenomeInfoDb': #>  #>     intersect #> The following objects are masked from 'package:IRanges': #>  #>     collapse, desc, intersect, setdiff, slice, union #> The following objects are masked from 'package:S4Vectors': #>  #>     first, intersect, rename, setdiff, setequal, union #> The following objects are masked from 'package:BiocGenerics': #>  #>     combine, intersect, setdiff, union #> The following object is masked from 'package:matrixStats': #>  #>     count #> The following objects are masked from 'package:stats': #>  #>     filter, lag #> The following objects are masked from 'package:base': #>  #>     intersect, setdiff, setequal, union theme_set(theme_bw()) if (!dir.exists(\"filtered_feature_bc_matrix\")) {     download.file(\"https://cf.10xgenomics.com/samples/cell-exp/3.0.2/5k_pbmc_v3_nextgem/5k_pbmc_v3_nextgem_filtered_feature_bc_matrix.tar.gz\", destfile = \"5kpbmc.tar.gz\", quiet = TRUE)     system(\"tar -xzf 5kpbmc.tar.gz\") } (sce <- read10xCounts(\"filtered_feature_bc_matrix/\")) #> Warning: as(<dgTMatrix>, \"dgCMatrix\") is deprecated since Matrix 1.5-0; do #> as(., \"CsparseMatrix\") instead #> class: SingleCellExperiment  #> dim: 33538 5155  #> metadata(1): Samples #> assays(1): counts #> rownames(33538): ENSG00000243485 ENSG00000237613 ... ENSG00000277475 #>   ENSG00000268674 #> rowData names(3): ID Symbol Type #> colnames: NULL #> colData names(2): Sample Barcode #> reducedDimNames(0): #> mainExpName: NULL #> altExpNames(0): colnames(sce) <- sce$Barcode names(rowData(sce))[2] <- \"symbol\""},{"path":"https://pachterlab.github.io/voyager/articles/nonspatial.html","id":"quality-control-qc","dir":"Articles","previous_headings":"","what":"Quality control (QC)","title":"Apply spatial analyses to non-spatial scRNA-seq data","text":"perform basic QC, remove low quality cells high proportion mitochondrially encoded counts. addPerCellQCMetrics() function computes total UMI counts detected per cell (sum), number genes detected per cell (detected), sum detected mitochondrial counts, percentage mitochondrial counts per cell.  2D histogram plotted better show point density plot.   Remove cells >20% mitochondrial counts","code":"is_mito <- str_detect(rowData(sce)$symbol, \"^MT-\") sum(is_mito) #> [1] 13 sce <- addPerCellQCMetrics(sce, subsets = list(mito = is_mito)) names(colData(sce)) #> [1] \"Sample\"                \"Barcode\"               \"sum\"                   #> [4] \"detected\"              \"subsets_mito_sum\"      \"subsets_mito_detected\" #> [7] \"subsets_mito_percent\"  \"total\" plotColData(sce, \"sum\") +     plotColData(sce, \"detected\") +     plotColData(sce, \"subsets_mito_percent\") plotColDataBin2D(sce, x = \"sum\", y = \"detected\") plotColDataBin2D(sce, x = \"sum\", y = \"subsets_mito_percent\") sce <- sce[, sce$subsets_mito_percent < 20] sce <- sce[rowSums(counts(sce)) > 0,]"},{"path":"https://pachterlab.github.io/voyager/articles/nonspatial.html","id":"basic-non-spatial-analyses","dir":"Articles","previous_headings":"","what":"Basic non-spatial analyses","title":"Apply spatial analyses to non-spatial scRNA-seq data","text":"normalize data, perform PCA, cluster cells, find marker genes clusters. Use highly variable genes PCA many PCs shall use analyses?  Variance explained drops sharply PC1 PC4 levels . Plot genes largest loadings top 4 PCs:  keep little information, use 10 PCs, variance explained levels even . plot cells first 4 PCs matrix plot. diagonals density plots number cells projected PC. x axis correspond columns matrix plot, y axis correspond rows, plot row 1 column 2 PC2 x axis PC1 y axis. cells colored clusters found previous code chunk.  many cells cluster? use conventional Wilcoxon rank sum test find marker genes cluster. test compares cluster rest cells, genes highly expressed cluster compared cells considered. results list data frames, data frame one cluster. Areas receiver operator curve (AUC) distinguishing cluster vs. cluster also included, closer 1 better 0.5 means better random guessing. false discovery rate (FDR) column Benjamini-Hochberg corrected p-values. Genes data frames already sorted p-values. See specific top markers cluster","code":"#clusts <- quickCluster(sce) #sce <- computeSumFactors(sce, cluster = clusts) #sce <- sce[, sizeFactors(sce) > 0] sce <- logNormCounts(sce) hvgs <- getTopHVGs(sce, n = 2000) set.seed(29) sce <- runPCA(sce, ncomponents = 30, BSPARAM = IrlbaParam(),               subset_row = hvgs, scale = TRUE) ElbowPlot(sce, ndims = 30) plotDimLoadings(sce) sce$cluster <- clusterRows(reducedDim(sce, \"PCA\")[,1:10],                            BLUSPARAM = SNNGraphParam(cluster.fun = \"leiden\",                                                      k = 10,                                                      cluster.args = list(                                                          resolution=0.5,                                                          objective_function = \"modularity\"                                                      ))) plotPCA(sce, ncomponents = 4, color_by = \"cluster\") table(sce$cluster) #>  #>    1    2    3    4    5    6    7    8    9  #>  443  963 1280  197  590  696   91  341   28 markers <- findMarkers(sce, groups = colData(sce)$cluster,                        test.type = \"wilcox\", pval.type = \"all\", direction = \"up\") markers[[4]] #> DataFrame with 21932 rows and 11 columns #>                     p.value         FDR summary.AUC     AUC.1     AUC.2 #>                   <numeric>   <numeric>   <numeric> <numeric> <numeric> #> ENSG00000251562 8.32533e-18 1.82591e-13    0.997643  0.918054  0.997048 #> ENSG00000198840 3.42464e-10 3.75546e-06    0.860587  0.762132  0.744691 #> ENSG00000114857 2.19738e-09 1.60643e-05    0.838651  0.673316  0.772493 #> ENSG00000198786 1.00558e-08 5.51360e-05    0.827955  0.680971  0.830107 #> ENSG00000244754 2.68777e-07 1.17896e-03    0.629404  0.676193  0.785197 #> ...                     ...         ...         ...       ...       ... #> ENSG00000277400           1           1         0.5  0.498871  0.500000 #> ENSG00000276256           1           1         0.5  0.498871  0.498962 #> ENSG00000278817           1           1         0.5  0.494357  0.482866 #> ENSG00000277856           1           1         0.5  0.500000  0.500000 #> ENSG00000275063           1           1         0.5  0.500000  0.499481 #>                     AUC.3     AUC.5     AUC.6     AUC.7     AUC.8     AUC.9 #>                 <numeric> <numeric> <numeric> <numeric> <numeric> <numeric> #> ENSG00000251562  0.931567  0.950486  0.939852  0.981592  0.909054  0.997643 #> ENSG00000198840  0.838192  0.740790  0.812241  0.920176  0.878411  0.860587 #> ENSG00000114857  0.702604  0.712131  0.668909  0.727116  0.658157  0.838651 #> ENSG00000198786  0.837857  0.802327  0.736248  0.866682  0.663099  0.827955 #> ENSG00000244754  0.705354  0.678121  0.690432  0.753640  0.629404  0.910080 #> ...                   ...       ...       ...       ...       ...       ... #> ENSG00000277400  0.498828  0.499153  0.499282  0.500000  0.500000       0.5 #> ENSG00000276256  0.498828  0.498305  0.498563  0.500000  0.500000       0.5 #> ENSG00000278817  0.487500  0.498305  0.492816  0.472527  0.497067       0.5 #> ENSG00000277856  0.500000  0.498305  0.500000  0.500000  0.500000       0.5 #> ENSG00000275063  0.500000  0.499153  0.500000  0.500000  0.500000       0.5 top_markers <- unlist(lapply(markers, function(x) head(rownames(x), 1))) top_markers_symbol <- rowData(sce)[top_markers, \"symbol\"] plotExpression(sce, top_markers_symbol, x = \"cluster\", point_fun = function(...) list(),                swap_rownames = \"symbol\")"},{"path":"https://pachterlab.github.io/voyager/articles/nonspatial.html","id":"spatial-analyses-for-qc-metrics","dir":"Articles","previous_headings":"","what":"“Spatial” analyses for QC metrics","title":"Apply spatial analyses to non-spatial scRNA-seq data","text":"Find k nearest neighbor graph PCA space Moran’s . using spdep since nb2listwdist() function distance based edge weighting requires 2-3 dimensional spatial coordinates coordinates 10 dimensions. inverse distance weighting used edge weights. ’s histological space, convert SCE object SpatialFeatureExperiment (SFE) use spatial analysis plotting functions Voyager, pretend first 2 PCs histological space. Add k nearest neighbor graph SFE object.","code":"foo <- findKNN(reducedDim(sce, \"PCA\")[,1:10], k=10, BNPARAM=AnnoyParam()) # Split by row foo_nb <- asplit(foo$index, 1) dmat <- 1/foo$distance # Row normalize the weights dmat <- sweep(dmat, 1, rowSums(dmat), FUN = \"/\") glist <- asplit(dmat, 1) # Sort based on index ord <- lapply(foo_nb, order) foo_nb <- lapply(seq_along(foo_nb), function(i) foo_nb[[i]][ord[[i]]]) class(foo_nb) <- \"nb\" glist <- lapply(seq_along(glist), function(i) glist[[i]][ord[[i]]])  listw <- list(style = \"W\",               neighbours = foo_nb,               weights = glist) class(listw) <- \"listw\" attr(listw, \"region.id\") <- colnames(sce) spe <- toSpatialExperiment(sce, spatialCoords = reducedDim(sce, \"PCA\")[,1:2]) sfe <- toSpatialFeatureExperiment(spe) sfe #> class: SpatialFeatureExperiment  #> dim: 21932 4629  #> metadata(1): Samples #> assays(2): counts logcounts #> rownames(21932): ENSG00000238009 ENSG00000239945 ... ENSG00000275063 #>   ENSG00000271254 #> rowData names(3): ID symbol Type #> colnames(4629): AAACCCAAGACAGCTG-1 AAACCCAAGTTAACGA-1 ... #>   TTTGTTGTCACGGACC-1 TTTGTTGTCCACACCT-1 #> colData names(11): Sample Barcode ... cluster sample_id #> reducedDimNames(1): PCA #> mainExpName: NULL #> altExpNames(0): #> spatialCoords names(2) : PC1 PC2 #> imgData names(0): #>  #> Geometries: #> colGeometries: centroids (POINT)  #>  #> Graphs: #> sample01: colGraph(sfe, \"knn10\") <- listw"},{"path":"https://pachterlab.github.io/voyager/articles/nonspatial.html","id":"morans-i","dir":"Articles","previous_headings":"“Spatial” analyses for QC metrics","what":"Moran’s I","title":"Apply spatial analyses to non-spatial scRNA-seq data","text":"total UMI counts (sum) genes detected (detected), Moran’s quite strong, ’s positive weaker percentage mitochondrial counts. second column, K, kurtosis feature interest.","code":"sfe <- colDataMoransI(sfe, c(\"sum\", \"detected\", \"subsets_mito_percent\")) colFeatureData(sfe)[c(\"sum\", \"detected\", \"subsets_mito_percent\"),] #> DataFrame with 3 rows and 2 columns #>                      moran_sample01 K_sample01 #>                           <numeric>  <numeric> #> sum                        0.657380   16.44603 #> detected                   0.746041    6.01002 #> subsets_mito_percent       0.437762    6.13555"},{"path":"https://pachterlab.github.io/voyager/articles/nonspatial.html","id":"moran-plot","dir":"Articles","previous_headings":"“Spatial” analyses for QC metrics","what":"Moran plot","title":"Apply spatial analyses to non-spatial scRNA-seq data","text":"local variations k nearest neighbors graph? Moran plot, x axis value cell, y axis average value among neighboring cells graph weighted edge weights. slope fitted line Moran’s . Sometimes clusters plot, showing different kinds neighborhoods. dashed lines averages x y axes.  cells cluster around average, cluster cells lower total counts whose neighbors also lower total counts cluster cells higher total counts whose neighbors also higher total counts. clusters seem somewhat related gene expression based clusters.   number genes detected percentage mitochondrial counts ’s one main cluster plot cells somewhat separated gene expression clusters, surprising gene expression clusters also based k nearest neighbor graph. Cluster 4 cells higher percentage mitochondrial counts neighbors.","code":"sfe <- colDataUnivariate(sfe, \"moran.plot\", c(\"sum\", \"detected\", \"subsets_mito_percent\")) moranPlot(sfe, \"sum\", color_by = \"cluster\") moranPlot(sfe, \"detected\", color_by = \"cluster\") moranPlot(sfe, \"subsets_mito_percent\", color_by = \"cluster\")"},{"path":"https://pachterlab.github.io/voyager/articles/nonspatial.html","id":"local-morans-i","dir":"Articles","previous_headings":"“Spatial” analyses for QC metrics","what":"Local Moran’s I","title":"Apply spatial analyses to non-spatial scRNA-seq data","text":"Also see local Moran’s 3 QC metrics: don’t histological space. visualize local “spatial” statistics? UMAP bad PCA can somewhat separate clusters, case can use first 2 PCs ’re histological space. reference, plot metrics clusters first 2 PCs.  plot local Moran’s metrics first 2 PCs:  However, ’s good 2D representation data easy plotting? Remember k nearest neighbor graph computed first 10 PCs rather first 2 PCs. graph tied 2D representation. can still plot histograms show distribution scatter plots compare local metric different variables, can colored another variable cluster. may added next release Voyager. now add results interest colData(sfe) use existing colData plotting functions scater Voyager.  y axis log transformed (hence warning bins cells) color cells long tail can seen cells don’t strong local Moran’s . Cells cluster 7 high local Moran’s total UMI counts genes detected, means tend homogeneous QC metrics. local Moran’s QC metrics relate ?  Cells locally homogeneous total UMI counts also homogeneous number genes detected, surprising given correlation two.  local Moran’s , sum vs percentage mitochondrial counts shows interesting pattern highlighting clusters 4 7, Moran plots. local Moran’s relate value ?  case, generally cells higher total counts also tend higher local Moran’s total counts, ’s another wing cells lower total counts slightly higher local Moran’s total counts ’s central value total counts near 0 local Moran’s . density contour shows cells concentrated central value.","code":"sfe <- colDataUnivariate(sfe, \"localmoran\", c(\"sum\", \"detected\", \"subsets_mito_percent\")) plotSpatialFeature(sfe, c(\"sum\", \"detected\", \"subsets_mito_percent\", \"cluster\")) plotLocalResult(sfe, \"localmoran\", c(\"sum\", \"detected\", \"subsets_mito_percent\"),                  colGeometryName = \"centroids\",                 divergent = TRUE, diverge_center = 0, ncol = 2) localResultAttrs(sfe, \"localmoran\", \"sum\") #>  [1] \"Ii\"             \"E.Ii\"           \"Var.Ii\"         \"Z.Ii\"           #>  [5] \"Pr(z != E(Ii))\" \"mean\"           \"median\"         \"pysal\"          #>  [9] \"-log10p\"        \"-log10p_adj\" sfe$sum_localmoran <- localResult(sfe, \"localmoran\", \"sum\")[,\"Ii\"] sfe$detected_localmoran <- localResult(sfe, \"localmoran\", \"detected\")[,\"Ii\"] sfe$pct_mito_localmoran <- localResult(sfe, \"localmoran\", \"subsets_mito_percent\")[,\"Ii\"] # Colorblind friendly palette data(\"ditto_colors\") plotColDataHistogram(sfe, c(\"sum_localmoran\", \"detected_localmoran\",                              \"pct_mito_localmoran\"), bins = 50,                       fill_by = \"cluster\") +     scale_fill_manual(values = ditto_colors) +     scale_y_log10() +     annotation_logticks(sides = \"l\") #> Warning: Transformation introduced infinite values in continuous y-axis plotColData(sfe, x = \"sum_localmoran\", y = \"detected_localmoran\", color_by = \"cluster\") plotColData(sfe, x = \"sum_localmoran\", y = \"pct_mito_localmoran\",              color_by = \"cluster\") plotColData(sfe, x = \"sum\", y = \"sum_localmoran\", color_by = \"cluster\") +     geom_density2d(data = as.data.frame(colData(sfe)),                    mapping = aes(x = sum, y = sum_localmoran), color = \"blue\",                     linewidth = 0.3)"},{"path":"https://pachterlab.github.io/voyager/articles/nonspatial.html","id":"local-spatial-heteroscedasticity-losh","dir":"Articles","previous_headings":"“Spatial” analyses for QC metrics","what":"Local spatial heteroscedasticity (LOSH)","title":"Apply spatial analyses to non-spatial scRNA-seq data","text":"LOSH indicates heterogeneity around cell k nearest neighbor graph.  make non-spatial plots LOSH local Moran’s .  clusters 2 6 tend locally heterogeneous. total counts genes detected relate LOSH?  generally cells higher LOSH total counts also higher LOSH genes detected, outliers high , heterogeneous neighborhoods. Absolute distance neighbors taken account adjacency matrix row normalized. interesting see outliers tend away 10 nearest neighbors, region PCA space cells apart. total counts relate LOSH?  seem clear relationship case.","code":"sfe <- colDataUnivariate(sfe, \"LOSH\", c(\"sum\", \"detected\", \"subsets_mito_percent\")) plotLocalResult(sfe, \"LOSH\", c(\"sum\", \"detected\", \"subsets_mito_percent\"),                  colGeometryName = \"centroids\", ncol = 2) localResultAttrs(sfe, \"LOSH\", \"sum\") #> [1] \"Hi\"      \"E.Hi\"    \"Var.Hi\"  \"Z.Hi\"    \"x_bar_i\" \"ei\" sfe$sum_losh <- localResult(sfe, \"LOSH\", \"sum\")[,\"Hi\"] sfe$detected_losh <- localResult(sfe, \"LOSH\", \"detected\")[,\"Hi\"] sfe$pct_mito_losh <- localResult(sfe, \"LOSH\", \"subsets_mito_percent\")[,\"Hi\"] plotColDataHistogram(sfe, c(\"sum_losh\", \"detected_losh\",                              \"pct_mito_losh\"), bins = 50,                       fill_by = \"cluster\") +     scale_fill_manual(values = ditto_colors) +     scale_y_log10() +     annotation_logticks(sides = \"l\") #> Warning: Transformation introduced infinite values in continuous y-axis plotColData(sfe, x = \"sum_losh\", y = \"detected_losh\", color_by = \"cluster\") plotColData(sfe, x = \"sum\", y = \"sum_losh\", color_by = \"cluster\")"},{"path":"https://pachterlab.github.io/voyager/articles/nonspatial.html","id":"spatial-analyses-for-gene-expression","dir":"Articles","previous_headings":"","what":"“Spatial” analyses for gene expression","title":"Apply spatial analyses to non-spatial scRNA-seq data","text":"reorganize differential expression results","code":"top_markers_df <- lapply(seq_along(markers), function(i) {     out <- markers[[i]][markers[[i]]$FDR < 0.05, c(\"FDR\", \"summary.AUC\")]     if (nrow(out)) out$cluster <- i     out }) top_markers_df <- do.call(rbind, top_markers_df) top_markers_df$symbol <- rowData(sce)[rownames(top_markers_df), \"symbol\"]"},{"path":"https://pachterlab.github.io/voyager/articles/nonspatial.html","id":"morans-i-1","dir":"Articles","previous_headings":"“Spatial” analyses for gene expression","what":"Moran’s I","title":"Apply spatial analyses to non-spatial scRNA-seq data","text":"results added rowData(sfe). NA’s non-highly variable genes, Moran’s computed highly variable genes . Moran’s ’s highly variable genes distributed? Also, top cluster marker genes distribution?  top marker genes quite positive Moran’s k nearest neighbor graph. also interesting color histogram gene sets. Since k nearest neighbor graph found PCA space, based gene expression, expected, Moran’s graph mostly positive, although often strong. small number genes slightly negative Moran’s . top genes look like PCA?   marker genes cluster, cluster 9. Perhaps genes high Moran’s specific cell type. Moran’s relate cluster AUC cluster differential expression p-value? differential expression p-value relate Moran’s ?  Generally significant marker genes tend higher Moran’s . surprising clusters Moran’s based k nearest neighbor graph.  Similarly, genes higher AUC tend higher Moran’s . clusters, generally speaking, genes specific cluster tend higher Moran’s . Use permutation testing see Moran’s statistically significant  seem significant. correlogram finds Moran’s higher higher order neighbors can proxy distance. ’s  see different patterns decay spatial autocorrelation different length scales spatial autocorrelation. PF4 marker gene specific cluster 10, small cluster, platelets. 27 cells cluster, higher order neighbors likely clusters. Marker genes larger clusters hundreds cells nevertheless display different patterns correlogram.","code":"sfe <- runMoransI(sfe, features = hvgs, BPPARAM = MulticoreParam(2)) rowData(sfe) #> DataFrame with 21932 rows and 5 columns #>                              ID      symbol            Type moran_sample01 #>                     <character> <character>     <character>      <numeric> #> ENSG00000238009 ENSG00000238009  AL627309.1 Gene Expression             NA #> ENSG00000239945 ENSG00000239945  AL627309.3 Gene Expression             NA #> ENSG00000241599 ENSG00000241599  AL627309.4 Gene Expression             NA #> ENSG00000229905 ENSG00000229905  AL669831.2 Gene Expression             NA #> ENSG00000237491 ENSG00000237491  AL669831.5 Gene Expression             NA #> ...                         ...         ...             ...            ... #> ENSG00000278817 ENSG00000278817  AC007325.4 Gene Expression             NA #> ENSG00000278384 ENSG00000278384  AL354822.1 Gene Expression             NA #> ENSG00000277856 ENSG00000277856  AC233755.2 Gene Expression             NA #> ENSG00000275063 ENSG00000275063  AC233755.1 Gene Expression             NA #> ENSG00000271254 ENSG00000271254  AC240274.1 Gene Expression             NA #>                 K_sample01 #>                  <numeric> #> ENSG00000238009         NA #> ENSG00000239945         NA #> ENSG00000241599         NA #> ENSG00000229905         NA #> ENSG00000237491         NA #> ...                    ... #> ENSG00000278817         NA #> ENSG00000278384         NA #> ENSG00000277856         NA #> ENSG00000275063         NA #> ENSG00000271254         NA plotRowDataHistogram(sfe, \"moran_sample01\", bins = 50) +     geom_vline(data = as.data.frame(rowData(sfe)[top_markers,]) |>                     mutate(index = seq_along(top_markers)),                aes(xintercept = moran_sample01, color = index)) +     scale_color_continuous(breaks = scales::breaks_width(2)) #> Warning: Removed 19932 rows containing non-finite values (`stat_bin()`). top_moran <- head(rownames(sfe)[order(rowData(sfe)$moran_sample01, decreasing = TRUE)], 4) plotSpatialFeature(sfe, top_moran, ncol = 2) top_moran_symbol <- rowData(sfe)[top_moran, \"symbol\"] plotExpression(sfe, top_moran_symbol, swap_rownames = \"symbol\") # See if markers are unique to clusters anyDuplicated(rownames(top_markers_df)) #> [1] 0 top_markers_df$moran <- rowData(sfe)[rownames(top_markers_df), \"moran_sample01\"] top_markers_df$log_p_adj <- -log10(top_markers_df$FDR) top_markers_df$cluster <- factor(top_markers_df$cluster,                                   levels = seq_len(length(unique(top_markers_df$cluster)))) as.data.frame(top_markers_df) |>      ggplot(aes(log_p_adj, moran)) +     geom_point(aes(color = cluster)) +     geom_smooth(method = \"lm\") +     scale_color_manual(values = ditto_colors) #> `geom_smooth()` using formula = 'y ~ x' #> Warning: Removed 1217 rows containing non-finite values #> (`stat_smooth()`). #> Warning: Removed 1217 rows containing missing values (`geom_point()`). as.data.frame(top_markers_df) |>      ggplot(aes(summary.AUC, moran)) +     geom_point(aes(color = cluster)) +     geom_smooth(method = \"lm\") +     scale_color_manual(values = ditto_colors) #> `geom_smooth()` using formula = 'y ~ x' #> Warning: Removed 1217 rows containing non-finite values #> (`stat_smooth()`). #> Warning: Removed 1217 rows containing missing values (`geom_point()`). sfe <- runUnivariate(sfe, \"moran.mc\", features = top_markers, nsim = 200) top_markers_symbol #> [1] \"LYAR\"    \"CTSS\"    \"RPL18\"   \"MALAT1\"  \"CD79A\"   \"IL7R\"    \"CCDC88A\" #> [8] \"PRF1\"    \"CLU\" plotMoranMC(sfe, top_markers) system.time({     sfe <- runUnivariate(sfe, \"sp.correlogram\", top_markers, order = 6,                       zero.policy = TRUE, BPPARAM = MulticoreParam(2)) }) #>    user  system elapsed  #> 675.818  63.245 500.834 plotCorrelogram(sfe, top_markers)"},{"path":"https://pachterlab.github.io/voyager/articles/nonspatial.html","id":"local-morans-i-1","dir":"Articles","previous_headings":"“Spatial” analyses for gene expression","what":"Local Moran’s I","title":"Apply spatial analyses to non-spatial scRNA-seq data","text":"also plot histograms, now results need ba added colData first.  , y axis log transformed make tail visible. clusters, top marker gene’s local Moran’s forms peak cells cluster higher local Moran’s cells. However, sometimes cells within cluster form long tail shared cells clusters. local Moran’s another method differential expression. since local Moran’s Leiden clustering use k nearest neighbor graph PCA space, local Moran’s marker genes perhaps eigengenes signifying gene programs cell type k nearest neighbor graph can validate criticize Leiden clusters. Furthermore, interestingly, genes, tallest peak histogram away 0. scatter plots shown “spatial” analyses QC metrics section can made see local Moran’s relates expression gene .  gene, just like total UMI counts, two wings central value local Moran’s around 0, generally cells higher expression gene higher local Moran’s gene well. density contours show cells concentrate around 0 expression weaker positive local Moran. streak cells 0 expression means many cells don’t express gene neighbors low slightly homogeneous expression gene. pattern may different different genes. Also, p-values cell local Moran’s available corrected multiple hypothesis testing, can plotted. p-values based z score local Moran statistic, although statistic distributed gene expression data warrants investigation. p-value can also computed permutation (see localmoran_perm()).","code":"sfe <- runUnivariate(sfe, \"localmoran\", features = top_markers) plotLocalResult(sfe, \"localmoran\", top_markers, colGeometryName = \"centroids\",                  divergent = TRUE, diverge_center = 0, ncol = 3) new_colname <- paste0(\"cluster\", seq_along(top_markers), \"_\",                        top_markers_symbol, \"_localmoran\") for (i in seq_along(top_markers)) {     g <- top_markers[i]     colData(sfe)[[new_colname[i]]] <-          localResult(sfe, \"localmoran\", g)[,\"Ii\"] } plotColDataHistogram(sfe, new_colname, fill_by = \"cluster\") +     scale_fill_manual(values = ditto_colors) +     ggtitle(\"Local Moran's I\") +     theme(legend.position = \"top\") +     scale_y_log10() +     annotation_logticks(sides = \"l\") #> Warning: Transformation introduced infinite values in continuous y-axis i <- 6 # Change if running this notebook plotExpression(sfe, top_markers[i], x = new_colname[i], color_by = \"cluster\") +     scale_color_manual(values = ditto_colors) +     coord_flip() +     # comment out in case of error after changing i     geom_density2d(data = as.data.frame(colData(sfe)) |>                         mutate(gene = logcounts(sfe)[top_markers[i],]),                    mapping = aes(x = .data[[new_colname[i]]], y = gene),                     color = \"blue\", linewidth = 0.3)  #> Scale for colour is already present. #> Adding another scale for colour, which will replace the existing scale. localResultAttrs(sfe, \"localmoran\", top_markers[1]) #>  [1] \"Ii\"             \"E.Ii\"           \"Var.Ii\"         \"Z.Ii\"           #>  [5] \"Pr(z != E(Ii))\" \"mean\"           \"median\"         \"pysal\"          #>  [9] \"-log10p\"        \"-log10p_adj\""},{"path":"https://pachterlab.github.io/voyager/articles/nonspatial.html","id":"losh","dir":"Articles","previous_headings":"“Spatial” analyses for gene expression","what":"LOSH","title":"Apply spatial analyses to non-spatial scRNA-seq data","text":"two genes right, ’s interesting see higher LOSH middle cluster. two genes left outliers throwing dynamic range. seems high LOSH regions different. , plot histograms  Relationship expression LOSH complicated. genes, top marker gene cluster 1 LYAR, cells cluster, .e. higher expression, also higher LOSH, much like Poisson negative binomial distributions, higher mean also means higher variance. However, genes, top marker gene cluster 2 CTSS, lower LOSH among cells higher expression, means expression gene homogeneous within cluster, consistent local Moran.  gene, density contour indicates many cells don’t express gene homogeneous neighborhoods also low expression. streak around 0 expression means neighbors cells don’t express gene different levels heterogeneity gene.","code":"sfe <- runUnivariate(sfe, \"LOSH\", top_markers) plotLocalResult(sfe, \"LOSH\", top_markers, colGeometryName = \"centroids\", ncol = 3) new_colname2 <- paste0(\"cluster\", seq_along(top_markers), \"_\",                        top_markers_symbol, \"_losh\") for (i in seq_along(top_markers)) {     g <- top_markers[i]     colData(sfe)[[new_colname2[i]]] <-          localResult(sfe, \"LOSH\", g)[,\"Hi\"] } plotColDataHistogram(sfe, new_colname2, fill_by = \"cluster\") +     scale_fill_manual(values = ditto_colors) +     ggtitle(\"Local heteroscedasticity\") +     theme(legend.position = \"top\") +     scale_y_log10() +     annotation_logticks(sides = \"l\") #> Warning: Transformation introduced infinite values in continuous y-axis i <- 6 # Change if running this notebook plotExpression(sfe, top_markers[i], x = new_colname2[i], color_by = \"cluster\") +     scale_color_manual(values = ditto_colors) +     coord_flip() +     # comment out in case of error after changing i     geom_density2d(data = as.data.frame(colData(sfe)) |>                         mutate(gene = logcounts(sfe)[top_markers[i],]),                    mapping = aes(x = .data[[new_colname2[i]]], y = gene),                     color = \"blue\", linewidth = 0.3)  #> Scale for colour is already present. #> Adding another scale for colour, which will replace the existing scale."},{"path":"https://pachterlab.github.io/voyager/articles/nonspatial.html","id":"moran-plot-1","dir":"Articles","previous_headings":"“Spatial” analyses for gene expression","what":"Moran plot","title":"Apply spatial analyses to non-spatial scRNA-seq data","text":"make Moran plots top marker genes. reference, show Moran’s top marker genes, slope line fitted Moran scatter plot. ’s significant marker gene cluster 7. plots shown sequence  genes, points concentrated around origin aren’t “enough” points elsewhere plot density contours. cells express genes, clusters plot. genes expressed many cells, cells neighbors express gene, hence vertical streak x = 0. applied univariate spatial statistics k nearest neighbor graph gene expression PCA space rather histological space. Just like histological space, impractical examine statistics gene gene, multivariate analyses incorporate k nearest neighbor graph may interesting.","code":"sfe <- runUnivariate(sfe, \"moran.plot\", features = top_markers, colGraphName = \"knn10\") top_markers_df[top_markers,] #> DataFrame with 9 rows and 6 columns #>                         FDR summary.AUC  cluster      symbol     moran #>                   <numeric>   <numeric> <factor> <character> <numeric> #> ENSG00000145220 2.80778e-08    0.890519        1        LYAR  0.395492 #> ENSG00000163131 2.20884e-15    0.993881        2        CTSS  0.867372 #> ENSG00000063177 5.31717e-17    1.000000        3       RPL18  0.737752 #> ENSG00000251562 1.82591e-13    0.997643        4      MALAT1  0.814179 #> ENSG00000105369 2.64693e-15    0.999939        5       CD79A  0.946637 #> ENSG00000168685 9.48170e-13    0.963182        6        IL7R  0.714728 #> ENSG00000115355 3.74026e-10    0.971350        7     CCDC88A  0.476699 #> ENSG00000180644 3.77998e-15    1.000000        8        PRF1  0.868973 #> ENSG00000120885 2.69076e-23    1.000000        9         CLU  0.907935 #>                 log_p_adj #>                 <numeric> #> ENSG00000145220   7.55164 #> ENSG00000163131  14.65584 #> ENSG00000063177  16.27432 #> ENSG00000251562  12.73852 #> ENSG00000105369  14.57726 #> ENSG00000168685  12.02311 #> ENSG00000115355   9.42710 #> ENSG00000180644  14.42251 #> ENSG00000120885  22.57013 plts <- lapply(top_markers, moranPlot, sfe = sfe, color_by = \"cluster\") #> Warning in value[[3L]](cond): Too few points for stat_density2d, not plotting #> contours.  #> Warning in value[[3L]](cond): Too few points for stat_density2d, not plotting #> contours.  #> Warning in value[[3L]](cond): Too few points for stat_density2d, not plotting #> contours. wrap_plots(plts, widths = 1, heights = 1) +     plot_layout(ncol = 3, guides = \"collect\") +     plot_annotation(tag_levels = \"1\")"},{"path":"https://pachterlab.github.io/voyager/articles/nonspatial.html","id":"session-info","dir":"Articles","previous_headings":"","what":"Session info","title":"Apply spatial analyses to non-spatial scRNA-seq data","text":"","code":"sessionInfo() #> R version 4.2.2 (2022-10-31) #> Platform: x86_64-apple-darwin17.0 (64-bit) #> Running under: macOS Big Sur ... 10.16 #>  #> Matrix products: default #> BLAS:   /Library/Frameworks/R.framework/Versions/4.2/Resources/lib/libRblas.0.dylib #> LAPACK: /Library/Frameworks/R.framework/Versions/4.2/Resources/lib/libRlapack.dylib #>  #> locale: #> [1] en_US.UTF-8/en_US.UTF-8/en_US.UTF-8/C/en_US.UTF-8/en_US.UTF-8 #>  #> attached base packages: #> [1] stats4    stats     graphics  grDevices utils     datasets  methods   #> [8] base      #>  #> other attached packages: #>  [1] dplyr_1.0.10                   patchwork_1.1.2                #>  [3] spdep_1.2-7                    sf_1.0-9                       #>  [5] spData_2.2.1                   sp_1.6-0                       #>  [7] BiocSingular_1.14.0            stringr_1.5.0                  #>  [9] BiocParallel_1.32.5            bluster_1.8.0                  #> [11] scran_1.26.2                   scater_1.27.3                  #> [13] ggplot2_3.4.0                  scuttle_1.8.4                  #> [15] BiocNeighbors_1.16.0           DropletUtils_1.18.1            #> [17] SpatialExperiment_1.8.0        SingleCellExperiment_1.20.0    #> [19] SummarizedExperiment_1.28.0    Biobase_2.58.0                 #> [21] GenomicRanges_1.50.2           GenomeInfoDb_1.34.7            #> [23] IRanges_2.32.0                 S4Vectors_0.36.1               #> [25] BiocGenerics_0.44.0            MatrixGenerics_1.10.0          #> [27] matrixStats_0.63.0             SpatialFeatureExperiment_1.0.3 #> [29] Voyager_1.0.8                  #>  #> loaded via a namespace (and not attached): #>   [1] systemfonts_1.0.4         igraph_1.3.5              #>   [3] splines_4.2.2             digest_0.6.31             #>   [5] htmltools_0.5.4           viridis_0.6.2             #>   [7] magick_2.7.3              fansi_1.0.4               #>   [9] magrittr_2.0.3            memoise_2.0.1             #>  [11] ScaledMatrix_1.6.0        cluster_2.1.4             #>  [13] limma_3.54.1              R.utils_2.12.2            #>  [15] pkgdown_2.0.7             colorspace_2.1-0          #>  [17] ggrepel_0.9.2             textshaping_0.3.6         #>  [19] xfun_0.36                 RCurl_1.98-1.10           #>  [21] jsonlite_1.8.4            glue_1.6.2                #>  [23] gtable_0.3.1              zlibbioc_1.44.0           #>  [25] XVector_0.38.0            DelayedArray_0.24.0       #>  [27] scico_1.3.1               Rhdf5lib_1.20.0           #>  [29] HDF5Array_1.26.0          scales_1.2.1              #>  [31] DBI_1.1.3                 edgeR_3.40.2              #>  [33] Rcpp_1.0.10               isoband_0.2.7             #>  [35] viridisLite_0.4.1         units_0.8-1               #>  [37] dqrng_0.3.0               rsvd_1.0.5                #>  [39] proxy_0.4-27              metapod_1.6.0             #>  [41] RColorBrewer_1.1-3        wk_0.7.1                  #>  [43] pkgconfig_2.0.3           R.methodsS3_1.8.2         #>  [45] farver_2.1.1              sass_0.4.5                #>  [47] deldir_1.0-6              locfit_1.5-9.7            #>  [49] utf8_1.2.2                tidyselect_1.2.0          #>  [51] labeling_0.4.2            rlang_1.0.6               #>  [53] munsell_0.5.0             tools_4.2.2               #>  [55] cachem_1.0.6              cli_3.6.0                 #>  [57] generics_0.1.3            evaluate_0.20             #>  [59] fastmap_1.1.0             yaml_2.3.7                #>  [61] ragg_1.2.5                knitr_1.42                #>  [63] fs_1.6.0                  purrr_1.0.1               #>  [65] s2_1.1.2                  nlme_3.1-161              #>  [67] sparseMatrixStats_1.10.0  R.oo_1.25.0               #>  [69] compiler_4.2.2            beeswarm_0.4.0            #>  [71] e1071_1.7-12              tibble_3.1.8              #>  [73] statmod_1.5.0             bslib_0.4.2               #>  [75] stringi_1.7.12            highr_0.10                #>  [77] desc_1.4.2                lattice_0.20-45           #>  [79] Matrix_1.5-3              classInt_0.4-8            #>  [81] vctrs_0.5.2               pillar_1.8.1              #>  [83] lifecycle_1.0.3           rhdf5filters_1.10.0       #>  [85] jquerylib_0.1.4           cowplot_1.1.1             #>  [87] bitops_1.0-7              irlba_2.3.5.1             #>  [89] R6_2.5.1                  KernSmooth_2.23-20        #>  [91] gridExtra_2.3             vipor_0.4.5               #>  [93] codetools_0.2-18          boot_1.3-28.1             #>  [95] MASS_7.3-58.2             assertthat_0.2.1          #>  [97] rhdf5_2.42.0              rprojroot_2.0.3           #>  [99] rjson_0.2.21              withr_2.5.0               #> [101] GenomeInfoDbData_1.2.9    mgcv_1.8-41               #> [103] parallel_4.2.2            grid_4.2.2                #> [105] beachmat_2.14.0           class_7.3-21              #> [107] rmarkdown_2.20            DelayedMatrixStats_1.20.0 #> [109] ggnewscale_0.4.8          ggbeeswarm_0.7.1"},{"path":"https://pachterlab.github.io/voyager/articles/seqfish_landing.html","id":"analysis-workflows","dir":"Articles","previous_headings":"","what":"Analysis Workflows","title":"seqFISH Processing Workflows with Voyager","text":"analysis tasks include basic quality control, spatial exploratory data analysis, identification spatially variable genes, computation global local spatial statistics. Accompanying Colab notebooks linked available.","code":""},{"path":[]},{"path":"https://pachterlab.github.io/voyager/articles/slideseqV2_landing.html","id":"dowload-data-and-create-a-spatialfeatureexperiment-object","dir":"Articles","previous_headings":"Getting Started","what":"Dowload Data and Create a SpatialFeatureExperiment object","title":"Slide-seqV2 Processing Workflows with Voyager","text":"vignettes demonstrate convert sequencing data spatial transcriptomics experiment SpatialFeatureExperiment object R. Many technologies yet standardized output formats, vignettes provide examples generate SFE object various output file types.","code":""},{"path":"https://pachterlab.github.io/voyager/articles/slideseqV2_landing.html","id":"analysis-workflows","dir":"Articles","previous_headings":"","what":"Analysis Workflows","title":"Slide-seqV2 Processing Workflows with Voyager","text":"vignettes demonstrate workflows can implemented Voyager using data generated Slide-seqV2 platform. analysis tasks include basic quality control, spatial exploratory data analysis, identification spatially variable genes, computation global local spatial statistics. Accompanying Colab notebooks linked available.","code":""},{"path":"https://pachterlab.github.io/voyager/articles/vig1_visium_basic.html","id":"introduction","dir":"Articles","previous_headings":"","what":"Introduction","title":"Basic Visium exploratory data analysis","text":"introductory vignette SpatialFeatureExperiment data representation Voyager analysis package, demonstrate basic exploratory data analysis (EDA) spatial transcriptomics data. Basic knowledge R SingleCellExperiment assumed. vignette showcases packages Visium spatial gene expression system dataset. technology chosen due popularity, therefore availability numerous publicly available datasets analysis (Moses Pachter 2022). code can run Google Colab.  Voyager developed goal facilitating use geospatial methods spatial genomics, introductory vignette restricted non-spatial scRNA-seq EDA Visium dataset. vignette illustrating univariate spatial analysis dataset, see advanced exploratory spatial data analyis vignette dataset. load packages used vignette.","code":"library(Voyager) library(SpatialFeatureExperiment) library(SingleCellExperiment) #> Loading required package: SummarizedExperiment #> Loading required package: MatrixGenerics #> Loading required package: matrixStats #>  #> Attaching package: 'MatrixGenerics' #> The following objects are masked from 'package:matrixStats': #>  #>     colAlls, colAnyNAs, colAnys, colAvgsPerRowSet, colCollapse, #>     colCounts, colCummaxs, colCummins, colCumprods, colCumsums, #>     colDiffs, colIQRDiffs, colIQRs, colLogSumExps, colMadDiffs, #>     colMads, colMaxs, colMeans2, colMedians, colMins, colOrderStats, #>     colProds, colQuantiles, colRanges, colRanks, colSdDiffs, colSds, #>     colSums2, colTabulates, colVarDiffs, colVars, colWeightedMads, #>     colWeightedMeans, colWeightedMedians, colWeightedSds, #>     colWeightedVars, rowAlls, rowAnyNAs, rowAnys, rowAvgsPerColSet, #>     rowCollapse, rowCounts, rowCummaxs, rowCummins, rowCumprods, #>     rowCumsums, rowDiffs, rowIQRDiffs, rowIQRs, rowLogSumExps, #>     rowMadDiffs, rowMads, rowMaxs, rowMeans2, rowMedians, rowMins, #>     rowOrderStats, rowProds, rowQuantiles, rowRanges, rowRanks, #>     rowSdDiffs, rowSds, rowSums2, rowTabulates, rowVarDiffs, rowVars, #>     rowWeightedMads, rowWeightedMeans, rowWeightedMedians, #>     rowWeightedSds, rowWeightedVars #> Loading required package: GenomicRanges #> Loading required package: stats4 #> Loading required package: BiocGenerics #>  #> Attaching package: 'BiocGenerics' #> The following objects are masked from 'package:stats': #>  #>     IQR, mad, sd, var, xtabs #> The following objects are masked from 'package:base': #>  #>     anyDuplicated, aperm, append, as.data.frame, basename, cbind, #>     colnames, dirname, do.call, duplicated, eval, evalq, Filter, Find, #>     get, grep, grepl, intersect, is.unsorted, lapply, Map, mapply, #>     match, mget, order, paste, pmax, pmax.int, pmin, pmin.int, #>     Position, rank, rbind, Reduce, rownames, sapply, setdiff, sort, #>     table, tapply, union, unique, unsplit, which.max, which.min #> Loading required package: S4Vectors #>  #> Attaching package: 'S4Vectors' #> The following objects are masked from 'package:base': #>  #>     expand.grid, I, unname #> Loading required package: IRanges #> Loading required package: GenomeInfoDb #> Loading required package: Biobase #> Welcome to Bioconductor #>  #>     Vignettes contain introductory material; view with #>     'browseVignettes()'. To cite Bioconductor, see #>     'citation(\"Biobase\")', and for packages 'citation(\"pkgname\")'. #>  #> Attaching package: 'Biobase' #> The following object is masked from 'package:MatrixGenerics': #>  #>     rowMedians #> The following objects are masked from 'package:matrixStats': #>  #>     anyMissing, rowMedians library(SpatialExperiment) library(scater) #> Loading required package: scuttle #> Loading required package: ggplot2 library(scran) library(patchwork) library(bluster) library(SFEData) library(BiocParallel) library(stringr) library(ggplot2) library(sparseMatrixStats) theme_set(theme_bw(10))"},{"path":"https://pachterlab.github.io/voyager/articles/vig1_visium_basic.html","id":"mouse-skeletal-muscle-dataset","dir":"Articles","previous_headings":"","what":"Mouse skeletal muscle dataset","title":"Basic Visium exploratory data analysis","text":"dataset used vignette paper Large-scale integration single-cell transcriptomic data captures transitional progenitor states mouse skeletal muscle regeneration (McKellar et al. 2021). Notexin injected tibialis anterior muscle mice induce injury, healing muscle collected 2, 5, 7 days post injury Visium analysis. dataset vignette timepoint day 2. vignette starts SpatialFeatureExperiment (SFE) object. gene count matrix directly downloaded GEO. 4992 spots, whether tissue , included. tissue boundary found thresholding H&E image OpenCV, small polygons removed likely debris. Spot polygons constructed spot centroid coordinates diameter Space Ranger output. in_tissue column colData indicates spot polygons intersect tissue polygons, based st_intersects(). Tissue boundary, nuclei, myofiber, Visium spot polygons stored sf data frames SFE object. Visium spot polygons called “spotPoly” SFE object. SpatialFeatureExperiment package convenience wrappers get set common types geometries, including spotPoly() Visium (technologies relevant) spot polygons, cellSeg() cell segmentation, nucSeg() nuclei segmentation, centroids() cell centroids. Behind scene specially named sf data frames. See vignette SpatialFeatureExperiment details structure SFE object. SFE object dataset provided SFEData package; begin downloading data loading R. authors provided full resolution hematoxylin eosin (H&E) image GEO, downsized facilitate display:","code":"(sfe <- McKellarMuscleData(\"full\")) #> snapshotDate(): 2022-10-31 #> see ?SFEData and browseVignettes('SFEData') for documentation #> loading from cache #> class: SpatialFeatureExperiment  #> dim: 15123 4992  #> metadata(0): #> assays(1): counts #> rownames(15123): ENSMUSG00000025902 ENSMUSG00000096126 ... #>   ENSMUSG00000064368 ENSMUSG00000064370 #> rowData names(6): Ensembl symbol ... vars cv2 #> colnames(4992): AAACAACGAATAGTTC AAACAAGTATCTCCCA ... TTGTTTGTATTACACG #>   TTGTTTGTGTAAATTC #> colData names(12): barcode col ... prop_mito in_tissue #> reducedDimNames(0): #> mainExpName: NULL #> altExpNames(0): #> spatialCoords names(2) : imageX imageY #> imgData names(1): sample_id #>  #> Geometries: #> colGeometries: spotPoly (POLYGON)  #> annotGeometries: tissueBoundary (POLYGON), myofiber_full (POLYGON), myofiber_simplified (POLYGON), nuclei (POLYGON), nuclei_centroid (POINT)  #>  #> Graphs: #> Vis5A:"},{"path":[]},{"path":"https://pachterlab.github.io/voyager/articles/vig1_visium_basic.html","id":"spots","dir":"Articles","previous_headings":"Quality control","what":"Spots","title":"Basic Visium exploratory data analysis","text":"begin quality control (QC) plotting various metrics violin plots space. QC metrics pre-computed stored colData (spots) rowData SFE object. plot total unique molecular identifier (UMI) counts per spot. commented line code shows compute total UMI counts.  spots injury site leukocyte infiltration high total counts. Spatial autocorrelation total counts apparent, discussed later section vignette. Next find number genes detected per spot. commented line code shows find number genes detected.  commonly done scRNA-seq data, plot nCounts vs. nGenes  plot two branches spots tissue, turn related myofiber size. See exploratory spatial data analysis (ESDA) Visium vignette. commonly done scRNA-seq data, plot proportion mitochondrially encoded counts. commented code shows find proportion:  expected, spots outside tissue higher proportion mitochondrial counts, tissue lysed, mitochondrial transcripts less likely degrade cytosolic transcripts protected double membrane. However, spots myofibers also high proportion mitochondrial counts, function myofibers. injury site leukocyte infiltration lower proportion mitochondrial counts. see relationship proportion mitochondrial counts total UMI counts, plot commonly done scRNA-seq analysis identify low quality cells, .e. cells UMI counts high proportion mitochondrial counts.  two clusters spots tissue, also turn related myofiber size. See ESDA Visium vignette. far haven’t seen spots obvious outliers QC metrics. following analyses use spots tissue, selected follows:","code":"names(colData(sfe)) #>  [1] \"barcode\"   \"col\"       \"row\"       \"x\"         \"y\"         \"dia\"       #>  [7] \"tissue\"    \"sample_id\" \"nCounts\"   \"nGenes\"    \"prop_mito\" \"in_tissue\" # colData(sfe)$nCounts <- colSums(counts(sfe)) violin <- plotColData(sfe, \"nCounts\", x = \"in_tissue\", colour_by = \"in_tissue\") +     theme(legend.position = \"top\") spatial <- plotSpatialFeature(sfe, \"nCounts\", colGeometryName = \"spotPoly\",                               annotGeometryName = \"tissueBoundary\",                               annot_fixed = list(fill = NA, color = \"black\",                                                   size = 0.5)) +     theme_void() violin + spatial # colData(sfe)$nGenes <- colSums(counts(sfe) > 0) violin <- plotColData(sfe, \"nGenes\", x = \"in_tissue\", colour_by = \"in_tissue\") +     theme(legend.position = \"top\") spatial <- plotSpatialFeature(sfe, \"nGenes\", colGeometryName = \"spotPoly\",                               annotGeometryName = \"tissueBoundary\",                               annot_fixed = list(fill = NA, color = \"black\",                                                   size = 0.5)) +     theme_void() violin + spatial plotColData(sfe, x = \"nCounts\", y = \"nGenes\", colour_by = \"in_tissue\") # mito_ind <- str_detect(rowData(sfe)$symbol, \"^Mt-\") # colData(sfe)$prop_mito <- colSums(counts(sfe)[mito_ind,]) / colData(sfe)$nCounts violin <- plotColData(sfe, \"prop_mito\", x = \"in_tissue\", colour_by = \"in_tissue\") +     theme(legend.position = \"top\") spatial <- plotSpatialFeature(sfe, \"prop_mito\", colGeometryName = \"spotPoly\",                               annotGeometryName = \"tissueBoundary\",                               annot_fixed = list(fill = NA, color = \"black\",                                                   size = 0.5)) +     theme_void() violin + spatial plotColData(sfe, x = \"nCounts\", y = \"prop_mito\", colour_by = \"in_tissue\") sfe_tissue <- sfe[, colData(sfe)$in_tissue] sfe_tissue <- sfe_tissue[rowSums(counts(sfe_tissue)) > 0,]"},{"path":"https://pachterlab.github.io/voyager/articles/vig1_visium_basic.html","id":"genes","dir":"Articles","previous_headings":"Quality control","what":"Genes","title":"Basic Visium exploratory data analysis","text":"scRNA-seq, gene expression variance Visium measurements overdispersed compared variance counts Poisson distributed. understand mean-variance relationship, compute mean, variance, coefficient variance (CV2) gene among spots tissue: avoid overplotting better show point density plot, use 2D histogram. color bin indicates number points bin.  red line, \\(y = x\\) expected Poisson distributed data, find variance higher highly expressed genes expected Poisson distributed counts. coefficient variation shows .","code":"rowData(sfe_tissue)$means <- rowMeans(counts(sfe_tissue)) rowData(sfe_tissue)$vars <- rowVars(counts(sfe_tissue)) # Coefficient of variance rowData(sfe_tissue)$cv2 <- rowData(sfe_tissue)$vars/rowData(sfe_tissue)$means^2 plotRowDataBin2D(sfe, \"means\", \"vars\", bins = 50) +     geom_abline(slope = 1, intercept = 0, color = \"red\") +     scale_x_log10() + scale_y_log10() +     annotation_logticks() +     coord_equal() plotRowDataBin2D(sfe, \"means\", \"cv2\", bins = 50) +     geom_abline(slope = -1, intercept = 0, color = \"red\") +     scale_x_log10() + scale_y_log10() +     annotation_logticks() +     coord_equal()"},{"path":"https://pachterlab.github.io/voyager/articles/vig1_visium_basic.html","id":"normalize-data","dir":"Articles","previous_headings":"","what":"Normalize data","title":"Basic Visium exploratory data analysis","text":"demonstrate use scater normalization , although note necessarily best approach normalizing spatial transcriptomics data. problem normalize spatial transcriptomics data non-trivial , nCounts plot space shows , spatial autocorrelation evident. Furthemrore, Visium, reverse transcription occurs situ spots, PCR amplification occurs cDNA dissociated spots. Artifacts may subsequently introduced amplification step, associated spatial origin. Spatial artifacts may arise diffusion transcripts tissue permeablization. However, given total counts seem correspond histological regions, total counts may biological component hence treated technical artifact normalized away scRNA-seq data normalization methods. words, issue normalization spatial transcriptomics data, Visium particular, complex currently unsolved. one way normalize non-spatial scRNA-seq data. commented code implements scran method (Lun, Bach, Marioni 2016). simplify matter, perform logNormCounts() introductory vignette. Note scater’s logNormCounts() quite different Seurat. Let \\(N\\) denote total UMI count one Visium spot, \\(\\bar N\\) average total UMI count spots dataset, \\(x\\) denote UMI count one gene Visium spot interest. Seurat performs log normalization \\(\\mathrm{log}\\left( \\frac{x}{N/10000} + 1 \\right)\\), natural log used. contrast, default parameters, scater uses \\(\\mathrm{log_2}\\left( \\frac{x}{N/\\bar N} + 1 \\right)\\). pseudocount (default 1), library size factors (default \\(N/\\bar N\\)), transform (default log2) can changed. Log 2 used differences values can interpreted log fold change. Next, identify highly variable genes (HVGs), used principal component analysis (PCA) dimensionality reduction. , different ways identify HVGs, scater differently Seurat. frameworks, log normalized data used default. summary, Seurat, default parameters, Loess curve fitted log transformed data (log normalized data log transformed fitting purposes), fitted values exponentiated expected variance gene. expected variance mean used standardize log normalized gene expression; standardized values used calculate standardized variance gene. top HVGs genes largest standardized variance. scater, default parameters, parametric non-linear curve variance vs. mean gene log normalized data. log ratio actual variance fitted variance curve calculated, Loess curve fitted log ratio vs. mean gene. “technical” component variance fitted values Loess curve. “biological” component difference actual variance Loess fitted variance. top HVGs genes largest biological component. See documentation modelGeneVar(), fitTrendVar(), getTopHVGs() details. differences can lead different downstream results. don’t comment way better vignette, ’s important aware differences.","code":"# clusters <- quickCluster(sfe_tissue) # sfe_tissue <- computeSumFactors(sfe_tissue, clusters=clusters) # sfe_tissue <- sfe_tissue[, sizeFactors(sfe_tissue) > 0] sfe_tissue <- logNormCounts(sfe_tissue) dec <- modelGeneVar(sfe_tissue) hvgs <- getTopHVGs(dec, n = 2000)"},{"path":"https://pachterlab.github.io/voyager/articles/vig1_visium_basic.html","id":"dimension-reduction-and-clustering","dir":"Articles","previous_headings":"","what":"Dimension reduction and clustering","title":"Basic Visium exploratory data analysis","text":"clustering show dimension reduction plots  principal components (PCs) can plotted space. Due spatial autocorrelation many genes spatial regions different histological characters, even though spatial information used PCA procedure, PCs may show spatial structure.  PC1, explains far variance PC2, separates injury site leukocytes myofibers close site Visium myofibers. PC2 highlight myofibers near edge. PC3 highlights muscle tendon junctions. PC4 seem informative; might picked outlier. also possible run UMAP following PCA, done scRNA-seq. recommend producing UMAP since procedure distorts distances, respect either local global structure data (Chari, Banerjee, Pachter 2021). However, completeness, show compute UMAP :  interesting spatial transcriptomics, locate clusters space, can done follows:  spatial information explicitly used clustering, due spatial autocorrelation gene expression histological regions, clusters spatially contiguous. many methods find spatially informed clusters, BayesSpace (E. Zhao et al. 2021), Bioconductor. Remark spatial regions: geographical space, usually one single way define spatial regions. example, influenced sociology geology, LA county can partitioned regions Eastside, Westside, South Central, San Fernado Valley, San Gabriel Valley, Pomona Valley, Gateway Cities, South Bay, etc., containing multiple smaller cities parts LA City, can divided many neighborhoods, Koreatown, Highland Park, Lincoln Heights, etc. Definitions regions subject dispute. Meanwhile, LA county can also partitioned watersheds LA River, San Gabriel River, Ballona Creek, etc., well different rock formations. kind spatial region resolution relevant depends question asked. also gray areas spatial regions. example, Whittier Narrows dam intercepts San Gabriel River Rio Hondo (large tributary LA River), whether dam area belongs watershed San Gabriel River LA River unclear. Similarly, spatial transcriptomics, methods identifying spatial regions currently generally aim give one result, multiple results different resolutions depending question asked may relevant. Furthermore, methods spatial region demarcation used spatial -omics ideally provide uncertainty assessments assignment cells Visium spots. existing geospatial method accounts uncertainty geocmeans (F. Zhao, Jiao, Liu 2013), CRAN. geographical histological space, conflicting views spatial variation. one hand, methods identify spatially variable genes SpatialDE often assume gene expression vary smoothly continuously space. hand, methods identifying spatial regions attempt identify discrete regions. continuous variation features might definitions geographical neighborhoods often subject dispute. existing methods attempt harmonize two views. example, spatially variable gene method belayer (Ma et al. 2022) takes discrete tissue layers account.","code":"sfe_tissue <- runPCA(sfe_tissue, ncomponents = 30, subset_row = hvgs,                      scale = TRUE) # scale as in Seurat ElbowPlot(sfe_tissue, ndims = 30) plotDimLoadings(sfe_tissue, dims = 1:4) colData(sfe_tissue)$cluster <- clusterRows(reducedDim(sfe_tissue, \"PCA\")[,1:3],                                            BLUSPARAM = SNNGraphParam(                                                cluster.fun = \"leiden\",                                                cluster.args = list(                                                    resolution_parameter = 0.5,                                                    objective_function = \"modularity\"))) plotPCA(sfe_tissue, ncomponents = 3, colour_by = \"cluster\") spatialReducedDim(sfe_tissue, \"PCA\", ncomponents = 4,                    colGeometryName = \"spotPoly\", divergent = TRUE,                    diverge_center = 0) &     theme_void() set.seed(29) sfe_tissue <- runUMAP(sfe_tissue, dimred = \"PCA\", n_dimred = 3) plotUMAP(sfe_tissue, colour_by = \"cluster\") plotSpatialFeature(sfe_tissue, \"cluster\", colGeometryName = \"spotPoly\") + theme_void()"},{"path":"https://pachterlab.github.io/voyager/articles/vig1_visium_basic.html","id":"non-spatial-differential-expression","dir":"Articles","previous_headings":"","what":"Non-spatial differential expression","title":"Basic Visium exploratory data analysis","text":"Cluster marker genes can found using differential analysis methods commonly done scRNA-seq. example Wilcoxon rank sum test: result sorted p-values: Significant markers cluster can obtained follows:  genes interesting view spatial context:","code":"markers <- findMarkers(sfe_tissue, groups = colData(sfe_tissue)$cluster,                        test.type = \"wilcox\", pval.type = \"all\", direction = \"up\") markers[[6]] #> DataFrame with 15043 rows and 8 columns #>                        p.value         FDR summary.AUC     AUC.1     AUC.2 #>                      <numeric>   <numeric>   <numeric> <numeric> <numeric> #> ENSMUSG00000098178 1.00128e-17 1.50622e-13    0.781437  0.801738  0.945666 #> ENSMUSG00000064339 7.07891e-02 1.00000e+00    0.551419  0.551419  0.699827 #> ENSMUSG00000025432 7.66475e-02 1.00000e+00    0.507812  0.507812  0.507812 #> ENSMUSG00000033707 7.66475e-02 1.00000e+00    0.507812  0.507812  0.507812 #> ENSMUSG00000028031 1.43351e-01 1.00000e+00    0.515091  0.528832  0.532820 #> ...                        ...         ...         ...       ...       ... #> ENSMUSG00000043969           1           1         0.5       0.5  0.500000 #> ENSMUSG00000091378           1           1         0.5       0.5  0.500000 #> ENSMUSG00000072437           1           1         0.5       0.5  0.500000 #> ENSMUSG00000003228           1           1         0.5       0.5  0.494975 #> ENSMUSG00000094649           1           1         0.5       0.5  0.497487 #>                        AUC.3     AUC.4     AUC.5 #>                    <numeric> <numeric> <numeric> #> ENSMUSG00000098178  0.781437  0.922948  0.883487 #> ENSMUSG00000064339  0.763090  0.894263  0.604148 #> ENSMUSG00000025432  0.507812  0.507812  0.507812 #> ENSMUSG00000033707  0.507812  0.507812  0.507812 #> ENSMUSG00000028031  0.520196  0.528059  0.515091 #> ...                      ...       ...       ... #> ENSMUSG00000043969  0.500000  0.496183  0.500000 #> ENSMUSG00000091378  0.500000  0.496183  0.500000 #> ENSMUSG00000072437  0.500000  0.492366  0.500000 #> ENSMUSG00000003228  0.476064  0.473282  0.489209 #> ENSMUSG00000094649  0.500000  0.500000  0.500000 genes_use <- vapply(markers, function(x) rownames(x)[1], FUN.VALUE = character(1)) plotExpression(sfe_tissue, rowData(sfe_tissue)[genes_use, \"symbol\"], x = \"cluster\",                colour_by = \"cluster\", swap_rownames = \"symbol\") plotSpatialFeature(sfe_tissue, genes_use, colGeometryName = \"spotPoly\", ncol = 4) &     theme_void()"},{"path":"https://pachterlab.github.io/voyager/articles/vig1_visium_basic.html","id":"morans-i","dir":"Articles","previous_headings":"","what":"Moran’s I","title":"Basic Visium exploratory data analysis","text":"Tobler’s first law geography states Everything related everything else. near things related distant things. observation motivates examination spatial autocorrelation. Positive spatial autocorrelation evident nearby things tend similar, weather Pasadena downtown Los Angeles (opposed weather Pasadena San Francisco). Negative spatial autocorrelation evident nearby things tend dissimilar, like squares chessboard. Spatial autocorrelation can arise intrinsic process diffusion communication physical contact, result covariate intrinsic process, areal data, areal units observation smaller scale spatial process. commonly used measure spatial autocorrelation Moran’s , defined \\[ = \\frac{n}{\\sum_{=1}^n \\sum_{j=1}^n w_{ij}} \\frac{\\sum_{=1}^n \\sum_{j=1}^n w_{ij} (x_i - \\bar{x})(x_j - \\bar{x})}{\\sum_{=1}^n (x_i - \\bar{x})^2}, \\] \\(n\\) number spots locations, \\(\\) \\(j\\) different locations, spots Visium context, \\(x\\) variable values location, \\(w_{ij}\\) spatial weight, can inversely proportional distance spots indicator whether two spots neighbors, subject various definitions neighborhood whether normalize number neighbors. spdep package uses neighborhood. Moran’s similar Pearson correlation value location average value neighbors (identical, see (Lee 2001)). Just like Pearson correlation, Moran’s generally bound -1 1, positive value indicates positive spatial autocorrelation negative value indicates negative spatial autocorrelation. Spatial dependence analysis spdep requires spatial neighborhood graph. graph adjacent Visium spot can found mentioned spatial autocorrelation apparent total UMI counts. ’s Moran’s shows: K means kurtosis. positive values Moran’s indicate positive spatial autocorrelation.","code":"colGraph(sfe_tissue, \"visium\") <- findVisiumGraph(sfe_tissue) calculateMoransI(t(colData(sfe_tissue)[,c(\"nCounts\", \"nGenes\")]),                   listw = colGraph(sfe_tissue, \"visium\")) #> DataFrame with 2 rows and 2 columns #>             moran         K #>         <numeric> <numeric> #> nCounts  0.528705   3.00082 #> nGenes   0.384028   3.88036"},{"path":"https://pachterlab.github.io/voyager/articles/vig1_visium_basic.html","id":"spatially-variable-genes","dir":"Articles","previous_headings":"Moran’s I","what":"Spatially variable genes","title":"Basic Visium exploratory data analysis","text":"spatially variable gene gene whose expression depends spatial locations, rather spatially random, like salt grains spread soup. Spatially variable genes can identified spatial autocorrelation signatures, sometimes Moran’s used compare assess spatially variable genes identified different methods. BPPARAM used parallelize computation Moran’s 2000 highly variable genes, 2 cores used SNOW backend. results stored rowData NA’s genes highly variable Moran’s computed genes. rank genes Moran’s plot space follows: see genes strong positive spatial autocorrelation, don’t observe strong negative spatial autocorrelation. can plot genes strongest positive spatial autocorrelation space:  genes indeed look spatially variable. However, spatial variability can simply due histological regions space, words, spatial distribution different cell types. many methods identify spatially variable genes, often involving Gaussian process modeling, far complex Moran’s , SpatialDE (Svensson, Teichmann, Stegle 2018). However, methods usually don’t account histological regions, except C-SIDE (Cable et al. 2022), identifies spatially variable genes within cell types. leads question really meant “cell type”. remains see spatial methods made specifically identifying spatially variable genes compare methods don’t explicitly use spatial information simply perform differential analysis cell types often spatially defined histological regions. Another consideration using Moran’s extent strength spatial autocorrelation varies space. gene exhibits strong spatial autocorrelation one region, another? different histological regions analyzed separately cases? ways see whether Moran’s statistically significant, many methods explore spatial autocorrelation. discussed advanced ESDA Visium vignette.","code":"sfe_tissue <- runMoransI(sfe_tissue, features = hvgs, colGraphName = \"visium\",                          BPPARAM = SnowParam(2)) #> Warning: <anonymous>: ... may be used in an incorrect context: 'fun(x[i, ], listw, ...)' rowData(sfe_tissue) #> DataFrame with 15043 rows and 8 columns #>                               Ensembl      symbol            type      means #>                           <character> <character>     <character>  <numeric> #> ENSMUSG00000025902 ENSMUSG00000025902       Sox17 Gene Expression 0.03969957 #> ENSMUSG00000096126 ENSMUSG00000096126     Gm22307 Gene Expression 0.00107296 #> ENSMUSG00000033845 ENSMUSG00000033845      Mrpl15 Gene Expression 0.38197425 #> ENSMUSG00000025903 ENSMUSG00000025903      Lypla1 Gene Expression 0.28755365 #> ENSMUSG00000033813 ENSMUSG00000033813       Tcea1 Gene Expression 0.26502146 #> ...                               ...         ...             ...        ... #> ENSMUSG00000064360 ENSMUSG00000064360      mt-Nd3 Gene Expression  56.445279 #> ENSMUSG00000064363 ENSMUSG00000064363      mt-Nd4 Gene Expression 123.991416 #> ENSMUSG00000064367 ENSMUSG00000064367      mt-Nd5 Gene Expression  14.645923 #> ENSMUSG00000064368 ENSMUSG00000064368      mt-Nd6 Gene Expression   0.109442 #> ENSMUSG00000064370 ENSMUSG00000064370     mt-Cytb Gene Expression 121.273605 #>                           vars       cv2 moran_Vis5A   K_Vis5A #>                      <numeric> <numeric>   <numeric> <numeric> #> ENSMUSG00000025902  0.04460915  28.30429          NA        NA #> ENSMUSG00000096126  0.00107296 932.00000          NA        NA #> ENSMUSG00000033845  0.47048031   3.22458          NA        NA #> ENSMUSG00000025903  0.34686963   4.19497          NA        NA #> ENSMUSG00000033813  0.32388797   4.61140   0.0489758   19.2181 #> ...                        ...       ...         ...       ... #> ENSMUSG00000064360 2.47976e+03  0.778314    0.410657  11.31069 #> ENSMUSG00000064363 1.45282e+04  0.944991    0.546964  13.62886 #> ENSMUSG00000064367 2.34858e+02  1.094895    0.480634   3.75345 #> ENSMUSG00000064368 1.31941e-01 11.015664          NA        NA #> ENSMUSG00000064370 1.48225e+04  1.007833    0.621060  10.71784 df <- rowData(sfe_tissue)[hvgs,] ord <- order(df$moran_Vis5A, decreasing = TRUE) df[ord, c(\"symbol\", \"moran_Vis5A\")] #> DataFrame with 2000 rows and 2 columns #>                         symbol moran_Vis5A #>                    <character>   <numeric> #> ENSMUSG00000064351      mt-Co1    0.764044 #> ENSMUSG00000050335      Lgals3    0.741474 #> ENSMUSG00000029304        Spp1    0.734937 #> ENSMUSG00000021939        Ctsb    0.708362 #> ENSMUSG00000004207        Psap    0.706552 #> ...                        ...         ... #> ENSMUSG00000039911       Spsb1  -0.0333357 #> ENSMUSG00000015711       Prune  -0.0354638 #> ENSMUSG00000042675       Ypel3  -0.0369055 #> ENSMUSG00000090262       Mpv17  -0.0412250 #> ENSMUSG00000020964       Sel1l  -0.0443975 plotSpatialFeature(sfe_tissue, rownames(df)[1:6], colGeometryName = \"spotPoly\") &     theme_void()"},{"path":"https://pachterlab.github.io/voyager/articles/vig1_visium_basic.html","id":"session-info","dir":"Articles","previous_headings":"","what":"Session Info","title":"Basic Visium exploratory data analysis","text":"","code":"sessionInfo() #> R version 4.2.2 (2022-10-31) #> Platform: x86_64-apple-darwin17.0 (64-bit) #> Running under: macOS Big Sur ... 10.16 #>  #> Matrix products: default #> BLAS:   /Library/Frameworks/R.framework/Versions/4.2/Resources/lib/libRblas.0.dylib #> LAPACK: /Library/Frameworks/R.framework/Versions/4.2/Resources/lib/libRlapack.dylib #>  #> locale: #> [1] en_US.UTF-8/en_US.UTF-8/en_US.UTF-8/C/en_US.UTF-8/en_US.UTF-8 #>  #> attached base packages: #> [1] stats4    stats     graphics  grDevices utils     datasets  methods   #> [8] base      #>  #> other attached packages: #>  [1] sparseMatrixStats_1.10.0       stringr_1.5.0                  #>  [3] BiocParallel_1.32.5            SFEData_1.0.2                  #>  [5] bluster_1.8.0                  patchwork_1.1.2                #>  [7] scran_1.26.2                   scater_1.27.3                  #>  [9] ggplot2_3.4.0                  scuttle_1.8.4                  #> [11] SpatialExperiment_1.8.0        SingleCellExperiment_1.20.0    #> [13] SummarizedExperiment_1.28.0    Biobase_2.58.0                 #> [15] GenomicRanges_1.50.2           GenomeInfoDb_1.34.7            #> [17] IRanges_2.32.0                 S4Vectors_0.36.1               #> [19] BiocGenerics_0.44.0            MatrixGenerics_1.10.0          #> [21] matrixStats_0.63.0             SpatialFeatureExperiment_1.0.3 #> [23] Voyager_1.0.8                  #>  #> loaded via a namespace (and not attached): #>   [1] snow_0.4-4                    AnnotationHub_3.6.0           #>   [3] BiocFileCache_2.6.0           systemfonts_1.0.4             #>   [5] igraph_1.3.5                  sp_1.6-0                      #>   [7] digest_0.6.31                 htmltools_0.5.4               #>   [9] viridis_0.6.2                 magick_2.7.3                  #>  [11] fansi_1.0.4                   magrittr_2.0.3                #>  [13] memoise_2.0.1                 ScaledMatrix_1.6.0            #>  [15] cluster_2.1.4                 limma_3.54.1                  #>  [17] Biostrings_2.66.0             R.utils_2.12.2                #>  [19] pkgdown_2.0.7                 colorspace_2.1-0              #>  [21] rappdirs_0.3.3                blob_1.2.3                    #>  [23] ggrepel_0.9.2                 textshaping_0.3.6             #>  [25] xfun_0.36                     dplyr_1.0.10                  #>  [27] crayon_1.5.2                  RCurl_1.98-1.10               #>  [29] jsonlite_1.8.4                glue_1.6.2                    #>  [31] gtable_0.3.1                  zlibbioc_1.44.0               #>  [33] XVector_0.38.0                DelayedArray_0.24.0           #>  [35] scico_1.3.1                   BiocSingular_1.14.0           #>  [37] DropletUtils_1.18.1           Rhdf5lib_1.20.0               #>  [39] HDF5Array_1.26.0              scales_1.2.1                  #>  [41] DBI_1.1.3                     edgeR_3.40.2                  #>  [43] Rcpp_1.0.10                   xtable_1.8-4                  #>  [45] viridisLite_0.4.1             spData_2.2.1                  #>  [47] units_0.8-1                   dqrng_0.3.0                   #>  [49] bit_4.0.5                     spdep_1.2-7                   #>  [51] rsvd_1.0.5                    proxy_0.4-27                  #>  [53] httr_1.4.4                    metapod_1.6.0                 #>  [55] FNN_1.1.3.1                   RColorBrewer_1.1-3            #>  [57] ellipsis_0.3.2                wk_0.7.1                      #>  [59] farver_2.1.1                  pkgconfig_2.0.3               #>  [61] R.methodsS3_1.8.2             uwot_0.1.14                   #>  [63] dbplyr_2.3.0                  sass_0.4.5                    #>  [65] deldir_1.0-6                  locfit_1.5-9.7                #>  [67] utf8_1.2.2                    labeling_0.4.2                #>  [69] AnnotationDbi_1.60.0          later_1.3.0                   #>  [71] tidyselect_1.2.0              rlang_1.0.6                   #>  [73] munsell_0.5.0                 BiocVersion_3.16.0            #>  [75] tools_4.2.2                   cachem_1.0.6                  #>  [77] cli_3.6.0                     dbscan_1.1-11                 #>  [79] ExperimentHub_2.6.0           generics_0.1.3                #>  [81] RSQLite_2.2.20                evaluate_0.20                 #>  [83] fastmap_1.1.0                 yaml_2.3.7                    #>  [85] ragg_1.2.5                    knitr_1.42                    #>  [87] bit64_4.0.5                   fs_1.6.0                      #>  [89] purrr_1.0.1                   s2_1.1.2                      #>  [91] KEGGREST_1.38.0               mime_0.12                     #>  [93] R.oo_1.25.0                   compiler_4.2.2                #>  [95] png_0.1-8                     interactiveDisplayBase_1.36.0 #>  [97] filelock_1.0.2                curl_5.0.0                    #>  [99] beeswarm_0.4.0                e1071_1.7-12                  #> [101] tibble_3.1.8                  statmod_1.5.0                 #> [103] bslib_0.4.2                   stringi_1.7.12                #> [105] highr_0.10                    desc_1.4.2                    #> [107] lattice_0.20-45               Matrix_1.5-3                  #> [109] classInt_0.4-8                vctrs_0.5.2                   #> [111] pillar_1.8.1                  lifecycle_1.0.3               #> [113] rhdf5filters_1.10.0           BiocManager_1.30.19           #> [115] jquerylib_0.1.4               BiocNeighbors_1.16.0          #> [117] cowplot_1.1.1                 bitops_1.0-7                  #> [119] irlba_2.3.5.1                 httpuv_1.6.8                  #> [121] R6_2.5.1                      promises_1.2.0.1              #> [123] KernSmooth_2.23-20            gridExtra_2.3                 #> [125] vipor_0.4.5                   codetools_0.2-18              #> [127] boot_1.3-28.1                 assertthat_0.2.1              #> [129] rhdf5_2.42.0                  rprojroot_2.0.3               #> [131] rjson_0.2.21                  withr_2.5.0                   #> [133] GenomeInfoDbData_1.2.9        parallel_4.2.2                #> [135] grid_4.2.2                    beachmat_2.14.0               #> [137] class_7.3-21                  rmarkdown_2.20                #> [139] DelayedMatrixStats_1.20.0     ggnewscale_0.4.8              #> [141] sf_1.0-9                      shiny_1.7.4                   #> [143] ggbeeswarm_0.7.1"},{"path":[]},{"path":"https://pachterlab.github.io/voyager/articles/vig2_visium.html","id":"introduction","dir":"Articles","previous_headings":"","what":"Introduction","title":"Spatial Visium exploratory data analysis","text":"vignette provides introduction exploratory spatial data analysis methods via Voyager package context Visium dataset.","code":"library(Voyager) library(SpatialFeatureExperiment) library(scater) #> Loading required package: SingleCellExperiment #> Loading required package: SummarizedExperiment #> Loading required package: MatrixGenerics #> Loading required package: matrixStats #>  #> Attaching package: 'MatrixGenerics' #> The following objects are masked from 'package:matrixStats': #>  #>     colAlls, colAnyNAs, colAnys, colAvgsPerRowSet, colCollapse, #>     colCounts, colCummaxs, colCummins, colCumprods, colCumsums, #>     colDiffs, colIQRDiffs, colIQRs, colLogSumExps, colMadDiffs, #>     colMads, colMaxs, colMeans2, colMedians, colMins, colOrderStats, #>     colProds, colQuantiles, colRanges, colRanks, colSdDiffs, colSds, #>     colSums2, colTabulates, colVarDiffs, colVars, colWeightedMads, #>     colWeightedMeans, colWeightedMedians, colWeightedSds, #>     colWeightedVars, rowAlls, rowAnyNAs, rowAnys, rowAvgsPerColSet, #>     rowCollapse, rowCounts, rowCummaxs, rowCummins, rowCumprods, #>     rowCumsums, rowDiffs, rowIQRDiffs, rowIQRs, rowLogSumExps, #>     rowMadDiffs, rowMads, rowMaxs, rowMeans2, rowMedians, rowMins, #>     rowOrderStats, rowProds, rowQuantiles, rowRanges, rowRanks, #>     rowSdDiffs, rowSds, rowSums2, rowTabulates, rowVarDiffs, rowVars, #>     rowWeightedMads, rowWeightedMeans, rowWeightedMedians, #>     rowWeightedSds, rowWeightedVars #> Loading required package: GenomicRanges #> Loading required package: stats4 #> Loading required package: BiocGenerics #>  #> Attaching package: 'BiocGenerics' #> The following objects are masked from 'package:stats': #>  #>     IQR, mad, sd, var, xtabs #> The following objects are masked from 'package:base': #>  #>     anyDuplicated, aperm, append, as.data.frame, basename, cbind, #>     colnames, dirname, do.call, duplicated, eval, evalq, Filter, Find, #>     get, grep, grepl, intersect, is.unsorted, lapply, Map, mapply, #>     match, mget, order, paste, pmax, pmax.int, pmin, pmin.int, #>     Position, rank, rbind, Reduce, rownames, sapply, setdiff, sort, #>     table, tapply, union, unique, unsplit, which.max, which.min #> Loading required package: S4Vectors #>  #> Attaching package: 'S4Vectors' #> The following objects are masked from 'package:base': #>  #>     expand.grid, I, unname #> Loading required package: IRanges #> Loading required package: GenomeInfoDb #> Loading required package: Biobase #> Welcome to Bioconductor #>  #>     Vignettes contain introductory material; view with #>     'browseVignettes()'. To cite Bioconductor, see #>     'citation(\"Biobase\")', and for packages 'citation(\"pkgname\")'. #>  #> Attaching package: 'Biobase' #> The following object is masked from 'package:MatrixGenerics': #>  #>     rowMedians #> The following objects are masked from 'package:matrixStats': #>  #>     anyMissing, rowMedians #> Loading required package: scuttle #> Loading required package: ggplot2 library(scran) library(SFEData) library(sf) #> Linking to GEOS 3.10.2, GDAL 3.4.2, PROJ 8.2.1; sf_use_s2() is TRUE library(ggplot2) library(scales) library(patchwork) library(BiocParallel) library(bluster) theme_set(theme_bw(10))"},{"path":"https://pachterlab.github.io/voyager/articles/vig2_visium.html","id":"dataset","dir":"Articles","previous_headings":"","what":"Dataset","title":"Spatial Visium exploratory data analysis","text":"dataset used vignette paper Large-scale integration single-cell transcriptomic data captures transitional progenitor states mouse skeletal muscle regeneration (McKellar et al. 2021). Notexin injected tibialis anterior muscle mice induce injury, healing muscle collected 2, 5, 7 days post injury Visium analysis. dataset vignette timepoint day 2. vignette starts SpatialFeatureExperiment (SFE) object. gene count matrix directly downloaded GEO. 4992 spots, whether tissue , included. H&E image used nuclei myofiber segmentation. subset nuclei randomly selected regions 3 timepoints manually annotated train StarDist model segment rest nuclei, myofibers manually segmented. tissue boundary found thresholding OpenCV, small polygons removed likely debris. Spot polygons constructed spot centroid coordinates diameter Space Ranger output. in_tissue column colData indicates spot polygons intersect tissue polygons, based st_intersects(). Tissue boundary, nuclei, myofiber, Visium spot polygons stored sf data frames SFE object. See vignette SpatialFeatureExperiment details structure SFE object. SFE object dataset provided SFEData package; begin downloading data loading R. Low resolution H&E image tissue section","code":"(sfe <- McKellarMuscleData(\"full\")) #> snapshotDate(): 2022-10-31 #> see ?SFEData and browseVignettes('SFEData') for documentation #> loading from cache #> class: SpatialFeatureExperiment  #> dim: 15123 4992  #> metadata(0): #> assays(1): counts #> rownames(15123): ENSMUSG00000025902 ENSMUSG00000096126 ... #>   ENSMUSG00000064368 ENSMUSG00000064370 #> rowData names(6): Ensembl symbol ... vars cv2 #> colnames(4992): AAACAACGAATAGTTC AAACAAGTATCTCCCA ... TTGTTTGTATTACACG #>   TTGTTTGTGTAAATTC #> colData names(12): barcode col ... prop_mito in_tissue #> reducedDimNames(0): #> mainExpName: NULL #> altExpNames(0): #> spatialCoords names(2) : imageX imageY #> imgData names(1): sample_id #>  #> Geometries: #> colGeometries: spotPoly (POLYGON)  #> annotGeometries: tissueBoundary (POLYGON), myofiber_full (POLYGON), myofiber_simplified (POLYGON), nuclei (POLYGON), nuclei_centroid (POINT)  #>  #> Graphs: #> Vis5A:"},{"path":[]},{"path":"https://pachterlab.github.io/voyager/articles/vig2_visium.html","id":"spots-in-tissue","dir":"Articles","previous_headings":"Exploratory data analysis","what":"Spots in tissue","title":"Spatial Visium exploratory data analysis","text":"example dataset Visium spots whether tissue , spots intersect tissue used analyses. Total UMI counts (nCounts), number genes detected per spot (nGenes), proportion mitochondrially encoded counts (prop_mito) precomputed colData(sfe). plotSpatialFeature function can used visualize various attributes space: expression gene, colData values, geometry attributes colGeometry annotGeometry. Visium spots plotted polygons reflecting actual size relative tissue, rather points, case packages plot Visium data. plotting geometries performed hood geom_sf. tissue boundary found thresholding H&E image removing small polygons likely debris. in_tissue column colData(sfe) indicates Visium spot polygon intersects tissue polygon; can found SpatialFeatureExperiment::annotPred(). demonstrate use scran (Lun, Bach, Marioni 2016) normalization , although note necessarily best approach normalizing spatial transcriptomics data. problem normalize spatial transcriptomics data non-trivial , nCounts plot space shows , spatial autocorrelation evident. Furthemrore, Visium, reverse transcription occurs situ spots, PCR amplification occurs cDNA dissociated spots. Artifacts may subsequently introduced amplification step, associated spatial origin. Spatial artifacts may arise diffusion transcripts tissue permeablization. However, given total counts seem correspond histological regions, total counts may biological component hence treated technical artifact normalized away scRNA-seq data normalization methods. words, issue normalization spatial transcriptomics data, Visium particular, complex currently unsolved. Myofiber nuclei segmentation polygons available dataset annotGeometries field. Myofibers manually segmented, nuclei segmented StarDist trained manually segmented subset.","code":"names(colData(sfe)) #>  [1] \"barcode\"   \"col\"       \"row\"       \"x\"         \"y\"         \"dia\"       #>  [7] \"tissue\"    \"sample_id\" \"nCounts\"   \"nGenes\"    \"prop_mito\" \"in_tissue\" sfe_tissue <- sfe[,colData(sfe)$in_tissue] sfe_tissue <- sfe_tissue[rowSums(counts(sfe_tissue)) > 0,] #clusters <- quickCluster(sfe_tissue) #sfe_tissue <- computeSumFactors(sfe_tissue, clusters=clusters) #sfe_tissue <- sfe_tissue[, sizeFactors(sfe_tissue) > 0] sfe_tissue <- logNormCounts(sfe_tissue) annotGeometryNames(sfe_tissue) #> [1] \"tissueBoundary\"      \"myofiber_full\"       \"myofiber_simplified\" #> [4] \"nuclei\"              \"nuclei_centroid\""},{"path":"https://pachterlab.github.io/voyager/articles/vig2_visium.html","id":"from-myofibers-and-nuclei-to-visium-spots","dir":"Articles","previous_headings":"Exploratory data analysis > Spots in tissue","what":"From myofibers and nuclei to Visium spots","title":"Spatial Visium exploratory data analysis","text":"plotSpatialFeature() function can also used plot attributes geometries, .e. non-geometry columns sf data frames rowGeometries, colGeometries, annotGeometries fields SFE object. rowGeometries colGeometries, columns associated sf data frames rather rowData colData, allowed one can specify columns associate geometries (see st_agr documentation st_sf). attribute annotGeometry plotted along side gene expression colData colGeometry attribute, annotGeometry attribute plotted different color palette distinguish column associated values. myofiber polygons annotGeometries can plotted shown , colored cross section area observed tissue section. aes_use argument set color rather fill (default polygons) plot Visium spot outlines make myofiber polygons visible. fill argument set NA make Visium spots look hollow, size argument controls thickness outlines. annot_aes argument specifies column annotGeometry use specify values aesthstic, just like aes ggplot2 (aes_string precise, since tidyeval used ). annot_fixed argument (used ) can set fixed size, alpha, color, etc. annotGeometry.  larger myofibers seem fewer total counts, possibly larger size myofibers dilutes transcripts. hints need normalization procedure. SpatialFeatureExperiment, can find number myofibers nuclei intersect Visium spot. predicate can anything implemented sf, example, number nuclei fully covered Visium spot can also found. default predicate st_intersects().  one--one mapping Visium spots myofibers. However, can relate attributes myofibers gene expression detected Visium spots. One way summarize attributes myofibers intersect (choose another better predicate implemented sf) spot, calculate mean, median, sum. can done annotSummary() function SpatialFeatureExperiment. default predicate st_intersects(), default summary function mean().  reveals relationship mean area myofibers intersecting Visium spot aspects spots, total counts gene expression. NAs designate spots intersecting myofibers, e.g. inflammatory region. Basic Visium vignette, encountered two mysterious branches two clusters nGenes vs. nCounts plot proportion mitochondrial counts vs. nCounts plot. Now see two clusters seem related myofiber size.","code":"plotSpatialFeature(sfe_tissue, features = \"nCounts\",                     colGeometryName = \"spotPoly\",                    annotGeometryName = \"myofiber_simplified\",                     annot_aes = list(fill = \"area\"), alpha = 0.5) +     theme_void() colData(sfe_tissue)$n_myofibers <-    annotNPred(sfe_tissue, colGeometryName = \"spotPoly\",              annotGeometryName = \"myofiber_simplified\") plotSpatialFeature(sfe_tissue, features = \"n_myofibers\",                     colGeometryName = \"spotPoly\") + theme_void() colData(sfe_tissue)$mean_myofiber_area <-    annotSummary(sfe_tissue, \"spotPoly\", \"myofiber_simplified\",                 annotColNames = \"area\")[,1] # it always returns a data frame # The gray spots don't intersect any myofiber plotSpatialFeature(sfe_tissue, \"mean_myofiber_area\", \"spotPoly\") +     theme_void() plotColData(sfe_tissue, x = \"nCounts\", y = \"nGenes\", colour_by = \"mean_myofiber_area\") plotColData(sfe_tissue, x = \"nCounts\", y = \"prop_mito\", colour_by = \"mean_myofiber_area\")"},{"path":"https://pachterlab.github.io/voyager/articles/vig2_visium.html","id":"myofiber-types","dir":"Articles","previous_headings":"Exploratory data analysis > Spots in tissue","what":"Myofiber types","title":"Spatial Visium exploratory data analysis","text":"Marker genes: Myh7 (Type , slow twitch, aerobic), Myh2 (Type IIa, fast twitch, somewhat aerobic), Myh4 (Type IIb, fast twitch, anareobic), Myh1 (Type IIx, fast twitch, anaerobic), protocol (Wang, Yue, Kuang 2017) first examine Type myofibers. fast twitch muscle, don’t expect many slow twitch Type myofibers. Row names sfe_tissue Ensembl IDs order avoid ambiguity sometimes multiple Ensembl IDs gene symbol genes aliases. However, gene symbols shorter human readable Ensembl IDs, better suited display plots. plotSpatialFeature() function functions Voyager, even row names recorded Ensembl IDs, features argument can take gene symbols column called “symbols” rowData(sfe), function converts gene symbols Ensembl IDs. default, gene symbols shown plot, show_symbol argument can set FALSE show Ensembl IDs instead. one gene symbol matches multiple Ensembl IDs dataset, warning given. exprs_values argument specifies assay use, default “logcounts”, .e. log normalized data. default may may suitable practice given total UMI counts may biological relevance spatial data. Therefore, plot raw counts log normalized counts:  marker gene type IIa myofibers shown . straightforward modify plotting display markers type IIb type IIx myofibers:  Type IIa myofibers also tend clustered together left side tissue. SFE inherits SCE, non-spatial EDA plots scater package can also used:  Plotting proportion mitochondrial counts vs. mean myofiber area, see two clusters, one higher proportion mitochondrial counts smaller area, another lower proportion mitochondrial counts average slightly larger area. Type IIa myofibers tend smaller area larger proportion mitochondrial counts.","code":"markers <- c(I = \"Myh7\", IIa = \"Myh2\", IIb = \"Myh4\", IIx = \"Myh1\") # Function specific for this vignette, with some hard coded values plot_counts_logcounts <- function(sfe, feature) {   p1 <- plotSpatialFeature(sfe, feature, \"spotPoly\",                    annotGeometryName = \"myofiber_simplified\",                     annot_aes = list(fill = \"area\"), show_symbol = TRUE,                     exprs_values = \"counts\", alpha = 0.5) +     ggtitle(\"Raw counts\")   p2 <- plotSpatialFeature(sfe, feature, \"spotPoly\",                    annotGeometryName = \"myofiber_simplified\",                     annot_aes = list(fill = \"area\"), show_symbol = TRUE,                     exprs_values = \"logcounts\", alpha = 0.5) +     ggtitle(\"Log normalized counts\")   p1 + p2 +     plot_annotation(title = feature) &       theme_void() } plot_counts_logcounts(sfe_tissue, markers[\"I\"]) plot_counts_logcounts(sfe_tissue, markers[\"IIa\"]) plotColData(sfe_tissue, x = \"mean_myofiber_area\", y = \"prop_mito\",              colour_by = markers[\"IIa\"], by_exprs_values = \"logcounts\",              swap_rownames = \"symbol\") #> Warning: Removed 36 rows containing missing values (`geom_point()`)."},{"path":"https://pachterlab.github.io/voyager/articles/vig2_visium.html","id":"spatial-neighborhood-graphs","dir":"Articles","previous_headings":"","what":"Spatial neighborhood graphs","title":"Spatial Visium exploratory data analysis","text":"spatial neighborhood graph required compute spatial dependency metrics Moran’s Geary’s C. SpatialFeatureExperiment package wraps methods spdep find spatial neighborhood graphs, stored within SFE object (see spdep documentation gabrielneigh(), knearneigh(), poly2nb(), tri2nb()). Voyager package uses graphs spatial dependency analyses, based spdep first version, methods geospatial packages, also use spatial neighborhood graphs, may added later. Visium, spots hexagonal grid, spatial neighborhood graph straightforward. However, spatial technologies single cell resolution, e.g. MERFISH, different methods can used find spatial neighborhood graph. example, method “poly2nb” used myofibers, identifies myofiber polygons physically touch . zero.policy = TRUE allow singletons, .e. nodes without neighbors graph; inflamed region, singletons. yet benchmarked spatial neighborhood construction methods determine “best” different technologies; particular method used demonstration purposes may best practice: plotColGraph() function plots graph space associated colGeometry, along geometry interest.  Similarly, plotAnnotGraph() function plots graph associated annotGeometry, along geometry interest.  plotRowGraph yet since haven’t worked dataset spatial graphs related genes relevant, although SFE object supports row graphs.","code":"colGraph(sfe_tissue, \"visium\") <- findVisiumGraph(sfe_tissue) annotGraph(sfe_tissue, \"myofiber_poly2nb\") <-    findSpatialNeighbors(sfe_tissue, type = \"myofiber_simplified\", MARGIN = 3,                        method = \"poly2nb\", zero.policy = TRUE) plotColGraph(sfe_tissue, colGraphName = \"visium\", colGeometryName = \"spotPoly\") +     theme_void() plotAnnotGraph(sfe_tissue, annotGraphName = \"myofiber_poly2nb\",                 annotGeometryName = \"myofiber_simplified\") +     theme_void()"},{"path":"https://pachterlab.github.io/voyager/articles/vig2_visium.html","id":"exploratory-spatial-data-analysis","dir":"Articles","previous_headings":"","what":"Exploratory spatial data analysis","title":"Spatial Visium exploratory data analysis","text":"spatial autocorrelation metrics package can computed directly vector matrix rather SFE object. user interface emulates dimension reductions scater package (e.g. calculateUMAP() takes matrix SCE object returns matrix, runUMAP() takes SCE object adds results reducedDims field SCE object). calculate* functions take matrix SFE object directly return results (format results depends structure results), run* functions take SFE object add results object. addition, colData* functions compute metrics numeric variables colData. colGeometry* functions compute metrics numeric columns colGeometry. annotGeometry* functions compute metrics numeric columns annotGeometry.","code":""},{"path":"https://pachterlab.github.io/voyager/articles/vig2_visium.html","id":"univariate-global","dir":"Articles","previous_headings":"","what":"Univariate global","title":"Spatial Visium exploratory data analysis","text":"Currently Voyager supports univariate global spatial autocorrelation implemented spdep ESDA: Moran’s Geary’s C, permutation testing Moran’s Geary’s C, Moran plot, correlograms. addition, beyond spdep, Voyager can cluster Moran plots correlograms. Plotting functions taking SFE objects implemented plot results ggplot2 customization options spdep plotting functions. functions calculateUnivariate(), runUnivariate(), colDataUnivariate(), colGeometryUnivariate(), annotGeometryUnivariate() compute univariate spatial statistics. univariate methods implemented R package spdep supported . argument type, indicates corresponding function names spdep, determines spatial statistics computed. demonstrate spatial autocorrelation gene expression, top highly variable genes (HVGs) used. HVGs found scran method. global statistic yields one result entire dataset.","code":"dec <- modelGeneVar(sfe_tissue) hvgs <- getTopHVGs(dec, n = 50)"},{"path":"https://pachterlab.github.io/voyager/articles/vig2_visium.html","id":"morans-i","dir":"Articles","previous_headings":"Univariate global","what":"Moran’s I","title":"Spatial Visium exploratory data analysis","text":"several ways quantify spatial autocorrelation, common Moran’s : \\[ = \\frac{n}{\\sum_{=1}^n \\sum_{j=1}^n w_{ij}} \\frac{\\sum_{=1}^n \\sum_{j=1}^n w_{ij} (x_i - \\bar{x})(x_j - \\bar{x})}{\\sum_{=1}^n (x_i - \\bar{x})^2}, \\] \\(n\\) number spots locations, \\(\\) \\(j\\) different locations, spots Visium context, \\(x\\) variable values location, \\(w_{ij}\\) spatial weight, can inversely proportional distance spots indicator whether two spots neighbors, subject various definitions neighborhood whether normalize number neighbors. spdep package uses neighborhood. Moran’s can understood Pearson correlation value location average value neighbors. Just like Pearson correlation, Moran’s generally bound -1 1, positive value indicates positive spatial autocorrelation negative value indicates negative spatial autocorrelation. Upon visual inspection, total UMI counts per spot seem spatial autocorrelation. spatial neighborhood graph required compute Moran’s , specified listw argument. matrices, rows features, gene count matrix. “moran” Moran’s , K sample kurtosis. add results SFE object, specifically colData: colData, results added colFeatureData(sfe), features Moran’s calculated NA. column names featureData distinguishes different samples (’s one sample dataset), parsed plotting functions. add results SFE object, specifically geometries: “area” area cross section myofiber seen tissue section “eccentricity” eccentricity ellipse fitted myofiber. non-geometry column colGeometry, colGeometryUnivariate() like annotGeometryUnivariate() , none colGeometries dataset extra columns. gene expression, logcounts assay used default (use exprs_values argument change assay), though may may best practice. metrics computed large number features, parallel computing supported, BiocParallel, BPPARAM argument.","code":"# Directly use vector or matrix, and multiple features can be specified at once calculateUnivariate(t(colData(sfe_tissue)[,c(\"nCounts\", \"nGenes\")]),                      type = \"moran\",                     listw = colGraph(sfe_tissue, \"visium\")) #> DataFrame with 2 rows and 2 columns #>             moran         K #>         <numeric> <numeric> #> nCounts  0.528705   3.00082 #> nGenes   0.384028   3.88036 sfe_tissue <- colDataUnivariate(sfe_tissue, features = c(\"nCounts\", \"nGenes\"),                                 colGraphName = \"visium\", type = \"moran\") colFeatureData(sfe_tissue)[c(\"nCounts\", \"nGenes\"),] #> DataFrame with 2 rows and 2 columns #>         moran_Vis5A   K_Vis5A #>           <numeric> <numeric> #> nCounts    0.528705   3.00082 #> nGenes     0.384028   3.88036 # Remember zero.policy = TRUE since there're singletons sfe_tissue <- annotGeometryUnivariate(sfe_tissue, type = \"moran\",                                       features = c(\"area\", \"eccentricity\"),                                        annotGeometryName = \"myofiber_simplified\",                                       annotGraphName = \"myofiber_poly2nb\",                                        zero.policy = TRUE) head(attr(annotGeometry(sfe_tissue, \"myofiber_simplified\"), \"featureData\")) #> DataFrame with 6 rows and 2 columns #>              moran_Vis5A   K_Vis5A #>                <numeric> <numeric> #> lyr.1                 NA        NA #> area            0.327888   4.95675 #> perimeter             NA        NA #> eccentricity    0.110938   3.26913 #> theta                 NA        NA #> sine_theta            NA        NA sfe_tissue <- runUnivariate(sfe_tissue, type = \"moran\", features = hvgs,                              colGraphName = \"visium\",                              BPPARAM = MulticoreParam(2)) rowData(sfe_tissue)[head(hvgs),] #> DataFrame with 6 rows and 8 columns #>                               Ensembl      symbol            type     means #>                           <character> <character>     <character> <numeric> #> ENSMUSG00000029304 ENSMUSG00000029304        Spp1 Gene Expression   1.63722 #> ENSMUSG00000050708 ENSMUSG00000050708        Ftl1 Gene Expression   2.37981 #> ENSMUSG00000050335 ENSMUSG00000050335      Lgals3 Gene Expression   1.43189 #> ENSMUSG00000021939 ENSMUSG00000021939        Ctsb Gene Expression   2.73117 #> ENSMUSG00000021190 ENSMUSG00000021190        Lgmn Gene Expression   1.11278 #> ENSMUSG00000018893 ENSMUSG00000018893          Mb Gene Expression   2.11118 #>                         vars       cv2 moran_Vis5A   K_Vis5A #>                    <numeric> <numeric>   <numeric> <numeric> #> ENSMUSG00000029304   60.1583   22.4430    0.734937   1.63516 #> ENSMUSG00000050708  162.1931   28.6384    0.665563   1.81841 #> ENSMUSG00000050335   48.0739   23.4471    0.741474   1.68098 #> ENSMUSG00000021939  131.6232   17.6455    0.708362   1.86896 #> ENSMUSG00000021190   21.4505   17.3228    0.659916   1.66838 #> ENSMUSG00000018893   74.1782   16.6428    0.675840   1.82510"},{"path":"https://pachterlab.github.io/voyager/articles/vig2_visium.html","id":"gearys-c","dir":"Articles","previous_headings":"Univariate global","what":"Geary’s C","title":"Spatial Visium exploratory data analysis","text":"Another spatial autocorrelation metric Geary’s C, defined : \\[ C = \\frac{(n-1)}{2\\sum_{=1}^n \\sum_{j=1}^n w_{ij}} \\frac{\\sum_{=1}^n \\sum_{j=1}^n w_{ij}(x_i - x_j)^2}{{\\sum_{=1}^n (x_i - \\bar{x})^2}} \\] Geary’s C 1 indicates positive spatial autocorrelation, 1 indicates negative spatial autocorrelation. compute Geary’s C features interest replace type = \"moran\" previous section type = \"geary\", add results SFE object. example, colData ’s one column K since ’s Moran’s Geary’s C. Moran’s Geary’s C suggest positive spatial autocorrelation nCounts nGenes. univariate global methods, including permutation testing Moran’s Geary’s C, correlograms, Moran scatter plot can also called functions runUnivariate, specifying type argument. See documentation runUnivariate see available methods see documentation corresponding spdep functions see extra arguments required method.","code":"sfe_tissue <- colDataUnivariate(sfe_tissue, features = c(\"nCounts\", \"nGenes\"),                                 colGraphName = \"visium\", type = \"geary\") colFeatureData(sfe_tissue)[c(\"nCounts\", \"nGenes\"),] #> DataFrame with 2 rows and 3 columns #>         moran_Vis5A   K_Vis5A geary_Vis5A #>           <numeric> <numeric>   <numeric> #> nCounts    0.528705   3.00082    0.474892 #> nGenes     0.384028   3.88036    0.605797"},{"path":"https://pachterlab.github.io/voyager/articles/vig2_visium.html","id":"permutation-testing","dir":"Articles","previous_headings":"Univariate global","what":"Permutation testing","title":"Spatial Visium exploratory data analysis","text":"establish whether spatial autocorrelation statistically significant, moran.test() function spdep can used. provides p-value, p-value may accurate data normally distributed. gene expression data generally normally distributed data normalization doesn’t always work well, use permutation testing test significance Moran’s Geary’s C, wrapping moran.mc() spdep. “mc” stands Monte Carlo. nsim argument specifies number simulations. following adds results SFE object: Note test performed multiple features, p-values corrected multiple hypothesis testing. results can plotted:  default, colorblind friendly palette dittoSeq used categorical variables. density plot Moran’s simulations values permuted disconnected spatial locations, vertical line actual Moran’s value. simulation indicates actual Moran’s much higher simulations values dissociated spatial locations permuted among locations, indicating spatial autocorrelation significant. Use type = \"geary.mc\" permutation testing Geary’s C. spdep package can also compute p-values Moran’s analytically, theory behind mean variance null distribution Moran’s assumes normal distribution data, gene expression data generally non-normal. However, according (Griffith 2010), large sample size (“preferably least 100”), mean variance Moran’s several iid non-normal simulated datasets (including negative binomial, commonly used model gene expression data) don’t seem deviate much values expected normally distributed data. Spatial transcriptomics datasets typically thousands spots cells, sample size likely large enough. Hence using analytical test non-normal data might bad. However, large sample size, minuscule difference can create significant p-values. perform analytical test Moran’s : Now compare p-values permutation analytical test; cases , default alternative hypothesis positive spatial autocorrelation: p-values permutation limited number permutations (1000 ). Either way, permutation analytical tests indicate significant positive spatial autocorrelation. limitation permutation testing Moran’s assumes permutation values among locations equally likely, necessarily true. instance, epidemiology, disease rate regions small population likely assumes extreme values (Assunção Reis 1999), analogous rare cell types lowly expressed genes histological space given divide total UMI counts per spot. extent happens may depend tissue, gene interest, technology, data normalization method.","code":"set.seed(29) sfe_tissue <- colDataUnivariate(sfe_tissue, features = c(\"nCounts\", \"nGenes\"),                                  colGraphName = \"visium\", nsim = 1000,                                 type = \"moran.mc\") colFeatureData(sfe_tissue)[c(\"nCounts\", \"nGenes\"),] #> DataFrame with 2 rows and 10 columns #>         moran_Vis5A   K_Vis5A geary_Vis5A moran.mc_statistic_Vis5A #>           <numeric> <numeric>   <numeric>                <numeric> #> nCounts    0.528705   3.00082    0.474892                 0.528705 #> nGenes     0.384028   3.88036    0.605797                 0.384028 #>         moran.mc_parameter_Vis5A moran.mc_p.value_Vis5A #>                        <numeric>              <numeric> #> nCounts                     1001            0.000999001 #> nGenes                      1001            0.000999001 #>         moran.mc_alternative_Vis5A  moran.mc_method_Vis5A #>                        <character>            <character> #> nCounts                    greater Monte-Carlo simulati.. #> nGenes                     greater Monte-Carlo simulati.. #>         moran.mc_data.name_Vis5A                      moran.mc_res_Vis5A #>                      <character>                                  <list> #> nCounts  x[i, ] \\nweights: lis.. -0.00244073,-0.01476250,-0.00826943,... #> nGenes   x[i, ] \\nweights: lis.. -0.00955170, 0.00243942, 0.00585069,... plotMoranMC(sfe_tissue, c(\"nCounts\", \"nGenes\")) sfe_tissue <- colDataUnivariate(sfe_tissue, features = c(\"nCounts\", \"nGenes\"),                                  colGraphName = \"visium\", type = \"moran.test\") names(colFeatureData(sfe_tissue)) #>  [1] \"moran_Vis5A\"                        \"K_Vis5A\"                            #>  [3] \"geary_Vis5A\"                        \"moran.mc_statistic_Vis5A\"           #>  [5] \"moran.mc_parameter_Vis5A\"           \"moran.mc_p.value_Vis5A\"             #>  [7] \"moran.mc_alternative_Vis5A\"         \"moran.mc_method_Vis5A\"              #>  [9] \"moran.mc_data.name_Vis5A\"           \"moran.mc_res_Vis5A\"                 #> [11] \"moran.test_statistic_Vis5A\"         \"moran.test_p.value_Vis5A\"           #> [13] \"moran.test_alternative_Vis5A\"       \"moran.test_data.name_Vis5A\"         #> [15] \"moran.test_method_Vis5A\"            \"moran.test_Moran.I.statistic_Vis5A\" #> [17] \"moran.test_Expectation_Vis5A\"       \"moran.test_Variance_Vis5A\" # permutation colFeatureData(sfe_tissue)[c(\"nCounts\", \"nGenes\"), c(\"moran.mc_p.value_Vis5A\", \"moran.test_p.value_Vis5A\")] #> DataFrame with 2 rows and 2 columns #>         moran.mc_p.value_Vis5A moran.test_p.value_Vis5A #>                      <numeric>                <numeric> #> nCounts            0.000999001             5.41958e-163 #> nGenes             0.000999001              2.82666e-87"},{"path":"https://pachterlab.github.io/voyager/articles/vig2_visium.html","id":"correlogram","dir":"Articles","previous_headings":"Univariate global","what":"Correlogram","title":"Spatial Visium exploratory data analysis","text":"correlogram, spatial autocorrelation higher orders neighbors (e.g. second order neighbors neighbors neighbors) calculated see decays orders. Visium, regular hexagonal grid, order neighbors proxy distance. irregular patterns single cells, different methods find spatial neighbors may give different results. colData, Moran’s correlogram computed results can plotted plotCorrelogram:  error bars twice standard deviation Moran’s value. standard deviation p-values (null hypothesis Moran’s 0) come moran.test() (Geary’s C correlogram, geary.test()); taken grain salt data normally distributed. p-values corrected multiple hypothesis testing across orders features. usual, . means p < 0.1, * means p < 0.05, ** means p < 0.01, *** means p < 0.001. , can done Geary’s C, colData, annotGeometry, etc.","code":"sfe_tissue <- runUnivariate(sfe_tissue, hvgs[1:2], colGraphName = \"visium\",                              order = 10, type = \"sp.correlogram\") plotCorrelogram(sfe_tissue, hvgs[1:2])"},{"path":"https://pachterlab.github.io/voyager/articles/vig2_visium.html","id":"moran-scatter-plot","dir":"Articles","previous_headings":"Univariate global","what":"Moran scatter plot","title":"Spatial Visium exploratory data analysis","text":"Moran scatter plot, x axis value spot, y axis average value neighbors. slope fitted line Moran’s . Sometimes clusters appear plot, showing different kinds neighborhoods. gene expression, use one gene (log normalized value) demonstrate:  dashed lines mark mean Myh2 spatially lagged Myh2. singletons . Visium spots lower Myh2 expression neighbors don’t express Myh2 spots don’t express Myh2 usually least neighbors . twp main clusters spots whose neighbors express Myh2: high (average) expression whose neighbors also high expression, low expression whose neighbors also low expression. features may show different kinds clusters. can use k-means clustering identify clusters, though clustering method supported bluster package can used.  Plot clusters space  can also done colData, annotGeometry, etc. Moran’s permutation testing.","code":"sfe_tissue <- runUnivariate(sfe_tissue, \"Myh2\", colGraphName = \"visium\",                              type = \"moran.plot\") moranPlot(sfe_tissue, \"Myh2\", graphName = \"visium\") set.seed(29) clusts <- clusterMoranPlot(sfe_tissue, \"Myh2\", BLUSPARAM = KmeansParam(2)) moranPlot(sfe_tissue, \"Myh2\", graphName = \"visium\",            color_by = clusts$ENSMUSG00000033196) +     labs(color = \"cluster\") colData(sfe_tissue)$Myh2_moranPlot_clust <- clusts$ENSMUSG00000033196 plotSpatialFeature(sfe_tissue, \"Myh2_moranPlot_clust\", colGeometryName = \"spotPoly\") +     theme_void()"},{"path":"https://pachterlab.github.io/voyager/articles/vig2_visium.html","id":"univariate-local","dir":"Articles","previous_headings":"","what":"Univariate local","title":"Spatial Visium exploratory data analysis","text":"Local statistics yield result location rather whole dataset, global statistics may obscure local heterogeneity. See (Fotheringham 2009) interesting discussion relationships global local spatial statistics. Local statistics stored localResults field SFE object, can accessed localResult() localResults() functions SpatialFeatureExperiment package.","code":""},{"path":"https://pachterlab.github.io/voyager/articles/vig2_visium.html","id":"local-morans-i","dir":"Articles","previous_headings":"Univariate local","what":"Local Moran’s I","title":"Spatial Visium exploratory data analysis","text":"recap, global Moran’s defined \\[ = \\frac{n}{\\sum_{=1}^n \\sum_{j=1}^n w_{ij}} \\frac{\\sum_{=1}^n \\sum_{j=1}^n w_{ij} (x_i - \\bar{x})(x_j - \\bar{x})}{\\sum_{=1}^n (x_i - \\bar{x})^2}. \\] Local Moran’s (Anselin 1995) defined \\[ I_i = (n-1)\\frac{(x_i - \\bar{x})\\sum_{j=1}^n w_{ij} (x_j - \\bar{x})}{\\sum_{=1}^n (x_i - \\bar{x})^2}. \\] ’s similar global Moran’s , values locations \\(\\) summed ’s normalization sum spatial weights. useful plot log normalized Myh2 gene expression context interpret local results:   see regions higher Myh2 expression also stronger spatial autocorrelation. interesting see spatial autocorrelation relates gene expression level, much finding variance relates mean expression gene, usually indicates overdispersion compared Poisson scRNA-seq Visium data:  gene, Visium spots higher expression also tend higher local Moran’s , may may apply genes. Local spatial analyses often return matrix data frame. plotLocalResult() function default column local spatial method, columns can plotted well. Use localResultAttrs() function see columns present, use attribute argument specify column plot. local spatial methods return p-values location, column name like Pr(z != E(Ii)), test two sided (default, can changed alternative argument runUnivariate() passed relevant underlying function spdep). Negative log p-value computed facilitate visualization, p-value corrected multiple hypothesis testing p.adjustSP() spdep, number tests number neighbors location rather total number locations (-log10p_adj).  plot following plots p-values, divergent palette used show locations significant adjusting multiple testing significant different colors. center divergent palette p = 0.05, bluish spots significant dark brown means really significant. “pysal” column displays quadrants relative means Moran plot. result similar k-means clustering shown .","code":"sfe_tissue <- runUnivariate(sfe_tissue, type = \"localmoran\", features = \"Myh2\",                             colGraphName = \"visium\") plotSpatialFeature(sfe_tissue, features = \"Myh2\", colGeometryName = \"spotPoly\") +     theme_void() plotLocalResult(sfe_tissue, \"localmoran\", features = \"Myh2\",                  colGeometryName = \"spotPoly\",divergent = TRUE,                 diverge_center = 0) +     theme_void() df <- data.frame(myh2 = logcounts(sfe_tissue)[rowData(sfe_tissue)$symbol == \"Myh2\",],                  Ii = localResult(sfe_tissue, \"localmoran\", \"Myh2\")[,\"Ii\"]) ggplot(df, aes(myh2, Ii)) + geom_point(alpha = 0.3) +     labs(x = \"Myh2 (log counts)\", y = \"localmoran\") localResultAttrs(sfe_tissue, \"localmoran\", \"Myh2\") #>  [1] \"Ii\"             \"E.Ii\"           \"Var.Ii\"         \"Z.Ii\"           #>  [5] \"Pr(z != E(Ii))\" \"mean\"           \"median\"         \"pysal\"          #>  [9] \"-log10p\"        \"-log10p_adj\" plotLocalResult(sfe_tissue, \"localmoran\", features = \"Myh2\",                  colGeometryName = \"spotPoly\", attribute = \"-log10p_adj\", divergent = TRUE,                 diverge_center = -log10(0.05)) +     theme_void() plotLocalResult(sfe_tissue, \"localmoran\", features = \"Myh2\",                  colGeometryName = \"spotPoly\", attribute = \"pysal\") +     theme_void()"},{"path":"https://pachterlab.github.io/voyager/articles/vig2_visium.html","id":"getis-ord-gi","dir":"Articles","previous_headings":"Univariate local","what":"Getis-Ord Gi*","title":"Spatial Visium exploratory data analysis","text":"Getis-Ord Gi* used find hotspots coldspots feature space. hotspot cluster high values space, coldspot cluster low values space. Getis-Ord Gi* essentially z-score spatially lagged value feature location \\(\\) (\\(\\sum_j w_{ij} x_j\\)), \\(w_{ij}\\) spatial weight. original publication Getis-Ord Gi* 1992 (Getis Ord 1992), spatial weight distance-based binary weight indicating whether another location within certain distance location \\(\\). Getis-Ord Gi excludes location \\(\\) computation mean variance lagged value, Gi* includes location \\(\\) . Usually Gi Gi* yield similar results. mean variance used z-score differ Gi Gi* described paper 1995 (J. K. Ord Getis 1995) derived (Getis Ord 1992). Binary weights recommended Getis-Ord Gi*.  High values Gi* indicate hotspots, low values Gi* indicate coldspots. Plot pseudo-p-values simulation  hotspots expected. warm color indicates adjusted \\(p < 0.05\\). Local results can also computed annotation geometries.   hotspots coldspots expected. Warm color indicates adjusted \\(p < 0.05\\).","code":"colGraph(sfe_tissue, \"visium_B\") <- findVisiumGraph(sfe_tissue, style = \"B\") sfe_tissue <- runUnivariate(sfe_tissue, type = \"localG_perm\", features = \"Myh2\",                             colGraphName = \"visium_B\", include_self = TRUE) plotLocalResult(sfe_tissue, \"localG_perm\", features = \"Myh2\",                  colGeometryName = \"spotPoly\", divergent = TRUE,                 diverge_center = 0) + theme_void() localResultAttrs(sfe_tissue, \"localG_perm\", \"Myh2\") #>  [1] \"localG\"             \"Gi\"                 \"E.Gi\"               #>  [4] \"Var.Gi\"             \"Pr(z != E(Gi))\"     \"Pr(z != E(Gi)) Sim\" #>  [7] \"Pr(folded) Sim\"     \"Skewness\"           \"Kurtosis\"           #> [10] \"-log10p Sim\"        \"-log10p_adj Sim\" plotLocalResult(sfe_tissue, \"localG_perm\", features = \"Myh2\",                  attribute = \"-log10p_adj Sim\",                 colGeometryName = \"spotPoly\", divergent = TRUE,                 diverge_center = -log10(0.05)) + theme_void() annotGraph(sfe_tissue, \"myofiber_poly2nb_B\") <-    findSpatialNeighbors(sfe_tissue, type = \"myofiber_simplified\", MARGIN = 3,                        method = \"poly2nb\", zero.policy = TRUE, style = \"B\") sfe_tissue <- annotGeometryUnivariate(sfe_tissue, \"localG_perm\", \"area\",                                        annotGeometryName = \"myofiber_simplified\",                                       annotGraphName = \"myofiber_poly2nb_B\",                                       include_self = TRUE, zero.policy = TRUE) plotLocalResult(sfe_tissue, \"localG_perm\", \"area\",                  annotGeometryName = \"myofiber_simplified\",                 divergent = TRUE, diverge_center = 0) +     theme_void() plotLocalResult(sfe_tissue, \"localG_perm\", \"area\",                  annotGeometryName = \"myofiber_simplified\",                 attribute = \"-log10p_adj Sim\",                 divergent = TRUE, diverge_center = -log10(0.05)) +     theme_void()"},{"path":"https://pachterlab.github.io/voyager/articles/vig2_visium.html","id":"local-spatial-heteroscedasticity-losh","dir":"Articles","previous_headings":"Univariate local","what":"Local spatial heteroscedasticity (LOSH)","title":"Spatial Visium exploratory data analysis","text":"LOSH (J. Keith Ord Getis 2012) defined \\[ H_i = \\frac{\\sum_j w_{ij}\\left| e_j \\right|^}{h_1\\sum_j w_{ij}} \\] \\(h_1 = \\sum_i \\left| e_i \\right|^/n\\), \\(e_j = x_j - \\bar{x}_j\\), \\[ \\bar{x}_j = \\frac{\\sum_j w_{jk}x_k}{\\sum_j w_{jk}}. \\] default, \\(= 2\\) LOSH like local variance. See (J. Keith Ord Getis 2012) details interpretation.  gene, isn’t clear whether LOSH relates gene expression levels. Voyager wrap LOSH.mc() perform permutation testing LOSH, time consuming. chi-squared approximation described 2012 LOSH paper account non-normality data approximate mean variance permutation distributions, p-values LOSH can quickly computed, LOSH.cs().  gene, local conditions mostly homogenous, except spots. Warm color indicates adjusted \\(p < 0.05\\).","code":"sfe_tissue <- runUnivariate(sfe_tissue, \"LOSH.cs\", \"Myh2\",                              colGraphName = \"visium\") plotLocalResult(sfe_tissue, \"LOSH.cs\", features = \"Myh2\",                  colGeometryName = \"spotPoly\") +     theme_void() localResultAttrs(sfe_tissue, \"LOSH.cs\", \"Myh2\") #> [1] \"Hi\"          \"E.Hi\"        \"Var.Hi\"      \"Z.Hi\"        \"x_bar_i\"     #> [6] \"ei\"          \"Pr()\"        \"-log10p\"     \"-log10p_adj\" plotLocalResult(sfe_tissue, \"LOSH.cs\", features = \"Myh2\",                  attribute = \"-log10p_adj\", colGeometryName = \"spotPoly\",                 divergent = TRUE, diverge_center = -log10(0.05)) +     theme_void()"},{"path":"https://pachterlab.github.io/voyager/articles/vig2_visium.html","id":"caveats","dir":"Articles","previous_headings":"","what":"Caveats","title":"Spatial Visium exploratory data analysis","text":"current version Voyager, univariate spatial autocorrelation metrics supported. Anisotropy, bivariate, multivariate spatial analyses added later versions. plotting functions don’t plot H&E image background. implemented first version since Visium spots plotted, block H&E image anyway. Also, plots small interactive, good enough visualizing gene expression Visium spots, H&E image informative zoomed . Interactive data visualization beyond scope package. ’s convoluted trick geom_sf flipping y axis, since coordinates pixels full resolution image image origin top left. 2D data supported present, although principle, sf GEOS support 3D data. present, runUnivariate type different parameter called, existing results overwritten. next version Voyager, may append non-default parameters names localResults relevant column names rowData keep record parameters distinguish results different parameters, case results compared. Spatial neighborhoods make sense within tissue section. multiple tissue sections, biological replica, different conditions? mouse brain, different biological replica can registered Allen Common Coordinate Framework (CCF) spatially comparable. Indeed, interesting see biological variability healthy wild type gene expression fine scaled region brain. However, CCF tissues without stereotypical structure, adipose skeletal muscle. don’t good solution spatially compare different tissue sections yet. Perhaps global spatial statistics whole section histological regions within section can compared. problem remains select informative metrics compare. Perhaps spatially-informed dimension reduction method, taking gene count matrix, also adjacency matrices spatial neighborhood graphs (different sections different blocks matrix) projecting cells Visium spots different sections shared low dimensional space can facilitate comparison. batch effect must corrected, dimension reduction interpretable, scalable.","code":""},{"path":"https://pachterlab.github.io/voyager/articles/vig2_visium.html","id":"session-info","dir":"Articles","previous_headings":"","what":"Session info","title":"Spatial Visium exploratory data analysis","text":"","code":"sessionInfo() #> R version 4.2.2 (2022-10-31) #> Platform: x86_64-apple-darwin17.0 (64-bit) #> Running under: macOS Big Sur ... 10.16 #>  #> Matrix products: default #> BLAS:   /Library/Frameworks/R.framework/Versions/4.2/Resources/lib/libRblas.0.dylib #> LAPACK: /Library/Frameworks/R.framework/Versions/4.2/Resources/lib/libRlapack.dylib #>  #> locale: #> [1] en_US.UTF-8/en_US.UTF-8/en_US.UTF-8/C/en_US.UTF-8/en_US.UTF-8 #>  #> attached base packages: #> [1] stats4    stats     graphics  grDevices utils     datasets  methods   #> [8] base      #>  #> other attached packages: #>  [1] bluster_1.8.0                  BiocParallel_1.32.5            #>  [3] patchwork_1.1.2                scales_1.2.1                   #>  [5] sf_1.0-9                       SFEData_1.0.2                  #>  [7] scran_1.26.2                   scater_1.27.3                  #>  [9] ggplot2_3.4.0                  scuttle_1.8.4                  #> [11] SingleCellExperiment_1.20.0    SummarizedExperiment_1.28.0    #> [13] Biobase_2.58.0                 GenomicRanges_1.50.2           #> [15] GenomeInfoDb_1.34.7            IRanges_2.32.0                 #> [17] S4Vectors_0.36.1               BiocGenerics_0.44.0            #> [19] MatrixGenerics_1.10.0          matrixStats_0.63.0             #> [21] SpatialFeatureExperiment_1.0.3 Voyager_1.0.8                  #>  #> loaded via a namespace (and not attached): #>   [1] utf8_1.2.2                    R.utils_2.12.2                #>   [3] tidyselect_1.2.0              RSQLite_2.2.20                #>   [5] AnnotationDbi_1.60.0          grid_4.2.2                    #>   [7] DropletUtils_1.18.1           munsell_0.5.0                 #>   [9] ScaledMatrix_1.6.0            codetools_0.2-18              #>  [11] ragg_1.2.5                    units_0.8-1                   #>  [13] statmod_1.5.0                 withr_2.5.0                   #>  [15] colorspace_2.1-0              filelock_1.0.2                #>  [17] highr_0.10                    knitr_1.42                    #>  [19] wk_0.7.1                      labeling_0.4.2                #>  [21] GenomeInfoDbData_1.2.9        bit64_4.0.5                   #>  [23] farver_2.1.1                  rhdf5_2.42.0                  #>  [25] rprojroot_2.0.3               vctrs_0.5.2                   #>  [27] generics_0.1.3                xfun_0.36                     #>  [29] BiocFileCache_2.6.0           R6_2.5.1                      #>  [31] ggbeeswarm_0.7.1              rsvd_1.0.5                    #>  [33] locfit_1.5-9.7                isoband_0.2.7                 #>  [35] bitops_1.0-7                  rhdf5filters_1.10.0           #>  [37] cachem_1.0.6                  DelayedArray_0.24.0           #>  [39] assertthat_0.2.1              promises_1.2.0.1              #>  [41] beeswarm_0.4.0                gtable_0.3.1                  #>  [43] beachmat_2.14.0               rlang_1.0.6                   #>  [45] systemfonts_1.0.4             splines_4.2.2                 #>  [47] scico_1.3.1                   BiocManager_1.30.19           #>  [49] s2_1.1.2                      yaml_2.3.7                    #>  [51] httpuv_1.6.8                  tools_4.2.2                   #>  [53] spData_2.2.1                  SpatialExperiment_1.8.0       #>  [55] ellipsis_0.3.2                jquerylib_0.1.4               #>  [57] RColorBrewer_1.1-3            proxy_0.4-27                  #>  [59] Rcpp_1.0.10                   sparseMatrixStats_1.10.0      #>  [61] zlibbioc_1.44.0               classInt_0.4-8                #>  [63] purrr_1.0.1                   RCurl_1.98-1.10               #>  [65] dbscan_1.1-11                 deldir_1.0-6                  #>  [67] viridis_0.6.2                 cowplot_1.1.1                 #>  [69] ggrepel_0.9.2                 cluster_2.1.4                 #>  [71] fs_1.6.0                      magrittr_2.0.3                #>  [73] magick_2.7.3                  ggnewscale_0.4.8              #>  [75] mime_0.12                     evaluate_0.20                 #>  [77] xtable_1.8-4                  gridExtra_2.3                 #>  [79] compiler_4.2.2                tibble_3.1.8                  #>  [81] KernSmooth_2.23-20            crayon_1.5.2                  #>  [83] R.oo_1.25.0                   htmltools_0.5.4               #>  [85] mgcv_1.8-41                   later_1.3.0                   #>  [87] spdep_1.2-7                   DBI_1.1.3                     #>  [89] ExperimentHub_2.6.0           dbplyr_2.3.0                  #>  [91] MASS_7.3-58.2                 rappdirs_0.3.3                #>  [93] boot_1.3-28.1                 Matrix_1.5-3                  #>  [95] cli_3.6.0                     R.methodsS3_1.8.2             #>  [97] parallel_4.2.2                metapod_1.6.0                 #>  [99] igraph_1.3.5                  pkgconfig_2.0.3               #> [101] pkgdown_2.0.7                 sp_1.6-0                      #> [103] vipor_0.4.5                   bslib_0.4.2                   #> [105] dqrng_0.3.0                   XVector_0.38.0                #> [107] stringr_1.5.0                 digest_0.6.31                 #> [109] Biostrings_2.66.0             rmarkdown_2.20                #> [111] edgeR_3.40.2                  DelayedMatrixStats_1.20.0     #> [113] curl_5.0.0                    shiny_1.7.4                   #> [115] rjson_0.2.21                  lifecycle_1.0.3               #> [117] nlme_3.1-161                  jsonlite_1.8.4                #> [119] Rhdf5lib_1.20.0               BiocNeighbors_1.16.0          #> [121] desc_1.4.2                    viridisLite_0.4.1             #> [123] limma_3.54.1                  fansi_1.0.4                   #> [125] pillar_1.8.1                  lattice_0.20-45               #> [127] KEGGREST_1.38.0               fastmap_1.1.0                 #> [129] httr_1.4.4                    interactiveDisplayBase_1.36.0 #> [131] glue_1.6.2                    png_0.1-8                     #> [133] BiocVersion_3.16.0            bit_4.0.5                     #> [135] class_7.3-21                  stringi_1.7.12                #> [137] sass_0.4.5                    HDF5Array_1.26.0              #> [139] blob_1.2.3                    textshaping_0.3.6             #> [141] BiocSingular_1.14.0           AnnotationHub_3.6.0           #> [143] memoise_2.0.1                 dplyr_1.0.10                  #> [145] irlba_2.3.5.1                 e1071_1.7-12"},{"path":[]},{"path":"https://pachterlab.github.io/voyager/articles/vig3_slideseq_v2.html","id":"introduction","dir":"Articles","previous_headings":"","what":"Introduction","title":"Slide-Seq V2 Exploratory Data Analysis","text":"Slide-seq V2 spatial transcriptomic tool measures genome-wide expression using DNA-barcoded beads patterned slide non-regular array. beads used current protocol diameter \\(10 \\mu m\\) thus larger single cell, number detected transcripts order magnitude higher compared previous iteration technology. vignette, use Voyager analyze dataset generated using Slide-Seq V2 technology. data described Dissecting treatment-naive ecosystem human melanoma brain metastasis (Biermann et al. 2022). raw counts cell metadata publicly available GEO. focus one human melanoma brain metastasis (MBM) samples provided SFEData package SpatialFeatureExperiment(SFE) object. SFE object contains raw counts, QC metrics number UMIs genes detected per barcode, centroid coordinates barcode sf POINT geometry. SFE object SFEData package includes information 27,566 features 29,536 beads/barcodes.","code":"library(Voyager) library(SFEData) library(SingleCellExperiment) #> Loading required package: SummarizedExperiment #> Loading required package: MatrixGenerics #> Loading required package: matrixStats #>  #> Attaching package: 'MatrixGenerics' #> The following objects are masked from 'package:matrixStats': #>  #>     colAlls, colAnyNAs, colAnys, colAvgsPerRowSet, colCollapse, #>     colCounts, colCummaxs, colCummins, colCumprods, colCumsums, #>     colDiffs, colIQRDiffs, colIQRs, colLogSumExps, colMadDiffs, #>     colMads, colMaxs, colMeans2, colMedians, colMins, colOrderStats, #>     colProds, colQuantiles, colRanges, colRanks, colSdDiffs, colSds, #>     colSums2, colTabulates, colVarDiffs, colVars, colWeightedMads, #>     colWeightedMeans, colWeightedMedians, colWeightedSds, #>     colWeightedVars, rowAlls, rowAnyNAs, rowAnys, rowAvgsPerColSet, #>     rowCollapse, rowCounts, rowCummaxs, rowCummins, rowCumprods, #>     rowCumsums, rowDiffs, rowIQRDiffs, rowIQRs, rowLogSumExps, #>     rowMadDiffs, rowMads, rowMaxs, rowMeans2, rowMedians, rowMins, #>     rowOrderStats, rowProds, rowQuantiles, rowRanges, rowRanks, #>     rowSdDiffs, rowSds, rowSums2, rowTabulates, rowVarDiffs, rowVars, #>     rowWeightedMads, rowWeightedMeans, rowWeightedMedians, #>     rowWeightedSds, rowWeightedVars #> Loading required package: GenomicRanges #> Loading required package: stats4 #> Loading required package: BiocGenerics #>  #> Attaching package: 'BiocGenerics' #> The following objects are masked from 'package:stats': #>  #>     IQR, mad, sd, var, xtabs #> The following objects are masked from 'package:base': #>  #>     anyDuplicated, aperm, append, as.data.frame, basename, cbind, #>     colnames, dirname, do.call, duplicated, eval, evalq, Filter, Find, #>     get, grep, grepl, intersect, is.unsorted, lapply, Map, mapply, #>     match, mget, order, paste, pmax, pmax.int, pmin, pmin.int, #>     Position, rank, rbind, Reduce, rownames, sapply, setdiff, sort, #>     table, tapply, union, unique, unsplit, which.max, which.min #> Loading required package: S4Vectors #>  #> Attaching package: 'S4Vectors' #> The following objects are masked from 'package:base': #>  #>     expand.grid, I, unname #> Loading required package: IRanges #> Loading required package: GenomeInfoDb #> Loading required package: Biobase #> Welcome to Bioconductor #>  #>     Vignettes contain introductory material; view with #>     'browseVignettes()'. To cite Bioconductor, see #>     'citation(\"Biobase\")', and for packages 'citation(\"pkgname\")'. #>  #> Attaching package: 'Biobase' #> The following object is masked from 'package:MatrixGenerics': #>  #>     rowMedians #> The following objects are masked from 'package:matrixStats': #>  #>     anyMissing, rowMedians library(SpatialExperiment) library(scater) #> Loading required package: scuttle #> Loading required package: ggplot2 library(scran) library(bluster) library(ggplot2) library(patchwork) library(spdep) #> Loading required package: sp #>  #> Attaching package: 'sp' #> The following object is masked from 'package:IRanges': #>  #>     %over% #> Loading required package: spData #> To access larger datasets in this package, install the spDataLarge #> package with: `install.packages('spDataLarge', #> repos='https://nowosad.github.io/drat/', type='source')` #> Loading required package: sf #> Linking to GEOS 3.10.2, GDAL 3.4.2, PROJ 8.2.1; sf_use_s2() is TRUE library(BiocParallel)  theme_set(theme_bw()) (sfe <- BiermannMelaMetasData(dataset = \"MBM05_rep1\")) #> snapshotDate(): 2022-10-31 #> see ?SFEData and browseVignettes('SFEData') for documentation #> downloading 1 resources #> retrieving 1 resource #> loading from cache #> require(\"SpatialFeatureExperiment\") #> class: SpatialFeatureExperiment  #> dim: 27566 29536  #> metadata(0): #> assays(1): counts #> rownames(27566): A1BG A1BG-AS1 ... ZZZ3 snoZ196 #> rowData names(3): means vars cv2 #> colnames(29536): ACCACTCATTTCTC-1 GTTCANTCCACGTA-1 ... ACGCGCAATCGTAG-1 #>   TTGTTCCGTTCATA-1 #> colData names(4): sample_id nCounts nGenes prop_mito #> reducedDimNames(0): #> mainExpName: NULL #> altExpNames(0): #> spatialCoords names(2) : xcoord ycoord #> imgData names(1): sample_id #>  #> Geometries: #> colGeometries: centroids (POINT)  #>  #> Graphs: #> sample01:"},{"path":"https://pachterlab.github.io/voyager/articles/vig3_slideseq_v2.html","id":"quality-control-qc","dir":"Articles","previous_headings":"","what":"Quality control (QC)","title":"Slide-Seq V2 Exploratory Data Analysis","text":"begin performing exploratory data analysis barcodes tissue. pre-computed QC measures stored object. Total UMI counts (nCounts), number genes detected per spot (nGenes), proportion mitochondrially encoded counts (prop_mito). , plot total number UMI counts per barcode violin plot space. latter task, leverage function plotSpatialFeature() uses geom_sf() plot geometries applicable. first lines compute average number UMI counts per barcode average plotted red line vilin plot.  barcode represented sf POINT geometry plot , note many beads quite low UMI counts, small regions throughout tissue appear high counts. perhaps due high cellular density melanoma cells, can speculate without image tissue. Interestingly, barcodes zero counts. contrast many scRNA-seq dataset many cells zero counts. Given density points, may choose aggregate points hexagonal grid avoid overplotting. hexagon colored total number UMI counts space hexagon may represent one barcode.  worthwhile note cell segmentation data included dataset. Even though Slide-Seq V2 profile gene expression single cell resolution, cell segmentation data can flexibly stored annotGeometries SFE object. geometries can plotted barcode-level data can used sf operations like finding number barcodes localized single cell.  plot visualizes number UMI counts per barcode log scale. appears barcodes higher counts co-localized regions throughout tissue, however, regions rather small may suggest spatial autocorrelation. Next find number genes detected per barcode. , QC feature provided nGenes colData attribute barcodes.  Similar number UMI counts per barcode, seem small regions higher number genes throughout tissue. may correspond regions cellular diversity high cellular density, might expected context melanoma. can compute degree number UMI counts per barcode depends spatial location measurement. relationship, spatial autocorrelation, can quantified using Moran’s index spatial autocorrelation, Moran’s . computation Moran’s requires first definition constitutes objects “near” . simply, represented spatial weights matrix. One possible representation adjacency matrix. matrix can computed polygonal data resulting matrix can binary, entries 1 polygons share border, 0 elsewhere (including diagonal). entries can weighted different ways, including length border shared two polygons. schema necessarily lend well spatial transcriptomic technologies, polygonal boundaries cell objects may correspond measurements count matrix, individual spots barcodes may correspond multiple neighborhoods cells. Certainly, interpretation spatial weights matrix change depending technology. case, can generate putative spatial graph using k-nearest neighbors algorithm. implemented findSpatialNeighbors() function argument method = \"knearneigh\" . store result colGraphs() slot SFE object. Now compute Moran's barcode QC metrics using colDataMoransI(). results substantiate visual check spatial autocorrelation. continue investigating QC metrics. proportion UMIs mapping mitochondrial genes useful metric assessing cell quality scRNA-seq data. examine QC metric plotting versus total number UMI counts barcode.  keeping expectations, barcodes associated fewer counts appear associated higher proportions mitochondrial reads. exclude barcodes containing >10% mitochondrial reads subsequent analysis. second line removes barcodes zero counts, necessary dataset barcodes zero counts. keep just demonstrate method.","code":"names(colData(sfe)) #> [1] \"sample_id\" \"nCounts\"   \"nGenes\"    \"prop_mito\" avg <- as.data.frame(colData(sfe)) |>   dplyr::summarise(across(-sample_id, mean))  violin <- plotColData(sfe, \"nCounts\") +   geom_hline(aes(yintercept = nCounts), avg, color=\"red\") +   theme(legend.position = \"top\")   spatial <- plotSpatialFeature(sfe, features = \"nCounts\",                                colGeometryName = \"centroids\", size = 0.2) +     theme_void() violin + spatial as.data.frame(cbind(spatialCoords(sfe), colData(sfe))) |>      ggplot(aes(xcoord, ycoord, z=nCounts)) +     stat_summary_2d(fun = function(x) sum(x), bins=100) +      scale_fill_distiller(palette = \"Blues\", direction = 1) +     labs(fill='nCounts')  +     theme_bw() + coord_equal() +     scale_x_continuous(expand = expansion()) +     scale_y_continuous(expand = expansion()) +     theme_void() colData(sfe)$log_nCounts <- log(colData(sfe)$nCounts)  avg <- as.data.frame(colData(sfe)) |>   dplyr::summarise(across(-sample_id, mean))  violin <- plotColData(sfe, \"log_nCounts\") +   geom_hline(aes(yintercept = log_nCounts), avg, color=\"red\") +   theme(legend.position = \"top\")   spatial <- plotSpatialFeature(sfe, features = \"log_nCounts\",                                colGeometryName = \"centroids\",                               size = 0.2) +     theme_void() violin + spatial violin <- plotColData(sfe, \"nGenes\") +    geom_hline(aes(yintercept = nGenes), avg, color=\"red\") +   theme(legend.position = \"top\")   spatial <- plotSpatialFeature(sfe, features = \"nGenes\",                               colGeometryName = \"centroids\",                               size = 0.2) +     theme_void() violin + spatial colGraph(sfe, \"knn5\") <- findSpatialNeighbors(sfe, method = \"knearneigh\",                                               dist_type = \"idw\", k = 5,                                                style = \"W\") features_use <- c(\"nCounts\", \"nGenes\") sfe <- colDataMoransI(sfe, features_use, colGraphName = \"knn5\") colFeatureData(sfe)[features_use,] #> DataFrame with 2 rows and 2 columns #>         moran_sample01 K_sample01 #>              <numeric>  <numeric> #> nCounts      0.0965909    48.6328 #> nGenes       0.0957030    11.2037 violin <- plotColData(sfe, \"prop_mito\") +     geom_hline(aes(yintercept = prop_mito), avg, color=\"red\") +     theme(legend.position = \"top\")   mito <- plotColData(sfe, x = \"nCounts\", y = \"prop_mito\")  violin + mito # Spatial neighborhood graph is reconstructed when subsetting columns # Use drop = TRUE to drop the graph without reconstruction, whose indices are  # no longer valid sfe_filt <- sfe[, colData(sfe)$prop_mito < 0.1] sfe_filt <- sfe_filt[rowSums(counts(sfe_filt)) > 0,]"},{"path":"https://pachterlab.github.io/voyager/articles/vig3_slideseq_v2.html","id":"data-normalization","dir":"Articles","previous_headings":"","what":"Data Normalization","title":"Slide-Seq V2 Exploratory Data Analysis","text":"Normalization spatial transcriptomics data non-trivial requires thoughtful consideration. Similarly scRNA-seq data analysis, goal normalization remove effects technical variation derive quantity reflects biological variation. However, several questions arise considering best practices spatial data normalization. example, spatial methods average detect fewer UMIs single-cell counterparts, may preclude use normalization techniques log transformation shown . ’s , always evident whether spatial autocorrelation genes (QC measures) artifact technology, thus, whether normalization methods preserve spatial autocorrelation architecture. questions provide avenues active research development, currently unresolved. end, log-normalize data cell identify variable genes subsequent analysis.","code":"sfe_filt <- logNormCounts(sfe_filt)  dec <- modelGeneVar(sfe_filt) hvgs <- getTopHVGs(dec, n = 2000)"},{"path":"https://pachterlab.github.io/voyager/articles/vig3_slideseq_v2.html","id":"dimension-reduction-and-clustering","dir":"Articles","previous_headings":"","what":"Dimension Reduction and Clustering","title":"Slide-Seq V2 Exploratory Data Analysis","text":"Much like scRNA-seq analysis, perform principal component analysis (PCA) clustering. note method use spatial information. can plot variance explained PC.  see first components explain variance data. principal components (PCs) can plotted space. notice PCs may show spatial structure correlates biological niches cells.  Without cellular overlays, can speculate potential relevance barcodes seem separated PC, PC doe seem separate distinct neighborhoods barcodes. Now can cluster barcodes using graph-based clustering algorithm plot space. plot colored cluster id. naive interpretation plot shows distinct niches barcodes separated abundant, intervening types. may indicative biological processes hand, namely melanoma metastasis, ‘hotspots’ melanoma proliferation separated unaffected normal tissue.","code":"set.seed(29) sfe_filt <- runPCA(sfe_filt, ncomponents = 30, subset_row = hvgs,                    scale = TRUE, BSPARAM = BiocSingular::IrlbaParam())  # scale as in Seurat ElbowPlot(sfe_filt, ndims = 30) + theme_bw() spatialReducedDim(sfe_filt, \"PCA\", ncomponents = 4,                    colGeometryName = \"centroids\", divergent = TRUE,                    diverge_center = 0, scattermore = TRUE, pointsize = 0.5) &     theme_void() colData(sfe_filt)$cluster <- clusterRows(reducedDim(sfe_filt, \"PCA\")[,1:3],                                            BLUSPARAM = SNNGraphParam(                                                cluster.fun = \"leiden\",                                                cluster.args = list(                                                    resolution_parameter = 0.5,                                                    objective_function = \"modularity\"))) plotSpatialFeature(sfe_filt, \"cluster\", colGeometryName = \"centroids\") +   guides(colour = guide_legend(override.aes = list(size=3))) +     theme_void()"},{"path":"https://pachterlab.github.io/voyager/articles/vig3_slideseq_v2.html","id":"morans-i","dir":"Articles","previous_headings":"Dimension Reduction and Clustering","what":"Moran’s I","title":"Slide-Seq V2 Exploratory Data Analysis","text":"One avenue future analysis includes identifying genes differentially expressed cluster, can interrogated findMarkers() non-spatial context calculateMoransI() spatial context. spatial case, consideration given whether differences seen across tissue represent biological difference artifacts field view. run global Moran’s log normalized gene expression. Now, might ask: genes display spatial autocorrelation?  Spatial variability can also investigated using differential expression testing known anatomical regions complemented spatial location. One potential drawback approach variability induced melanoma, rather native tissue architecture, may preclude identification typical structures. analyses can done stage: gene expression patterns, , differentiate neighborhoods melanoma cells? genes differentially expressed cluster?","code":"sfe_filt <- runMoransI(sfe_filt, features = hvgs,                         BPPARAM = MulticoreParam(2)) top_moran <- rownames(sfe_filt)[order(rowData(sfe_filt)$moran_sample01,                                        decreasing = TRUE)[1:4]] plotSpatialFeature(sfe_filt, top_moran, colGeometryName = \"centroids\",                    scattermore = TRUE, pointsize = 0.5) &     theme_void()"},{"path":"https://pachterlab.github.io/voyager/articles/vig3_slideseq_v2.html","id":"session-info","dir":"Articles","previous_headings":"","what":"Session Info","title":"Slide-Seq V2 Exploratory Data Analysis","text":"","code":"sessionInfo() #> R version 4.2.2 (2022-10-31) #> Platform: x86_64-apple-darwin17.0 (64-bit) #> Running under: macOS Big Sur ... 10.16 #>  #> Matrix products: default #> BLAS:   /Library/Frameworks/R.framework/Versions/4.2/Resources/lib/libRblas.0.dylib #> LAPACK: /Library/Frameworks/R.framework/Versions/4.2/Resources/lib/libRlapack.dylib #>  #> locale: #> [1] en_US.UTF-8/en_US.UTF-8/en_US.UTF-8/C/en_US.UTF-8/en_US.UTF-8 #>  #> attached base packages: #> [1] stats4    stats     graphics  grDevices utils     datasets  methods   #> [8] base      #>  #> other attached packages: #>  [1] SpatialFeatureExperiment_1.0.3 BiocParallel_1.32.5            #>  [3] spdep_1.2-7                    sf_1.0-9                       #>  [5] spData_2.2.1                   sp_1.6-0                       #>  [7] patchwork_1.1.2                bluster_1.8.0                  #>  [9] scran_1.26.2                   scater_1.27.3                  #> [11] ggplot2_3.4.0                  scuttle_1.8.4                  #> [13] SpatialExperiment_1.8.0        SingleCellExperiment_1.20.0    #> [15] SummarizedExperiment_1.28.0    Biobase_2.58.0                 #> [17] GenomicRanges_1.50.2           GenomeInfoDb_1.34.7            #> [19] IRanges_2.32.0                 S4Vectors_0.36.1               #> [21] BiocGenerics_0.44.0            MatrixGenerics_1.10.0          #> [23] matrixStats_0.63.0             SFEData_1.0.2                  #> [25] Voyager_1.0.8                  #>  #> loaded via a namespace (and not attached): #>   [1] AnnotationHub_3.6.0           BiocFileCache_2.6.0           #>   [3] systemfonts_1.0.4             igraph_1.3.5                  #>   [5] scattermore_0.8               digest_0.6.31                 #>   [7] htmltools_0.5.4               viridis_0.6.2                 #>   [9] magick_2.7.3                  fansi_1.0.4                   #>  [11] magrittr_2.0.3                memoise_2.0.1                 #>  [13] ScaledMatrix_1.6.0            cluster_2.1.4                 #>  [15] limma_3.54.1                  Biostrings_2.66.0             #>  [17] R.utils_2.12.2                pkgdown_2.0.7                 #>  [19] colorspace_2.1-0              ggrepel_0.9.2                 #>  [21] blob_1.2.3                    rappdirs_0.3.3                #>  [23] textshaping_0.3.6             xfun_0.36                     #>  [25] dplyr_1.0.10                  crayon_1.5.2                  #>  [27] RCurl_1.98-1.10               jsonlite_1.8.4                #>  [29] glue_1.6.2                    gtable_0.3.1                  #>  [31] zlibbioc_1.44.0               XVector_0.38.0                #>  [33] DelayedArray_0.24.0           scico_1.3.1                   #>  [35] BiocSingular_1.14.0           DropletUtils_1.18.1           #>  [37] Rhdf5lib_1.20.0               HDF5Array_1.26.0              #>  [39] scales_1.2.1                  DBI_1.1.3                     #>  [41] edgeR_3.40.2                  Rcpp_1.0.10                   #>  [43] viridisLite_0.4.1             xtable_1.8-4                  #>  [45] units_0.8-1                   dqrng_0.3.0                   #>  [47] rsvd_1.0.5                    bit_4.0.5                     #>  [49] proxy_0.4-27                  metapod_1.6.0                 #>  [51] httr_1.4.4                    RColorBrewer_1.1-3            #>  [53] wk_0.7.1                      ellipsis_0.3.2                #>  [55] farver_2.1.1                  pkgconfig_2.0.3               #>  [57] R.methodsS3_1.8.2             sass_0.4.5                    #>  [59] dbplyr_2.3.0                  deldir_1.0-6                  #>  [61] locfit_1.5-9.7                utf8_1.2.2                    #>  [63] labeling_0.4.2                tidyselect_1.2.0              #>  [65] rlang_1.0.6                   later_1.3.0                   #>  [67] AnnotationDbi_1.60.0          munsell_0.5.0                 #>  [69] BiocVersion_3.16.0            tools_4.2.2                   #>  [71] cachem_1.0.6                  cli_3.6.0                     #>  [73] dbscan_1.1-11                 ExperimentHub_2.6.0           #>  [75] generics_0.1.3                RSQLite_2.2.20                #>  [77] evaluate_0.20                 stringr_1.5.0                 #>  [79] fastmap_1.1.0                 yaml_2.3.7                    #>  [81] ragg_1.2.5                    knitr_1.42                    #>  [83] bit64_4.0.5                   fs_1.6.0                      #>  [85] purrr_1.0.1                   s2_1.1.2                      #>  [87] KEGGREST_1.38.0               sparseMatrixStats_1.10.0      #>  [89] mime_0.12                     R.oo_1.25.0                   #>  [91] compiler_4.2.2                beeswarm_0.4.0                #>  [93] png_0.1-8                     filelock_1.0.2                #>  [95] curl_5.0.0                    interactiveDisplayBase_1.36.0 #>  [97] e1071_1.7-12                  statmod_1.5.0                 #>  [99] tibble_3.1.8                  bslib_0.4.2                   #> [101] stringi_1.7.12                highr_0.10                    #> [103] desc_1.4.2                    lattice_0.20-45               #> [105] Matrix_1.5-3                  classInt_0.4-8                #> [107] vctrs_0.5.2                   pillar_1.8.1                  #> [109] lifecycle_1.0.3               rhdf5filters_1.10.0           #> [111] BiocManager_1.30.19           jquerylib_0.1.4               #> [113] BiocNeighbors_1.16.0          cowplot_1.1.1                 #> [115] irlba_2.3.5.1                 bitops_1.0-7                  #> [117] httpuv_1.6.8                  R6_2.5.1                      #> [119] promises_1.2.0.1              gridExtra_2.3                 #> [121] KernSmooth_2.23-20            vipor_0.4.5                   #> [123] codetools_0.2-18              boot_1.3-28.1                 #> [125] assertthat_0.2.1              rhdf5_2.42.0                  #> [127] rprojroot_2.0.3               rjson_0.2.21                  #> [129] withr_2.5.0                   GenomeInfoDbData_1.2.9        #> [131] parallel_4.2.2                grid_4.2.2                    #> [133] beachmat_2.14.0               class_7.3-21                  #> [135] rmarkdown_2.20                DelayedMatrixStats_1.20.0     #> [137] ggnewscale_0.4.8              shiny_1.7.4                   #> [139] ggbeeswarm_0.7.1"},{"path":[]},{"path":"https://pachterlab.github.io/voyager/articles/vig4_cosmx.html","id":"introduction","dir":"Articles","previous_headings":"","what":"Introduction","title":"CosMX non-small cell lung cancer data","text":"Nanostring GeoMX DSP popular spatial transcriptomics technology formalin fixed paraffin embedded (FFPE) tissues, doesn’t single cell resolution. CosMX FISH based technology FFPE tissue (et al. 2021) single cell resolution, vignette provides example analyze CosMX data voyager. Note FFPE common way preserve archive tissue, cases, samples available may FFPE. CosMX dataset non-small cell lung cancer used described (et al. 2021). processed data available download Nanostring website. gene count matrix, cell metadata, cell segmentation polygon coordinates downloaded Nanostring website CSV files read R data frames. gene count matrix converted sparse matrix. cell metadata contains centroid coordinates cells. cell polygon data frames converted sf data frame df2sf() function SpatialFeatureExperiment (SFE). used construct SFE object. Cell segmentation available one z-plane. first biological replicate included SFEData package. biological replicate 980 features 100,290 cells. Take look cells space:  single cell resolution, lot details can seen, although ’s artifact borders fields view (FOVs). Plot cell density","code":"library(Voyager) library(SFEData) library(SingleCellExperiment) #> Loading required package: SummarizedExperiment #> Loading required package: MatrixGenerics #> Loading required package: matrixStats #>  #> Attaching package: 'MatrixGenerics' #> The following objects are masked from 'package:matrixStats': #>  #>     colAlls, colAnyNAs, colAnys, colAvgsPerRowSet, colCollapse, #>     colCounts, colCummaxs, colCummins, colCumprods, colCumsums, #>     colDiffs, colIQRDiffs, colIQRs, colLogSumExps, colMadDiffs, #>     colMads, colMaxs, colMeans2, colMedians, colMins, colOrderStats, #>     colProds, colQuantiles, colRanges, colRanks, colSdDiffs, colSds, #>     colSums2, colTabulates, colVarDiffs, colVars, colWeightedMads, #>     colWeightedMeans, colWeightedMedians, colWeightedSds, #>     colWeightedVars, rowAlls, rowAnyNAs, rowAnys, rowAvgsPerColSet, #>     rowCollapse, rowCounts, rowCummaxs, rowCummins, rowCumprods, #>     rowCumsums, rowDiffs, rowIQRDiffs, rowIQRs, rowLogSumExps, #>     rowMadDiffs, rowMads, rowMaxs, rowMeans2, rowMedians, rowMins, #>     rowOrderStats, rowProds, rowQuantiles, rowRanges, rowRanks, #>     rowSdDiffs, rowSds, rowSums2, rowTabulates, rowVarDiffs, rowVars, #>     rowWeightedMads, rowWeightedMeans, rowWeightedMedians, #>     rowWeightedSds, rowWeightedVars #> Loading required package: GenomicRanges #> Loading required package: stats4 #> Loading required package: BiocGenerics #>  #> Attaching package: 'BiocGenerics' #> The following objects are masked from 'package:stats': #>  #>     IQR, mad, sd, var, xtabs #> The following objects are masked from 'package:base': #>  #>     anyDuplicated, aperm, append, as.data.frame, basename, cbind, #>     colnames, dirname, do.call, duplicated, eval, evalq, Filter, Find, #>     get, grep, grepl, intersect, is.unsorted, lapply, Map, mapply, #>     match, mget, order, paste, pmax, pmax.int, pmin, pmin.int, #>     Position, rank, rbind, Reduce, rownames, sapply, setdiff, sort, #>     table, tapply, union, unique, unsplit, which.max, which.min #> Loading required package: S4Vectors #>  #> Attaching package: 'S4Vectors' #> The following objects are masked from 'package:base': #>  #>     expand.grid, I, unname #> Loading required package: IRanges #> Loading required package: GenomeInfoDb #> Loading required package: Biobase #> Welcome to Bioconductor #>  #>     Vignettes contain introductory material; view with #>     'browseVignettes()'. To cite Bioconductor, see #>     'citation(\"Biobase\")', and for packages 'citation(\"pkgname\")'. #>  #> Attaching package: 'Biobase' #> The following object is masked from 'package:MatrixGenerics': #>  #>     rowMedians #> The following objects are masked from 'package:matrixStats': #>  #>     anyMissing, rowMedians library(SpatialExperiment) library(scater) # devel version of plotExpression #> Loading required package: scuttle #> Loading required package: ggplot2 library(scran) library(bluster) library(ggplot2) library(patchwork) library(stringr) library(spdep) #> Loading required package: sp #>  #> Attaching package: 'sp' #> The following object is masked from 'package:IRanges': #>  #>     %over% #> Loading required package: spData #> To access larger datasets in this package, install the spDataLarge #> package with: `install.packages('spDataLarge', #> repos='https://nowosad.github.io/drat/', type='source')` #> Loading required package: sf #> Linking to GEOS 3.10.2, GDAL 3.4.2, PROJ 8.2.1; sf_use_s2() is TRUE library(BiocParallel) library(BiocSingular) theme_set(theme_void()) (sfe <- HeNSCLCData()) #> snapshotDate(): 2022-10-31 #> see ?SFEData and browseVignettes('SFEData') for documentation #> loading from cache #> require(\"SpatialFeatureExperiment\") #> class: SpatialFeatureExperiment  #> dim: 980 100290  #> metadata(0): #> assays(1): counts #> rownames(980): AATK ABL1 ... NegPrb22 NegPrb23 #> rowData names(3): means vars cv2 #> colnames(100290): 1_1 1_2 ... 30_4759 30_4760 #> colData names(17): Area AspectRatio ... nCounts nGenes #> reducedDimNames(0): #> mainExpName: NULL #> altExpNames(0): #> spatialCoords names(2) : CenterX_global_px CenterY_global_px #> imgData names(1): sample_id #>  #> Geometries: #> colGeometries: centroids (POINT), cellSeg (POLYGON)  #>  #> Graphs: #> sample01: ggplot(cellSeg(sfe)) + geom_sf() +     theme_bw() +     scale_x_continuous(expand = expansion()) +     scale_y_continuous(expand = expansion()) plotCellBin2D(sfe) + theme_bw()"},{"path":[]},{"path":"https://pachterlab.github.io/voyager/articles/vig4_cosmx.html","id":"cells","dir":"Articles","previous_headings":"Quality control (QC)","what":"Cells","title":"CosMX non-small cell lung cancer data","text":"Single cell RNA-seq (scRNA-seq) technologies typically don’t quantify cell morphology, gene expression Visium doesn’t single cell resolution. single cell resolution smFISH based data, cell gene expression related QC metrics total number transcripts detected number genes detected, also cell morphology area (z-plane segmentation polygons provided) aspect ratio. Area relevant QC since can flag falsely undersegmented cells, .e. several cells falsely considered one cell segmentation program. However, since pre-defined gene panel used mitochondrially encoded genes quantified, scRNA-seq QC metric proportion mitochondrially encoded counts applicable. QC metrics precomputed stored colData Cell area, aspect ratio, marker stain intensities, .e. columns “sample_id” come Nanostring’s website. sf package can compute areas cell polygons. R, EBImage package can compute morphological metrics aspect ratio, eccentricity, orientation, etc., requires data converted raster. OpenCV can compute morphological metrics polygons without converting raster, needs called Python C++. Since math behind many basic morphological metrics pretty simple, may add Voyager future version. Since plotting 100,000 polygons slow plot isn’t large enough us see polygons anyway, use scattermore rasterize plot speed plotting. Instead plotting every single point, now ggplot merely displays rasterized image. Number transcript spots detected per cell  make nCounts nGenes comparable across datasets, divide number genes probed. dataset, 960 genes, 20 negative controls. However, different genes may probed different datasets, can different tissues, make nCounts nGenes completely comparable across datasets. However, may still somewhat comparable, since genes highly expressed major cell types tissue tend selected gene panel.  means cells mostly less 1 transcript count per gene average, surprising since cells express genes. cells detected express less 30% genes probed. Number genes (980) detected per cell  Based spatial plot, seems nCounts nGenes biologically relevant, cells transcripts detected. nCounts relates nGenes  ’s nature cells without transcripts?  cells without transcripts central cavity.  “empty” cells tend smaller cells also really large ones. Cell area distribution  Larger cells likely found certain areas tissue. biological, -segmentation likely cell type tissue region. area relate total counts?  may vaguely seem cells total counts tend larger (least z-plane), cells large low total counts. Negative control probes used dataset QC. calculate proportion transcripts attributed negative controls.  NA’s empty cells, proportion low except outliers. prop_neg relate nCounts?  looks kind like proportion mitochondrial counts vs. nCounts plot scRNA-seq, cells fewer total counts tend higher proportion mitochondrial counts.  distribution obviously bimodal, since x-axis log transformed better visualize distribution, 0’s removed. ’s kind arbitrary; now ’ll remove cells 10% transcripts negative controls. removing low quality cells, 100,095 cells left.","code":"names(colData(sfe)) #>  [1] \"Area\"               \"AspectRatio\"        \"Width\"              #>  [4] \"Height\"             \"Mean.MembraneStain\" \"Max.MembraneStain\"  #>  [7] \"Mean.PanCK\"         \"Max.PanCK\"          \"Mean.CD45\"          #> [10] \"Max.CD45\"           \"Mean.CD3\"           \"Max.CD3\"            #> [13] \"Mean.DAPI\"          \"Max.DAPI\"           \"sample_id\"          #> [16] \"nCounts\"            \"nGenes\" # Function to plot violin plot for distribution and spatial at once plot_violin_spatial <- function(sfe, feature) {     violin <- plotColData(sfe, feature, point_fun = function(...) list())     spatial <- plotSpatialFeature(sfe, feature, colGeometryName = \"centroids\",                                   scattermore = TRUE)     violin + spatial +         plot_layout(widths = c(1, 2)) } plot_violin_spatial(sfe, \"nCounts\") summary(sfe$nCounts) #>    Min. 1st Qu.  Median    Mean 3rd Qu.    Max.  #>     0.0   135.0   248.0   302.8   409.0  2475.0 n_panel <- 960 colData(sfe)$nCounts_normed <- sfe$nCounts/n_panel colData(sfe)$nGenes_normed <- sfe$nGenes/n_panel plotColDataHistogram(sfe, c(\"nCounts_normed\", \"nGenes_normed\")) +     theme_bw() plot_violin_spatial(sfe, \"nGenes\") summary(sfe$nGenes) #>    Min. 1st Qu.  Median    Mean 3rd Qu.    Max.  #>     0.0    75.0   119.0   127.1   171.0   500.0 plotColDataBin2D(sfe, \"nCounts\", \"nGenes\") +     theme_bw() colData(sfe)$is_empty <- colData(sfe)$nCounts < 1 plotSpatialFeature(sfe, \"is_empty\", \"cellSeg\") plotColData(sfe, x = \"Area\", y = \"is_empty\") plot_violin_spatial(sfe, \"Area\") plotColDataBin2D(sfe, \"nCounts\", \"Area\") + theme_bw() neg_inds <- str_detect(rownames(sfe), \"^NegPrb\") # Number of negative control probes sum(neg_inds) #> [1] 20 colData(sfe)$prop_neg <- colSums(counts(sfe)[neg_inds,])/colData(sfe)$nCounts plot_violin_spatial(sfe, \"prop_neg\") #> Warning: Removed 142 rows containing non-finite values #> (`stat_ydensity()`). plotColDataBin2D(sfe, \"nCounts\", \"prop_neg\") +     scale_fill_viridis_c() + theme_bw() #> Scale for fill is already present. #> Adding another scale for fill, which will replace the existing scale. #> Warning: Removed 142 rows containing non-finite values (`stat_bin2d()`). # The zeros are removed plotColDataHistogram(sfe, \"prop_neg\") +     scale_x_log10() +     theme_bw() #> Warning: Transformation introduced infinite values in continuous x-axis #> Warning: Removed 59213 rows containing non-finite values (`stat_bin()`). # Remove low quality cells (sfe <- sfe[,!sfe$is_empty & sfe$prop_neg < 0.1]) #> class: SpatialFeatureExperiment  #> dim: 980 100095  #> metadata(0): #> assays(1): counts #> rownames(980): AATK ABL1 ... NegPrb22 NegPrb23 #> rowData names(3): means vars cv2 #> colnames(100095): 1_1 1_2 ... 30_4759 30_4760 #> colData names(21): Area AspectRatio ... is_empty prop_neg #> reducedDimNames(0): #> mainExpName: NULL #> altExpNames(0): #> spatialCoords names(2) : CenterX_global_px CenterY_global_px #> imgData names(1): sample_id #>  #> Geometries: #> colGeometries: centroids (POINT), cellSeg (POLYGON)  #>  #> Graphs: #> sample01:"},{"path":"https://pachterlab.github.io/voyager/articles/vig4_cosmx.html","id":"markers","dir":"Articles","previous_headings":"Quality control (QC) > Cells","what":"Markers","title":"CosMX non-small cell lung cancer data","text":"Nanostring provides cell stain marker intensities cell metadata. plot aspect ratio mean intensity cells stains markers, plotted . PanCK marker epithelial cells. CD45 leukocyte marker. CD3 T cell marker. Since takes quite plot 100,000 cells 6 times, scattermore really helps.","code":"names(colData(sfe)) #>  [1] \"Area\"               \"AspectRatio\"        \"Width\"              #>  [4] \"Height\"             \"Mean.MembraneStain\" \"Max.MembraneStain\"  #>  [7] \"Mean.PanCK\"         \"Max.PanCK\"          \"Mean.CD45\"          #> [10] \"Max.CD45\"           \"Mean.CD3\"           \"Max.CD3\"            #> [13] \"Mean.DAPI\"          \"Max.DAPI\"           \"sample_id\"          #> [16] \"nCounts\"            \"nGenes\"             \"nCounts_normed\"     #> [19] \"nGenes_normed\"      \"is_empty\"           \"prop_neg\" plotSpatialFeature(sfe, c(\"AspectRatio\", \"Mean.DAPI\", \"Mean.MembraneStain\",                            \"Mean.PanCK\", \"Mean.CD45\", \"Mean.CD3\"),                    colGeometryName = \"centroids\", ncol = 2, scattermore = TRUE)"},{"path":"https://pachterlab.github.io/voyager/articles/vig4_cosmx.html","id":"genes","dir":"Articles","previous_headings":"Quality control (QC)","what":"Genes","title":"CosMX non-small cell lung cancer data","text":"red line \\(y = x\\) expected Poisson data. Gene expression dataset variance expected Poisson, even gene lower expression. Zoom negative controls  Among “high quality” cells, negative controls still higher variance relative mean compared Poisson. Negative controls vs. real genes  negative controls lower mean “expression” vast majority real genes.","code":"rowData(sfe)$means <- rowMeans(counts(sfe)) rowData(sfe)$vars <- rowVars(counts(sfe)) rowData(sfe)$is_neg <- neg_inds plotRowDataBin2D(sfe, \"means\", \"vars\", subset = \"is_neg\", bins = 50) +     geom_abline(slope = 1, intercept = 0, color = \"red\") +     scale_x_log10() + scale_y_log10() +     annotation_logticks() +     coord_equal() +     theme_bw() as.data.frame(rowData(sfe)[neg_inds,]) |>      ggplot(aes(means, vars)) +     geom_point() +     geom_abline(slope = 1, intercept = 0, color = \"red\") +     scale_x_log10() + scale_y_log10() +     annotation_logticks() +     coord_equal() +     theme_bw() plotRowData(sfe, x = \"means\", y = \"is_neg\") +     scale_y_log10() +     annotation_logticks(sides = \"b\")"},{"path":"https://pachterlab.github.io/voyager/articles/vig4_cosmx.html","id":"spatial-autocorrelation-in-qc-metrics","dir":"Articles","previous_headings":"","what":"Spatial autocorrelation in QC metrics","title":"CosMX non-small cell lung cancer data","text":"spatial neighborhood graph required spatial dependence analyses spdep. Without benchmark, don’t yet know type neighborhood graph best purpose. Methods find spatial neighborhood graphs spdep knearneigh() (k nearest neighbors), dnearneigh() (find cells within certain distance), poly2nb() (polygon contiguity) recommended larger datasets. cell-cell contact may biologically relevant, cell segmentation imperfect, leading non-contiguous cell segmentation polygons cells appear contiguous H&E, using poly2nb() find polygon contiguity neighbors without supplementing another kind neighborhood problematic. Delaunay triangulation deldir package, used spdep (tri2nb()), takes 4 5 minutes dataset size, run time increases much drastically linearly number cells increases. Sphere Interest (SOI) graph (soi.graph()) prunes edges triangulation long, take long . triangulation SOI graph, slower knearneigh(), dnearneigh(), poly2nb(), somewhat practical considerations. implementation gabrielneigh() relativeneigh() take impracticably long (hour terminated R session impatience) dataset recommended. Methods find approximate nearest neighbors Annoy (AnnoyParam()) HNSW (HnswParam()), supported bluster BiocNeighbors packages might speed finding graphs, haven’t formally benchmarked . See Chapter 14 Spatial Data Science proximity areal data detailed discussion different neighborhood graphs spdep. methods areal data first wrapped Voyager much spatial transcriptomics data analogous areal geospatial data, data several cells aggregated areas, happens Visium spots. Just like geospatial areal data, Visium aggregation areas arbitrary represent underlying spatial process. Although sometimes geographical areal units arbitrary, tissues generally hexagonal grids means Visium spot polygons arbitrary context. Regions interest (ROI) selection spatial transcriptomics methods, laser capture microdissection (LCM) GeoMX DSP obviously analogous geospatial areal data. aggregation also happens analyze smFISH-based data cell level, basic unit observation individual transcript spots. spdep caters areal data, gstat caters geostatistical data, continuous spatial process sampled point locations. ways, spatial transcriptomics data analogous geostatistical data. Visium samples supposed spatial biological process regular hexagonal grid, pretend Visium spots points. smFISH-based single cell resolution data, cells observed can thought sample underlying spatial biological process supervening specific locations cells. sense, cells samples, since smFISH based technologies attempt visualize cells tissue section. However, biological function tissue depend particular spatial arrangement individual cells (.e. supervenes particular spatial arrangement), cell types, specific cell locations observed can thought samples process, consider cell basic unit spatial process. next release Voyager, plan add semivariograms (gstat package) exploratory tool identify presence spatial autocorrelation, length scale, anisotropy (.e. different different directions). Covariates can specified computing variogram account spatial trends adjust another spatial variable. However, unlike Morans’s , semivariogram can’t identify negative spatial autocorrelation, although since spatial neighborhood graph typically encode spatial directions, spdep autocorrelation metrics can’t identify anisotropy. Another problem semivariogram assumes data intrinsically stationary, .e. semivariogram holds entire dataset, similarity two cells depends distance , may case spatial autocorrelation varies space evident genes local spatial analyses. Single cell smFISH based data also dissimiliar areal geostatistical data important ways. geospatial areal data, data numerous basic units spatial process (e.g. people epidemiology) aggregated areas (e.g. cities), whereas histological space, cell arguably sensible basic unit biological spatial process individual mRNA molecules. Unlike geostatistical data, cells seen tissue section often polygons tessellating tissue section rather points. Furthermore, ideally samples underlying spatial process affect spatial process geostatistical data, cells play active roles biological spatial process. However, data analysis methods areal geostatistical data can still relevant EDA descriptive models (causal mechanistic) single cell smFISH data. Different types spatial neighborhood graphs cells may relevant different processes. instance, contiguity cell segmentation polygons relevant contact involved cell signaling, although cell segmentation imperfect. Positive spatial autocorrelation can arise contact activation, negative autocorrelation can arise contact inhibition. However, cells may also influenced longer range factors secreted ligands, morphogens, simpler spatial trends like distance artery vein. case, perhaps semivariogram using Euclidean distance cells spatial weights spatial autocorrelation metrics relevant EDA. interesting compare results different spatial neighborhood graphs spatial weights, spdep gstat. Perhaps one best method, different methods reveal different phenomena. problem choosing spatial neighborhood matrix long history far predating spatial transcriptomics. See (Getis 2009) brief discussion decades work around issue. Spatial autocorrelation metrics seek measure nearby things tend similar dissimilar, neighborhood graph edge weights define mean “nearby” areal data. Note Visium spot can contain several dozens cells, spatial neighborhood graphs Visium spots describe neighborhood relationships much longer length scales spatial neighborhood graphs single cells, spatial autocorrelation metrics using Visium graph different meanings cellular neighborhood graphs. now, just demonstrate software usage, use k nearest neighborhood graph distance based edge weights, commonly done graph based clustering scRNA-seq, although don’t yet know best value k scenario. purpose vignette, say use \\(k = 5\\), execution time isn’t outrageous. argument style = \"W\" row normalize adjacency matrix spatial neighborhood graph necessary Moran scatter plot. Inverse distance edge weights can take small values matter relative rather absolute values distance arbitrary unit; row normalizing adjacency matrix makes weighted average value neighbors comparable value cell . tissue, many cells appear contiguous, since cell segmentation imperfect, many false singletons, makes polygon contiguity neighbors poly2nb() problematic without modification. based distribution number neighbors based contiguity, \\(k = 5\\) doesn’t seem bad approximate contiguity. Now compute Moran’s cell QC metrics Positive spatial autocorrelation suggested, stronger nCounts nGenes. length scales spatial autocorrelation QC metrics? nice lagged neighborhood graphs can stored reused features rather recomputed feature spdep::sp.correlogram() called behind scene . takes minutes run, long typical song. Another way find length scale spatial autocorrelation bin cells bins different sizes find spatial autocorrelation bin size, probably faster finding lagged values higher higher neighborhoods since geom_bin2d() geom_hex() ggplot2 run pretty fast even large datasets. use semivariogram; gstat also bins data estimating semivariogram calculating semivariogram long distance much faster correlogram cell-cell neighborhood graphs. Note MulticoreParam() doesn’t work Windows; vignette built Linux. Use SnowParam() DoparParam() Windows. See ?BiocParallelParam available parallel processing backends. notice significant performance differences ShowParam() MulticoreParam() context.  seem similar length scales, aspect ratios tend decay quickly. Moran’s scatter plot nCounts. first panel, density points plot, second, points influential fitting line highlighted red, still 2D histogram avoid overplotting.  obvious clusters plot clusters may obscured overplotting. Local Moran’s nCounts  Cool, appears epithelial regions tend homogenous nCounts.","code":"system.time(     colGraph(sfe, \"knn5\") <- findSpatialNeighbors(sfe, method = \"knearneigh\",                                                   dist_type = \"idw\", k = 5,                                                    style = \"W\")     ) #>    user  system elapsed  #>  97.459   0.857  98.931 features_use <- c(\"nCounts\", \"nGenes\", \"Area\", \"AspectRatio\") sfe <- colDataMoransI(sfe, features_use, colGraphName = \"knn5\") colFeatureData(sfe)[features_use,] #> DataFrame with 4 rows and 2 columns #>             moran_sample01 K_sample01 #>                  <numeric>  <numeric> #> nCounts           0.386673    6.80818 #> nGenes            0.434660    3.19599 #> Area              0.198151    8.96966 #> AspectRatio       0.256203   43.05666 system.time(     sfe <- colDataUnivariate(sfe, \"sp.correlogram\", features = features_use,                          colGraphName = \"knn5\", order = 6, zero.policy = TRUE,                          BPPARAM = MulticoreParam(2)) ) #>    user  system elapsed  #> 317.937   9.880 337.312 plotCorrelogram(sfe, features_use) +     theme_bw() sfe <- colDataUnivariate(sfe, \"moran.plot\", \"nCounts\", colGraphName = \"knn5\") p1 <- moranPlot(sfe, \"nCounts\", binned = TRUE, plot_influential = FALSE) p2 <- moranPlot(sfe, \"nCounts\", binned = TRUE) p1 / p2 + plot_layout(guides = \"collect\") & theme_bw() sfe <- colDataUnivariate(sfe, \"localmoran\", \"nCounts\", colGraphName = \"knn5\") plotLocalResult(sfe, \"localmoran\", \"nCounts\", colGeometryName = \"cellSeg\",                 divergent = TRUE, diverge_center = 0)"},{"path":"https://pachterlab.github.io/voyager/articles/vig4_cosmx.html","id":"data-normalization","dir":"Articles","previous_headings":"","what":"Data normalization","title":"CosMX non-small cell lung cancer data","text":"Given may relationship cell size total counts, total counts may biological thus purely treated technical, questions raised data normalization different standard scRNA-seq practices. instance, technical contributions total counts kind data? Furthermore, cell area, since part technical, z-plane cell segmentation polygons intersects cell, cell types, biological? Also, different methods data normalization affect spatial autocorrelation? spatial autocorrelation used ways normalizing data? Besides correcting technical effects making gene expression cells different total counts comparable, data normalization stabilizes variance tries make data normally distributed since many statistical methods assume normally distributed data. don’t know best practice normalize kind data, still normalize data downstream analyses.","code":"sfe <- logNormCounts(sfe)"},{"path":"https://pachterlab.github.io/voyager/articles/vig4_cosmx.html","id":"morans-i","dir":"Articles","previous_headings":"","what":"Moran’s I","title":"CosMX non-small cell lung cancer data","text":"run global Moran’s log normalized gene expression. real genes tend spatial autocorrelation negative controls?  seems least shorter length scale captured k nearest neighbor graph, genes don’t strong spatial autocorrelation strong positive spatial autocorrelation. contrast, Moran’s negative controls closely packed around 0, indicating lack spatial autocorrelation, good sign, evidence technical artifact manifests spatial trend manifest negative controls. genes highest Moran’s ?  highlight epithelial regions. regions spatially organized, short length scale used Moran’s correlogram shows Moran’s decays first order neighbors. wonder using longer length scale change results.","code":"# Note: on your computer, you can put progressbar = TRUE inside MulticoreParam() # to show progress bar. This applies to any BiocParallParam. sfe <- runMoransI(sfe, features = rownames(sfe),                    BPPARAM = MulticoreParam(2)) plotRowData(sfe, x = \"moran_sample01\", y = \"is_neg\") +     geom_hline(yintercept = 0, linetype = 2) top_moran <- rownames(sfe)[order(rowData(sfe)$moran_sample01, decreasing = TRUE)[1:6]] plotSpatialFeature(sfe, top_moran, colGeometryName = \"centroids\",                     scattermore = TRUE, ncol = 2)"},{"path":"https://pachterlab.github.io/voyager/articles/vig4_cosmx.html","id":"non-spatial-dimension-reduction-and-clustering","dir":"Articles","previous_headings":"","what":"Non-spatial dimension reduction and clustering","title":"CosMX non-small cell lung cancer data","text":"first PC highlights epithelium. PC2 highlights T cells. PC4 might highlight leukocytes. Need check genes highest loadings find PCs mean. Non-spatial clustering locating clusters space    analyses can done stage: many cell types neighborhood cell? subject different definitions neighborhood. cell types tend co-localize ? Find spatial regions based cell type colocalization, can done R package spicyR (Canete et al. 2022)","code":"set.seed(29) sfe <- runPCA(sfe, ncomponents = 30, scale = TRUE, BSPARAM = IrlbaParam()) ElbowPlot(sfe, ndims = 30) + theme_bw() plotDimLoadings(sfe, dims = 1:6) + theme_bw() spatialReducedDim(sfe, \"PCA\", 6, colGeometryName = \"centroids\", divergent = TRUE,                   diverge_center = 0, ncol = 2, scattermore = TRUE) set.seed(29) sfe <- runUMAP(sfe, dimred = \"PCA\", n_dimred = 15) colData(sfe)$cluster <- clusterRows(reducedDim(sfe, \"PCA\")[,1:15],                                     BLUSPARAM = SNNGraphParam(                                         cluster.fun = \"leiden\",                                         cluster.args = list(                                             resolution_parameter = 0.5,                                             objective_function = \"modularity\"))) #> Warning in (function (to_check, X, clust_centers, clust_info, dtype, nn, : #> detected tied distances to neighbors, see ?'BiocNeighbors-ties' plotPCA(sfe, ncomponents = 4, colour_by = \"cluster\") plotUMAP(sfe, colour_by = \"cluster\") plotSpatialFeature(sfe, \"cluster\", colGeometryName = \"cellSeg\")"},{"path":"https://pachterlab.github.io/voyager/articles/vig4_cosmx.html","id":"differential-expression","dir":"Articles","previous_headings":"","what":"Differential expression","title":"CosMX non-small cell lung cancer data","text":"Cluster marker genes found Wilcoxon rank sum test commonly done scRNA-seq. ’s already sorted p-values Get significant marker cluster plot. Since ’re many points, used development version scater plot points, uninformative due overplotting make plot really slow.  Plot top marker genes heatmap","code":"markers <- findMarkers(sfe, groups = colData(sfe)$cluster,                        test.type = \"wilcox\", pval.type = \"all\", direction = \"up\") markers[[6]] #> DataFrame with 980 rows and 12 columns #>         p.value       FDR summary.AUC     AUC.1     AUC.2     AUC.3     AUC.4 #>       <numeric> <numeric>   <numeric> <numeric> <numeric> <numeric> <numeric> #> IGKC          0         0    0.886220  0.916675  0.902230  0.855811  0.919104 #> IGHG1         0         0    0.870429  0.895158  0.882323  0.836324  0.899743 #> IGHG2         0         0    0.853809  0.882468  0.868460  0.820343  0.883634 #> XBP1          0         0    0.819308  0.853902  0.828680  0.841712  0.834907 #> MZB1          0         0    0.773730  0.797467  0.792704  0.764919  0.794961 #> ...         ...       ...         ...       ...       ...       ...       ... #> VEGFA         1         1    0.243503  0.508913  0.456377  0.510560  0.467930 #> VIM           1         1    0.185879  0.609866  0.368711  0.427010  0.393079 #> VWF           1         1    0.230489  0.509358  0.505214  0.502174  0.502987 #> YBX3          1         1    0.315843  0.525782  0.446604  0.475401  0.451682 #> ZFP36         1         1    0.302163  0.546794  0.440116  0.476302  0.396124 #>           AUC.5     AUC.7     AUC.8     AUC.9    AUC.10 #>       <numeric> <numeric> <numeric> <numeric> <numeric> #> IGKC   0.919945  0.922712  0.901806  0.886220  0.937943 #> IGHG1  0.900523  0.900002  0.881820  0.870429  0.917872 #> IGHG2  0.885282  0.882786  0.866664  0.853809  0.897537 #> XBP1   0.837336  0.785166  0.830170  0.819308  0.789964 #> MZB1   0.792701  0.795958  0.782687  0.773730  0.801084 #> ...         ...       ...       ...       ...       ... #> VEGFA  0.489021  0.399374  0.511659  0.465990  0.243503 #> VIM    0.185879  0.527159  0.386313  0.342166  0.651976 #> VWF    0.230489  0.492060  0.500912  0.499264  0.499925 #> YBX3   0.335891  0.322215  0.493629  0.480576  0.315843 #> ZFP36  0.302163  0.420099  0.455934  0.380452  0.366587 genes_use <- vapply(markers, function(x) rownames(x)[1], FUN.VALUE = character(1)) plotExpression(sfe, genes_use, x = \"cluster\", point_fun = function(...) list()) genes_use2 <- unique(unlist(lapply(markers, function(x) rownames(x)[1:5]))) plotGroupedHeatmap(sfe, genes_use2, group = \"cluster\", colour = scales::viridis_pal()(100))"},{"path":"https://pachterlab.github.io/voyager/articles/vig4_cosmx.html","id":"local-spatial-statistics-of-marker-genes","dir":"Articles","previous_headings":"","what":"Local spatial statistics of marker genes","title":"CosMX non-small cell lung cancer data","text":"Plot genes space  Moran’s marker genes Local Moran’s marker genes  seems histological regions tend spatially homogenous gene expression others. epithelial region tends homogenous. Run local spatial heteroscdasticity (LOSH) marker genes find local heterogeneity  genes heterogeneous also highly expressed, COLA1 IGKC. However case genes. example, MZT2A quite ubiqiutously experssed, heterogeneous regions others, KRT19 seem much heterogeneous ’s highly expressed. MZT2A, LOSH picked artifact edges FOVs, although apparent genes plotted . don’t information cell belongs FOV, FOV edge effects considered data normalization. interesting systematically see LOSH relates gene expression across genes, differs cell types gene functions.","code":"plotSpatialFeature(sfe, genes_use, colGeometryName = \"centroids\", ncol = 2,                    scattermore = TRUE) rowData(sfe)[genes_use, \"moran_sample01\", drop = FALSE] #> DataFrame with 10 rows and 1 column #>          moran_sample01 #>               <numeric> #> MZT2A          0.199135 #> COL1A1         0.394786 #> IGHM           0.293234 #> HLA-DPA1       0.242445 #> COL4A1         0.213574 #> IGKC           0.425227 #> SERPINA1       0.254097 #> IL7R           0.177632 #> TPSB2          0.206110 #> KRT19          0.770423 sfe <- runUnivariate(sfe, \"localmoran\", features = genes_use, colGraphName = \"knn5\",                      BPPARAM = MulticoreParam(2)) plotLocalResult(sfe, type = \"localmoran\", features = genes_use,                  colGeometryName = \"centroids\", ncol = 2, divergent = TRUE,                 diverge_center = 0, scattermore = TRUE) sfe <- runUnivariate(sfe, \"LOSH\", features = genes_use, colGraphName = \"knn5\",                      BPPARAM = MulticoreParam(2)) plotLocalResult(sfe, type = \"LOSH\", features = genes_use,                  colGeometryName = \"centroids\", ncol = 2, scattermore = TRUE)"},{"path":"https://pachterlab.github.io/voyager/articles/vig4_cosmx.html","id":"session-info","dir":"Articles","previous_headings":"","what":"Session Info","title":"CosMX non-small cell lung cancer data","text":"","code":"sessionInfo() #> R version 4.2.2 (2022-10-31) #> Platform: x86_64-apple-darwin17.0 (64-bit) #> Running under: macOS Big Sur ... 10.16 #>  #> Matrix products: default #> BLAS:   /Library/Frameworks/R.framework/Versions/4.2/Resources/lib/libRblas.0.dylib #> LAPACK: /Library/Frameworks/R.framework/Versions/4.2/Resources/lib/libRlapack.dylib #>  #> locale: #> [1] en_US.UTF-8/en_US.UTF-8/en_US.UTF-8/C/en_US.UTF-8/en_US.UTF-8 #>  #> attached base packages: #> [1] stats4    stats     graphics  grDevices utils     datasets  methods   #> [8] base      #>  #> other attached packages: #>  [1] SpatialFeatureExperiment_1.0.3 BiocSingular_1.14.0            #>  [3] BiocParallel_1.32.5            spdep_1.2-7                    #>  [5] sf_1.0-9                       spData_2.2.1                   #>  [7] sp_1.6-0                       stringr_1.5.0                  #>  [9] patchwork_1.1.2                bluster_1.8.0                  #> [11] scran_1.26.2                   scater_1.27.3                  #> [13] ggplot2_3.4.0                  scuttle_1.8.4                  #> [15] SpatialExperiment_1.8.0        SingleCellExperiment_1.20.0    #> [17] SummarizedExperiment_1.28.0    Biobase_2.58.0                 #> [19] GenomicRanges_1.50.2           GenomeInfoDb_1.34.7            #> [21] IRanges_2.32.0                 S4Vectors_0.36.1               #> [23] BiocGenerics_0.44.0            MatrixGenerics_1.10.0          #> [25] matrixStats_0.63.0             SFEData_1.0.2                  #> [27] Voyager_1.0.8                  #>  #> loaded via a namespace (and not attached): #>   [1] utf8_1.2.2                    R.utils_2.12.2                #>   [3] tidyselect_1.2.0              RSQLite_2.2.20                #>   [5] AnnotationDbi_1.60.0          grid_4.2.2                    #>   [7] DropletUtils_1.18.1           munsell_0.5.0                 #>   [9] ScaledMatrix_1.6.0            codetools_0.2-18              #>  [11] ragg_1.2.5                    units_0.8-1                   #>  [13] statmod_1.5.0                 withr_2.5.0                   #>  [15] colorspace_2.1-0              filelock_1.0.2                #>  [17] highr_0.10                    knitr_1.42                    #>  [19] wk_0.7.1                      labeling_0.4.2                #>  [21] GenomeInfoDbData_1.2.9        pheatmap_1.0.12               #>  [23] bit64_4.0.5                   farver_2.1.1                  #>  [25] rhdf5_2.42.0                  rprojroot_2.0.3               #>  [27] vctrs_0.5.2                   generics_0.1.3                #>  [29] xfun_0.36                     BiocFileCache_2.6.0           #>  [31] R6_2.5.1                      ggbeeswarm_0.7.1              #>  [33] rsvd_1.0.5                    locfit_1.5-9.7                #>  [35] bitops_1.0-7                  rhdf5filters_1.10.0           #>  [37] cachem_1.0.6                  DelayedArray_0.24.0           #>  [39] assertthat_0.2.1              promises_1.2.0.1              #>  [41] scales_1.2.1                  beeswarm_0.4.0                #>  [43] gtable_0.3.1                  beachmat_2.14.0               #>  [45] rlang_1.0.6                   systemfonts_1.0.4             #>  [47] splines_4.2.2                 scico_1.3.1                   #>  [49] BiocManager_1.30.19           s2_1.1.2                      #>  [51] yaml_2.3.7                    httpuv_1.6.8                  #>  [53] tools_4.2.2                   ellipsis_0.3.2                #>  [55] jquerylib_0.1.4               RColorBrewer_1.1-3            #>  [57] proxy_0.4-27                  Rcpp_1.0.10                   #>  [59] sparseMatrixStats_1.10.0      zlibbioc_1.44.0               #>  [61] classInt_0.4-8                purrr_1.0.1                   #>  [63] RCurl_1.98-1.10               dbscan_1.1-11                 #>  [65] deldir_1.0-6                  viridis_0.6.2                 #>  [67] cowplot_1.1.1                 ggrepel_0.9.2                 #>  [69] cluster_2.1.4                 fs_1.6.0                      #>  [71] magrittr_2.0.3                magick_2.7.3                  #>  [73] scattermore_0.8               ggnewscale_0.4.8              #>  [75] mime_0.12                     evaluate_0.20                 #>  [77] xtable_1.8-4                  gridExtra_2.3                 #>  [79] compiler_4.2.2                tibble_3.1.8                  #>  [81] KernSmooth_2.23-20            crayon_1.5.2                  #>  [83] R.oo_1.25.0                   htmltools_0.5.4               #>  [85] mgcv_1.8-41                   later_1.3.0                   #>  [87] DBI_1.1.3                     ExperimentHub_2.6.0           #>  [89] dbplyr_2.3.0                  rappdirs_0.3.3                #>  [91] boot_1.3-28.1                 Matrix_1.5-3                  #>  [93] cli_3.6.0                     R.methodsS3_1.8.2             #>  [95] parallel_4.2.2                metapod_1.6.0                 #>  [97] igraph_1.3.5                  pkgconfig_2.0.3               #>  [99] pkgdown_2.0.7                 vipor_0.4.5                   #> [101] bslib_0.4.2                   dqrng_0.3.0                   #> [103] XVector_0.38.0                digest_0.6.31                 #> [105] RcppAnnoy_0.0.20              Biostrings_2.66.0             #> [107] rmarkdown_2.20                uwot_0.1.14                   #> [109] edgeR_3.40.2                  DelayedMatrixStats_1.20.0     #> [111] curl_5.0.0                    shiny_1.7.4                   #> [113] rjson_0.2.21                  lifecycle_1.0.3               #> [115] nlme_3.1-161                  jsonlite_1.8.4                #> [117] Rhdf5lib_1.20.0               BiocNeighbors_1.16.0          #> [119] desc_1.4.2                    viridisLite_0.4.1             #> [121] limma_3.54.1                  fansi_1.0.4                   #> [123] pillar_1.8.1                  lattice_0.20-45               #> [125] KEGGREST_1.38.0               fastmap_1.1.0                 #> [127] httr_1.4.4                    interactiveDisplayBase_1.36.0 #> [129] glue_1.6.2                    png_0.1-8                     #> [131] BiocVersion_3.16.0            bit_4.0.5                     #> [133] class_7.3-21                  stringi_1.7.12                #> [135] sass_0.4.5                    HDF5Array_1.26.0              #> [137] blob_1.2.3                    textshaping_0.3.6             #> [139] AnnotationHub_3.6.0           memoise_2.0.1                 #> [141] dplyr_1.0.10                  irlba_2.3.5.1                 #> [143] e1071_1.7-12"},{"path":[]},{"path":"https://pachterlab.github.io/voyager/articles/vig5_xenium.html","id":"introduction","dir":"Articles","previous_headings":"","what":"Introduction","title":"Xenium breast cancer dataset","text":"Xenium new technology 10X genomics single cell resolution smFISH based spatial transcriptomics. first Xenium dataset formalin fixed paraffin embedded (FFPE) human breast tumor, reported (Janesick et al. 2022) downloaded 10X website. gene count matrix downloaded HDF5 file read R SingleCellExperiment (SCE) object DropletUtils::read10xCounts(). gene count matrix originally DelayedArray, data loaded memory. now, matrix converted memory dgCMatrix. However, next release, like write another vignette disk analyses. challenge representing sf data frames disk, perhaps sedona SQLDataFrame. cell metadata (including centroid coordinates) cell segmentation polygons downloaded parquet files, compact way store columnar data CSV, read R data frames arrow::read_parquet(). cell polygons converted sf data frame SpatialFeatureExperiment::df2sf(). SCE object converted SpatialFeatureExperiment (SFE) polygon geometry added SFE object, SFEData package. load packages used vignette. 118708 cells dataset, little CosMX dataset. SFE object doesn’t column names (.e. cell IDs). assign cell IDs. tissue, cell outlines, looks like  Plot cell density space","code":"library(Voyager) library(SFEData) # Pushed fix to Bioc but changes may take a while to show up library(SingleCellExperiment) #> Loading required package: SummarizedExperiment #> Loading required package: MatrixGenerics #> Loading required package: matrixStats #>  #> Attaching package: 'MatrixGenerics' #> The following objects are masked from 'package:matrixStats': #>  #>     colAlls, colAnyNAs, colAnys, colAvgsPerRowSet, colCollapse, #>     colCounts, colCummaxs, colCummins, colCumprods, colCumsums, #>     colDiffs, colIQRDiffs, colIQRs, colLogSumExps, colMadDiffs, #>     colMads, colMaxs, colMeans2, colMedians, colMins, colOrderStats, #>     colProds, colQuantiles, colRanges, colRanks, colSdDiffs, colSds, #>     colSums2, colTabulates, colVarDiffs, colVars, colWeightedMads, #>     colWeightedMeans, colWeightedMedians, colWeightedSds, #>     colWeightedVars, rowAlls, rowAnyNAs, rowAnys, rowAvgsPerColSet, #>     rowCollapse, rowCounts, rowCummaxs, rowCummins, rowCumprods, #>     rowCumsums, rowDiffs, rowIQRDiffs, rowIQRs, rowLogSumExps, #>     rowMadDiffs, rowMads, rowMaxs, rowMeans2, rowMedians, rowMins, #>     rowOrderStats, rowProds, rowQuantiles, rowRanges, rowRanks, #>     rowSdDiffs, rowSds, rowSums2, rowTabulates, rowVarDiffs, rowVars, #>     rowWeightedMads, rowWeightedMeans, rowWeightedMedians, #>     rowWeightedSds, rowWeightedVars #> Loading required package: GenomicRanges #> Loading required package: stats4 #> Loading required package: BiocGenerics #>  #> Attaching package: 'BiocGenerics' #> The following objects are masked from 'package:stats': #>  #>     IQR, mad, sd, var, xtabs #> The following objects are masked from 'package:base': #>  #>     anyDuplicated, aperm, append, as.data.frame, basename, cbind, #>     colnames, dirname, do.call, duplicated, eval, evalq, Filter, Find, #>     get, grep, grepl, intersect, is.unsorted, lapply, Map, mapply, #>     match, mget, order, paste, pmax, pmax.int, pmin, pmin.int, #>     Position, rank, rbind, Reduce, rownames, sapply, setdiff, sort, #>     table, tapply, union, unique, unsplit, which.max, which.min #> Loading required package: S4Vectors #>  #> Attaching package: 'S4Vectors' #> The following objects are masked from 'package:base': #>  #>     expand.grid, I, unname #> Loading required package: IRanges #> Loading required package: GenomeInfoDb #> Loading required package: Biobase #> Welcome to Bioconductor #>  #>     Vignettes contain introductory material; view with #>     'browseVignettes()'. To cite Bioconductor, see #>     'citation(\"Biobase\")', and for packages 'citation(\"pkgname\")'. #>  #> Attaching package: 'Biobase' #> The following object is masked from 'package:MatrixGenerics': #>  #>     rowMedians #> The following objects are masked from 'package:matrixStats': #>  #>     anyMissing, rowMedians library(SpatialExperiment) library(SpatialFeatureExperiment) library(ggplot2) library(stringr) library(scater) # devel version of plotExpression #> Loading required package: scuttle library(scuttle) library(BiocParallel) library(BiocSingular) library(bluster) library(scran) library(patchwork) theme_set(theme_void()) # Fixed version this function may not immediately show up on Bioconductor # Use remotes::install_github(\"pachterlab/SFEData\") if Bioc version doesn't work (sfe <- JanesickBreastData(dataset = \"rep2\")) #> adding rname 'https://caltech.box.com/public/static/y9f16wiaz70ojvteavctcu3k9zs6ctfl' #> class: SpatialFeatureExperiment  #> dim: 541 118708  #> metadata(1): Samples #> assays(1): counts #> rownames(541): ABCC11 ACTA2 ... BLANK_0497 BLANK_0499 #> rowData names(6): ID Symbol ... vars cv2 #> colnames: NULL #> colData names(10): Sample Barcode ... nCounts nGenes #> reducedDimNames(0): #> mainExpName: NULL #> altExpNames(0): #> spatialCoords names(2) : x_centroid y_centroid #> imgData names(1): sample_id #>  #> Geometries: #> colGeometries: centroids (POINT), cellSeg (POLYGON), nucSeg (GEOMETRY)  #>  #> Graphs: #> sample01: colnames(sfe) <- seq_len(ncol(sfe)) ggplot(cellSeg(sfe)) + geom_sf() +     theme_bw() +     scale_x_continuous(expand = expansion()) +     scale_y_continuous(expand = expansion()) plotCellBin2D(sfe) + theme_bw()"},{"path":[]},{"path":"https://pachterlab.github.io/voyager/articles/vig5_xenium.html","id":"cells","dir":"Articles","previous_headings":"Quality control","what":"Cells","title":"Xenium breast cancer dataset","text":"QC metrics precomputed stored colData Since ’re cells, better plot tissue larger, ’ll plot histogram QC metrics spatial plots separately, unlike CosMx vignette. divided nCounts total number genes probed, histogram comparable smFISH-based datasets.  Compared FFPE CosMX non-small cell lung cancer dataset, transcripts per gene average larger proportion genes detected dataset, also FFPE. However, interpreted care, since two datasets different tissues different gene panels, may may indicate Xenium better detection efficiency CosMX.  seem FOV artifacts. However, cell ID FOV information unavailable examine .  standard examination look relationship nCounts nGenes:  appear two branches. plot distribution cell area  pixels. ’s long tail. nuclei much smaller cells. cell area distributed space?  Cells sparse region tend larger dense region. may biological artifact cell segmentation algorithm . nuclei segmentations plotted instead cell segmentation. nuclei much smaller extent difficult see.  ’s outlier near right edge section, throwing dynamic range plot. Upon inspection H&E image, outlier bit tissue debris doesn’t look like cell. can still cells dense, gland like regions tend larger nuclei. may biological, nuclei densely packed regions likely undersegmented, .e. multiple nuclei counted one nuclei segmentation program, . observations motivate examination relationship cell area nuclei area:  , two branches, probably related cell density cell type. nucleus outlier also large cell area, though much outlier cell area. However, spatial outlier ’s unusually large compared neighbors (scroll two plots back). Next calculate proportion cell z-plane taken nucleus, examine distribution:  distribution generated two peaks combined. histogram, seem cells without nuclei segmentation artifacts nucleus larger cell. However, many cells dataset possible just cells visible histogram. double check: cells without nuclei nuclei larger cells. plot nuclei proportion space:  Cells histological regions larger proportions occupied nuclei. interesting check, controlling cell type, cell area, nucleus area, proportion cell occupied nucleus relate gene expression. However, problem performing analysis cell segmentation available one z-plane areas also relate z-plane intersects cell. plot 2D histogram better show density points plot:  Smaller cells tend higher proportion occupied nucleus. can related cell type, limitation small nuclei can tissue. also examine relationship nucleus area proportion cell occupied nucleus:  outlier obvious. cells small nuclei low proportion area occupied nucleus.","code":"names(colData(sfe)) #>  [1] \"Sample\"                  \"Barcode\"                 #>  [3] \"transcript_counts\"       \"control_probe_counts\"    #>  [5] \"control_codeword_counts\" \"cell_area\"               #>  [7] \"nucleus_area\"            \"sample_id\"               #>  [9] \"nCounts\"                 \"nGenes\" n_panel <- 313 colData(sfe)$nCounts_normed <- sfe$nCounts/n_panel colData(sfe)$nGenes_normed <- sfe$nGenes/n_panel plotColDataHistogram(sfe, c(\"nCounts_normed\", \"nGenes_normed\")) + theme_bw() plotSpatialFeature(sfe, \"nCounts\", colGeometryName = \"cellSeg\") plotSpatialFeature(sfe, \"nGenes\", colGeometryName = \"cellSeg\") plotColDataBin2D(sfe, \"nCounts\", \"nGenes\") + theme_bw() plotColDataHistogram(sfe, c(\"cell_area\", \"nucleus_area\"), scales = \"free_y\") +     theme_bw() plotSpatialFeature(sfe, \"cell_area\", colGeometryName = \"cellSeg\") plotSpatialFeature(sfe, \"nucleus_area\", colGeometryName = \"nucSeg\") plotColDataBin2D(sfe, \"cell_area\", \"nucleus_area\") + theme_bw() +     scale_fill_viridis_c() #> Scale for fill is already present. #> Adding another scale for fill, which will replace the existing scale. colData(sfe)$prop_nuc <- sfe$nucleus_area / sfe$cell_area plotColDataHistogram(sfe, \"prop_nuc\") + theme_bw() # No nucleus sum(sfe$nucleus_area < 1) #> [1] 0 # Nucleus larger than cell sum(sfe$nucleus_area > sfe$cell_area) #> [1] 0 plotSpatialFeature(sfe, \"prop_nuc\", colGeometryName = \"cellSeg\") plotColDataBin2D(sfe, \"cell_area\", \"prop_nuc\") + theme_bw() +     scale_fill_viridis_c() #> Scale for fill is already present. #> Adding another scale for fill, which will replace the existing scale. plotColDataBin2D(sfe, \"nucleus_area\", \"prop_nuc\") + theme_bw() +     scale_fill_viridis_c() #> Scale for fill is already present. #> Adding another scale for fill, which will replace the existing scale."},{"path":"https://pachterlab.github.io/voyager/articles/vig5_xenium.html","id":"negative-controls","dir":"Articles","previous_headings":"Quality control","what":"Negative controls","title":"Xenium breast cancer dataset","text":"Since hundred genes plus negative control probes, row names SFE object can printed find negative control probes called. According Xenium paper (Janesick et al. 2022), 3 types controls: probe controls assess non-specific binding RNA, decoding controls assess misassigned genes, genomic DNA (gDNA) controls ensure signal RNA. paper explain detail control probes designed, explain blank probes . blank probes can used negative control. number 1, probe control number 2, decoding control must number 3, gDNA control Also make indicator whether feature sort negative control addPerCellQCMetrics() function scuttle package can conveniently add transcript counts, proportion total counts, number features detected subset features SCE object. SFE object, SFE inherits SCE. Next plot proportion transcript counts coming negative control.  histogram dominated bin zero extreme outliers seen evident scale x axis. also plot histogram cells least 1 count negative control. NA’s come cells got segmented transcripts detected.  vast majority cells less 1% transcript counts negative controls, outliers 50%. Next plot distribution number negative control counts per cell:  counts low, mostly zero, outliers 10 counts types aggregated. outlier 50% counts negative controls must low total real transcript counts begin . scuttle package can detect outliers, default assigns anything zero outlier, since 3 median absolute deviations (MADs) away median, 0, MAD 0 since vast majority cells don’t negative control count. makes sense allow small proportion negative controls. use distribution just cells least 1 negative control count find outliers. distribution long tail definite outliers. code extracts outliers, based cells least one negative control count examine outliers located space:  find outliers difficult see:  analysis reveals outliers seem smaller. Outliers negative probe controls negative codeword controls also hard see plot, plots skipped . top left region tissue tends counts antisense controls.  Now identified outliers, can remove along empty cells proceeding analysis: 1000 cells removed. Next check many negative control features detected per cell:  3 counts per cell per type. non-outliers, type around 1%, data looks good.","code":"rownames(sfe) #>   [1] \"ABCC11\"                  \"ACTA2\"                   #>   [3] \"ACTG2\"                   \"ADAM9\"                   #>   [5] \"ADGRE5\"                  \"ADH1B\"                   #>   [7] \"ADIPOQ\"                  \"AGR3\"                    #>   [9] \"AHSP\"                    \"AIF1\"                    #>  [11] \"AKR1C1\"                  \"AKR1C3\"                  #>  [13] \"ALDH1A3\"                 \"ANGPT2\"                  #>  [15] \"ANKRD28\"                 \"ANKRD29\"                 #>  [17] \"ANKRD30A\"                \"APOBEC3A\"                #>  [19] \"APOBEC3B\"                \"APOC1\"                   #>  [21] \"AQP1\"                    \"AQP3\"                    #>  [23] \"AR\"                      \"AVPR1A\"                  #>  [25] \"BACE2\"                   \"BANK1\"                   #>  [27] \"BASP1\"                   \"BTNL9\"                   #>  [29] \"C15orf48\"                \"C1QA\"                    #>  [31] \"C1QC\"                    \"C2orf42\"                 #>  [33] \"C5orf46\"                 \"C6orf132\"                #>  [35] \"CAV1\"                    \"CAVIN2\"                  #>  [37] \"CCDC6\"                   \"CCDC80\"                  #>  [39] \"CCL20\"                   \"CCL5\"                    #>  [41] \"CCL8\"                    \"CCND1\"                   #>  [43] \"CCPG1\"                   \"CCR7\"                    #>  [45] \"CD14\"                    \"CD163\"                   #>  [47] \"CD19\"                    \"CD1C\"                    #>  [49] \"CD247\"                   \"CD27\"                    #>  [51] \"CD274\"                   \"CD3D\"                    #>  [53] \"CD3E\"                    \"CD3G\"                    #>  [55] \"CD4\"                     \"CD68\"                    #>  [57] \"CD69\"                    \"CD79A\"                   #>  [59] \"CD79B\"                   \"CD80\"                    #>  [61] \"CD83\"                    \"CD86\"                    #>  [63] \"CD8A\"                    \"CD8B\"                    #>  [65] \"CD9\"                     \"CD93\"                    #>  [67] \"CDC42EP1\"                \"CDH1\"                    #>  [69] \"CEACAM6\"                 \"CEACAM8\"                 #>  [71] \"CENPF\"                   \"CLCA2\"                   #>  [73] \"CLDN4\"                   \"CLDN5\"                   #>  [75] \"CLEC14A\"                 \"CLEC9A\"                  #>  [77] \"CLECL1\"                  \"CLIC6\"                   #>  [79] \"CPA3\"                    \"CRHBP\"                   #>  [81] \"CRISPLD2\"                \"CSF3\"                    #>  [83] \"CTH\"                     \"CTLA4\"                   #>  [85] \"CTSG\"                    \"CTTN\"                    #>  [87] \"CX3CR1\"                  \"CXCL12\"                  #>  [89] \"CXCL16\"                  \"CXCL5\"                   #>  [91] \"CXCR4\"                   \"CYP1A1\"                  #>  [93] \"CYTIP\"                   \"DAPK3\"                   #>  [95] \"DERL3\"                   \"DMKN\"                    #>  [97] \"DNAAF1\"                  \"DNTTIP1\"                 #>  [99] \"DPT\"                     \"DSC2\"                    #> [101] \"DSP\"                     \"DST\"                     #> [103] \"DUSP2\"                   \"DUSP5\"                   #> [105] \"EDN1\"                    \"EDNRB\"                   #> [107] \"EGFL7\"                   \"EGFR\"                    #> [109] \"EIF4EBP1\"                \"ELF3\"                    #> [111] \"ELF5\"                    \"ENAH\"                    #> [113] \"EPCAM\"                   \"ERBB2\"                   #> [115] \"ERN1\"                    \"ESM1\"                    #> [117] \"ESR1\"                    \"FAM107B\"                 #> [119] \"FAM49A\"                  \"FASN\"                    #> [121] \"FBLIM1\"                  \"FBLN1\"                   #> [123] \"FCER1A\"                  \"FCER1G\"                  #> [125] \"FCGR3A\"                  \"FGL2\"                    #> [127] \"FLNB\"                    \"FOXA1\"                   #> [129] \"FOXC2\"                   \"FOXP3\"                   #> [131] \"FSTL3\"                   \"GATA3\"                   #> [133] \"GJB2\"                    \"GLIPR1\"                  #> [135] \"GNLY\"                    \"GPR183\"                  #> [137] \"GZMA\"                    \"GZMB\"                    #> [139] \"GZMK\"                    \"HAVCR2\"                  #> [141] \"HDC\"                     \"HMGA1\"                   #> [143] \"HOOK2\"                   \"HOXD8\"                   #> [145] \"HOXD9\"                   \"HPX\"                     #> [147] \"IGF1\"                    \"IGSF6\"                   #> [149] \"IL2RA\"                   \"IL2RG\"                   #> [151] \"IL3RA\"                   \"IL7R\"                    #> [153] \"ITGAM\"                   \"ITGAX\"                   #> [155] \"ITM2C\"                   \"JUP\"                     #> [157] \"KARS\"                    \"KDR\"                     #> [159] \"KIT\"                     \"KLF5\"                    #> [161] \"KLRB1\"                   \"KLRC1\"                   #> [163] \"KLRD1\"                   \"KLRF1\"                   #> [165] \"KRT14\"                   \"KRT15\"                   #> [167] \"KRT16\"                   \"KRT23\"                   #> [169] \"KRT5\"                    \"KRT6B\"                   #> [171] \"KRT7\"                    \"KRT8\"                    #> [173] \"LAG3\"                    \"LARS\"                    #> [175] \"LDHB\"                    \"LEP\"                     #> [177] \"LGALSL\"                  \"LIF\"                     #> [179] \"LILRA4\"                  \"LPL\"                     #> [181] \"LPXN\"                    \"LRRC15\"                  #> [183] \"LTB\"                     \"LUM\"                     #> [185] \"LY86\"                    \"LYPD3\"                   #> [187] \"LYZ\"                     \"MAP3K8\"                  #> [189] \"MDM2\"                    \"MEDAG\"                   #> [191] \"MKI67\"                   \"MLPH\"                    #> [193] \"MMP1\"                    \"MMP12\"                   #> [195] \"MMP2\"                    \"MMRN2\"                   #> [197] \"MNDA\"                    \"MPO\"                     #> [199] \"MRC1\"                    \"MS4A1\"                   #> [201] \"MUC6\"                    \"MYBPC1\"                  #> [203] \"MYH11\"                   \"MYLK\"                    #> [205] \"MYO5B\"                   \"MZB1\"                    #> [207] \"NARS\"                    \"NCAM1\"                   #> [209] \"NDUFA4L2\"                \"NKG7\"                    #> [211] \"NOSTRIN\"                 \"NPM3\"                    #> [213] \"OCIAD2\"                  \"OPRPN\"                   #> [215] \"OXTR\"                    \"PCLAF\"                   #> [217] \"PCOLCE\"                  \"PDCD1\"                   #> [219] \"PDCD1LG2\"                \"PDE4A\"                   #> [221] \"PDGFRA\"                  \"PDGFRB\"                  #> [223] \"PDK4\"                    \"PECAM1\"                  #> [225] \"PELI1\"                   \"PGR\"                     #> [227] \"PIGR\"                    \"PIM1\"                    #> [229] \"PLD4\"                    \"POLR2J3\"                 #> [231] \"POSTN\"                   \"PPARG\"                   #> [233] \"PRDM1\"                   \"PRF1\"                    #> [235] \"PTGDS\"                   \"PTN\"                     #> [237] \"PTPRC\"                   \"PTRHD1\"                  #> [239] \"QARS\"                    \"RAB30\"                   #> [241] \"RAMP2\"                   \"RAPGEF3\"                 #> [243] \"REXO4\"                   \"RHOH\"                    #> [245] \"RORC\"                    \"RTKN2\"                   #> [247] \"RUNX1\"                   \"S100A14\"                 #> [249] \"S100A4\"                  \"S100A8\"                  #> [251] \"SCD\"                     \"SCGB2A1\"                 #> [253] \"SDC4\"                    \"SEC11C\"                  #> [255] \"SEC24A\"                  \"SELL\"                    #> [257] \"SERHL2\"                  \"SERPINA3\"                #> [259] \"SERPINB9\"                \"SFRP1\"                   #> [261] \"SFRP4\"                   \"SH3YL1\"                  #> [263] \"SLAMF1\"                  \"SLAMF7\"                  #> [265] \"SLC25A37\"                \"SLC4A1\"                  #> [267] \"SLC5A6\"                  \"SMAP2\"                   #> [269] \"SMS\"                     \"SNAI1\"                   #> [271] \"SOX17\"                   \"SOX18\"                   #> [273] \"SPIB\"                    \"SQLE\"                    #> [275] \"SRPK1\"                   \"SSTR2\"                   #> [277] \"STC1\"                    \"SVIL\"                    #> [279] \"TAC1\"                    \"TACSTD2\"                 #> [281] \"TCEAL7\"                  \"TCF15\"                   #> [283] \"TCF4\"                    \"TCF7\"                    #> [285] \"TCIM\"                    \"TCL1A\"                   #> [287] \"TENT5C\"                  \"TFAP2A\"                  #> [289] \"THAP2\"                   \"TIFA\"                    #> [291] \"TIGIT\"                   \"TIMP4\"                   #> [293] \"TMEM147\"                 \"TNFRSF17\"                #> [295] \"TOMM7\"                   \"TOP2A\"                   #> [297] \"TPD52\"                   \"TPSAB1\"                  #> [299] \"TRAC\"                    \"TRAF4\"                   #> [301] \"TRAPPC3\"                 \"TRIB1\"                   #> [303] \"TUBA4A\"                  \"TUBB2B\"                  #> [305] \"TYROBP\"                  \"UCP1\"                    #> [307] \"USP53\"                   \"VOPP1\"                   #> [309] \"VWF\"                     \"WARS\"                    #> [311] \"ZEB1\"                    \"ZEB2\"                    #> [313] \"ZNF562\"                  \"NegControlProbe_00042\"   #> [315] \"NegControlProbe_00041\"   \"NegControlProbe_00039\"   #> [317] \"NegControlProbe_00035\"   \"NegControlProbe_00034\"   #> [319] \"NegControlProbe_00033\"   \"NegControlProbe_00031\"   #> [321] \"NegControlProbe_00025\"   \"NegControlProbe_00024\"   #> [323] \"NegControlProbe_00022\"   \"NegControlProbe_00019\"   #> [325] \"NegControlProbe_00017\"   \"NegControlProbe_00016\"   #> [327] \"NegControlProbe_00014\"   \"NegControlProbe_00013\"   #> [329] \"NegControlProbe_00012\"   \"NegControlProbe_00009\"   #> [331] \"NegControlProbe_00004\"   \"NegControlProbe_00003\"   #> [333] \"NegControlProbe_00002\"   \"antisense_PROKR2\"        #> [335] \"antisense_ULK3\"          \"antisense_SCRIB\"         #> [337] \"antisense_TRMU\"          \"antisense_MYLIP\"         #> [339] \"antisense_LGI3\"          \"antisense_BCL2L15\"       #> [341] \"antisense_ADCY4\"         \"NegControlCodeword_0500\" #> [343] \"NegControlCodeword_0501\" \"NegControlCodeword_0502\" #> [345] \"NegControlCodeword_0503\" \"NegControlCodeword_0504\" #> [347] \"NegControlCodeword_0505\" \"NegControlCodeword_0506\" #> [349] \"NegControlCodeword_0507\" \"NegControlCodeword_0508\" #> [351] \"NegControlCodeword_0509\" \"NegControlCodeword_0510\" #> [353] \"NegControlCodeword_0511\" \"NegControlCodeword_0512\" #> [355] \"NegControlCodeword_0513\" \"NegControlCodeword_0514\" #> [357] \"NegControlCodeword_0515\" \"NegControlCodeword_0516\" #> [359] \"NegControlCodeword_0517\" \"NegControlCodeword_0518\" #> [361] \"NegControlCodeword_0519\" \"NegControlCodeword_0520\" #> [363] \"NegControlCodeword_0521\" \"NegControlCodeword_0522\" #> [365] \"NegControlCodeword_0523\" \"NegControlCodeword_0524\" #> [367] \"NegControlCodeword_0525\" \"NegControlCodeword_0526\" #> [369] \"NegControlCodeword_0527\" \"NegControlCodeword_0528\" #> [371] \"NegControlCodeword_0529\" \"NegControlCodeword_0530\" #> [373] \"NegControlCodeword_0531\" \"NegControlCodeword_0532\" #> [375] \"NegControlCodeword_0533\" \"NegControlCodeword_0534\" #> [377] \"NegControlCodeword_0535\" \"NegControlCodeword_0536\" #> [379] \"NegControlCodeword_0537\" \"NegControlCodeword_0538\" #> [381] \"NegControlCodeword_0539\" \"NegControlCodeword_0540\" #> [383] \"BLANK_0006\"              \"BLANK_0013\"              #> [385] \"BLANK_0037\"              \"BLANK_0069\"              #> [387] \"BLANK_0072\"              \"BLANK_0087\"              #> [389] \"BLANK_0110\"              \"BLANK_0114\"              #> [391] \"BLANK_0120\"              \"BLANK_0147\"              #> [393] \"BLANK_0180\"              \"BLANK_0186\"              #> [395] \"BLANK_0272\"              \"BLANK_0278\"              #> [397] \"BLANK_0319\"              \"BLANK_0321\"              #> [399] \"BLANK_0337\"              \"BLANK_0350\"              #> [401] \"BLANK_0351\"              \"BLANK_0352\"              #> [403] \"BLANK_0353\"              \"BLANK_0354\"              #> [405] \"BLANK_0355\"              \"BLANK_0356\"              #> [407] \"BLANK_0357\"              \"BLANK_0358\"              #> [409] \"BLANK_0359\"              \"BLANK_0360\"              #> [411] \"BLANK_0361\"              \"BLANK_0362\"              #> [413] \"BLANK_0363\"              \"BLANK_0364\"              #> [415] \"BLANK_0365\"              \"BLANK_0366\"              #> [417] \"BLANK_0367\"              \"BLANK_0368\"              #> [419] \"BLANK_0369\"              \"BLANK_0370\"              #> [421] \"BLANK_0371\"              \"BLANK_0372\"              #> [423] \"BLANK_0373\"              \"BLANK_0374\"              #> [425] \"BLANK_0375\"              \"BLANK_0376\"              #> [427] \"BLANK_0377\"              \"BLANK_0378\"              #> [429] \"BLANK_0379\"              \"BLANK_0380\"              #> [431] \"BLANK_0381\"              \"BLANK_0382\"              #> [433] \"BLANK_0383\"              \"BLANK_0384\"              #> [435] \"BLANK_0385\"              \"BLANK_0386\"              #> [437] \"BLANK_0387\"              \"BLANK_0388\"              #> [439] \"BLANK_0389\"              \"BLANK_0390\"              #> [441] \"BLANK_0391\"              \"BLANK_0392\"              #> [443] \"BLANK_0393\"              \"BLANK_0394\"              #> [445] \"BLANK_0395\"              \"BLANK_0396\"              #> [447] \"BLANK_0397\"              \"BLANK_0398\"              #> [449] \"BLANK_0399\"              \"BLANK_0400\"              #> [451] \"BLANK_0401\"              \"BLANK_0402\"              #> [453] \"BLANK_0403\"              \"BLANK_0404\"              #> [455] \"BLANK_0405\"              \"BLANK_0406\"              #> [457] \"BLANK_0407\"              \"BLANK_0408\"              #> [459] \"BLANK_0409\"              \"BLANK_0410\"              #> [461] \"BLANK_0411\"              \"BLANK_0412\"              #> [463] \"BLANK_0413\"              \"BLANK_0414\"              #> [465] \"BLANK_0415\"              \"BLANK_0416\"              #> [467] \"BLANK_0417\"              \"BLANK_0418\"              #> [469] \"BLANK_0419\"              \"BLANK_0420\"              #> [471] \"BLANK_0421\"              \"BLANK_0422\"              #> [473] \"BLANK_0423\"              \"BLANK_0424\"              #> [475] \"BLANK_0425\"              \"BLANK_0426\"              #> [477] \"BLANK_0427\"              \"BLANK_0428\"              #> [479] \"BLANK_0429\"              \"BLANK_0430\"              #> [481] \"BLANK_0431\"              \"BLANK_0432\"              #> [483] \"BLANK_0433\"              \"BLANK_0434\"              #> [485] \"BLANK_0435\"              \"BLANK_0436\"              #> [487] \"BLANK_0437\"              \"BLANK_0438\"              #> [489] \"BLANK_0439\"              \"BLANK_0440\"              #> [491] \"BLANK_0441\"              \"BLANK_0442\"              #> [493] \"BLANK_0443\"              \"BLANK_0444\"              #> [495] \"BLANK_0445\"              \"BLANK_0446\"              #> [497] \"BLANK_0447\"              \"BLANK_0448\"              #> [499] \"BLANK_0449\"              \"BLANK_0450\"              #> [501] \"BLANK_0451\"              \"BLANK_0452\"              #> [503] \"BLANK_0453\"              \"BLANK_0454\"              #> [505] \"BLANK_0455\"              \"BLANK_0456\"              #> [507] \"BLANK_0457\"              \"BLANK_0458\"              #> [509] \"BLANK_0459\"              \"BLANK_0460\"              #> [511] \"BLANK_0461\"              \"BLANK_0462\"              #> [513] \"BLANK_0463\"              \"BLANK_0464\"              #> [515] \"BLANK_0465\"              \"BLANK_0466\"              #> [517] \"BLANK_0467\"              \"BLANK_0468\"              #> [519] \"BLANK_0469\"              \"BLANK_0470\"              #> [521] \"BLANK_0471\"              \"BLANK_0472\"              #> [523] \"BLANK_0473\"              \"BLANK_0474\"              #> [525] \"BLANK_0475\"              \"BLANK_0476\"              #> [527] \"BLANK_0477\"              \"BLANK_0478\"              #> [529] \"BLANK_0479\"              \"BLANK_0480\"              #> [531] \"BLANK_0481\"              \"BLANK_0482\"              #> [533] \"BLANK_0483\"              \"BLANK_0484\"              #> [535] \"BLANK_0485\"              \"BLANK_0486\"              #> [537] \"BLANK_0487\"              \"BLANK_0488\"              #> [539] \"BLANK_0489\"              \"BLANK_0497\"              #> [541] \"BLANK_0499\" is_blank <- str_detect(rownames(sfe), \"^BLANK_\") sum(is_blank) #> [1] 159 is_neg <- str_detect(rownames(sfe), \"^NegControlProbe\") sum(is_neg) #> [1] 20 is_neg2 <- str_detect(rownames(sfe), \"^NegControlCodeword\") sum(is_neg2) #> [1] 41 is_anti <- str_detect(rownames(sfe), \"^antisense\") sum(is_anti) #> [1] 8 is_any_neg <- is_blank | is_neg | is_neg2 | is_anti sfe <- addPerCellQCMetrics(sfe, subsets = list(blank = is_blank,                                                negProbe = is_neg,                                                negCodeword = is_neg2,                                                anti = is_anti,                                                any_neg = is_any_neg)) names(colData(sfe)) #>  [1] \"Sample\"                       \"Barcode\"                      #>  [3] \"transcript_counts\"            \"control_probe_counts\"         #>  [5] \"control_codeword_counts\"      \"cell_area\"                    #>  [7] \"nucleus_area\"                 \"sample_id\"                    #>  [9] \"nCounts\"                      \"nGenes\"                       #> [11] \"nCounts_normed\"               \"nGenes_normed\"                #> [13] \"prop_nuc\"                     \"sum\"                          #> [15] \"detected\"                     \"subsets_blank_sum\"            #> [17] \"subsets_blank_detected\"       \"subsets_blank_percent\"        #> [19] \"subsets_negProbe_sum\"         \"subsets_negProbe_detected\"    #> [21] \"subsets_negProbe_percent\"     \"subsets_negCodeword_sum\"      #> [23] \"subsets_negCodeword_detected\" \"subsets_negCodeword_percent\"  #> [25] \"subsets_anti_sum\"             \"subsets_anti_detected\"        #> [27] \"subsets_anti_percent\"         \"subsets_any_neg_sum\"          #> [29] \"subsets_any_neg_detected\"     \"subsets_any_neg_percent\"      #> [31] \"total\" cols_use <- names(colData(sfe))[str_detect(names(colData(sfe)), \"_percent$\")] plotColDataHistogram(sfe, cols_use, bins = 100, ncol = 3) + theme_bw() #> Warning: Removed 285 rows containing non-finite values (`stat_bin()`). plotColDataHistogram(sfe, cols_use, bins = 100, ncol = 3) +      scale_x_log10() +     annotation_logticks(sides = \"b\") +     theme_bw() #> Warning: Transformation introduced infinite values in continuous x-axis #> Warning: Removed 565577 rows containing non-finite values #> (`stat_bin()`). cols_use2 <- names(colData(sfe))[str_detect(names(colData(sfe)), \"_detected$\")] plotColDataHistogram(sfe, cols_use2, bins = 20, ncol = 3) +     # Avoid decimal breaks on x axis unless there're too few breaks     scale_x_continuous(breaks = scales::breaks_extended(Q = c(1,2,5))) +     theme_bw() get_neg_ctrl_outliers <- function(col, sfe) {     inds <- colData(sfe)$nCounts > 0 & colData(sfe)[[col]] > 0     df <- colData(sfe)[inds,]     outlier_inds <- isOutlier(df[[col]], type = \"higher\")     outliers <- rownames(df)[outlier_inds]     col2 <- str_remove(col, \"^subsets_\")     col2 <- str_remove(col2, \"_percent$\")     new_colname <- paste(\"is\", col2, \"outlier\", sep = \"_\")     colData(sfe)[[new_colname]] <- colnames(sfe) %in% outliers     sfe } cols_use <- names(colData(sfe))[str_detect(names(colData(sfe)), \"_percent$\")] for (n in cols_use) {     sfe <- get_neg_ctrl_outliers(n, sfe) } names(colData(sfe)) #>  [1] \"Sample\"                       \"Barcode\"                      #>  [3] \"transcript_counts\"            \"control_probe_counts\"         #>  [5] \"control_codeword_counts\"      \"cell_area\"                    #>  [7] \"nucleus_area\"                 \"sample_id\"                    #>  [9] \"nCounts\"                      \"nGenes\"                       #> [11] \"nCounts_normed\"               \"nGenes_normed\"                #> [13] \"prop_nuc\"                     \"sum\"                          #> [15] \"detected\"                     \"subsets_blank_sum\"            #> [17] \"subsets_blank_detected\"       \"subsets_blank_percent\"        #> [19] \"subsets_negProbe_sum\"         \"subsets_negProbe_detected\"    #> [21] \"subsets_negProbe_percent\"     \"subsets_negCodeword_sum\"      #> [23] \"subsets_negCodeword_detected\" \"subsets_negCodeword_percent\"  #> [25] \"subsets_anti_sum\"             \"subsets_anti_detected\"        #> [27] \"subsets_anti_percent\"         \"subsets_any_neg_sum\"          #> [29] \"subsets_any_neg_detected\"     \"subsets_any_neg_percent\"      #> [31] \"total\"                        \"is_blank_outlier\"             #> [33] \"is_negProbe_outlier\"          \"is_negCodeword_outlier\"       #> [35] \"is_anti_outlier\"              \"is_any_neg_outlier\" plotSpatialFeature(sfe, \"is_blank_outlier\", colGeometryName = \"cellSeg\") plotColData(sfe, y = \"is_blank_outlier\", x = \"cell_area\",              # to not to plot points, only in devel version of scater             point_fun = function(...) list()) plotSpatialFeature(sfe, \"is_anti_outlier\", colGeometryName = \"cellSeg\") inds_keep <- sfe$nCounts > 0 & sfe$nucleus_area < 400 & !sfe$is_anti_outlier &     !sfe$is_blank_outlier & !sfe$is_negCodeword_outlier & !sfe$is_negProbe_outlier (sfe <- sfe[,inds_keep]) #> class: SpatialFeatureExperiment  #> dim: 541 117503  #> metadata(1): Samples #> assays(1): counts #> rownames(541): ABCC11 ACTA2 ... BLANK_0497 BLANK_0499 #> rowData names(6): ID Symbol ... vars cv2 #> colnames(117503): 1 2 ... 118707 118708 #> colData names(36): Sample Barcode ... is_anti_outlier #>   is_any_neg_outlier #> reducedDimNames(0): #> mainExpName: NULL #> altExpNames(0): #> spatialCoords names(2) : x_centroid y_centroid #> imgData names(1): sample_id #>  #> Geometries: #> colGeometries: centroids (POINT), cellSeg (POLYGON), nucSeg (GEOMETRY)  #>  #> Graphs: #> sample01: plotColDataHistogram(sfe, cols_use2, bins = 20, ncol = 3) +     # Avoid decimal breaks on x axis unless there're too few breaks     scale_x_continuous(breaks = scales::breaks_extended(3, Q = c(1,2,5))) +     theme_bw()"},{"path":"https://pachterlab.github.io/voyager/articles/vig5_xenium.html","id":"genes","dir":"Articles","previous_headings":"Quality control","what":"Genes","title":"Xenium breast cancer dataset","text":"look mean variance gene Real genes generally higher mean expression across cells negative controls.  real genes negative controls plotted different colors  red line \\(y = x\\) expected data follows Poisson distribution. Negative controls real genes form mostly separate clusters. Negative controls stick close line, real genes overdispersed. Unlike CosMX dataset, negative controls don’t seem overdispersed.","code":"rowData(sfe)$means <- rowMeans(counts(sfe)) rowData(sfe)$vars <- rowVars(counts(sfe)) rowData(sfe)$is_neg <- is_any_neg plotRowData(sfe, x = \"means\", y = \"is_neg\") +     scale_y_log10() +     annotation_logticks(sides = \"b\") plotRowDataBin2D(sfe, \"means\", \"vars\", subset = \"is_neg\",                   name_true = \"Counts (negative controls)\",                   name_false = \"Counts (real genes)\", bins = 50) +     geom_abline(slope = 1, intercept = 0, color = \"red\") +     scale_x_log10() + scale_y_log10() +     annotation_logticks() +     coord_equal() +     theme_bw()"},{"path":"https://pachterlab.github.io/voyager/articles/vig5_xenium.html","id":"spatial-autocorrelation-of-qc-metrics","dir":"Articles","previous_headings":"","what":"Spatial autocorrelation of QC metrics","title":"Xenium breast cancer dataset","text":"’s sparse dense region. poses question type neighborhood graph use, e.g. conceivable cells sparse region just singletons. Furthermore, unclear length scale influence might . might depend cell type contact secreted signals used cell type, length scale influence. k nearest neighbors used, neighbors dense region much closer together sparse region. distance based neighbors used, cells dense region neighbors cells sparse region, sparse region can break multiple compartments distance cutoff long enough. purpose demonstration, use k nearest neighbors \\(k = 5\\), inverse distance weighting. Note using neighbors leads longer computation time spatial autocorrelation metrics. Global Moran’s indicatse positive spatial autocorrelation. strength spatial autocorrelation can vary spatially, also run local Moran’s . pointsize argument adjusts point size scattermore. default 0, meaning single pixels, since cells sparse region hard see way, increase pointsize. still plot polygons larger single panel plots, use scattermore multi-panel plots polygons panel invisible anyway due small size save time.  Interestingly, nCounts homogeneous interior dense region, nGenes homogeneous edge dense region. expected, cell area homogeneous sparse region. However, nucleus area homogeneous interior dense region. Moran plot nCounts  obvious clusters . lower panel, 2D histogram influential points plotted red.","code":"system.time(     colGraph(sfe, \"knn5\") <- findSpatialNeighbors(sfe, method = \"knearneigh\",                                                    dist_type = \"idw\", k = 5,                                                    style = \"W\") ) #>    user  system elapsed  #> 106.741   0.224 107.204 sfe <- colDataMoransI(sfe, c(\"nCounts\", \"nGenes\", \"cell_area\", \"nucleus_area\"),                       colGraphName = \"knn5\") colFeatureData(sfe)[c(\"nCounts\", \"nGenes\", \"cell_area\", \"nucleus_area\"),] #> DataFrame with 4 rows and 2 columns #>              moran_sample01 K_sample01 #>                   <numeric>  <numeric> #> nCounts            0.422387    5.55509 #> nGenes             0.401395    3.13694 #> cell_area          0.628837    7.57098 #> nucleus_area       0.377248    6.88331 sfe <- colDataUnivariate(sfe, type = \"localmoran\",                           features = c(\"nCounts\", \"nGenes\", \"cell_area\",                                        \"nucleus_area\"),                          colGraphName = \"knn5\", BPPARAM = MulticoreParam(2)) plotLocalResult(sfe, \"localmoran\",                 features = c(\"nCounts\", \"nGenes\", \"cell_area\", \"nucleus_area\"),                 colGeometryName = \"centroids\", scattermore = TRUE,                 divergent = TRUE, diverge_center = 0, pointsize = 1) sfe <- colDataUnivariate(sfe, \"moran.plot\", \"nCounts\", colGraphName = \"knn5\") p1 <- moranPlot(sfe, \"nCounts\", binned = TRUE, plot_influential = FALSE)  p2 <- moranPlot(sfe, \"nCounts\", binned = TRUE) p1 / p2 + plot_layout(guides = \"collect\") & theme_bw()"},{"path":"https://pachterlab.github.io/voyager/articles/vig5_xenium.html","id":"morans-i","dir":"Articles","previous_headings":"","what":"Moran’s I","title":"Xenium breast cancer dataset","text":"default, gene expression, log normalized counts used spatial autocorrelation metrics, running Moran’s , normalize data. Use cores available speed .  expected, generally negative controls tightly clustered around 0, real genes positive Moran’s , means generally technical artifact spatial trend. significantly negative Moran’s observed. negative spatial autocorrelation rare gene expression? two negative controls sizable Moran’s ?  somewhat spatial trend antisense probe, detected upper left. However, might significantly affect results since 2 counts 1% counts cell. negative control codeword 1 count per cell cells negative control detected seem far . detected negative controls, detected one also one highest Moran’s among negative controls. However, negative control higher Moran’s among detected. genes highest Moran’s ?  highlight histological regions, CosMX vignette. Moran’s relate gene expression level?  highly expressed genes higher Moran’s , less expressed genes higher Moran’s well.","code":"sfe <- logNormCounts(sfe) system.time(     sfe <- runMoransI(sfe, colGraphName = \"knn5\", BPPARAM = MulticoreParam(2)) ) #>    user  system elapsed  #>  80.849   5.311  43.970 rowData(sfe)$is_neg <- is_any_neg plotRowData(sfe, x = \"moran_sample01\", y = \"is_neg\") ord <- order(rowData(sfe)$moran_sample01[is_any_neg], decreasing = TRUE)[1:2] top_neg <- rownames(sfe)[is_any_neg][ord] plotSpatialFeature(sfe, top_neg, colGeometryName = \"centroids\",                    scattermore = TRUE, pointsize = 1) head(sort(rowData(sfe)$means[is_any_neg], decreasing = TRUE), 15) #>      antisense_PROKR2       antisense_SCRIB     antisense_BCL2L15  #>          0.0192761036          0.0131741317          0.0066806805  #>        antisense_TRMU       antisense_MYLIP        antisense_ULK3  #>          0.0042041480          0.0030807724          0.0028169494  #>            BLANK_0485       antisense_ADCY4        antisense_LGI3  #>          0.0023403658          0.0019829281          0.0017871884  #>            BLANK_0430 NegControlProbe_00035 NegControlProbe_00012  #>          0.0015063445          0.0010978443          0.0010382714  #> NegControlProbe_00033 NegControlProbe_00014            BLANK_0120  #>          0.0009446567          0.0009361463          0.0009276359 top_moran <- rownames(sfe)[order(rowData(sfe)$moran_sample01, decreasing = TRUE)[1:6]] plotSpatialFeature(sfe, top_moran, colGeometryName = \"centroids\",                    scattermore = TRUE, ncol = 2, pointsize = 0.5) plotRowData(sfe, x = \"means\", y = \"moran_sample01\")"},{"path":"https://pachterlab.github.io/voyager/articles/vig5_xenium.html","id":"non-spatial-dimension-reduction-and-clustering","dir":"Articles","previous_headings":"","what":"Non-spatial dimension reduction and clustering","title":"Xenium breast cancer dataset","text":"run non-spatial PCA scRNA-seq data    spatial region explicitly used, PC’s highlight spatial regions due spatial autocorrelation gene expression histological regions different cell types. Non-spatial clustering locating clusters space Now scater can also rasterize plots lots points rasterise argument, different mechanism scattermore requires system dependencies.   Plot location clusters space","code":"set.seed(29) sfe <- runPCA(sfe, ncomponents = 30, scale = TRUE, BSPARAM = IrlbaParam()) ElbowPlot(sfe, ndims = 30) + theme_bw() plotDimLoadings(sfe, dims = 1:6) + theme_bw() spatialReducedDim(sfe, \"PCA\", 6, colGeometryName = \"centroids\", divergent = TRUE,                   diverge_center = 0, ncol = 2, scattermore = TRUE, pointsize = 0.5) set.seed(29) sfe <- runUMAP(sfe, dimred = \"PCA\", n_dimred = 15) colData(sfe)$cluster <- clusterRows(reducedDim(sfe, \"PCA\")[,1:15],                                     BLUSPARAM = SNNGraphParam(                                         cluster.fun = \"leiden\",                                         cluster.args = list(                                             resolution_parameter = 0.5,                                             objective_function = \"modularity\"))) #> Warning in (function (to_check, X, clust_centers, clust_info, dtype, nn, : #> detected tied distances to neighbors, see ?'BiocNeighbors-ties' plotPCA(sfe, ncomponents = 4, colour_by = \"cluster\", rasterise = FALSE) plotUMAP(sfe, colour_by = \"cluster\", rasterise = FALSE) plotSpatialFeature(sfe, \"cluster\", colGeometryName = \"cellSeg\")"},{"path":"https://pachterlab.github.io/voyager/articles/vig5_xenium.html","id":"differential-expression","dir":"Articles","previous_headings":"","what":"Differential expression","title":"Xenium breast cancer dataset","text":"Cluster marker genes found Wilcoxon rank sum test commonly done scRNA-seq. ’s already sorted p-values: code extracts significant markers cluster:  allows plotting top marker genes heatmap:","code":"markers <- findMarkers(sfe, groups = colData(sfe)$cluster,                        test.type = \"wilcox\", pval.type = \"all\", direction = \"up\") markers[[6]] #> DataFrame with 541 rows and 15 columns #>             p.value          FDR summary.AUC     AUC.1     AUC.2     AUC.3 #>           <numeric>    <numeric>   <numeric> <numeric> <numeric> <numeric> #> CD3E   1.08129e-172 5.84976e-170    0.834288  0.928724  0.899960  0.923141 #> TRAC   7.53686e-145 2.03872e-142    0.805752  0.926592  0.887797  0.918802 #> IL7R   5.33332e-136 9.61776e-134    0.796108  0.900779  0.853621  0.896071 #> CCL5    3.34091e-74  4.51858e-72    0.717197  0.770503  0.728465  0.763076 #> CD3D    7.56448e-51  8.18477e-49    0.678574  0.732699  0.712700  0.730421 #> ...             ...          ...         ...       ...       ...       ... #> USP53             1            1    0.222654  0.222654  0.479578  0.434055 #> VWF               1            1    0.159973  0.518134  0.504303  0.538958 #> ZEB1              1            1    0.352678  0.600358  0.517118  0.514668 #> ZEB2              1            1    0.314895  0.736440  0.314895  0.645152 #> ZNF562            1            1    0.273830  0.273830  0.420054  0.388919 #>            AUC.4     AUC.5     AUC.7     AUC.8     AUC.9    AUC.10    AUC.11 #>        <numeric> <numeric> <numeric> <numeric> <numeric> <numeric> <numeric> #> CD3E    0.910392  0.921113  0.879616  0.913567  0.929736  0.897792  0.835816 #> TRAC    0.892413  0.916267  0.862178  0.901142  0.928463  0.873201  0.782884 #> IL7R    0.873714  0.886957  0.838819  0.870514  0.902496  0.854189  0.786892 #> CCL5    0.731374  0.756452  0.720285  0.746292  0.772738  0.734768  0.699777 #> CD3D    0.714314  0.726523  0.700896  0.718518  0.733008  0.711401  0.680635 #> ...          ...       ...       ...       ...       ...       ...       ... #> USP53   0.408708  0.341343  0.468542  0.473662  0.293087  0.459260  0.519215 #> VWF     0.472873  0.434238  0.499472  0.159973  0.544675  0.436101  0.506998 #> ZEB1    0.352678  0.446303  0.478010  0.320867  0.618736  0.487657  0.508938 #> ZEB2    0.341763  0.330367  0.510486  0.300680  0.753614  0.327831  0.386492 #> ZNF562  0.452230  0.437512  0.474652  0.426815  0.281439  0.454937  0.498550 #>           AUC.12    AUC.13 #>        <numeric> <numeric> #> CD3E    0.834288  0.927932 #> TRAC    0.805752  0.925837 #> IL7R    0.796108  0.901166 #> CCL5    0.717197  0.769366 #> CD3D    0.678574  0.730821 #> ...          ...       ... #> USP53   0.511505  0.310949 #> VWF     0.506769  0.554152 #> ZEB1    0.515443  0.628981 #> ZEB2    0.277589  0.743554 #> ZNF562  0.518159  0.353732 genes_use <- vapply(markers, function(x) rownames(x)[1], FUN.VALUE = character(1)) plotExpression(sfe, genes_use, x = \"cluster\", point_fun = function(...) list()) genes_use2 <- unique(unlist(lapply(markers, function(x) rownames(x)[1:5]))) plotGroupedHeatmap(sfe, genes_use2, group = \"cluster\", colour = scales::viridis_pal()(100))"},{"path":"https://pachterlab.github.io/voyager/articles/vig5_xenium.html","id":"local-spatial-statistics-of-marker-genes","dir":"Articles","previous_headings":"","what":"Local spatial statistics of marker genes","title":"Xenium breast cancer dataset","text":"First plot genes space reference  Global Moran’s marker genes shown : marker genes positive spatial autocorrelation, stronger others. Local Moran’s marker genes shown :  seems histological regions tend spatially homogenous gene expression others. epithelial region tends homogenous. genes, regions higher expression also higher local Moran’s , FOXA1 GATA3, genes, case, FGL2 LUM. Finally, assess local spatial heteroscdasticity (LOSH) marker genes find local heterogeneity:  , just like CosMX dataset, LOSH higher gene highly expressed (e.g. CD3E, LUM, TENT5C) cases (e.g. FOXA1, GATA3). may due spatial distribution different cell types.","code":"plotSpatialFeature(sfe, genes_use, colGeometryName = \"centroids\", ncol = 3,                    pointsize = 0.3, scattermore = TRUE) setNames(rowData(sfe)[genes_use, \"moran_sample01\"], genes_use) #>     FOXA1      FGL2      MYLK       LUM       LPL      CD3E    TENT5C      CD93  #> 0.7421765 0.2604219 0.4653625 0.6812312 0.4549359 0.4015241 0.2806543 0.3250982  #>     GATA3      CPA3     MS4A1    LILRA4     KRT15  #> 0.6558350 0.1904912 0.2144728 0.1092981 0.5425155 sfe <- runUnivariate(sfe, \"localmoran\", features = genes_use, colGraphName = \"knn5\",                      BPPARAM = MulticoreParam(2)) plotLocalResult(sfe, type = \"localmoran\", features = genes_use,                  colGeometryName = \"centroids\", ncol = 3, divergent = TRUE,                 diverge_center = 0, scattermore = TRUE, pointsize = 0.3) sfe <- runUnivariate(sfe, \"LOSH\", features = genes_use, colGraphName = \"knn5\",                      BPPARAM = MulticoreParam(2)) plotLocalResult(sfe, type = \"LOSH\", features = genes_use,                  colGeometryName = \"centroids\", ncol = 3, scattermore = TRUE,                  pointsize = 0.3)"},{"path":"https://pachterlab.github.io/voyager/articles/vig5_xenium.html","id":"session-info","dir":"Articles","previous_headings":"","what":"Session info","title":"Xenium breast cancer dataset","text":"","code":"sessionInfo() #> R version 4.2.2 (2022-10-31) #> Platform: x86_64-apple-darwin17.0 (64-bit) #> Running under: macOS Big Sur ... 10.16 #>  #> Matrix products: default #> BLAS:   /Library/Frameworks/R.framework/Versions/4.2/Resources/lib/libRblas.0.dylib #> LAPACK: /Library/Frameworks/R.framework/Versions/4.2/Resources/lib/libRlapack.dylib #>  #> locale: #> [1] en_US.UTF-8/en_US.UTF-8/en_US.UTF-8/C/en_US.UTF-8/en_US.UTF-8 #>  #> attached base packages: #> [1] stats4    stats     graphics  grDevices utils     datasets  methods   #> [8] base      #>  #> other attached packages: #>  [1] patchwork_1.1.2                scran_1.26.2                   #>  [3] bluster_1.8.0                  BiocSingular_1.14.0            #>  [5] BiocParallel_1.32.5            scater_1.27.3                  #>  [7] scuttle_1.8.4                  stringr_1.5.0                  #>  [9] ggplot2_3.4.0                  SpatialFeatureExperiment_1.0.3 #> [11] SpatialExperiment_1.8.0        SingleCellExperiment_1.20.0    #> [13] SummarizedExperiment_1.28.0    Biobase_2.58.0                 #> [15] GenomicRanges_1.50.2           GenomeInfoDb_1.34.7            #> [17] IRanges_2.32.0                 S4Vectors_0.36.1               #> [19] BiocGenerics_0.44.0            MatrixGenerics_1.10.0          #> [21] matrixStats_0.63.0             SFEData_1.0.2                  #> [23] Voyager_1.0.8                  #>  #> loaded via a namespace (and not attached): #>   [1] utf8_1.2.2                    R.utils_2.12.2                #>   [3] tidyselect_1.2.0              RSQLite_2.2.20                #>   [5] AnnotationDbi_1.60.0          grid_4.2.2                    #>   [7] DropletUtils_1.18.1           munsell_0.5.0                 #>   [9] ScaledMatrix_1.6.0            codetools_0.2-18              #>  [11] ragg_1.2.5                    units_0.8-1                   #>  [13] statmod_1.5.0                 withr_2.5.0                   #>  [15] colorspace_2.1-0              filelock_1.0.2                #>  [17] highr_0.10                    knitr_1.42                    #>  [19] wk_0.7.1                      labeling_0.4.2                #>  [21] GenomeInfoDbData_1.2.9        pheatmap_1.0.12               #>  [23] bit64_4.0.5                   farver_2.1.1                  #>  [25] rhdf5_2.42.0                  rprojroot_2.0.3               #>  [27] vctrs_0.5.2                   generics_0.1.3                #>  [29] xfun_0.36                     BiocFileCache_2.6.0           #>  [31] R6_2.5.1                      ggbeeswarm_0.7.1              #>  [33] rsvd_1.0.5                    locfit_1.5-9.7                #>  [35] bitops_1.0-7                  rhdf5filters_1.10.0           #>  [37] cachem_1.0.6                  DelayedArray_0.24.0           #>  [39] assertthat_0.2.1              promises_1.2.0.1              #>  [41] scales_1.2.1                  beeswarm_0.4.0                #>  [43] gtable_0.3.1                  beachmat_2.14.0               #>  [45] rlang_1.0.6                   systemfonts_1.0.4             #>  [47] splines_4.2.2                 scico_1.3.1                   #>  [49] BiocManager_1.30.19           s2_1.1.2                      #>  [51] yaml_2.3.7                    httpuv_1.6.8                  #>  [53] tools_4.2.2                   spData_2.2.1                  #>  [55] ellipsis_0.3.2                jquerylib_0.1.4               #>  [57] RColorBrewer_1.1-3            proxy_0.4-27                  #>  [59] Rcpp_1.0.10                   sparseMatrixStats_1.10.0      #>  [61] zlibbioc_1.44.0               classInt_0.4-8                #>  [63] purrr_1.0.1                   RCurl_1.98-1.10               #>  [65] dbscan_1.1-11                 deldir_1.0-6                  #>  [67] viridis_0.6.2                 cowplot_1.1.1                 #>  [69] ggrepel_0.9.2                 cluster_2.1.4                 #>  [71] fs_1.6.0                      magrittr_2.0.3                #>  [73] magick_2.7.3                  scattermore_0.8               #>  [75] ggnewscale_0.4.8              mime_0.12                     #>  [77] evaluate_0.20                 xtable_1.8-4                  #>  [79] gridExtra_2.3                 compiler_4.2.2                #>  [81] tibble_3.1.8                  KernSmooth_2.23-20            #>  [83] crayon_1.5.2                  R.oo_1.25.0                   #>  [85] htmltools_0.5.4               mgcv_1.8-41                   #>  [87] later_1.3.0                   spdep_1.2-7                   #>  [89] DBI_1.1.3                     ExperimentHub_2.6.0           #>  [91] dbplyr_2.3.0                  rappdirs_0.3.3                #>  [93] sf_1.0-9                      boot_1.3-28.1                 #>  [95] Matrix_1.5-3                  cli_3.6.0                     #>  [97] R.methodsS3_1.8.2             parallel_4.2.2                #>  [99] metapod_1.6.0                 igraph_1.3.5                  #> [101] pkgconfig_2.0.3               pkgdown_2.0.7                 #> [103] sp_1.6-0                      vipor_0.4.5                   #> [105] bslib_0.4.2                   dqrng_0.3.0                   #> [107] XVector_0.38.0                digest_0.6.31                 #> [109] RcppAnnoy_0.0.20              Biostrings_2.66.0             #> [111] rmarkdown_2.20                uwot_0.1.14                   #> [113] edgeR_3.40.2                  DelayedMatrixStats_1.20.0     #> [115] curl_5.0.0                    shiny_1.7.4                   #> [117] rjson_0.2.21                  lifecycle_1.0.3               #> [119] nlme_3.1-161                  jsonlite_1.8.4                #> [121] Rhdf5lib_1.20.0               BiocNeighbors_1.16.0          #> [123] desc_1.4.2                    viridisLite_0.4.1             #> [125] limma_3.54.1                  fansi_1.0.4                   #> [127] pillar_1.8.1                  lattice_0.20-45               #> [129] KEGGREST_1.38.0               fastmap_1.1.0                 #> [131] httr_1.4.4                    interactiveDisplayBase_1.36.0 #> [133] glue_1.6.2                    png_0.1-8                     #> [135] BiocVersion_3.16.0            bit_4.0.5                     #> [137] class_7.3-21                  stringi_1.7.12                #> [139] sass_0.4.5                    HDF5Array_1.26.0              #> [141] blob_1.2.3                    textshaping_0.3.6             #> [143] AnnotationHub_3.6.0           memoise_2.0.1                 #> [145] dplyr_1.0.10                  irlba_2.3.5.1                 #> [147] e1071_1.7-12"},{"path":[]},{"path":"https://pachterlab.github.io/voyager/articles/vig6_merfish.html","id":"introduction","dir":"Articles","previous_headings":"","what":"Introduction","title":"MERFISH mouse liver dataset and considerations of large data","text":"SpatialFeatureExperiment (SFE) Voyager packages originally developed around relatively small Visium dataset proof concept, hence originally optimized large datasets. However, larger smFISH datasets hundreds thousands, sometimes million cells already produced soon produced routinely. Among studies using smFISH-based spatial transcriptomics technologies reported number cells per dataset, number cells per dataset increased past years (Moses Pachter 2022).  anticipation large datasets, vignette produced using limited GitHub Actions resources (MacOS), 14 GB RAM 3 CPU cores 14 GB disk space, comparable laptops. therefore expect analyses vignette scale reasonably sized datasets. dataset use vignette MERFISH mouse liver dataset downloaded Vizgen website discuss issues large datasets upcoming features next release Voyager. gene count matrix cell metadata (including centroid coordinates) downloaded CSV files read R. 7 z-planes imaged, cell segmentation available one z-plane. cell polygons HDF5 files, one HDF5 file per field view (FOV), ’re 1000 FOVs dataset. Converting HDF5 files sf data frame trivial. See vignette creating SpatialFeatureExperiment (SFE) object code used conversion, polygons included SFE object. cell metadata already cell volume. polygons used analyses, polygons can’t seen static plot hundreds thousands cells anyway, conversion optional. transcript spot locations available, yet work large point dataset. load packages used 395215 cells dataset. Plotting polygons takes , isn’t bad.  However, wish save plot PDF. avoid problem, can either use scattermore = TRUE argument plotSpatialFeature() plot centroids since polygons hard see anyway, can use ggrastr package rasterize polygons without rasterizing text. Cell density can vaguely seen plot . count number cells bins better visualize cell density.  Cell density part homogeneous shows structure denser regions seem relate blood vessels.","code":"library(Voyager) library(SFEData) library(SingleCellExperiment) #> Loading required package: SummarizedExperiment #> Loading required package: MatrixGenerics #> Loading required package: matrixStats #>  #> Attaching package: 'MatrixGenerics' #> The following objects are masked from 'package:matrixStats': #>  #>     colAlls, colAnyNAs, colAnys, colAvgsPerRowSet, colCollapse, #>     colCounts, colCummaxs, colCummins, colCumprods, colCumsums, #>     colDiffs, colIQRDiffs, colIQRs, colLogSumExps, colMadDiffs, #>     colMads, colMaxs, colMeans2, colMedians, colMins, colOrderStats, #>     colProds, colQuantiles, colRanges, colRanks, colSdDiffs, colSds, #>     colSums2, colTabulates, colVarDiffs, colVars, colWeightedMads, #>     colWeightedMeans, colWeightedMedians, colWeightedSds, #>     colWeightedVars, rowAlls, rowAnyNAs, rowAnys, rowAvgsPerColSet, #>     rowCollapse, rowCounts, rowCummaxs, rowCummins, rowCumprods, #>     rowCumsums, rowDiffs, rowIQRDiffs, rowIQRs, rowLogSumExps, #>     rowMadDiffs, rowMads, rowMaxs, rowMeans2, rowMedians, rowMins, #>     rowOrderStats, rowProds, rowQuantiles, rowRanges, rowRanks, #>     rowSdDiffs, rowSds, rowSums2, rowTabulates, rowVarDiffs, rowVars, #>     rowWeightedMads, rowWeightedMeans, rowWeightedMedians, #>     rowWeightedSds, rowWeightedVars #> Loading required package: GenomicRanges #> Loading required package: stats4 #> Loading required package: BiocGenerics #>  #> Attaching package: 'BiocGenerics' #> The following objects are masked from 'package:stats': #>  #>     IQR, mad, sd, var, xtabs #> The following objects are masked from 'package:base': #>  #>     anyDuplicated, aperm, append, as.data.frame, basename, cbind, #>     colnames, dirname, do.call, duplicated, eval, evalq, Filter, Find, #>     get, grep, grepl, intersect, is.unsorted, lapply, Map, mapply, #>     match, mget, order, paste, pmax, pmax.int, pmin, pmin.int, #>     Position, rank, rbind, Reduce, rownames, sapply, setdiff, sort, #>     table, tapply, union, unique, unsplit, which.max, which.min #> Loading required package: S4Vectors #>  #> Attaching package: 'S4Vectors' #> The following objects are masked from 'package:base': #>  #>     expand.grid, I, unname #> Loading required package: IRanges #> Loading required package: GenomeInfoDb #> Loading required package: Biobase #> Welcome to Bioconductor #>  #>     Vignettes contain introductory material; view with #>     'browseVignettes()'. To cite Bioconductor, see #>     'citation(\"Biobase\")', and for packages 'citation(\"pkgname\")'. #>  #> Attaching package: 'Biobase' #> The following object is masked from 'package:MatrixGenerics': #>  #>     rowMedians #> The following objects are masked from 'package:matrixStats': #>  #>     anyMissing, rowMedians library(SpatialExperiment) library(scater) # devel version of plotExpression #> Loading required package: scuttle #> Loading required package: ggplot2 library(ggplot2) library(patchwork) library(stringr) library(spdep) #> Loading required package: sp #>  #> Attaching package: 'sp' #> The following object is masked from 'package:IRanges': #>  #>     %over% #> Loading required package: spData #> To access larger datasets in this package, install the spDataLarge #> package with: `install.packages('spDataLarge', #> repos='https://nowosad.github.io/drat/', type='source')` #> Loading required package: sf #> Linking to GEOS 3.10.2, GDAL 3.4.2, PROJ 8.2.1; sf_use_s2() is TRUE library(BiocParallel) library(BiocSingular) library(gstat) library(BiocNeighbors) library(sf) library(automap) theme_set(theme_void()) (sfe <- VizgenLiverData()) #> snapshotDate(): 2022-10-31 #> see ?SFEData and browseVignettes('SFEData') for documentation #> downloading 1 resources #> retrieving 1 resource #> loading from cache #> require(\"SpatialFeatureExperiment\") #> class: SpatialFeatureExperiment  #> dim: 385 395215  #> metadata(0): #> assays(1): counts #> rownames(385): Comt Ldha ... Blank-36 Blank-37 #> rowData names(3): means vars cv2 #> colnames(395215): 10482024599960584593741782560798328923 #>   111551578131181081835796893618918348842 ... #>   92389687374928708938472537234969690424 #>   96399783859933548456002372694492036651 #> colData names(9): fov volume ... nCounts nGenes #> reducedDimNames(0): #> mainExpName: NULL #> altExpNames(0): #> spatialCoords names(2) : center_x center_y #> imgData names(1): sample_id #>  #> Geometries: #> colGeometries: centroids (POINT), cellSeg (POLYGON)  #>  #> Graphs: #> sample01: ggplot(colGeometry(sfe, \"cellSeg\")) + geom_sf() +     scale_x_continuous(expand = expansion()) +     scale_y_continuous(expand = expansion()) +     theme_bw() ggplot(as.data.frame(spatialCoords(sfe))) +     geom_hex(aes(center_x, center_y), bins = 300) +     scale_fill_distiller(palette = \"Blues\", direction = 1) +     scale_x_continuous(expand = expansion()) +     scale_y_continuous(expand = expansion()) +     theme_bw() + coord_equal()"},{"path":"https://pachterlab.github.io/voyager/articles/vig6_merfish.html","id":"quality-control","dir":"Articles","previous_headings":"","what":"Quality control","title":"MERFISH mouse liver dataset and considerations of large data","text":"Plotting almost 400,000 polygons kind slow doable  nCounts kind looks like salt pepper. Using scattermore package can speed plotting large number points. non-interactive plot, cell polygons small see anyway, plotting cell centroid points fine.  run server, plotting almost 400,000 polygons took around 23 seconds, using geom_scattermore() took 2 seconds. Using geom_scattermore() plotting cell density space added next release Voyager. Since geom_scattermore() rasterizes plot, plot pixelated zoomed . next release add spatial plotting functions use bounding box plot portion tissue. function simplified generalizable, compared provided next release. interactive data visualization useful ESDA, need static figures publications.  Much time making plot spent subsetting sf data frame bounding box. spatial autocorrelation evident upper right region smaller cells, less rest patch. nCounts seems related cell size; larger cells seem total counts. Interactive data visualization currently beyond scope Voyager vignette. existing tools interactive visualization highly multiplexed imaging data, MERmaid (G. Wang et al. 2020) MERFISH data, TissUUmaps (Pielawski et al. 2022), Visinity (Warchol et al. 2022). Since aren’t many genes, genes negative control probes can displayed: number real genes 347 Next plot distribution nCounts, divided number genes panel, distribution comparable across datasets different numbers genes.  Xenium dataset, mysterious regular notches histogram number genes detected. also plot number genes detected per cell, geom_scattermore()  Similarly nCounts, points look intermingled. Distribution cell volume space  Next, explore nCounts relates nGenes:  ’re two branches plot. cell size relate nCounts?  lower branch larger cells don’t tend total counts, upper branch larger cells tend total counts. also examine cell size relates number genes detected:  seem clusters possibly related cell type.","code":"names(colData(sfe)) #> [1] \"fov\"       \"volume\"    \"min_x\"     \"max_x\"     \"min_y\"     \"max_y\"     #> [7] \"sample_id\" \"nCounts\"   \"nGenes\" system.time(     print(plotSpatialFeature(sfe, \"nCounts\", colGeometryName = \"cellSeg\")) ) #>    user  system elapsed  #>  30.748   1.195  32.048 system.time({     print(plotSpatialFeature(sfe, \"nCounts\", colGeometryName = \"centroids\",                              scattermore = TRUE)) }) #>    user  system elapsed  #>   1.775   0.211   1.989 plot_colgeom_bbox <- function(sfe, feature, bbox,                               divergent = FALSE, diverge_center = 0) {     df <- cellSeg(sfe)     if (feature %in% names(colData(sfe)))         df[[feature]] <- colData(sfe)[[feature]]     else         df[[feature]] <- as.vector(logcounts(sfe)[feature,])     feature <- make.names(feature)     names(df) <- make.names(names(df))     # Specify bounding box     bbox_use <- st_as_sfc(st_bbox(bbox))     # Subset the sf data frame with the bounding box     df <- df[bbox_use,]     if (divergent) {         r <- getDivergeRange(df[[feature]], diverge_center)         # fill, since only for polygons for now         pal <- scico::scale_fill_scico(palette = \"roma\", begin = r[1], end = r[2])     } else         pal <- scale_fill_distiller(palette = \"Blues\", direction = 1)     ggplot(df) + geom_sf(aes_string(fill = feature), size = 0.1) +         pal + theme_bw() +         scale_x_continuous(expand = expansion()) +         scale_y_continuous(expand = expansion()) } bbox_use <- c(xmin = 3000, xmax = 3500, ymin = 2500, ymax = 3000) plot_colgeom_bbox(sfe, \"nCounts\", bbox_use) #> Warning: `aes_string()` was deprecated in ggplot2 3.0.0. #> ℹ Please use tidy evaluation ideoms with `aes()` rownames(sfe) #>   [1] \"Comt\"          \"Ldha\"          \"Pck1\"          \"Akr1a1\"        #>   [5] \"Ugt2b1\"        \"Acsl5\"         \"Ugt2a3\"        \"Igf1\"          #>   [9] \"Errfi1\"        \"Serping1\"      \"Adh4\"          \"Hsd17b2\"       #>  [13] \"Tpi1\"          \"Cyp1a2\"        \"Acsl1\"         \"Akr1d1\"        #>  [17] \"Alas1\"         \"Aldh7a1\"       \"G6pc\"          \"Hsd17b12\"      #>  [21] \"Pdhb\"          \"Gpd1\"          \"Cyp7b1\"        \"Pgam1\"         #>  [25] \"Hc\"            \"Dld\"           \"Cyp2c23\"       \"Proz\"          #>  [29] \"Acss2\"         \"Psap\"          \"Cald1\"         \"Hsd3b3\"        #>  [33] \"Galm\"          \"Cxcl12\"        \"Sardh\"         \"Cebpa\"         #>  [37] \"Aldh3a2\"       \"Gck\"           \"Sdc1\"          \"Pdha1\"         #>  [41] \"Npc2\"          \"Hsd17b6\"       \"Aqp1\"          \"Adh7\"          #>  [45] \"Smpdl3a\"       \"Egfr\"          \"Pgm1\"          \"Fasn\"          #>  [49] \"Ctsc\"          \"Abcb4\"         \"Fyb\"           \"Alas2\"         #>  [53] \"Gpi1\"          \"Fech\"          \"Lsr\"           \"Psmd3\"         #>  [57] \"Gm2a\"          \"Pabpc1\"        \"Cbr4\"          \"Tkt\"           #>  [61] \"Tmem56\"        \"Eif3f\"         \"Cxadr\"         \"Srd5a1\"        #>  [65] \"Cyp2c55\"       \"Gnai2\"         \"Gimap6\"        \"Hsd3b2\"        #>  [69] \"Grn\"           \"Rpp14\"         \"Csnk1a1\"       \"Egr1\"          #>  [73] \"Mpeg1\"         \"Acsl4\"         \"Hmgb1\"         \"Mpp1\"          #>  [77] \"Lcp1\"          \"Plvap\"         \"Aldh1b1\"       \"Oxsm\"          #>  [81] \"Dlat\"          \"Csk\"           \"Mcat\"          \"Hsd17b7\"       #>  [85] \"Epas1\"         \"Eif3a\"         \"Nrp1\"          \"Dek\"           #>  [89] \"H2afy\"         \"Bpgm\"          \"Hsd3b6\"        \"Dnase1l3\"      #>  [93] \"Serpinh1\"      \"Tinagl1\"       \"Aldoc\"         \"Cyp2c38\"       #>  [97] \"Dpt\"           \"Mrc1\"          \"Minpp1\"        \"Fgf1\"          #> [101] \"Alcam\"         \"Gimap4\"        \"Cav2\"          \"Eng\"           #> [105] \"Adgre1\"        \"Shisa5\"        \"Csf1r\"         \"Esam\"          #> [109] \"Unc93b1\"       \"Cnp\"           \"Clec14a\"       \"Kdr\"           #> [113] \"Adpgk\"         \"Gca\"           \"Pkm\"           \"Mkrn1\"         #> [117] \"Sdc3\"          \"Acaca\"         \"Gpr182\"        \"Bmp2\"          #> [121] \"Tfrc\"          \"Timp3\"         \"Calcrl\"        \"Pfkl\"          #> [125] \"Wnt2\"          \"Cybb\"          \"Icam1\"         \"Cdh5\"          #> [129] \"Sgms2\"         \"Cd48\"          \"Stk17b\"        \"Tubb6\"         #> [133] \"Vcam1\"         \"Hgf\"           \"Ramp1\"         \"Arsb\"          #> [137] \"Pld4\"          \"Smarca4\"       \"Fstl1\"         \"Pfkm\"          #> [141] \"Lhfp\"          \"Lmna\"          \"Cd300lg\"       \"Laptm5\"        #> [145] \"Timp2\"         \"Slc25a37\"      \"Fzd7\"          \"Lyve1\"         #> [149] \"Acacb\"         \"Cyp1a1\"        \"Eno3\"          \"Cd83\"          #> [153] \"Epcam\"         \"Ltbp4\"         \"Pgm2\"          \"Mertk\"         #> [157] \"Pth1r\"         \"Itga2b\"        \"Kctd12\"        \"Srd5a3\"        #> [161] \"Bmp5\"          \"Pecam1\"        \"G6pc3\"         \"Cyp17a1\"       #> [165] \"Stab2\"         \"Cygb\"          \"Col1a2\"        \"Nid1\"          #> [169] \"Cd44\"          \"Ctnnal1\"       \"Ephb4\"         \"Elk3\"          #> [173] \"Foxq1\"         \"Cxcl14\"        \"Fzd4\"          \"Itgb2\"         #> [177] \"Tcf7\"          \"Srd5a2\"        \"Aldh3b1\"       \"Flt4\"          #> [181] \"Selp\"          \"Rbpj\"          \"Ep300\"         \"Rhoj\"          #> [185] \"Fzd1\"          \"Tcf7l2\"        \"Ssh2\"          \"Col6a1\"        #> [189] \"Notch2\"        \"Tcf4\"          \"Tek\"           \"Trim47\"        #> [193] \"Tent5c\"        \"Ncf1\"          \"Lepr\"          \"Pck2\"          #> [197] \"Lmnb1\"         \"Selplg\"        \"Myh10\"         \"Aldoart1\"      #> [201] \"Podxl\"         \"Kitl\"          \"Tcf3\"          \"Tspan13\"       #> [205] \"Dll4\"          \"Fzd8\"          \"Lad1\"          \"Procr\"         #> [209] \"Ccr2\"          \"Akr1c18\"       \"Maml1\"         \"Ms4a1\"         #> [213] \"Hk3\"           \"Bcam\"          \"Fzd5\"          \"Dkk3\"          #> [217] \"Bank1\"         \"Itgal\"         \"Pgam2\"         \"Axin2\"         #> [221] \"Pfkp\"          \"Meis2\"         \"Jag1\"          \"Gimap3\"        #> [225] \"Rassf4\"        \"Notch1\"        \"Cd93\"          \"Tet2\"          #> [229] \"Tcf7l1\"        \"Cd34\"          \"Hvcn1\"         \"Mal\"           #> [233] \"Itgb7\"         \"Wnt4\"          \"Kit\"           \"Gapdhs\"        #> [237] \"Kcnj16\"        \"Tnfrsf13c\"     \"Hk1\"           \"Pdgfra\"        #> [241] \"Apobec3\"       \"Slc34a2\"       \"Vav1\"          \"Lamp3\"         #> [245] \"Meis1\"         \"Lck\"           \"Efnb2\"         \"Notch4\"        #> [249] \"Klrb1c\"        \"Angpt2\"        \"Vwf\"           \"E2f2\"          #> [253] \"Ccr1\"          \"Angpt1\"        \"B4galt6\"       \"Cyp21a1\"       #> [257] \"Pdpn\"          \"Dll1\"          \"Ammecr1\"       \"Csf3r\"         #> [261] \"Ndn\"           \"Fgf2\"          \"Runx1\"         \"Mpl\"           #> [265] \"Mecom\"         \"Itgam\"         \"Hoxb4\"         \"Tox\"           #> [269] \"Prickle2\"      \"Acss1\"         \"Cyp2b9\"        \"Aldh3a1\"       #> [273] \"Bmp7\"          \"Gata2\"         \"Il7r\"          \"Satb1\"         #> [277] \"Sfrp1\"         \"Eno2\"          \"Mrvi1\"         \"Mki67\"         #> [281] \"Nes\"           \"Tmod1\"         \"Ace\"           \"Gfap\"          #> [285] \"Tgfb2\"         \"Tomt\"          \"Flt3\"          \"Sult2b1\"       #> [289] \"Hkdc1\"         \"Notch3\"        \"Cdh11\"         \"Il6\"           #> [293] \"Hk2\"           \"Mmrn1\"         \"Vangl2\"        \"Pou2af1\"       #> [297] \"Hoxb5\"         \"Jag2\"          \"Aldh3b2\"       \"Gypa\"          #> [301] \"Lrp2\"          \"Lef1\"          \"Olr1\"          \"Lox\"           #> [305] \"Txlnb\"         \"Slc12a1\"       \"Aldh3b3\"       \"Cxcr2\"         #> [309] \"Nkd2\"          \"Sult1e1\"       \"Acsl6\"         \"Ddx4\"          #> [313] \"Ldhc\"          \"Kcnj1\"         \"Acsbg1\"        \"Fzd3\"          #> [317] \"F13a1\"         \"Hsd11b2\"       \"Dkk2\"          \"Hsd17b1\"       #> [321] \"Fzd2\"          \"Cyp2b23\"       \"Eno4\"          \"Celsr2\"        #> [325] \"Obscn\"         \"Slamf1\"        \"Akap14\"        \"Gnaz\"          #> [329] \"Cd177\"         \"Tet1\"          \"Cspg4\"         \"Aldoart2\"      #> [333] \"Cyp2b19\"       \"Ryr2\"          \"Ldhal6b\"       \"Acsf3\"         #> [337] \"Chodl\"         \"Ivl\"           \"Cyp11b1\"       \"Sfrp2\"         #> [341] \"Dkk1\"          \"Cyp11a1\"       \"1700061G19Rik\" \"Acsbg2\"        #> [345] \"Olah\"          \"Pdha2\"         \"Hsd17b3\"       \"Blank-0\"       #> [349] \"Blank-1\"       \"Blank-2\"       \"Blank-3\"       \"Blank-4\"       #> [353] \"Blank-5\"       \"Blank-6\"       \"Blank-7\"       \"Blank-8\"       #> [357] \"Blank-9\"       \"Blank-10\"      \"Blank-11\"      \"Blank-12\"      #> [361] \"Blank-13\"      \"Blank-14\"      \"Blank-15\"      \"Blank-16\"      #> [365] \"Blank-17\"      \"Blank-18\"      \"Blank-19\"      \"Blank-20\"      #> [369] \"Blank-21\"      \"Blank-22\"      \"Blank-23\"      \"Blank-24\"      #> [373] \"Blank-25\"      \"Blank-26\"      \"Blank-27\"      \"Blank-28\"      #> [377] \"Blank-29\"      \"Blank-30\"      \"Blank-31\"      \"Blank-32\"      #> [381] \"Blank-33\"      \"Blank-34\"      \"Blank-35\"      \"Blank-36\"      #> [385] \"Blank-37\" n_panel <- 347 colData(sfe)$nCounts_normed <- sfe$nCounts / n_panel colData(sfe)$nGenes_normed <- sfe$nGenes / n_panel plotColDataHistogram(sfe, c(\"nCounts_normed\", \"nGenes_normed\")) +     theme_bw() plotSpatialFeature(sfe, \"nGenes\", colGeometryName = \"centroids\", scattermore = TRUE) plotSpatialFeature(sfe, \"volume\", colGeometryName = \"centroids\", scattermore = TRUE) plotColDataBin2D(sfe, \"nCounts\", \"nGenes\") +      theme_bw() plotColDataBin2D(sfe, \"volume\", \"nCounts\") + theme_bw() plotColDataBin2D(sfe, \"volume\", \"nGenes\") + theme_bw()"},{"path":"https://pachterlab.github.io/voyager/articles/vig6_merfish.html","id":"negative-controls","dir":"Articles","previous_headings":"Quality control","what":"Negative controls","title":"MERFISH mouse liver dataset and considerations of large data","text":"Blank probes used negative controls Total transcript counts blank probes  Number blank features detected per cell  Percentage blank features per cell  percentage interesting: within tissue, cells high percentage blank counts scattered like salt pepper, cells left edge tissue, edges FOVs, tissue doesn’t end. Also plot histograms  NA’s cells without transcript detected. Unlike Xenium dataset, cells least one blank count. log transforming, zeroes removed plot.  small percentage blank counts acceptable. remove outlier based distribution percentage ’s greater zero. blank percentage relate total counts?  outliers percentage blank counts low total counts. seemingly real cells sizable nCounts also low percentage blank counts. Since distribution percentage long tail, log transform finding outliers. proportion cells outliers? ’s cutoff outlier? Remove outliers empty cells ’re still 390,000 cells left.","code":"is_blank <- str_detect(rownames(sfe), \"^Blank-\") sfe <- addPerCellQCMetrics(sfe, subset = list(blank = is_blank)) names(colData(sfe)) #>  [1] \"fov\"                    \"volume\"                 \"min_x\"                  #>  [4] \"max_x\"                  \"min_y\"                  \"max_y\"                  #>  [7] \"sample_id\"              \"nCounts\"                \"nGenes\"                 #> [10] \"nCounts_normed\"         \"nGenes_normed\"          \"sum\"                    #> [13] \"detected\"               \"subsets_blank_sum\"      \"subsets_blank_detected\" #> [16] \"subsets_blank_percent\"  \"total\" plotSpatialFeature(sfe, \"subsets_blank_sum\", colGeometryName = \"centroids\",                    scattermore = TRUE) plotSpatialFeature(sfe, \"subsets_blank_detected\", colGeometryName = \"centroids\",                    scattermore = TRUE) plotSpatialFeature(sfe, \"subsets_blank_percent\", colGeometryName = \"centroids\",                    scattermore = TRUE) plotColDataHistogram(sfe, paste0(\"subsets_blank_\", c(\"sum\", \"detected\", \"percent\"))) +     theme_bw() #> Warning: Removed 1332 rows containing non-finite values (`stat_bin()`). mean(sfe$subsets_blank_sum > 0) #> [1] 0.7648799 plotColDataHistogram(sfe, \"subsets_blank_percent\") +     scale_x_log10() +     annotation_logticks() +     theme_bw() #> Warning: Transformation introduced infinite values in continuous x-axis #> Warning: Removed 92923 rows containing non-finite values (`stat_bin()`). plotColDataBin2D(sfe, \"nCounts\", \"subsets_blank_percent\") +     scale_fill_viridis_c() +     theme_bw() #> Scale for fill is already present. #> Adding another scale for fill, which will replace the existing scale. #> Warning: Removed 1332 rows containing non-finite values #> (`stat_bin2d()`). get_neg_ctrl_outliers <- function(col, sfe, nmads = 3, log = FALSE) {     inds <- colData(sfe)$nCounts > 0 & colData(sfe)[[col]] > 0     df <- colData(sfe)[inds,]     outlier_inds <- isOutlier(df[[col]], type = \"higher\", nmads = nmads, log = log)     outliers <- rownames(df)[outlier_inds]     col2 <- str_remove(col, \"^subsets_\")     col2 <- str_remove(col2, \"_percent$\")     new_colname <- paste(\"is\", col2, \"outlier\", sep = \"_\")     colData(sfe)[[new_colname]] <- colnames(sfe) %in% outliers     sfe } sfe <- get_neg_ctrl_outliers(\"subsets_blank_percent\", sfe, log = TRUE) mean(sfe$is_blank_outlier) #> [1] 0.008944499 min(sfe$subsets_blank_percent[sfe$is_blank_outlier]) #> [1] 2.303523 (sfe <- sfe[, !sfe$is_blank_outlier & sfe$nCounts > 0]) #> class: SpatialFeatureExperiment  #> dim: 385 390348  #> metadata(0): #> assays(1): counts #> rownames(385): Comt Ldha ... Blank-36 Blank-37 #> rowData names(3): means vars cv2 #> colnames(390348): 10482024599960584593741782560798328923 #>   111551578131181081835796893618918348842 ... #>   92389687374928708938472537234969690424 #>   96399783859933548456002372694492036651 #> colData names(18): fov volume ... total is_blank_outlier #> reducedDimNames(0): #> mainExpName: NULL #> altExpNames(0): #> spatialCoords names(2) : center_x center_y #> imgData names(1): sample_id #>  #> Geometries: #> colGeometries: centroids (POINT), cellSeg (POLYGON)  #>  #> Graphs: #> sample01:"},{"path":"https://pachterlab.github.io/voyager/articles/vig6_merfish.html","id":"genes","dir":"Articles","previous_headings":"Quality control","what":"Genes","title":"MERFISH mouse liver dataset and considerations of large data","text":"look mean variance gene  genes display higher mean expression blanks, considerable overlap distribution, probably genes expressed lower levels fewer cells included. “real” genes negative controls plotted different colors  red line \\(y = x\\) expected data follows Poisson distribution.  zoomed , blanks also somewhat overdispersed.","code":"rowData(sfe)$means <- rowMeans(counts(sfe)) rowData(sfe)$vars <- rowVars(counts(sfe)) rowData(sfe)$is_blank <- is_blank plotRowData(sfe, x = \"means\", y = \"is_blank\") +     scale_y_log10() +     annotation_logticks(sides = \"b\") plotRowData(sfe, x = \"means\", y = \"vars\", colour_by = \"is_blank\") +     geom_abline(slope = 1, intercept = 0, color = \"red\") +     scale_x_log10() + scale_y_log10() +     annotation_logticks() +     coord_equal() +     theme_bw() as.data.frame(rowData(sfe)[is_blank,]) |>      ggplot(aes(means, vars)) +     geom_point() +     geom_abline(slope = 1, intercept = 0, color = \"red\") +     scale_x_log10() + scale_y_log10() +     annotation_logticks() +     coord_equal() +     theme_bw()"},{"path":"https://pachterlab.github.io/voyager/articles/vig6_merfish.html","id":"spatial-autocorrelation-of-qc-metrics","dir":"Articles","previous_headings":"","what":"Spatial autocorrelation of QC metrics","title":"MERFISH mouse liver dataset and considerations of large data","text":", plot zoomed patch visually inspect cell-cell contiguity  ’re quite cells contiguous cell, cell segmentation imperfect, purely using poly2nb() problematic. next release, might implement way blend polygon contiguity graph graph case singletons. now use k nearest neighbors, \\(k = 5\\), seems like reasonable approximation contiguity based visual inspection. spdep implementation k nearest neighbors isn’t bad, taking longer song (radio edit Italodance server, like full Trance Ethereal Techno song GitHub Actions). Annoy faster way find approximate k nearest neighbors, used graph based clustering scRNA-seq data. One way use Annoy R use AnnoyParam() BiocNeighbors. examine speed Annoy, convert results nb object spdep, inverse distance weighting. profiling, time constructed spatial weights matrix spent nb2listwdist(), perform distance weighting. output findKNN() contains matrix indices neighbors, another matrix distances neighbors. speed code, directly compute inverse distance edge weights without using nb2listwdist() format data listw structure. functions knn2nb() nb2listwdist() involve slow R loops flexible many kinds graphs. took half time spdep, formalize add next release. necessarily Annoy faster kd tree method dbscan, used spdep, much time spent nb2listwdist() compute distance based edge weights geometry, spdep take distance matrix returned dbscan::kNN() used distance matrix BiocNeighbors::findKNN() rather using geometry find distance . next release, also use BiocNeighbors distance based neighbors, also returns distance list, can used compute distance based edge weights efficiently nb2listwdist(). comparison results shown : large results similar, small differences Annoy finds approximate k nearest neighbors. spatial neighborhood graph, can compute Moran’s QC metrics. Unlike smFISH-based datasets website, nCounts nGenes sizable negative Moran’s ’s, closer 0 volume. interesting compare metrics across different tissues, add datasets SFEData future releases. Also check local Moran’s , since little patch examined , regions may positive spatial autocorrelation.  niches around smaller blood vessels positive local Moran’s nCounts nGenes. likely due homogeneous endothelial cells compared hepatocytes.","code":"ggplot(cellSeg(sfe)[st_as_sfc(st_bbox(bbox_use)),]) + geom_sf() system.time(     colGraph(sfe, \"knn5\") <- findSpatialNeighbors(sfe, method = \"knearneigh\",                                                    dist_type = \"idw\", k = 5,                                                    style = \"W\") ) #>    user  system elapsed  #> 369.612   1.018 371.526 system.time({     foo <- findKNN(spatialCoords(sfe), k=5, BNPARAM=AnnoyParam())     # Split by row     foo_nb <- asplit(foo$index, 1)     dmat <- 1/foo$distance     # Row normalize the weights     dmat <- sweep(dmat, 1, rowSums(dmat), FUN = \"/\")     glist <- asplit(dmat, 1)     # Sort based on index     ord <- lapply(foo_nb, order)     foo_nb <- lapply(seq_along(foo_nb), function(i) foo_nb[[i]][ord[[i]]])     class(foo_nb) <- \"nb\"     glist <- lapply(seq_along(glist), function(i) glist[[i]][ord[[i]]])          listw <- list(style = \"W\",                   neighbours = foo_nb,                   weights = glist)     class(listw) <- \"listw\" }) #>    user  system elapsed  #> 154.965   3.086 158.532 diff_nbs <- diffnb(colGraph(sfe, \"knn5\")$neighbours, foo_nb) diff_card <- card(diff_nbs) summary(diff_card) #>      Min.   1st Qu.    Median      Mean   3rd Qu.      Max.  #> 0.0000000 0.0000000 0.0000000 0.0001537 0.0000000 2.0000000 sfe <- colDataMoransI(sfe, c(\"nCounts\", \"nGenes\", \"volume\"),                        colGraphName = \"knn5\") colFeatureData(sfe)[c(\"nCounts\", \"nGenes\", \"volume\"),] #> DataFrame with 3 rows and 2 columns #>         moran_sample01 K_sample01 #>              <numeric>  <numeric> #> nCounts     -0.1084532    4.22513 #> nGenes      -0.0922130    2.25923 #> volume      -0.0195237    3.89406 sfe <- colDataUnivariate(sfe, type = \"localmoran\",                           features = c(\"nCounts\", \"nGenes\", \"volume\"),                          colGraphName = \"knn5\") plotLocalResult(sfe, \"localmoran\", c(\"nCounts\", \"nGenes\", \"volume\"),                 colGeometryName = \"centroids\", scattermore = TRUE,                 ncol = 2, divergent = TRUE, diverge_center = 0)"},{"path":"https://pachterlab.github.io/voyager/articles/vig6_merfish.html","id":"morans-i","dir":"Articles","previous_headings":"","what":"Moran’s I","title":"MERFISH mouse liver dataset and considerations of large data","text":"’s actually slow thought almost 400,000 cells. Moran’s ’s distributed real genes blank probes?  blanks clustered tightly around 0. vast majority real genes positive spatial autocorrelation, quite strong. genes negative spatial autocorrelation, although may may statistically significant. Plot top genes positive spatial autocorrelation  Unlike smFISH-based cancer datasets dataset, genes highest Moran’s highlight different histological regions. probably zones hepatic lobule, blood vessels. interesting compare spatial autocorrelation marker genes among different tissues cell types. Negative Moran’s means nearby cells tend dissimilar . hard see plotting whole tissue section, use bounding box . gene negative Moran’s compared one Moran’s closest 0.  took since bottleneck spatial subsetting bounding box performed twice. next release, subsetting done multiple features plotted. expected, feature Moran’s closest 0 blank.","code":"sfe <- logNormCounts(sfe) system.time(     sfe <- runMoransI(sfe, BPPARAM = MulticoreParam(2)) ) #>    user  system elapsed  #> 220.117  24.417 134.661 plotRowData(sfe, x = \"moran_sample01\", y = \"is_blank\") +     geom_hline(yintercept = 0, linetype = 2) top_moran <- rownames(sfe)[order(rowData(sfe)$moran_sample01, decreasing = TRUE)[1:6]] plotSpatialFeature(sfe, top_moran, colGeometryName = \"centroids\", scattermore = TRUE,                    ncol = 2) bottom_moran <- rownames(sfe)[order(rowData(sfe)$moran_sample01)[1]] bottom_abs_moran <- rownames(sfe)[order(abs(rowData(sfe)$moran_sample01))[1]] plot_colgeom_bbox(sfe, bottom_moran, bbox_use) + plot_colgeom_bbox(sfe, bottom_abs_moran, bbox_use)"},{"path":"https://pachterlab.github.io/voyager/articles/vig6_merfish.html","id":"spatial-autocorrelation-at-larger-length-scales","dir":"Articles","previous_headings":"","what":"Spatial autocorrelation at larger length scales","title":"MERFISH mouse liver dataset and considerations of large data","text":"k nearest neighbor graph used concerns 5 cells around cell, small neighborhood, small length scale. current release Voyager, correlogram can computed get sense length scale spatial autocorrelation. However, since finding lag values higher higher orders neighborhoods slow large number cells higher orders, correlogram helpful . section, use methods involving binning explore spatial autocorrelation larger length scales.","code":""},{"path":"https://pachterlab.github.io/voyager/articles/vig6_merfish.html","id":"binning","dir":"Articles","previous_headings":"Spatial autocorrelation at larger length scales","what":"Binning","title":"MERFISH mouse liver dataset and considerations of large data","text":"sf package can create polygons grid, can bin cells attributes gene expressions. make 100 100 hexagonal grid bounding box cell centroids. use grid bin QC metrics averaging values cells. Since bins completely covered tissue fewer cells, mean may less susceptible edge effect sum, bins near edge lower sums, may spuriously increase Moran’s . Plot binned values  ’s outlier bin evident plotting single cells. ’s still edge effect around blood vessels. might truly edge effect, endothelial cells tend lower values 3 variables . compute Moran’s binned data, contiguity neighborhoods. zero.policy = TRUE bins neighbors. larger length scale, Moran’s becomes positive. Comparing Moran’s across different sized bins can give sense length scale spatial autocorrelation. However, problems binning watch : Edge effect, especially using sum binning function use aggregate values binning using rectangular grid, whether use rook queen neighbors. Rook means two cells neighbors share edge, queen means neighbors even merely share vertex. binning can greatly speed computation spatial autocorrelation metrics larger datasets, fact used Moran’s Seurat, can used smaller datasets find length scales spatial autocorrelation. hand, seen , Moran’s can flip signs different length scales, larger datasets, exploring spatial autocorrelation cell level still interesting.","code":"(bins <- st_make_grid(colGeometry(sfe, \"centroids\"), n = 100, square = FALSE)) #> Geometry set for 11165 features  #> Geometry type: POLYGON #> Dimension:     XY #> Bounding box:  xmin: -137.2225 ymin: -158.8407 xmax: 10396.09 ymax: 9708.547 #> CRS:           NA #> First 5 geometries: #> POLYGON ((-85.58866 -69.40817, -137.2225 -39.59... #> POLYGON ((-85.58866 109.4569, -137.2225 139.267... #> POLYGON ((-85.58866 288.3219, -137.2225 318.132... #> POLYGON ((-85.58866 467.1869, -137.2225 496.997... #> POLYGON ((-85.58866 646.052, -137.2225 675.8628... df <- cbind(colGeometry(sfe, \"centroids\"), colData(sfe)[,c(\"nCounts\", \"nGenes\", \"volume\")]) df_binned <- aggregate(df, bins, FUN = mean) # Remove bins not containing cells df_binned <- df_binned[!is.na(df_binned$nCounts),] # Not using facet_wrap to give each panel its own color scale plts <- lapply(c(\"nCounts\", \"nGenes\", \"volume\"), function(f) {     ggplot(df_binned[,f]) + geom_sf(aes_string(fill = f), linewidth = 0) +         scale_fill_distiller(palette = \"Blues\", direction = 1) }) wrap_plots(plts, nrow = 2) nb <- poly2nb(df_binned) listw <- nb2listw(nb, zero.policy = TRUE) calculateMoransI(t(as.matrix(st_drop_geometry(df_binned[,c(\"nCounts\", \"nGenes\", \"volume\")]))),                  listw = listw, zero.policy = TRUE) #> DataFrame with 3 rows and 2 columns #>             moran         K #>         <numeric> <numeric> #> nCounts  0.490837   5.21703 #> nGenes   0.422267  16.10323 #> volume   0.352221   4.78100"},{"path":"https://pachterlab.github.io/voyager/articles/vig6_merfish.html","id":"semivariogram","dir":"Articles","previous_headings":"Spatial autocorrelation at larger length scales","what":"Semivariogram","title":"MERFISH mouse liver dataset and considerations of large data","text":"geostatistical data, underlying spatial process sampled known locations. Kriging uses Gaussian process interpolate values sample locations, semivariogram used model spatial dependency locations, covariance Gaussian process. kriging, semivariogram can used exploratory data analysis tool find length scale anisotropy spatial autocorrelation. One classic R packages geostatistical tradition gstat, use find semivariograms, defined \\[ \\gamma(t) = \\frac 1 2 \\mathrm{Var}(X_t - X_0), \\] \\(X\\) value gene expression, \\(t\\) spatial vector. \\(X_0\\) value location interest, \\(X_t\\) value lagged \\(t\\). positive spatial autocorrelation, variance smaller among nearby values, variogram increase distance, eventually leveling distance beyond length scale spatial autocorrelation. “semi” comes 1/2. next release Voyager, part runUnivariate() learning curve users minimal. First find empirical variogram assuming ’s directions. data binned distance intervals, much faster correlogram cell level. width argument controlls bin size. cutoff argument maximum distance consider. use defaults. first argument formula; covariates can specified, done . different widths cutoffs, variogram can estimated different length scales. gstat package can also fit model empirical variogram. See vgm() different types models. automap package can choose model user, used . Unfortunately, gstat doesn’t scale 400,000 cells, although worked 100,000 cells smFISH-based datasets website. since variogram used explore larger length scales anyway, use binned data , problems binning apply.  numbers plot number pairs distance bin. variogram 0 0 distance; variance within bin size, called nugget. variogram levels greater distance, value variogram levels sill. Range variogram leveling , indicating length scale spatial autocorrelation; range visual inspection appears closer 1000 model somehow indicates 423. variogram map can made see spatial autocorrelation may differ different directions, .e. anisotropy  apparently ’s anisotropy shorter length scales, may artifact hexagonal bins. Going beyond 2000 (whatever unit), variance drops northwest southeast direction directions, perhaps related repetitiveness hepatic lobules general NE/SW direction blood vessels seen previous plots. variogram can also calculated specified angles, selected sides hexagon:  variogram rises going beyond 2000 30 90 degrees drops 150 degrees. consistent variogram map. differences averaged omni-directional variogram. gstat fit anisotropy parameters, fitted curve omni-directional. fits pretty well 2000. nCounts, may differ QC metrics genes. anisotropy varies space? problem variogram ’s global, giving one result entire dataset, albeit nuanced just number Moran’s , kriging assumes data intrinsically stationary, meaning variogram model applies everywhere, spatial dependence depends lag two observations. next release voyager, write ggplot2 based plotting functions make better looking customizable plots variograms. gstat using lattice, predecessor ggplot2 make facetted plots superseded ggplot2. gstat one oldest R packages still CRAN, dating back days S (prequel R), although oldest archive CRAN 2003. spdep also really old; oldest archive CRAN 2002, ’s still active development. using time honored packages methods (Moran’s Geary’s C date back 1950s modern form date back 1969 (Cliff Ord 1969; Bivand 2013)) cool new spatial transcriptomics dataset, participating glorious tradition, develop spatial analysis tradition forms around spatial -omics data analysis.","code":"# as_Spatial since automap uses old fashioned sp, the predecessor of sf v <- autofitVariogram(nCounts ~ 1, as_Spatial(df_binned)) plot(v) v2 <- variogram(nCounts ~ 1, data = df_binned, width = 300, cutoff = 4500, map = TRUE) plot(v2) v3 <- variogram(nCounts ~ 1, df_binned, alpha = c(30, 90, 150)) v3_model <- fit.variogram(v3, vgm(\"Ste\")) #> Warning in direct[direct$id == id, \"is.direct\"] && any(model$psill < 0): #> 'length(x) = 3 > 1' in coercion to 'logical(1)' plot(v3, v3_model)"},{"path":"https://pachterlab.github.io/voyager/articles/vig6_merfish.html","id":"pca-for-larger-datasets","dir":"Articles","previous_headings":"","what":"PCA for larger datasets","title":"MERFISH mouse liver dataset and considerations of large data","text":"many ways PCA R, BiocSingular package makes number different methods available consistent user interface, supports memory data DelayedArray. According benchmark, stats::prcomp() shipped R rather slow larger datasets. fastest methods irlba::irlba() RSpectra::svds(), former supported BiocSingular. use IRLBA see long takes. Many PCA algorithms involve repeated matrix multiplications. R come optimized BLAS LAPACK, portability reasons. However, BLAS LAPACK used R can changed optimized one (’s ), speed matrix multiplication. ’s pretty quick almost 400,000 cells, aren’t many genes . Use elbow plot see variance explained PC:  Plot top gene loadings PC  Many genes seem related endothelium. Plot first 4 PCs space  PC1 PC4 highlight major blood vessels, PC2 PC3 less spatial structure. CosMX Xenium datasets website, top PCs clear spatial structures despite absence spatial information non-spatial PCA clear spatial compartments cell types, seem case dataset except blood vessels. seen genes strong spatial structures. methods spatially informed PCA, MULTISPATI PCA (Dray, Saı̈d, Débias 2008) adespatial package, seeks maximize variance (non-spatial PCA) Moran’s PC. Unlike traditional PCs, eigenvalues, signifying variance explained, positive, MULTISPATI PCA can negative eigenvalues, signify negative spatial autocorrelation. PCs MULTISPATI PCA positive eigenvalues also spatially coherent non-spatial PCA. CosMX Xenium datasets website, spatial coherence MULTISPATI might make difference, might make difference dataset non-spatial PCs don’t show much spatial structure, least larger scale entire tissue section. use makeshift function plot zoomed patch  ’s spatial structure PC2 PC3 smaller scale. Like global Moran’s , PCA MULTISPATI PCA return one result entire dataset. contrast, geographically weighted PCA (GWPCA) (Harris et al. 2015) can account spatial heterogeneity. GWPCA runs PCA spatial location using nearby locations weighed kernel. different locations can different PCs, results can visualized “winning variables” PC, .e. plotting feature highest loading PC space. likely doesn’t scale 400,000 cells, still interesting performed spatially binned data. first release Voyager univariate spatial analysis methods. plan add bivariate multivariate methods next release, include MULTISPATI PCA GWPCA, scalable re-implementation.","code":"set.seed(29) system.time(     sfe <- runPCA(sfe, ncomponents = 20, subset_row = !is_blank,                   exprs_values = \"logcounts\",                   scale = TRUE, BSPARAM = IrlbaParam()) ) #>    user  system elapsed  #>  23.742   1.760  25.546 gc() #>             used   (Mb) gc trigger   (Mb) limit (Mb)  max used   (Mb) #> Ncells  19507145 1041.8   34708228 1853.7         NA  34708228 1853.7 #> Vcells 261753411 1997.1  585320657 4465.7      16384 585138646 4464.3 ElbowPlot(sfe) + theme_bw() plotDimLoadings(sfe) + theme_bw() spatialReducedDim(sfe, \"PCA\", 4, colGeometryName = \"centroids\", scattermore = TRUE,                   divergent = TRUE, diverge_center = 0) colData(sfe)$PC2 <- reducedDim(sfe, \"PCA\", withDimnames = FALSE)[,2] colData(sfe)$PC3 <- reducedDim(sfe, \"PCA\", withDimnames = FALSE)[,3] plot_colgeom_bbox(sfe, \"PC2\", bbox_use, divergent = TRUE, diverge_center = 0) +  plot_colgeom_bbox(sfe, \"PC3\", bbox_use, divergent = TRUE, diverge_center = 0)"},{"path":"https://pachterlab.github.io/voyager/articles/vig6_merfish.html","id":"more-challenges-from-large-datasets","dir":"Articles","previous_headings":"","what":"More challenges from large datasets","title":"MERFISH mouse liver dataset and considerations of large data","text":", despite numerous cells, data loaded memory. data doesn’t fit memory? next release, plan write new vignette DelayedArray demonstrating memory data analysis. already supported SingleCellExperiment, SFE inherits . However, geometries, graphs, local results can take lot memory well. can possibly stored SQL databases operated SQLDataFrame. geometric operations can handled sedona, although options limited compared GEOS, performs geometric operations behind scene sf. Another question can raised large spatial transcriptomics data: still good idea analyze entire dataset ? must many interesting unique neighborhoods might get attention deserve whole dataset analyzed . , geographical space, national level data usually analyzed block resolution, although reason privacy subjects. County resolution often used, aren’t hundreds thousands counties. Many analyses done cities counties neighborhood resolution; using largest geographical unit isn’t always relevant. Back histological space: aggregate cells larger spatial units? decide scale spatial units (analogous nation vs state vs county etc) relevant? traditional anatomical ontologies, Allen Brain Atlas, isn’t available tissues. Also, single cell -omics data, traditional ontologies can improved. Furthermore, 3D thick section single cell resolution spatial transcriptomics data, STARmap (X. Wang et al. 2018) EASI-FISH (Y. Wang et al. 2021), although vast majority spatial -omics data thin sections pretty much de facto 2D. mostly live surface Earth, many 2D geospatial resources 3D. However, methods can principle applied 3D existing software primarily made 2D data might work. example, GEOS supports 3D data, principle 3D geometries sf work, although ’s little documentation . Also, k nearest neighbor, Moran’s , variograms, etc. principle work 3D, gstat officially supports 3D. challenges related 3D data: Even multiple z-planes imaged, resolution much lower z direction x y directions. z-plane treated attribute coordinate? make static plots 3D data publications? complicated plotting z-planes separately, since 3D block can sectioned direction. Also interactive visualization, need somehow see tissue. Finally, geospatial tradition one tradition relevant large spatial data, present Voyager works vector data. uncertain whether raster added later version, existing tools large raster data well, TileDB. traditions can relevant, astronomy image processing, beyond scope package.","code":""},{"path":"https://pachterlab.github.io/voyager/articles/vig6_merfish.html","id":"session-info","dir":"Articles","previous_headings":"","what":"Session Info","title":"MERFISH mouse liver dataset and considerations of large data","text":"","code":"sessionInfo() #> R version 4.2.2 (2022-10-31) #> Platform: x86_64-apple-darwin17.0 (64-bit) #> Running under: macOS Big Sur ... 10.16 #>  #> Matrix products: default #> BLAS:   /Library/Frameworks/R.framework/Versions/4.2/Resources/lib/libRblas.0.dylib #> LAPACK: /Library/Frameworks/R.framework/Versions/4.2/Resources/lib/libRlapack.dylib #>  #> locale: #> [1] en_US.UTF-8/en_US.UTF-8/en_US.UTF-8/C/en_US.UTF-8/en_US.UTF-8 #>  #> attached base packages: #> [1] stats4    stats     graphics  grDevices utils     datasets  methods   #> [8] base      #>  #> other attached packages: #>  [1] SpatialFeatureExperiment_1.0.3 automap_1.0-16                 #>  [3] BiocNeighbors_1.16.0           gstat_2.1-0                    #>  [5] BiocSingular_1.14.0            BiocParallel_1.32.5            #>  [7] spdep_1.2-7                    sf_1.0-9                       #>  [9] spData_2.2.1                   sp_1.6-0                       #> [11] stringr_1.5.0                  patchwork_1.1.2                #> [13] scater_1.27.3                  ggplot2_3.4.0                  #> [15] scuttle_1.8.4                  SpatialExperiment_1.8.0        #> [17] SingleCellExperiment_1.20.0    SummarizedExperiment_1.28.0    #> [19] Biobase_2.58.0                 GenomicRanges_1.50.2           #> [21] GenomeInfoDb_1.34.7            IRanges_2.32.0                 #> [23] S4Vectors_0.36.1               BiocGenerics_0.44.0            #> [25] MatrixGenerics_1.10.0          matrixStats_0.63.0             #> [27] SFEData_1.0.2                  Voyager_1.0.8                  #>  #> loaded via a namespace (and not attached): #>   [1] utf8_1.2.2                    R.utils_2.12.2                #>   [3] tidyselect_1.2.0              RSQLite_2.2.20                #>   [5] AnnotationDbi_1.60.0          grid_4.2.2                    #>   [7] maptools_1.1-6                DropletUtils_1.18.1           #>   [9] munsell_0.5.0                 ScaledMatrix_1.6.0            #>  [11] codetools_0.2-18              ragg_1.2.5                    #>  [13] units_0.8-1                   withr_2.5.0                   #>  [15] colorspace_2.1-0              filelock_1.0.2                #>  [17] highr_0.10                    knitr_1.42                    #>  [19] wk_0.7.1                      labeling_0.4.2                #>  [21] GenomeInfoDbData_1.2.9        bit64_4.0.5                   #>  [23] farver_2.1.1                  rhdf5_2.42.0                  #>  [25] rprojroot_2.0.3               vctrs_0.5.2                   #>  [27] generics_0.1.3                xfun_0.36                     #>  [29] BiocFileCache_2.6.0           R6_2.5.1                      #>  [31] ggbeeswarm_0.7.1              rsvd_1.0.5                    #>  [33] locfit_1.5-9.7                bitops_1.0-7                  #>  [35] rhdf5filters_1.10.0           cachem_1.0.6                  #>  [37] reshape_0.8.9                 DelayedArray_0.24.0           #>  [39] assertthat_0.2.1              promises_1.2.0.1              #>  [41] scales_1.2.1                  beeswarm_0.4.0                #>  [43] gtable_0.3.1                  beachmat_2.14.0               #>  [45] rlang_1.0.6                   systemfonts_1.0.4             #>  [47] hexbin_1.28.2                 scico_1.3.1                   #>  [49] BiocManager_1.30.19           s2_1.1.2                      #>  [51] yaml_2.3.7                    httpuv_1.6.8                  #>  [53] tools_4.2.2                   ellipsis_0.3.2                #>  [55] jquerylib_0.1.4               RColorBrewer_1.1-3            #>  [57] proxy_0.4-27                  Rcpp_1.0.10                   #>  [59] plyr_1.8.8                    sparseMatrixStats_1.10.0      #>  [61] zlibbioc_1.44.0               classInt_0.4-8                #>  [63] purrr_1.0.1                   RCurl_1.98-1.10               #>  [65] dbscan_1.1-11                 deldir_1.0-6                  #>  [67] viridis_0.6.2                 cowplot_1.1.1                 #>  [69] zoo_1.8-11                    ggrepel_0.9.2                 #>  [71] cluster_2.1.4                 fs_1.6.0                      #>  [73] magrittr_2.0.3                scattermore_0.8               #>  [75] magick_2.7.3                  spacetime_1.2-8               #>  [77] ggnewscale_0.4.8              mime_0.12                     #>  [79] evaluate_0.20                 xtable_1.8-4                  #>  [81] gridExtra_2.3                 compiler_4.2.2                #>  [83] tibble_3.1.8                  KernSmooth_2.23-20            #>  [85] crayon_1.5.2                  R.oo_1.25.0                   #>  [87] htmltools_0.5.4               later_1.3.0                   #>  [89] DBI_1.1.3                     ExperimentHub_2.6.0           #>  [91] dbplyr_2.3.0                  rappdirs_0.3.3                #>  [93] boot_1.3-28.1                 Matrix_1.5-3                  #>  [95] cli_3.6.0                     R.methodsS3_1.8.2             #>  [97] parallel_4.2.2                igraph_1.3.5                  #>  [99] pkgconfig_2.0.3               pkgdown_2.0.7                 #> [101] foreign_0.8-84                vipor_0.4.5                   #> [103] bslib_0.4.2                   dqrng_0.3.0                   #> [105] XVector_0.38.0                digest_0.6.31                 #> [107] Biostrings_2.66.0             rmarkdown_2.20                #> [109] intervals_0.15.2              edgeR_3.40.2                  #> [111] DelayedMatrixStats_1.20.0     curl_5.0.0                    #> [113] shiny_1.7.4                   rjson_0.2.21                  #> [115] lifecycle_1.0.3               jsonlite_1.8.4                #> [117] Rhdf5lib_1.20.0               desc_1.4.2                    #> [119] viridisLite_0.4.1             limma_3.54.1                  #> [121] fansi_1.0.4                   pillar_1.8.1                  #> [123] lattice_0.20-45               KEGGREST_1.38.0               #> [125] fastmap_1.1.0                 httr_1.4.4                    #> [127] interactiveDisplayBase_1.36.0 glue_1.6.2                    #> [129] xts_0.12.2                    FNN_1.1.3.1                   #> [131] png_0.1-8                     bluster_1.8.0                 #> [133] BiocVersion_3.16.0            bit_4.0.5                     #> [135] class_7.3-21                  stringi_1.7.12                #> [137] sass_0.4.5                    HDF5Array_1.26.0              #> [139] blob_1.2.3                    textshaping_0.3.6             #> [141] AnnotationHub_3.6.0           memoise_2.0.1                 #> [143] dplyr_1.0.10                  irlba_2.3.5.1                 #> [145] e1071_1.7-12"},{"path":[]},{"path":[]},{"path":"https://pachterlab.github.io/voyager/articles/vig7_seqfish.html","id":"dataset","dir":"Articles","previous_headings":"","what":"Dataset","title":"seqFISH exploratory data analysis","text":"data used vignette described Integration spatial single-cell transcriptomic data elucidates mouse organogenesis. Briefly, seqFISH use profile 351 genes several mouse embryos 8-12 somite stage (ss). focus single biological replicate, embryo 3. raw processed counts corresponding metadata available download Marioni lab. Expression matrices, segmentation data, segmented cell vertices provided R objects can readily imported R environment. data relevant vignette converted SFE object available download Box. data added SFEData package Bioconductor available 3.17 release. begin downloading data loading R. rows count matrix correspond 351 barcoded genes measured seqFISH. Additionally, authors provide metadata, including field view z-slice cell. filter count matrix metadata include cells single z-slice.","code":"library(Voyager) library(SingleCellExperiment) #> Loading required package: SummarizedExperiment #> Loading required package: MatrixGenerics #> Loading required package: matrixStats #>  #> Attaching package: 'MatrixGenerics' #> The following objects are masked from 'package:matrixStats': #>  #>     colAlls, colAnyNAs, colAnys, colAvgsPerRowSet, colCollapse, #>     colCounts, colCummaxs, colCummins, colCumprods, colCumsums, #>     colDiffs, colIQRDiffs, colIQRs, colLogSumExps, colMadDiffs, #>     colMads, colMaxs, colMeans2, colMedians, colMins, colOrderStats, #>     colProds, colQuantiles, colRanges, colRanks, colSdDiffs, colSds, #>     colSums2, colTabulates, colVarDiffs, colVars, colWeightedMads, #>     colWeightedMeans, colWeightedMedians, colWeightedSds, #>     colWeightedVars, rowAlls, rowAnyNAs, rowAnys, rowAvgsPerColSet, #>     rowCollapse, rowCounts, rowCummaxs, rowCummins, rowCumprods, #>     rowCumsums, rowDiffs, rowIQRDiffs, rowIQRs, rowLogSumExps, #>     rowMadDiffs, rowMads, rowMaxs, rowMeans2, rowMedians, rowMins, #>     rowOrderStats, rowProds, rowQuantiles, rowRanges, rowRanks, #>     rowSdDiffs, rowSds, rowSums2, rowTabulates, rowVarDiffs, rowVars, #>     rowWeightedMads, rowWeightedMeans, rowWeightedMedians, #>     rowWeightedSds, rowWeightedVars #> Loading required package: GenomicRanges #> Loading required package: stats4 #> Loading required package: BiocGenerics #>  #> Attaching package: 'BiocGenerics' #> The following objects are masked from 'package:stats': #>  #>     IQR, mad, sd, var, xtabs #> The following objects are masked from 'package:base': #>  #>     anyDuplicated, aperm, append, as.data.frame, basename, cbind, #>     colnames, dirname, do.call, duplicated, eval, evalq, Filter, Find, #>     get, grep, grepl, intersect, is.unsorted, lapply, Map, mapply, #>     match, mget, order, paste, pmax, pmax.int, pmin, pmin.int, #>     Position, rank, rbind, Reduce, rownames, sapply, setdiff, sort, #>     table, tapply, union, unique, unsplit, which.max, which.min #> Loading required package: S4Vectors #>  #> Attaching package: 'S4Vectors' #> The following objects are masked from 'package:base': #>  #>     expand.grid, I, unname #> Loading required package: IRanges #> Loading required package: GenomeInfoDb #> Loading required package: Biobase #> Welcome to Bioconductor #>  #>     Vignettes contain introductory material; view with #>     'browseVignettes()'. To cite Bioconductor, see #>     'citation(\"Biobase\")', and for packages 'citation(\"pkgname\")'. #>  #> Attaching package: 'Biobase' #> The following object is masked from 'package:MatrixGenerics': #>  #>     rowMedians #> The following objects are masked from 'package:matrixStats': #>  #>     anyMissing, rowMedians library(SpatialExperiment) library(SpatialFeatureExperiment) library(batchelor) library(scater) #> Loading required package: scuttle #> Loading required package: ggplot2 library(scran) library(bluster) library(purrr) #>  #> Attaching package: 'purrr' #> The following object is masked from 'package:GenomicRanges': #>  #>     reduce #> The following object is masked from 'package:IRanges': #>  #>     reduce library(tidyr) #>  #> Attaching package: 'tidyr' #> The following object is masked from 'package:S4Vectors': #>  #>     expand library(dplyr) #>  #> Attaching package: 'dplyr' #> The following object is masked from 'package:Biobase': #>  #>     combine #> The following objects are masked from 'package:GenomicRanges': #>  #>     intersect, setdiff, union #> The following object is masked from 'package:GenomeInfoDb': #>  #>     intersect #> The following objects are masked from 'package:IRanges': #>  #>     collapse, desc, intersect, setdiff, slice, union #> The following objects are masked from 'package:S4Vectors': #>  #>     first, intersect, rename, setdiff, setequal, union #> The following objects are masked from 'package:BiocGenerics': #>  #>     combine, intersect, setdiff, union #> The following object is masked from 'package:matrixStats': #>  #>     count #> The following objects are masked from 'package:stats': #>  #>     filter, lag #> The following objects are masked from 'package:base': #>  #>     intersect, setdiff, setequal, union library(fossil) #> Loading required package: sp #>  #> Attaching package: 'sp' #> The following object is masked from 'package:SpatialFeatureExperiment': #>  #>     bbox #> The following object is masked from 'package:IRanges': #>  #>     %over% #> Loading required package: maps #>  #> Attaching package: 'maps' #> The following object is masked from 'package:purrr': #>  #>     map #> Loading required package: shapefiles #> Loading required package: foreign #>  #> Attaching package: 'shapefiles' #> The following objects are masked from 'package:foreign': #>  #>     read.dbf, write.dbf library(ggplot2) library(patchwork) library(spdep) #> Loading required package: spData #> To access larger datasets in this package, install the spDataLarge #> package with: `install.packages('spDataLarge', #> repos='https://nowosad.github.io/drat/', type='source')` #> Loading required package: sf #> Linking to GEOS 3.10.2, GDAL 3.4.2, PROJ 8.2.1; sf_use_s2() is TRUE library(BiocParallel)  theme_set(theme_bw()) # the commented line downloads the data from Box and stores it in the current directory  download.file(\"https://caltech.box.com/public/static/ulrqr1gk7oh21h9ejgua1xajs6dsbvrj\",'./seqfish_em3.Rds', mode='wb', method = 'wget', quiet = TRUE)  sfe <- readRDS(\"./seqfish_em3.Rds\") sfe #> class: SpatialFeatureExperiment  #> dim: 351 23194  #> metadata(0): #> assays(1): counts #> rownames(351): Abcc4 Acp5 ... Zfp57 Zic3 #> rowData names(0): #> colnames(23194): embryo3_Pos0_cell10_z2 embryo3_Pos0_cell10_z5 ... #>   embryo3_Pos39_cell98_z5 embryo3_Pos39_cell99_z2 #> colData names(15): uniqueID embryo ... celltype_mapped_refined #>   sample_id #> reducedDimNames(0): #> mainExpName: NULL #> altExpNames(0): #> spatialCoords names(2) : X Y #> imgData names(0): #>  #> Geometries: #> colGeometries: seg_coords (GEOMETRY)  #>  #> Graphs: #> sample01: names(colData(sfe)) #>  [1] \"uniqueID\"                \"embryo\"                  #>  [3] \"pos\"                     \"z\"                       #>  [5] \"x_global\"                \"y_global\"                #>  [7] \"x_global_affine\"         \"y_global_affine\"         #>  [9] \"embryo_pos\"              \"embryo_pos_z\"            #> [11] \"Area\"                    \"UMAP1\"                   #> [13] \"UMAP2\"                   \"celltype_mapped_refined\" #> [15] \"sample_id\" mask <- colData(sfe)$z == 2 sfe <- sfe[,mask]"},{"path":"https://pachterlab.github.io/voyager/articles/vig7_seqfish.html","id":"quality-control","dir":"Articles","previous_headings":"","what":"Quality control","title":"seqFISH exploratory data analysis","text":"begin quality control (QC) cells computing metrics common single-cell analysis store colData field SFE object. , compute number counts per cell. also compute average display violin plot.  Notably, cells dataset fewer counts expected single-cell sequencing experiment cells higher counts seem dispersed throughout tissue. Fewer counts expected seqFISH experiments probing highly expressed genes may lead optical crowding multiple imaging rounds. Since counts collected several fields view, visualize number cells total counts field separately.  variability total number counts field view. completely apparent accounts low number counts FOVs. example, FOV 22 fewest number cells, comparably counts detected regions cells (e.g. FOV 18). Next, compute number genes detected per cell, defined number genes non-zero counts. plot metric FOV done .  Many cells fewer 100 detected genes. part reflects panel 351 probed genes chosen distinguish cell types developmental stages distinct cell types likely express small subset 351 genes. authors also note gene panel consists lowly expressed moderately expressed genes. Taken together, technical details can explain relatively low number counts genes per cell. , plot number genes detected per cell FOV.  plot mirrors plot total counts. single FOV stands obvious outlier. authors provided cell type assignments metadata. can assess whether low quality cells tend located particular FOV. appears FOV 26 31 largest fraction low quality cells. Interestingly, correspond FOVs largest number cells overall. plot nCounts vs. nGenes FOV.  scRNA-seq, gene expression variance seqFISH measurements overdispersed compared variance counts Poisson distributed. understand mean-variance relationship, compute mean variance gene among cells tissue. , perform calculation separately FOV  red line represents line \\(y = x\\), mean-variance relationship expected Poisson distributed data. data deviate expectation FOV. case, variance greater expected.","code":"colData(sfe)$nCounts <- colSums(counts(sfe)) avg <- mean(colData(sfe)$nCounts)  violin <- plotColData(sfe, \"nCounts\") +     geom_hline(yintercept = avg, color='red') +     theme(legend.position = \"top\")   spatial <- plotSpatialFeature(sfe, \"nCounts\", colGeometryName = \"seg_coords\") +     theme_void()  violin + spatial pos <- colData(sfe)$pos counts_spl <- split.data.frame(t(counts(sfe)), pos)  # nCounts per FOV df <- map_dfr(counts_spl, rowSums, .id='pos') |>     pivot_longer(cols=contains('embryo'), values_to = 'nCounts') |>     mutate(pos = factor(pos, levels = paste0(\"Pos\", seq_len(length(unique(pos)))-1))) |>      dplyr::filter(!is.na(nCounts))  cells_fov <- colData(sfe) |>      as.data.frame() |>      mutate(pos = factor(pos, levels = paste0(\"Pos\", seq_len(length(unique(pos)))-1))) |>      ggplot(aes(pos,)) +     geom_bar() +      theme_minimal() +      labs(         x = \"\",         y = \"Number of cells\") +      theme(axis.text.x = element_text(angle = 90))  counts_fov <- ggplot(df, aes(pos, nCounts)) +     geom_boxplot(outlier.size = 0.5) +      theme_minimal() +      labs(x = \"\", y = 'nCounts') +      theme(axis.text.x = element_text(angle = 90))  cells_fov / counts_fov colData(sfe)$nGenes <- colSums(counts(sfe) > 0)  avg <- mean(colData(sfe)$nGenes)  violin <- plotColData(sfe, \"nGenes\") +     geom_hline(yintercept = avg, color='red') +     theme(legend.position = \"top\")   spatial <- plotSpatialFeature(sfe, \"nGenes\", colGeometryName = \"seg_coords\") +     theme_void()  violin + spatial df <- map_dfr(counts_spl, ~ rowSums(.x > 0), .id='pos') |>     pivot_longer(cols = contains('embryo'), values_to = 'nGenes') |>     mutate(pos = factor(pos, levels = paste0(\"Pos\", seq_len(length(unique(pos)))-1))) |>      filter(!is.na(nGenes)) |>     merge(df)  genes_fov <- ggplot(df, aes(pos, nGenes)) +     geom_boxplot(outlier.size = 0.5) +      theme_bw() +      labs(x = \"\") +      theme(axis.text.x = element_text(angle = 90))  genes_fov meta <- data.frame(colData(sfe))   meta <- meta |>      group_by(pos) |>      add_tally(name = \"nCells_FOV\") |>      filter(celltype_mapped_refined %in% \"Low quality\") |>      add_tally(name = \"nLQ_FOV\") |>      mutate(prop_lq = nLQ_FOV/nCells_FOV) |>     distinct(pos, prop_lq) |>      ungroup() |>      mutate(pos = factor(pos, levels = paste0(\"Pos\", seq_len(length(unique(pos)))-1)))  prop_lq <- ggplot(meta, aes(pos, prop_lq)) +      geom_bar(stat = 'identity' ) +      theme_bw() +     theme(axis.text.x = element_text(angle = 90))   prop_lq count_vs_genes_p <- ggplot(df, aes(nCounts, nGenes)) +    geom_point(     alpha = 0.5,     size = 1,     fill = \"white\"   ) +   facet_wrap(~ pos)  count_vs_genes_p gene_meta <- map_dfr(counts_spl, colMeans, .id = 'pos') |>    pivot_longer(cols = -pos, names_to = 'gene', values_to = 'mean')  gene_meta <- map_dfr(counts_spl, ~colVars(.x, useNames = TRUE), .id = 'pos') |>    pivot_longer(-pos, names_to = 'gene', values_to='variance') |>    full_join(gene_meta) #> Joining, by = c(\"pos\", \"gene\") ggplot(gene_meta, aes(mean, variance)) +    geom_point(     alpha = 0.5,     size = 1,     fill = \"white\"   ) +   facet_wrap(~ pos) +   geom_abline(slope = 1, intercept = 0, color = \"red\") +   scale_x_log10() + scale_y_log10() +   annotation_logticks() +   theme_bw()"},{"path":"https://pachterlab.github.io/voyager/articles/vig7_seqfish.html","id":"data-normalization-and-dimension-reduction","dir":"Articles","previous_headings":"","what":"Data normalization and dimension reduction","title":"seqFISH exploratory data analysis","text":"exploratory analysis indicates presence batch effects corresponding FOV. use normalization scheme batch aware. SFE object inherits SpatialExperimentand SingleCellExperiment, classes, can take advantage normalization methods implemented scran batchelor R packages. first use multiBatchNorm() function scale data within batch. noted documentation, function uses median-based normalization ratio average counts batches. Batch correction dimension reduction accomplished using fastMNN() performs multi-sample PCA across multiple gene expression matrices project cells common low-dimensional space. function fastMNN returns batch-corrected matrix reducedDims slot SingleCellExperiment object. extract relevant data store SFE ojbject. Now visualize first two PCs space. notice PCs may show spatial structure correlates biological niches cells.  Unfortunately, FOV artifacts can still seen.","code":"sfe <- multiBatchNorm(sfe, batch = pos) sfe_red <- fastMNN(sfe, batch = pos, cos.norm = FALSE, d = 20) reducedDim(sfe, \"PCA\") <- reducedDim(sfe_red, \"corrected\") assay(sfe, \"reconstructed\") <- assay(sfe_red, \"reconstructed\") spatialReducedDim(sfe, \"PCA\", ncomponents = 2, divergent = TRUE, diverge_center = 0) &     theme_void()"},{"path":"https://pachterlab.github.io/voyager/articles/vig7_seqfish.html","id":"clustering","dir":"Articles","previous_headings":"","what":"Clustering","title":"seqFISH exploratory data analysis","text":"Much like single cell analysis, can use batch-corrected data cluster cells. implement graph-based clustering algorithm plot resulting clusters space. plot colored cluster ID cell types provided author.  authors assigned cells types identified clustering step. case, clustering results seem recapitulate major cell niches previous annotations. can compute Rand index using function fossil package assess similarity two clustering results. value 1 suggest clustering results identical, value 0 suggest results agree . relatively large Rand index suggests cells often found cluster cases.","code":"colData(sfe)$cluster <-    clusterRows(reducedDim(sfe, \"PCA\"),                       BLUSPARAM = SNNGraphParam(                         cluster.fun = \"leiden\",                         cluster.args = list(                         resolution_parameter = 0.5,                         objective_function = \"modularity\")                         )               ) plotSpatialFeature(sfe, c(\"cluster\", \"celltype_mapped_refined\"),                     colGeometryName = \"seg_coords\") &      theme_void() g1 <- as.numeric(colData(sfe)$cluster) g2 <- as.numeric(colData(sfe)$celltype_mapped_refined)  rand.index(g1, g2) #> [1] 0.8401644"},{"path":"https://pachterlab.github.io/voyager/articles/vig7_seqfish.html","id":"univariate-spatial-statistics","dir":"Articles","previous_headings":"","what":"Univariate Spatial Statistics","title":"seqFISH exploratory data analysis","text":"point, may interested identifying genes exhibit spatial variability, whose expression depends spatial location within tissue. Measures spatial autocorrelation can useful identifyign genes display spatial variablity. Among common measures Moran’s Geary’s C. latter case, less 1 indicates positive spatial autocorrelation, value larger 1 points negative spatial autocorrelation. former case, positive negative values Moran’s indicate positive negative spatial autocorrelation, respectively. tests require spatial neighborhood graph computation statistic. several ways define spatial neighbors findSpatialNeighbors() function wraps methods implemented spdep package. , compute k-nearest neighborhood graph. dist_type = \"idw\" weights edges graph inverse distance neighbors. also save variable genes use computations . use runUnivariate() function compute spatial autocorrelation metrics save results save SFE object. mc type test implements permutation test statistic relies nsim argument computing p-value statistic. can plot results Monte Carlo simulations:  vertical line represents observed value Moran’s density represents Moran’s computed permuted data. simulations suggest spatial autocorrelation feature significant. function can also used plot geary.mc results. Now, might ask: genes display spatial autocorrelation?  appears genes highest spatial autocorrelation seem obvious expression patterns tissue. interesting see genes also differentially expressed clusters . Non-spatial differential gene expression can interrogated using findMarkers() function implemented scran package complex methods identifying spatially variable genes actively developed. analyses bring interesting considerations. one, unclear whether normalization scheme employed effectively removes FOV batch effects. said, may times FOV differences expected represent biological differences, example context tumor sample. remains seen normalization methods perform best cases, represents area research.","code":"colGraph(sfe, \"knn5\") <- findSpatialNeighbors(   sfe, method = \"knearneigh\", dist_type = \"idw\",    k = 5, style = \"W\") dec <- modelGeneVar(sfe) hvgs <- getTopHVGs(dec, n = 100) sfe <- runUnivariate(   sfe, type = \"geary.mc\", features = hvgs,    colGraphName = \"knn5\", nsim = 100) sfe <- runUnivariate(   sfe, type = \"moran.mc\", features = hvgs,   colGraphName = \"knn5\", nsim = 100)  sfe <- colDataUnivariate(   sfe, type = \"moran.mc\", features = c(\"nCounts\", \"nGenes\"),    colGraphName = \"knn5\", nsim = 100) plotMoranMC(sfe, \"Meox1\") top_moran <- rownames(sfe)[order(-rowData(sfe)$moran.mc_statistic_sample01)[1:4]]  plotSpatialFeature(sfe, top_moran, colGeometryName = \"seg_coords\") &     theme_void()"},{"path":"https://pachterlab.github.io/voyager/articles/vig7_seqfish.html","id":"session-info","dir":"Articles","previous_headings":"","what":"Session Info","title":"seqFISH exploratory data analysis","text":"","code":"sessionInfo() #> R version 4.2.2 (2022-10-31) #> Platform: x86_64-apple-darwin17.0 (64-bit) #> Running under: macOS Big Sur ... 10.16 #>  #> Matrix products: default #> BLAS:   /Library/Frameworks/R.framework/Versions/4.2/Resources/lib/libRblas.0.dylib #> LAPACK: /Library/Frameworks/R.framework/Versions/4.2/Resources/lib/libRlapack.dylib #>  #> locale: #> [1] en_US.UTF-8/en_US.UTF-8/en_US.UTF-8/C/en_US.UTF-8/en_US.UTF-8 #>  #> attached base packages: #> [1] stats4    stats     graphics  grDevices utils     datasets  methods   #> [8] base      #>  #> other attached packages: #>  [1] BiocParallel_1.32.5            spdep_1.2-7                    #>  [3] sf_1.0-9                       spData_2.2.1                   #>  [5] patchwork_1.1.2                fossil_0.4.0                   #>  [7] shapefiles_0.7.2               foreign_0.8-84                 #>  [9] maps_3.4.1                     sp_1.6-0                       #> [11] dplyr_1.0.10                   tidyr_1.3.0                    #> [13] purrr_1.0.1                    bluster_1.8.0                  #> [15] scran_1.26.2                   scater_1.27.3                  #> [17] ggplot2_3.4.0                  scuttle_1.8.4                  #> [19] batchelor_1.14.1               SpatialFeatureExperiment_1.0.3 #> [21] SpatialExperiment_1.8.0        SingleCellExperiment_1.20.0    #> [23] SummarizedExperiment_1.28.0    Biobase_2.58.0                 #> [25] GenomicRanges_1.50.2           GenomeInfoDb_1.34.7            #> [27] IRanges_2.32.0                 S4Vectors_0.36.1               #> [29] BiocGenerics_0.44.0            MatrixGenerics_1.10.0          #> [31] matrixStats_0.63.0             Voyager_1.0.8                  #>  #> loaded via a namespace (and not attached): #>   [1] systemfonts_1.0.4         igraph_1.3.5              #>   [3] digest_0.6.31             htmltools_0.5.4           #>   [5] viridis_0.6.2             magick_2.7.3              #>   [7] fansi_1.0.4               magrittr_2.0.3            #>   [9] memoise_2.0.1             ScaledMatrix_1.6.0        #>  [11] cluster_2.1.4             limma_3.54.1              #>  [13] R.utils_2.12.2            pkgdown_2.0.7             #>  [15] colorspace_2.1-0          ggrepel_0.9.2             #>  [17] textshaping_0.3.6         xfun_0.36                 #>  [19] RCurl_1.98-1.10           jsonlite_1.8.4            #>  [21] glue_1.6.2                gtable_0.3.1              #>  [23] zlibbioc_1.44.0           XVector_0.38.0            #>  [25] DelayedArray_0.24.0       scico_1.3.1               #>  [27] BiocSingular_1.14.0       DropletUtils_1.18.1       #>  [29] Rhdf5lib_1.20.0           HDF5Array_1.26.0          #>  [31] scales_1.2.1              DBI_1.1.3                 #>  [33] edgeR_3.40.2              Rcpp_1.0.10               #>  [35] viridisLite_0.4.1         units_0.8-1               #>  [37] dqrng_0.3.0               rsvd_1.0.5                #>  [39] proxy_0.4-27              ResidualMatrix_1.8.0      #>  [41] metapod_1.6.0             RColorBrewer_1.1-3        #>  [43] wk_0.7.1                  farver_2.1.1              #>  [45] pkgconfig_2.0.3           R.methodsS3_1.8.2         #>  [47] sass_0.4.5                deldir_1.0-6              #>  [49] locfit_1.5-9.7            utf8_1.2.2                #>  [51] labeling_0.4.2            tidyselect_1.2.0          #>  [53] rlang_1.0.6               munsell_0.5.0             #>  [55] tools_4.2.2               cachem_1.0.6              #>  [57] cli_3.6.0                 dbscan_1.1-11             #>  [59] generics_0.1.3            evaluate_0.20             #>  [61] stringr_1.5.0             fastmap_1.1.0             #>  [63] yaml_2.3.7                ragg_1.2.5                #>  [65] knitr_1.42                fs_1.6.0                  #>  [67] s2_1.1.2                  sparseMatrixStats_1.10.0  #>  [69] R.oo_1.25.0               compiler_4.2.2            #>  [71] beeswarm_0.4.0            e1071_1.7-12              #>  [73] tibble_3.1.8              statmod_1.5.0             #>  [75] bslib_0.4.2               stringi_1.7.12            #>  [77] highr_0.10                desc_1.4.2                #>  [79] lattice_0.20-45           Matrix_1.5-3              #>  [81] classInt_0.4-8            vctrs_0.5.2               #>  [83] pillar_1.8.1              lifecycle_1.0.3           #>  [85] rhdf5filters_1.10.0       jquerylib_0.1.4           #>  [87] BiocNeighbors_1.16.0      cowplot_1.1.1             #>  [89] bitops_1.0-7              irlba_2.3.5.1             #>  [91] R6_2.5.1                  KernSmooth_2.23-20        #>  [93] gridExtra_2.3             vipor_0.4.5               #>  [95] codetools_0.2-18          boot_1.3-28.1             #>  [97] assertthat_0.2.1          rhdf5_2.42.0              #>  [99] rprojroot_2.0.3           rjson_0.2.21              #> [101] withr_2.5.0               GenomeInfoDbData_1.2.9    #> [103] parallel_4.2.2            grid_4.2.2                #> [105] beachmat_2.14.0           class_7.3-21              #> [107] rmarkdown_2.20            DelayedMatrixStats_1.20.0 #> [109] ggnewscale_0.4.8          ggbeeswarm_0.7.1"},{"path":[]},{"path":"https://pachterlab.github.io/voyager/articles/visium_10x.html","id":"introduction","dir":"Articles","previous_headings":"","what":"Introduction","title":"Basic analysis of 10X example Visium dataset","text":"introductory vignette SpatialFeatureExperiment data representation Voyager anlaysis package, demonstrate basic exploratory data analysis (EDA) spatial transcriptomics data. Basic knowledge R SingleCellExperiment assumed. vignette showcases packages Visium spatial gene expression system dataset, downloaded 10X website, Space Ranger output format. technology chosen due popularity, therefore availability numerous publicly available datasets analysis (Moses Pachter 2022). Voyager developed goal facilitating use geospatial methods spatial genomics, introductory vignette restricted non-spatial scRNA-seq EDA Visium dataset. another Visium introductory vignette using dataset SFEData package 10X website. load packages used vignette. download data 10X website. unfiltered gene count matrix: spatial information: Decompress downloaded content: outs directory Space Ranger output looks like: gene count matrix directory: spatial directory: outputs spatial directory explained 10X website. tissue_hires_image.png relatively high resolution image tissue, full resolution. tissue_lowres_image.png file low resolution image tissue, suitable quick plotting, shown :  array dots framing tissue seen image fiducials, used align tissue image positions Visium spots, gene expression can matched spatial locations. alignment fiducials shown aligned_fiducials.jpg. Space Ranger can automatically detect spots tissue, spots highlighted detected_tissue_image.jpg. Inside scalefactors_json.json file: spot_diameter_fullres diameter Visium spot full resolution H&E image pixels. tissue_hires_scalef tissue_lowres_scalef ratio size high resolution (full resolution) low resolution H&E image full resolution image. fiducial_diameter_fullres diameter fiducial spot used align spots H&E image pixels full resolution image. tissue_positions_list.csv file contains information coordinates spots full resolution image whether spot tissue (in_tissue, 1 means yes 0 means ) automatically detected Space Ranger manually annotated Loupe browser. spatial_enrichment.csv file Moran’s (presumably spots tissue) p-value gene detected least 10 spots least 20 UMIs. read Space Ranger output R SFE object:","code":"library(Voyager) library(SpatialExperiment) #> Loading required package: SingleCellExperiment #> Loading required package: SummarizedExperiment #> Loading required package: MatrixGenerics #> Loading required package: matrixStats #>  #> Attaching package: 'MatrixGenerics' #> The following objects are masked from 'package:matrixStats': #>  #>     colAlls, colAnyNAs, colAnys, colAvgsPerRowSet, colCollapse, #>     colCounts, colCummaxs, colCummins, colCumprods, colCumsums, #>     colDiffs, colIQRDiffs, colIQRs, colLogSumExps, colMadDiffs, #>     colMads, colMaxs, colMeans2, colMedians, colMins, colOrderStats, #>     colProds, colQuantiles, colRanges, colRanks, colSdDiffs, colSds, #>     colSums2, colTabulates, colVarDiffs, colVars, colWeightedMads, #>     colWeightedMeans, colWeightedMedians, colWeightedSds, #>     colWeightedVars, rowAlls, rowAnyNAs, rowAnys, rowAvgsPerColSet, #>     rowCollapse, rowCounts, rowCummaxs, rowCummins, rowCumprods, #>     rowCumsums, rowDiffs, rowIQRDiffs, rowIQRs, rowLogSumExps, #>     rowMadDiffs, rowMads, rowMaxs, rowMeans2, rowMedians, rowMins, #>     rowOrderStats, rowProds, rowQuantiles, rowRanges, rowRanks, #>     rowSdDiffs, rowSds, rowSums2, rowTabulates, rowVarDiffs, rowVars, #>     rowWeightedMads, rowWeightedMeans, rowWeightedMedians, #>     rowWeightedSds, rowWeightedVars #> Loading required package: GenomicRanges #> Loading required package: stats4 #> Loading required package: BiocGenerics #>  #> Attaching package: 'BiocGenerics' #> The following objects are masked from 'package:stats': #>  #>     IQR, mad, sd, var, xtabs #> The following objects are masked from 'package:base': #>  #>     anyDuplicated, aperm, append, as.data.frame, basename, cbind, #>     colnames, dirname, do.call, duplicated, eval, evalq, Filter, Find, #>     get, grep, grepl, intersect, is.unsorted, lapply, Map, mapply, #>     match, mget, order, paste, pmax, pmax.int, pmin, pmin.int, #>     Position, rank, rbind, Reduce, rownames, sapply, setdiff, sort, #>     table, tapply, union, unique, unsplit, which.max, which.min #> Loading required package: S4Vectors #>  #> Attaching package: 'S4Vectors' #> The following objects are masked from 'package:base': #>  #>     expand.grid, I, unname #> Loading required package: IRanges #> Loading required package: GenomeInfoDb #> Loading required package: Biobase #> Welcome to Bioconductor #>  #>     Vignettes contain introductory material; view with #>     'browseVignettes()'. To cite Bioconductor, see #>     'citation(\"Biobase\")', and for packages 'citation(\"pkgname\")'. #>  #> Attaching package: 'Biobase' #> The following object is masked from 'package:MatrixGenerics': #>  #>     rowMedians #> The following objects are masked from 'package:matrixStats': #>  #>     anyMissing, rowMedians library(SpatialFeatureExperiment) library(SingleCellExperiment) library(ggplot2) library(scater) #> Loading required package: scuttle library(scuttle) library(scran) library(stringr) library(patchwork) library(bluster) library(rjson) theme_set(theme_bw()) if (!file.exists(\"visium_ob.tar.gz\"))     download.file(\"https://cf.10xgenomics.com/samples/spatial-exp/2.0.0/Visium_Mouse_Olfactory_Bulb/Visium_Mouse_Olfactory_Bulb_raw_feature_bc_matrix.tar.gz\",                    destfile = \"visium_ob.tar.gz\") if (!file.exists(\"visium_ob_spatial.tar.gz\"))     download.file(\"https://cf.10xgenomics.com/samples/spatial-exp/2.0.0/Visium_Mouse_Olfactory_Bulb/Visium_Mouse_Olfactory_Bulb_spatial.tar.gz\",                    destfile = \"visium_ob_spatial.tar.gz\") if (!dir.exists(\"outs\")) {     dir.create(\"outs\")     system(\"tar -xvf visium_ob.tar.gz -C outs\")     system(\"tar -xvf visium_ob_spatial.tar.gz -C outs\") } list.dirs(\"outs\") #> [1] \"outs\"                       \"outs/raw_feature_bc_matrix\" #> [3] \"outs/spatial\" list.files(\"outs/raw_feature_bc_matrix\") #> [1] \"barcodes.tsv.gz\" \"features.tsv.gz\" \"matrix.mtx.gz\" list.files(\"outs/spatial\") #> [1] \"aligned_fiducials.jpg\"     \"detected_tissue_image.jpg\" #> [3] \"scalefactors_json.json\"    \"spatial_enrichment.csv\"    #> [5] \"tissue_hires_image.png\"    \"tissue_lowres_image.png\"   #> [7] \"tissue_positions.csv\" knitr::include_graphics(\"outs/spatial/tissue_lowres_image.png\") fromJSON(file = \"outs/spatial/scalefactors_json.json\") #> $tissue_hires_scalef #> [1] 0.2 #>  #> $tissue_lowres_scalef #> [1] 0.06 #>  #> $fiducial_diameter_fullres #> [1] 118.9155 #>  #> $spot_diameter_fullres #> [1] 73.61433 head(read.csv(\"outs/spatial/tissue_positions.csv\")) #>              barcode in_tissue array_row array_col pxl_row_in_fullres #> 1 ACGCCTGACACGCGCT-1         0         0         0               8668 #> 2 TACCGATCCAACACTT-1         0         1         1               8611 #> 3 ATTAAAGCGGACGAGC-1         0         0         2               8554 #> 4 GATAAGGGACGATTAG-1         0         1         3               8498 #> 5 GTGCAAATCACCAATA-1         0         0         4               8441 #> 6 TGTTGGCTGGCGGAAG-1         0         1         5               8384 #>   pxl_col_in_fullres #> 1               1102 #> 2               1200 #> 3               1102 #> 4               1200 #> 5               1102 #> 6               1200 head(read.csv(\"outs/spatial/spatial_enrichment.csv\")) #>           Feature.ID Feature.Name    Feature.Type         I P.value #> 1 ENSMUSG00000001023       S100a5 Gene Expression 0.7709048       0 #> 2 ENSMUSG00000019874        Fabp7 Gene Expression 0.6987346       0 #> 3 ENSMUSG00000002985         Apoe Gene Expression 0.6945210       0 #> 4 ENSMUSG00000025739        Gng13 Gene Expression 0.6585750       0 #> 5 ENSMUSG00000090223         Pcp4 Gene Expression 0.6317032       0 #> 6 ENSMUSG00000053310         Nrgn Gene Expression 0.6033600       0 #>   Adjusted.p.value Feature.Counts.in.Spots.Under.Tissue #> 1                0                                 9019 #> 2                0                                13462 #> 3                0                                67509 #> 4                0                                 5260 #> 5                0                                45118 #> 6                0                                10723 #>   Median.Normalized.Average.Counts Barcodes.Detected.per.Feature #> 1                        15.848669                          1021 #> 2                        20.679932                          1170 #> 3                        76.635169                          1184 #> 4                         8.803694                          1050 #> 5                        25.811125                          1133 #> 6                         6.075966                           898 sfe <- read10xVisiumSFE(samples = \"outs\", type = \"sparse\", data = \"raw\") #> Warning: as(<dgTMatrix>, \"dgCMatrix\") is deprecated since Matrix 1.5-0; do #> as(., \"CsparseMatrix\") instead sfe #> class: SpatialFeatureExperiment  #> dim: 32285 4992  #> metadata(0): #> assays(1): counts #> rownames(32285): ENSMUSG00000051951 ENSMUSG00000089699 ... #>   ENSMUSG00000095019 ENSMUSG00000095041 #> rowData names(1): symbol #> colnames(4992): AAACAACGAATAGTTC-1 AAACAAGTATCTCCCA-1 ... #>   TTGTTTGTATTACACG-1 TTGTTTGTGTAAATTC-1 #> colData names(4): in_tissue array_row array_col sample_id #> reducedDimNames(0): #> mainExpName: NULL #> altExpNames(0): #> spatialCoords names(2) : pxl_row_in_fullres pxl_col_in_fullres #> imgData names(4): sample_id image_id data scaleFactor #>  #> Geometries: #> colGeometries: spotPoly (POLYGON)  #>  #> Graphs: #> sample01:"},{"path":"https://pachterlab.github.io/voyager/articles/visium_10x.html","id":"quality-control-qc","dir":"Articles","previous_headings":"","what":"Quality control (QC)","title":"Basic analysis of 10X example Visium dataset","text":"H&E image needs rotated aligned Visium spots. tissue can mounted orientation, standard rotation align image spots. rotateImg() function SpatialExperiment rotates image degrees clockwise. mirroImg() function reflects image. present SpatialExperiment automatically rotate reflect image. much done manually.  image stored data column imgData field, DataFrame: image rotated 90 degrees counterclockwise.  current version Voyager plot image, current version SpatialFeatureExperiment touch image. future version, image may cropped SFE object subsetted. Use ggspavis package plot image behind spots. Percentage mitochondrial counts spots outside tissue higher near tissue, especially left.  3 peaks, apparently histologically relevant. Also obvious outliers.  unlike scRNA-seq data. Spots tissue wide range mitocondrial percentage. Spots tissue fall 3 clusters plot, seemingly related histological regions.","code":"is_mt <- str_detect(rowData(sfe)$symbol, \"^mt-\") sfe <- addPerCellQCMetrics(sfe, subsets = list(mito = is_mt)) names(colData(sfe)) #>  [1] \"in_tissue\"             \"array_row\"             \"array_col\"             #>  [4] \"sample_id\"             \"sum\"                   \"detected\"              #>  [7] \"subsets_mito_sum\"      \"subsets_mito_detected\" \"subsets_mito_percent\"  #> [10] \"total\" plotSpatialFeature(sfe, c(\"sum\", \"detected\", \"subsets_mito_percent\"),                    ncol = 2) & theme_void() plot(imgRaster(sfe)) imgData(sfe) #> DataFrame with 1 row and 4 columns #>     sample_id    image_id   data scaleFactor #>   <character> <character> <list>   <numeric> #> 1    sample01      lowres   ####        0.06 imgData(sfe)$data[[1]] <- rotateImg(imgData(sfe)$data[[1]], degrees = -90) plot(imgRaster(sfe)) plotColData(sfe, \"sum\", x = \"in_tissue\", color_by = \"in_tissue\") +     plotColData(sfe, \"detected\", x = \"in_tissue\", color_by = \"in_tissue\") +     plotColData(sfe, \"subsets_mito_percent\", x = \"in_tissue\", color_by = \"in_tissue\") +     plot_layout(guides = \"collect\") plotColData(sfe, x = \"sum\", y = \"subsets_mito_percent\", color_by = \"in_tissue\") +     geom_density_2d() #> Warning: `stat_contour()`: Zero contours were generated #> Warning in min(x): no non-missing arguments to min; returning Inf #> Warning in max(x): no non-missing arguments to max; returning -Inf sfe_tissue <- sfe[,sfe$in_tissue] plotColDataBin2D(sfe_tissue, x = \"sum\", y = \"detected\", bins = 75) #clusters <- quickCluster(sfe_tissue) #sfe_tissue <- computeSumFactors(sfe_tissue, clusters=clusters) #sfe_tissue <- sfe_tissue[, sizeFactors(sfe_tissue) > 0] sfe_tissue <- logNormCounts(sfe_tissue) dec <- modelGeneVar(sfe_tissue) hvgs <- getTopHVGs(dec, n = 2000)"},{"path":"https://pachterlab.github.io/voyager/articles/visium_10x.html","id":"dimension-reduction-and-clustering","dir":"Articles","previous_headings":"","what":"Dimension reduction and clustering","title":"Basic analysis of 10X example Visium dataset","text":"clustering show dimension reduction plots    Significant markers cluster can obtained follows:  genes interesting view spatial context:  spatial analyses dataset performed “advanced” version vignette.","code":"sfe_tissue <- runPCA(sfe_tissue, ncomponents = 30, subset_row = hvgs,                      scale = TRUE) # scale as in Seurat ElbowPlot(sfe_tissue, ndims = 30) names(rowData(sfe_tissue)) #> [1] \"symbol\" plotDimLoadings(sfe_tissue, dims = 1:5, show_symbol = TRUE, ncol = 3) set.seed(29) colData(sfe_tissue)$cluster <- clusterRows(reducedDim(sfe_tissue, \"PCA\")[,1:3],                                            BLUSPARAM = SNNGraphParam(                                                cluster.fun = \"leiden\",                                                cluster.args = list(                                                    resolution_parameter = 0.5,                                                    objective_function = \"modularity\"))) plotPCA(sfe_tissue, ncomponents = 5, colour_by = \"cluster\") plotSpatialFeature(sfe_tissue, features = \"cluster\",                     colGeometryName = \"spotPoly\") +     theme_void() spatialReducedDim(sfe_tissue, \"PCA\", ncomponents = 5,                    colGeometryName = \"spotPoly\", divergent = TRUE,                    diverge_center = 0, ncol = 2) &     theme_void() markers <- findMarkers(sfe_tissue, groups = colData(sfe_tissue)$cluster,                        test.type = \"wilcox\", pval.type = \"all\", direction = \"up\") genes_use <- vapply(markers, function(x) rownames(x)[1], FUN.VALUE = character(1)) plotExpression(sfe_tissue, rowData(sfe_tissue)[genes_use, \"symbol\"], x = \"cluster\",                colour_by = \"cluster\", swap_rownames = \"symbol\") plotSpatialFeature(sfe_tissue, genes_use, colGeometryName = \"spotPoly\", ncol = 2) &     theme_void()"},{"path":"https://pachterlab.github.io/voyager/articles/visium_10x.html","id":"session-info","dir":"Articles","previous_headings":"","what":"Session info","title":"Basic analysis of 10X example Visium dataset","text":"","code":"sessionInfo() #> R version 4.2.2 (2022-10-31) #> Platform: x86_64-apple-darwin17.0 (64-bit) #> Running under: macOS Big Sur ... 10.16 #>  #> Matrix products: default #> BLAS:   /Library/Frameworks/R.framework/Versions/4.2/Resources/lib/libRblas.0.dylib #> LAPACK: /Library/Frameworks/R.framework/Versions/4.2/Resources/lib/libRlapack.dylib #>  #> locale: #> [1] en_US.UTF-8/en_US.UTF-8/en_US.UTF-8/C/en_US.UTF-8/en_US.UTF-8 #>  #> attached base packages: #> [1] stats4    stats     graphics  grDevices utils     datasets  methods   #> [8] base      #>  #> other attached packages: #>  [1] rjson_0.2.21                   bluster_1.8.0                  #>  [3] patchwork_1.1.2                stringr_1.5.0                  #>  [5] scran_1.26.2                   scater_1.27.3                  #>  [7] scuttle_1.8.4                  ggplot2_3.4.0                  #>  [9] SpatialFeatureExperiment_1.0.3 SpatialExperiment_1.8.0        #> [11] SingleCellExperiment_1.20.0    SummarizedExperiment_1.28.0    #> [13] Biobase_2.58.0                 GenomicRanges_1.50.2           #> [15] GenomeInfoDb_1.34.7            IRanges_2.32.0                 #> [17] S4Vectors_0.36.1               BiocGenerics_0.44.0            #> [19] MatrixGenerics_1.10.0          matrixStats_0.63.0             #> [21] Voyager_1.0.8                  #>  #> loaded via a namespace (and not attached): #>   [1] systemfonts_1.0.4         igraph_1.3.5              #>   [3] sp_1.6-0                  BiocParallel_1.32.5       #>   [5] digest_0.6.31             htmltools_0.5.4           #>   [7] viridis_0.6.2             magick_2.7.3              #>   [9] fansi_1.0.4               magrittr_2.0.3            #>  [11] memoise_2.0.1             ScaledMatrix_1.6.0        #>  [13] cluster_2.1.4             limma_3.54.1              #>  [15] R.utils_2.12.2            pkgdown_2.0.7             #>  [17] colorspace_2.1-0          ggrepel_0.9.2             #>  [19] textshaping_0.3.6         xfun_0.36                 #>  [21] dplyr_1.0.10              RCurl_1.98-1.10           #>  [23] jsonlite_1.8.4            glue_1.6.2                #>  [25] gtable_0.3.1              zlibbioc_1.44.0           #>  [27] XVector_0.38.0            DelayedArray_0.24.0       #>  [29] scico_1.3.1               BiocSingular_1.14.0       #>  [31] DropletUtils_1.18.1       Rhdf5lib_1.20.0           #>  [33] HDF5Array_1.26.0          scales_1.2.1              #>  [35] DBI_1.1.3                 edgeR_3.40.2              #>  [37] Rcpp_1.0.10               isoband_0.2.7             #>  [39] viridisLite_0.4.1         spData_2.2.1              #>  [41] units_0.8-1               dqrng_0.3.0               #>  [43] spdep_1.2-7               rsvd_1.0.5                #>  [45] proxy_0.4-27              metapod_1.6.0             #>  [47] RColorBrewer_1.1-3        wk_0.7.1                  #>  [49] pkgconfig_2.0.3           R.methodsS3_1.8.2         #>  [51] farver_2.1.1              sass_0.4.5                #>  [53] deldir_1.0-6              locfit_1.5-9.7            #>  [55] utf8_1.2.2                tidyselect_1.2.0          #>  [57] labeling_0.4.2            rlang_1.0.6               #>  [59] munsell_0.5.0             tools_4.2.2               #>  [61] cachem_1.0.6              cli_3.6.0                 #>  [63] generics_0.1.3            evaluate_0.20             #>  [65] fastmap_1.1.0             yaml_2.3.7                #>  [67] ragg_1.2.5                knitr_1.42                #>  [69] fs_1.6.0                  purrr_1.0.1               #>  [71] s2_1.1.2                  sparseMatrixStats_1.10.0  #>  [73] R.oo_1.25.0               compiler_4.2.2            #>  [75] beeswarm_0.4.0            png_0.1-8                 #>  [77] e1071_1.7-12              tibble_3.1.8              #>  [79] statmod_1.5.0             bslib_0.4.2               #>  [81] stringi_1.7.12            highr_0.10                #>  [83] desc_1.4.2                lattice_0.20-45           #>  [85] Matrix_1.5-3              classInt_0.4-8            #>  [87] vctrs_0.5.2               pillar_1.8.1              #>  [89] lifecycle_1.0.3           rhdf5filters_1.10.0       #>  [91] jquerylib_0.1.4           BiocNeighbors_1.16.0      #>  [93] cowplot_1.1.1             bitops_1.0-7              #>  [95] irlba_2.3.5.1             R6_2.5.1                  #>  [97] KernSmooth_2.23-20        gridExtra_2.3             #>  [99] vipor_0.4.5               codetools_0.2-18          #> [101] boot_1.3-28.1             MASS_7.3-58.2             #> [103] assertthat_0.2.1          rhdf5_2.42.0              #> [105] rprojroot_2.0.3           withr_2.5.0               #> [107] GenomeInfoDbData_1.2.9    parallel_4.2.2            #> [109] grid_4.2.2                beachmat_2.14.0           #> [111] class_7.3-21              rmarkdown_2.20            #> [113] DelayedMatrixStats_1.20.0 ggnewscale_0.4.8          #> [115] sf_1.0-9                  ggbeeswarm_0.7.1"},{"path":"https://pachterlab.github.io/voyager/articles/visium_10x_spatial.html","id":"introduction","dir":"Articles","previous_headings":"","what":"Introduction","title":"Spatial analysis of 10X example Visium dataset","text":"introductory vignette, performed basic non-spatial analyses mouse olfactory bulb Visium dataset 10X website. vignette, perform spatial analyses histological space well gene expression space. load packages used vignette: download data 10X website. unfiltered gene count matrix: spatial information: Decompress downloaded content: Contents outs directory Space Ranger explained introductory vignette. read data R SFE object. add QC metrics, already plotted introductory vignette.","code":"library(Voyager) library(SpatialFeatureExperiment) library(SingleCellExperiment) #> Loading required package: SummarizedExperiment #> Loading required package: MatrixGenerics #> Loading required package: matrixStats #>  #> Attaching package: 'MatrixGenerics' #> The following objects are masked from 'package:matrixStats': #>  #>     colAlls, colAnyNAs, colAnys, colAvgsPerRowSet, colCollapse, #>     colCounts, colCummaxs, colCummins, colCumprods, colCumsums, #>     colDiffs, colIQRDiffs, colIQRs, colLogSumExps, colMadDiffs, #>     colMads, colMaxs, colMeans2, colMedians, colMins, colOrderStats, #>     colProds, colQuantiles, colRanges, colRanks, colSdDiffs, colSds, #>     colSums2, colTabulates, colVarDiffs, colVars, colWeightedMads, #>     colWeightedMeans, colWeightedMedians, colWeightedSds, #>     colWeightedVars, rowAlls, rowAnyNAs, rowAnys, rowAvgsPerColSet, #>     rowCollapse, rowCounts, rowCummaxs, rowCummins, rowCumprods, #>     rowCumsums, rowDiffs, rowIQRDiffs, rowIQRs, rowLogSumExps, #>     rowMadDiffs, rowMads, rowMaxs, rowMeans2, rowMedians, rowMins, #>     rowOrderStats, rowProds, rowQuantiles, rowRanges, rowRanks, #>     rowSdDiffs, rowSds, rowSums2, rowTabulates, rowVarDiffs, rowVars, #>     rowWeightedMads, rowWeightedMeans, rowWeightedMedians, #>     rowWeightedSds, rowWeightedVars #> Loading required package: GenomicRanges #> Loading required package: stats4 #> Loading required package: BiocGenerics #>  #> Attaching package: 'BiocGenerics' #> The following objects are masked from 'package:stats': #>  #>     IQR, mad, sd, var, xtabs #> The following objects are masked from 'package:base': #>  #>     anyDuplicated, aperm, append, as.data.frame, basename, cbind, #>     colnames, dirname, do.call, duplicated, eval, evalq, Filter, Find, #>     get, grep, grepl, intersect, is.unsorted, lapply, Map, mapply, #>     match, mget, order, paste, pmax, pmax.int, pmin, pmin.int, #>     Position, rank, rbind, Reduce, rownames, sapply, setdiff, sort, #>     table, tapply, union, unique, unsplit, which.max, which.min #> Loading required package: S4Vectors #>  #> Attaching package: 'S4Vectors' #> The following objects are masked from 'package:base': #>  #>     expand.grid, I, unname #> Loading required package: IRanges #> Loading required package: GenomeInfoDb #> Loading required package: Biobase #> Welcome to Bioconductor #>  #>     Vignettes contain introductory material; view with #>     'browseVignettes()'. To cite Bioconductor, see #>     'citation(\"Biobase\")', and for packages 'citation(\"pkgname\")'. #>  #> Attaching package: 'Biobase' #> The following object is masked from 'package:MatrixGenerics': #>  #>     rowMedians #> The following objects are masked from 'package:matrixStats': #>  #>     anyMissing, rowMedians library(ggplot2) library(scater) #> Loading required package: scuttle library(scuttle) library(scran) library(stringr) library(patchwork) library(bluster) library(rjson) library(EBImage) #>  #> Attaching package: 'EBImage' #> The following object is masked from 'package:SummarizedExperiment': #>  #>     resize #> The following object is masked from 'package:Biobase': #>  #>     channel #> The following objects are masked from 'package:GenomicRanges': #>  #>     resize, tile #> The following objects are masked from 'package:IRanges': #>  #>     resize, tile library(terra) #> terra 1.7.3 #>  #> Attaching package: 'terra' #> The following objects are masked from 'package:EBImage': #>  #>     flip, rotate #> The following object is masked from 'package:patchwork': #>  #>     area #> The following objects are masked from 'package:SummarizedExperiment': #>  #>     distance, nearest, shift, trim, values, values<-, width #> The following objects are masked from 'package:GenomicRanges': #>  #>     distance, gaps, nearest, shift, trim, values, values<-, width #> The following objects are masked from 'package:IRanges': #>  #>     distance, gaps, nearest, shift, trim, width #> The following objects are masked from 'package:S4Vectors': #>  #>     values, values<-, width #> The following object is masked from 'package:BiocGenerics': #>  #>     width #> The following objects are masked from 'package:SpatialFeatureExperiment': #>  #>     centroids, crop library(rlang) #>  #> Attaching package: 'rlang' #> The following object is masked from 'package:Biobase': #>  #>     exprs library(sf) #> Linking to GEOS 3.10.2, GDAL 3.4.2, PROJ 8.2.1; sf_use_s2() is TRUE library(rmapshaper) #> Registered S3 method overwritten by 'geojsonlint': #>   method         from  #>   print.location dplyr library(dplyr) #>  #> Attaching package: 'dplyr' #> The following objects are masked from 'package:terra': #>  #>     intersect, union #> The following object is masked from 'package:EBImage': #>  #>     combine #> The following object is masked from 'package:Biobase': #>  #>     combine #> The following objects are masked from 'package:GenomicRanges': #>  #>     intersect, setdiff, union #> The following object is masked from 'package:GenomeInfoDb': #>  #>     intersect #> The following objects are masked from 'package:IRanges': #>  #>     collapse, desc, intersect, setdiff, slice, union #> The following objects are masked from 'package:S4Vectors': #>  #>     first, intersect, rename, setdiff, setequal, union #> The following objects are masked from 'package:BiocGenerics': #>  #>     combine, intersect, setdiff, union #> The following object is masked from 'package:matrixStats': #>  #>     count #> The following objects are masked from 'package:stats': #>  #>     filter, lag #> The following objects are masked from 'package:base': #>  #>     intersect, setdiff, setequal, union library(BiocParallel) library(BiocNeighbors) theme_set(theme_bw()) if (!file.exists(\"visium_ob.tar.gz\"))     download.file(\"https://cf.10xgenomics.com/samples/spatial-exp/2.0.0/Visium_Mouse_Olfactory_Bulb/Visium_Mouse_Olfactory_Bulb_raw_feature_bc_matrix.tar.gz\",                    destfile = \"visium_ob.tar.gz\") if (!file.exists(\"visium_ob_spatial.tar.gz\"))     download.file(\"https://cf.10xgenomics.com/samples/spatial-exp/2.0.0/Visium_Mouse_Olfactory_Bulb/Visium_Mouse_Olfactory_Bulb_spatial.tar.gz\",                    destfile = \"visium_ob_spatial.tar.gz\") if (!dir.exists(\"outs\")) {     dir.create(\"outs\")     system(\"tar -xvf visium_ob.tar.gz -C outs\")     system(\"tar -xvf visium_ob_spatial.tar.gz -C outs\") } (sfe <- read10xVisiumSFE(samples = \"outs\", type = \"sparse\", data = \"raw\")) #> Warning: as(<dgTMatrix>, \"dgCMatrix\") is deprecated since Matrix 1.5-0; do #> as(., \"CsparseMatrix\") instead #> class: SpatialFeatureExperiment  #> dim: 32285 4992  #> metadata(0): #> assays(1): counts #> rownames(32285): ENSMUSG00000051951 ENSMUSG00000089699 ... #>   ENSMUSG00000095019 ENSMUSG00000095041 #> rowData names(1): symbol #> colnames(4992): AAACAACGAATAGTTC-1 AAACAAGTATCTCCCA-1 ... #>   TTGTTTGTATTACACG-1 TTGTTTGTGTAAATTC-1 #> colData names(4): in_tissue array_row array_col sample_id #> reducedDimNames(0): #> mainExpName: NULL #> altExpNames(0): #> spatialCoords names(2) : pxl_row_in_fullres pxl_col_in_fullres #> imgData names(4): sample_id image_id data scaleFactor #>  #> Geometries: #> colGeometries: spotPoly (POLYGON)  #>  #> Graphs: #> sample01: is_mt <- str_detect(rowData(sfe)$symbol, \"^mt-\") sfe <- addPerCellQCMetrics(sfe, subsets = list(mito = is_mt))"},{"path":"https://pachterlab.github.io/voyager/articles/visium_10x_spatial.html","id":"tissue-segmentation","dir":"Articles","previous_headings":"","what":"Tissue segmentation","title":"Spatial analysis of 10X example Visium dataset","text":"Space Ranger can automatically detect spots tissue Loupe browser can used manually annotate spots tissue, may interesting get tissue outline polygon, know much spot overlaps tissue plot outline. tissue boundary polygon can manually annotated QuPath, saves polygon GeoJSON can directly read R st_read(). can segment tissue computationally. R generally isn’t great image processing, packages can perform segmentation, EBImage, based house C C++ code, imager, based CImg. don’t full resolution image. perform tissue segmentation high resolution downsampled image scale make coordinates tissue boundary match spots. EBImage package used . Compared OpenCV, EBImage slow full resolution image, fine downsized image.  rendered static webpage, image static, run interactively, image shown interactive widget can zoom pan. show RGB channels separately   tissue can discerned thresholding. tall peak right background. much lower peaks around 0.6 0.85 must tissue. capture faint bluish region, blue channel used thresholding. threshold chosen based histogram experimenting nearby values.  use opening operation (erosion followed dilation) denoise  small holes tissue, can removed closing operation (dilation followed erosion):  larger holes tissue mask, may real holes faint regions nuclei missed thresholding. might large enough affect Visium spots intersect tissue. Now main piece tissue clear. must object largest area. However, two small pieces belong tissue top left. debris fiducials can removed setting pixels mask outside bounding box main piece 0. assign different value contiguous object bwlabel(), use computeFeatures.shape() find area among shape features (e.g. perimeter) object.  remove small pieces debris.  Object number 797 piece debris bottom left. pieces area 100 pixels tissue. Since debris really small bits tissue, boundary debris tissue can blurry. two distinguished morphology H&E image proximity main tissue. remove debris mask Since holes mask faint regions tissue missed thresholding, holes filled  segmentation process took lot manual oversight, choosing threshold, choosing kernel size shape opening closing operations, deciding whether fill holes, deciding debris tissue. Finally, image needs rotated match spots.","code":"img <- readImage(\"outs/spatial/tissue_hires_image.png\") display(img) img2 <- img colorMode(img2) <- Grayscale display(img2, all = TRUE) hist(img) mask <- img2[,,3] < 0.87 display(mask) kern <- makeBrush(3, shape='disc') mask_open <- opening(mask, kern) display(mask_open) mask_close <- closing(mask_open, kern) display(mask_close) mask_label <- bwlabel(mask_close) fts <- computeFeatures.shape(mask_label) head(fts) #>   s.area s.perimeter s.radius.mean s.radius.sd s.radius.min s.radius.max #> 1     39          25      3.428773   1.3542219    1.4176036     5.762777 #> 2     20          14      2.032665   0.3439068    1.5000000     2.500000 #> 3      8           8      1.144123   0.4370160    0.7071068     1.581139 #> 4     14          10      1.689175   0.2160726    1.5811388     2.121320 #> 5     15          12      1.716761   0.4684015    1.0000000     2.236068 #> 6      9           8      1.207107   0.2071068    1.0000000     1.414214 summary(fts[,\"s.area\"]) #>     Min.  1st Qu.   Median     Mean  3rd Qu.     Max.  #>      8.0     14.0     51.0    595.9    345.0 496326.0 max_ind <- which.max(fts[,\"s.area\"]) inds <- which(as.array(mask_label) == max_ind, arr.ind = TRUE) head(inds) #>       row col #> [1,] 1168 562 #> [2,] 1169 562 #> [3,] 1170 562 #> [4,] 1158 563 #> [5,] 1159 563 #> [6,] 1160 563 row_inds <- c(seq_len(min(inds[,1])-1), seq(max(inds[,1])+1, nrow(mask_label), by = 1)) col_inds <- c(seq_len(min(inds[,2])-1), seq(max(inds[,2])+1, nrow(mask_label), by = 1)) mask_label[row_inds, ] <- 0 mask_label[,col_inds] <- 0 display(mask_label) unique(as.vector(mask_label)) #>  [1]   0 421 425 429 430 438 450 458 461 469 473 483 487 505 523 633 640 642 651 #> [20] 678 739 741 757 762 775 778 789 791 797 805 810 813 820 821 822 826 831 838 #> [39] 839 840 843 845 848 849 861 862 863 fts2 <- fts[unique(as.vector(mask_label))[-1],] fts2 <- fts2[order(fts2[,\"s.area\"], decreasing = TRUE),] plot(fts2[,1][-1], type = \"l\", ylab = \"Area\") head(fts2, 10) #>     s.area s.perimeter s.radius.mean s.radius.sd s.radius.min s.radius.max #> 421 496326        3151    395.118732  68.6493949  234.1605637   485.715835 #> 450    217          55      7.840627   1.2883202    5.0010247    10.458197 #> 849    211          63      7.961248   2.0228566    3.8569142    12.189753 #> 797    182          56      7.547362   2.3368359    3.0772370    11.839919 #> 461    136          54      7.186020   3.2751628    0.9255555    12.479805 #> 741     92          56      6.365661   2.8382829    1.3273276    11.653219 #> 840     69          33      4.503526   1.6417370    1.6026264     7.076974 #> 862     63          37      4.854424   2.4445530    0.6361407     8.837838 #> 839     45          25      3.305562   0.7074306    1.9320455     4.526897 #> 775     32          22      2.887407   1.1755375    0.5300865     4.543636 #display(mask_label == 797) mask_label[mask_label %in% c(797, as.numeric(rownames(fts2)[fts2[,1] < 100]))] <- 0 mask_label <- fillHull(mask_label) display(paintObjects(mask_label, img, col=c(\"red\", \"yellow\"), opac=c(1, 0.3))) mask_label <- EBImage::rotate(mask_label, 270) display(mask_label)"},{"path":"https://pachterlab.github.io/voyager/articles/visium_10x_spatial.html","id":"convert-tissue-mask-to-polygon","dir":"Articles","previous_headings":"","what":"Convert tissue mask to polygon","title":"Spatial analysis of 10X example Visium dataset","text":"Now tissue mask, convert polygon. OpenCV can directly perform conversion, isn’t comprehensive R wrapper OpenCV, conversion convoluted R. first convert Image object raster implemented terra, core R package geospatial raster data. terra can convert raster polygon. image downsized, polygon look quite pixelated. mitigate pixelation save memory, ms_simplify() function used simplify polygon, keeping small proportion vertices. st_simplify() function sf can also simplify polygons, can’t specify proportion vertices keep. adding geometry SFE object, needs scaled match coordinates spots  can use geometric operations find spots intersect tissue, spots covered tissue, much spot intersects tissue. Discrepancies Space Ranger’s annotation annotation based tissue segmentation :  Spots margin can intersect tissue without covered .  can also get geometries intersections tissue Visium spots, calculate percentage spot tissue. However, percentage may useful tissue segmentation subject error. percentage may useful pathologist annotated histological regions objects nuclei myofibers. spots intersect tissue, total counts relate percentage spot tissue?  Spots fully covered tissue lower total UMI counts, can due fully tissue cell types lower total counts histological region near edge, spots fully covered tissue also low UMI counts.","code":"raster2polygon <- function(seg, keep = 0.2) {     r <- rast(t(as.array(seg)), extent = ext(0, nrow(seg), 0, ncol(seg)))     r[r < 1] <- NA     contours <- st_as_sf(as.polygons(r, dissolve = TRUE))     simplified <- ms_simplify(contours, keep = keep)     list(full = contours,          simplified = simplified) } tb <- raster2polygon(mask_label) scale_factors <- fromJSON(file = \"outs/spatial/scalefactors_json.json\") tb$simplified$geometry <- tb$simplified$geometry / scale_factors$tissue_hires_scalef tissueBoundary(sfe) <- tb$simplified plotSpatialFeature(sfe, \"sum\", annotGeometryName = \"tissueBoundary\",                     annot_fixed = list(fill = NA, size = 0.5, color = \"black\")) +     theme_void() # Which spots intersect tissue sfe$int_tissue <- annotPred(sfe, colGeometryName = \"spotPoly\",                              annotGeometryName = \"tissueBoundary\",                             pred = st_intersects) sfe$cov_tissue <- annotPred(sfe, colGeometryName = \"spotPoly\",                              annotGeometryName = \"tissueBoundary\",                             pred = st_covered_by) sfe$diff_sr <- case_when(sfe$in_tissue == sfe$int_tissue ~ \"same\",                          sfe$in_tissue & !sfe$int_tissue ~ \"Space Ranger\",                          sfe$int_tissue & !sfe$in_tissue ~ \"segmentation\") |>      factor(levels = c(\"Space Ranger\", \"same\", \"segmentation\")) plotSpatialFeature(sfe, \"diff_sr\",                     annotGeometryName = \"tissueBoundary\",                     annot_fixed = list(fill = NA, size = 0.5, color = \"black\")) +     scale_fill_brewer(type = \"div\", palette = 4) +     theme_void() #> Scale for fill is already present. #> Adding another scale for fill, which will replace the existing scale. sfe$diff_int_cov <- sfe$int_tissue != sfe$cov_tissue plotSpatialFeature(sfe, \"diff_int_cov\",                     annotGeometryName = \"tissueBoundary\",                     annot_fixed = list(fill = NA, size = 0.5, color = \"black\")) +     theme_void() spot_ints <- annotOp(sfe, colGeometryName = \"spotPoly\",                       annotGeometryName = \"tissueBoundary\", op = st_intersection) sfe$pct_tissue <- st_area(spot_ints) / st_area(spotPoly(sfe)) * 100 sfe_tissue <- sfe[,sfe$int_tissue] plotColDataBin2D(sfe_tissue, x = \"pct_tissue\", y = \"sum\", subset = \"diff_int_cov\",                 name_true = \"Not covered\", name_false = \"Covered\", bins = 50)"},{"path":"https://pachterlab.github.io/voyager/articles/visium_10x_spatial.html","id":"spatial-autocorrelation-of-qc-metrics","dir":"Articles","previous_headings":"","what":"Spatial autocorrelation of QC metrics","title":"Spatial analysis of 10X example Visium dataset","text":"","code":"colGraph(sfe_tissue, \"visium\") <- findVisiumGraph(sfe_tissue) qc_features <- c(\"sum\", \"detected\", \"subsets_mito_percent\") sfe_tissue <- colDataUnivariate(sfe_tissue, \"moran.mc\", qc_features, nsim = 200) plotMoranMC(sfe_tissue, qc_features) sfe_tissue <- colDataUnivariate(sfe_tissue, \"sp.correlogram\", qc_features,                                 order = 8) plotCorrelogram(sfe_tissue, qc_features) sfe_tissue <- colDataUnivariate(sfe_tissue, \"localmoran\", qc_features) plotLocalResult(sfe_tissue, \"localmoran\", qc_features, ncol = 2,                 colGeometryName = \"spotPoly\", divergent = TRUE,                  diverge_center = 0) &     theme_void() sfe_tissue <- colDataUnivariate(sfe_tissue, \"LOSH\", qc_features) plotLocalResult(sfe_tissue, \"LOSH\", qc_features, ncol = 2,                 colGeometryName = \"spotPoly\") &     theme_void() sfe_tissue <- colDataUnivariate(sfe_tissue, \"moran.plot\", qc_features) moranPlot(sfe_tissue, \"subsets_mito_percent\")"},{"path":"https://pachterlab.github.io/voyager/articles/visium_10x_spatial.html","id":"spatial-autocorrelation-of-gene-expression","dir":"Articles","previous_headings":"","what":"Spatial autocorrelation of gene expression","title":"Spatial analysis of 10X example Visium dataset","text":"Normalize data scran method, find highly variable genes Find Moran’s highly variable genes  vast majority genes positive Moran’s . plot genes highest Moran’s .  global Moran’s seems tissue structure. genes negative Moran’s might statistically significant   ’re 2000 highly variable genes 2000 tests, longer significant correcting multiple testing. global Moran’s relate gene expression level?  Genes highly expressed overall tend higher Moran’s .","code":"#clusters <- quickCluster(sfe_tissue) #sfe_tissue <- computeSumFactors(sfe_tissue, clusters=clusters) #sfe_tissue <- sfe_tissue[, sizeFactors(sfe_tissue) > 0] sfe_tissue <- logNormCounts(sfe_tissue) dec <- modelGeneVar(sfe_tissue) hvgs <- getTopHVGs(dec, n = 2000) sfe_tissue <- runMoransI(sfe_tissue, features = hvgs, BPPARAM = MulticoreParam(2)) plotRowDataHistogram(sfe_tissue, \"moran_sample01\") #> Warning: Removed 30285 rows containing non-finite values (`stat_bin()`). top_moran <- rownames(sfe_tissue)[order(rowData(sfe_tissue)$moran_sample01,                                          decreasing = TRUE)[1:9]] plotSpatialFeature(sfe_tissue, top_moran, ncol = 3) & theme_void() neg_moran <- rownames(sfe_tissue)[order(rowData(sfe_tissue)$moran_sample01,                                          decreasing = FALSE)[1:9]] plotSpatialFeature(sfe_tissue, neg_moran, ncol = 3) & theme_void() sfe_tissue <- runUnivariate(sfe_tissue, \"moran.mc\", neg_moran,                              colGraphName = \"visium\", nsim = 200, alternative = \"less\") plotMoranMC(sfe_tissue, neg_moran) rowData(sfe_tissue)[neg_moran, c(\"moran_sample01\", \"moran.mc_p.value_sample01\")] #> DataFrame with 9 rows and 2 columns #>                    moran_sample01 moran.mc_p.value_sample01 #>                         <numeric>                 <numeric> #> ENSMUSG00000041426     -0.0531915                0.00497512 #> ENSMUSG00000048277     -0.0451179                0.00497512 #> ENSMUSG00000021236     -0.0445148                0.01990050 #> ENSMUSG00000025241     -0.0419121                0.01990050 #> ENSMUSG00000026126     -0.0399917                0.00995025 #> ENSMUSG00000034342     -0.0393964                0.02487562 #> ENSMUSG00000047205     -0.0381599                0.00497512 #> ENSMUSG00000031431     -0.0369456                0.00995025 #> ENSMUSG00000037552     -0.0368969                0.01990050 sfe_tissue <- addPerFeatureQCMetrics(sfe_tissue) names(rowData(sfe_tissue)) #>  [1] \"symbol\"                        \"moran_sample01\"                #>  [3] \"K_sample01\"                    \"moran.mc_statistic_sample01\"   #>  [5] \"moran.mc_parameter_sample01\"   \"moran.mc_p.value_sample01\"     #>  [7] \"moran.mc_alternative_sample01\" \"moran.mc_method_sample01\"      #>  [9] \"moran.mc_data.name_sample01\"   \"moran.mc_res_sample01\"         #> [11] \"mean\"                          \"detected\" plotRowData(sfe_tissue, x = \"mean\", y = \"moran_sample01\") +     scale_x_log10() +     annotation_logticks(sides = \"b\") +     geom_density2d() #> Warning: Transformation introduced infinite values in continuous x-axis #> Transformation introduced infinite values in continuous x-axis #> Warning: Removed 30285 rows containing non-finite values #> (`stat_density2d()`). #> Warning: Removed 30285 rows containing missing values (`geom_point()`)."},{"path":"https://pachterlab.github.io/voyager/articles/visium_10x_spatial.html","id":"apply-spatial-analysis-methods-to-gene-expression-space","dir":"Articles","previous_headings":"","what":"Apply spatial analysis methods to gene expression space","title":"Spatial analysis of 10X example Visium dataset","text":"Spatial statistics require spatial neighborhood graph can also applied k nearest neighbor graph histological space gene expression space. done depth vignette. Caveat current version Voyager: running Moran’s different neighborhood graph overwrite existing Moran’s results. next version, users may specify new names statistics different parameters parameters stored rowData. genes tend similar neighbors 10 nearest neighbor graph PCA space gene expression rather histological space:  Although Moran’s computed histological space, genes highest Moran’s PCA space also show spatial structure, different cell types reside different spatial regions.","code":"sfe_tissue <- runPCA(sfe_tissue, ncomponents = 30, subset_row = hvgs,                      scale = TRUE) # scale as in Seurat foo <- findKNN(reducedDim(sfe_tissue, \"PCA\")[,1:10], k=10, BNPARAM=AnnoyParam()) # Split by row foo_nb <- asplit(foo$index, 1) dmat <- 1/foo$distance # Row normalize the weights dmat <- sweep(dmat, 1, rowSums(dmat), FUN = \"/\") glist <- asplit(dmat, 1) # Sort based on index ord <- lapply(foo_nb, order) foo_nb <- lapply(seq_along(foo_nb), function(i) foo_nb[[i]][ord[[i]]]) class(foo_nb) <- \"nb\" glist <- lapply(seq_along(glist), function(i) glist[[i]][ord[[i]]])  listw <- list(style = \"W\",               neighbours = foo_nb,               weights = glist) class(listw) <- \"listw\" attr(listw, \"region.id\") <- colnames(sfe_tissue) colGraph(sfe_tissue, \"knn10\") <- listw sfe_tissue <- runMoransI(sfe_tissue, features = hvgs, BPPARAM = MulticoreParam(2),                          colGraphName = \"knn10\") top_moran2 <- rownames(sfe_tissue)[order(rowData(sfe_tissue)$moran_sample01,                                          decreasing = TRUE)[1:9]] plotSpatialFeature(sfe_tissue, top_moran2, ncol = 3) & theme_void()"},{"path":"https://pachterlab.github.io/voyager/articles/visium_10x_spatial.html","id":"session-info","dir":"Articles","previous_headings":"","what":"Session info","title":"Spatial analysis of 10X example Visium dataset","text":"","code":"sessionInfo() #> R version 4.2.2 (2022-10-31) #> Platform: x86_64-apple-darwin17.0 (64-bit) #> Running under: macOS Big Sur ... 10.16 #>  #> Matrix products: default #> BLAS:   /Library/Frameworks/R.framework/Versions/4.2/Resources/lib/libRblas.0.dylib #> LAPACK: /Library/Frameworks/R.framework/Versions/4.2/Resources/lib/libRlapack.dylib #>  #> locale: #> [1] en_US.UTF-8/en_US.UTF-8/en_US.UTF-8/C/en_US.UTF-8/en_US.UTF-8 #>  #> attached base packages: #> [1] stats4    stats     graphics  grDevices utils     datasets  methods   #> [8] base      #>  #> other attached packages: #>  [1] BiocNeighbors_1.16.0           BiocParallel_1.32.5            #>  [3] dplyr_1.0.10                   rmapshaper_0.4.6               #>  [5] sf_1.0-9                       rlang_1.0.6                    #>  [7] terra_1.7-3                    EBImage_4.40.0                 #>  [9] rjson_0.2.21                   bluster_1.8.0                  #> [11] patchwork_1.1.2                stringr_1.5.0                  #> [13] scran_1.26.2                   scater_1.27.3                  #> [15] scuttle_1.8.4                  ggplot2_3.4.0                  #> [17] SingleCellExperiment_1.20.0    SummarizedExperiment_1.28.0    #> [19] Biobase_2.58.0                 GenomicRanges_1.50.2           #> [21] GenomeInfoDb_1.34.7            IRanges_2.32.0                 #> [23] S4Vectors_0.36.1               BiocGenerics_0.44.0            #> [25] MatrixGenerics_1.10.0          matrixStats_0.63.0             #> [27] SpatialFeatureExperiment_1.0.3 Voyager_1.0.8                  #>  #> loaded via a namespace (and not attached): #>   [1] systemfonts_1.0.4         igraph_1.3.5              #>   [3] lazyeval_0.2.2            splines_4.2.2             #>   [5] sp_1.6-0                  jqr_1.2.3                 #>   [7] geojsonlint_0.4.0         digest_0.6.31             #>   [9] htmltools_0.5.4           viridis_0.6.2             #>  [11] magick_2.7.3              tiff_0.1-11               #>  [13] fansi_1.0.4               magrittr_2.0.3            #>  [15] memoise_2.0.1             geojsonsf_2.0.3           #>  [17] ScaledMatrix_1.6.0        SpatialExperiment_1.8.0   #>  [19] cluster_2.1.4             limma_3.54.1              #>  [21] R.utils_2.12.2            pkgdown_2.0.7             #>  [23] jpeg_0.1-10               colorspace_2.1-0          #>  [25] ggrepel_0.9.2             jsonvalidate_1.3.2        #>  [27] textshaping_0.3.6         xfun_0.36                 #>  [29] RCurl_1.98-1.10           jsonlite_1.8.4            #>  [31] glue_1.6.2                gtable_0.3.1              #>  [33] zlibbioc_1.44.0           XVector_0.38.0            #>  [35] V8_4.2.2                  DelayedArray_0.24.0       #>  [37] scico_1.3.1               BiocSingular_1.14.0       #>  [39] DropletUtils_1.18.1       Rhdf5lib_1.20.0           #>  [41] HDF5Array_1.26.0          abind_1.4-5               #>  [43] scales_1.2.1              DBI_1.1.3                 #>  [45] edgeR_3.40.2              Rcpp_1.0.10               #>  [47] isoband_0.2.7             viridisLite_0.4.1         #>  [49] spData_2.2.1              units_0.8-1               #>  [51] dqrng_0.3.0               foreign_0.8-84            #>  [53] spdep_1.2-7               rsvd_1.0.5                #>  [55] proxy_0.4-27              metapod_1.6.0             #>  [57] htmlwidgets_1.6.1         RColorBrewer_1.1-3        #>  [59] wk_0.7.1                  farver_2.1.1              #>  [61] pkgconfig_2.0.3           R.methodsS3_1.8.2         #>  [63] sass_0.4.5                deldir_1.0-6              #>  [65] crul_1.3                  locfit_1.5-9.7            #>  [67] utf8_1.2.2                labeling_0.4.2            #>  [69] tidyselect_1.2.0          munsell_0.5.0             #>  [71] tools_4.2.2               cachem_1.0.6              #>  [73] cli_3.6.0                 dbscan_1.1-11             #>  [75] generics_0.1.3            evaluate_0.20             #>  [77] fastmap_1.1.0             fftwtools_0.9-11          #>  [79] yaml_2.3.7                ragg_1.2.5                #>  [81] knitr_1.42                fs_1.6.0                  #>  [83] purrr_1.0.1               s2_1.1.2                  #>  [85] nlme_3.1-161              sparseMatrixStats_1.10.0  #>  [87] R.oo_1.25.0               compiler_4.2.2            #>  [89] curl_5.0.0                beeswarm_0.4.0            #>  [91] png_0.1-8                 e1071_1.7-12              #>  [93] tibble_3.1.8              statmod_1.5.0             #>  [95] bslib_0.4.2               stringi_1.7.12            #>  [97] highr_0.10                desc_1.4.2                #>  [99] rgeos_0.6-1               lattice_0.20-45           #> [101] Matrix_1.5-3              classInt_0.4-8            #> [103] vctrs_0.5.2               pillar_1.8.1              #> [105] lifecycle_1.0.3           rhdf5filters_1.10.0       #> [107] jquerylib_0.1.4           cowplot_1.1.1             #> [109] maptools_1.1-6            geojsonio_0.10.0          #> [111] bitops_1.0-7              irlba_2.3.5.1             #> [113] R6_2.5.1                  KernSmooth_2.23-20        #> [115] gridExtra_2.3             vipor_0.4.5               #> [117] codetools_0.2-18          MASS_7.3-58.2             #> [119] boot_1.3-28.1             assertthat_0.2.1          #> [121] rhdf5_2.42.0              rprojroot_2.0.3           #> [123] httpcode_0.3.0            withr_2.5.0               #> [125] GenomeInfoDbData_1.2.9    mgcv_1.8-41               #> [127] geojson_0.3.4             parallel_4.2.2            #> [129] grid_4.2.2                beachmat_2.14.0           #> [131] class_7.3-21              rmarkdown_2.20            #> [133] DelayedMatrixStats_1.20.0 ggnewscale_0.4.8          #> [135] ggbeeswarm_0.7.1"},{"path":[]},{"path":"https://pachterlab.github.io/voyager/articles/visium_landing.html","id":"dowload-data-and-create-a-spatialfeatureexperiment-object","dir":"Articles","previous_headings":"Getting Started","what":"Dowload Data and Create a SpatialFeatureExperiment object","title":"Visium Processing Workflows with Voyager","text":"Several publicly available Visium datasets available 10X Genomics website. vignette demonstrates read output typical Visium experiment SpatialFeatureExperiment object.","code":""},{"path":"https://pachterlab.github.io/voyager/articles/visium_landing.html","id":"analysis-workflows","dir":"Articles","previous_headings":"","what":"Analysis Workflows","title":"Visium Processing Workflows with Voyager","text":"vignettes demonstrate workflows can implemented Voyager using variety Visium datasets. analysis tasks include basic quality control, spatial exploratory data analysis, identification spatially variable genes, computation global local spatial statistics. Accompanying Colab notebooks linked available.","code":""},{"path":"https://pachterlab.github.io/voyager/articles/xenium_landing.html","id":"getting-started","dir":"Articles","previous_headings":"","what":"Getting Started","title":"Visium Processing Workflows with Voyager","text":"10x Genomics publicly released Xenium human breast cancer dataset website. tutorial processing output various spatial transcriptomics technologies SpatialFeatureExperiment(SFE) object use Voyager Getting Started page. output files format Xenium data may change technology developed released.","code":""},{"path":"https://pachterlab.github.io/voyager/articles/xenium_landing.html","id":"analysis-workflows","dir":"Articles","previous_headings":"","what":"Analysis Workflows","title":"Visium Processing Workflows with Voyager","text":"vignettes demonstrate workflows can implemented Voyager using variety Visium datasets. analysis tasks include basic quality control, spatial exploratory data analysis, identification spatially variable genes, computation global local spatial statistics. Accompanying Colab notebooks linked available.","code":""},{"path":"https://pachterlab.github.io/voyager/authors.html","id":null,"dir":"","previous_headings":"","what":"Authors","title":"Authors and Citation","text":"Lambda Moses. Author, maintainer. Kayla Jackson. Author. Lior Pachter. Author, reviewer.","code":""},{"path":"https://pachterlab.github.io/voyager/authors.html","id":"citation","dir":"","previous_headings":"","what":"Citation","title":"Authors and Citation","text":"Moses L, Jackson K, Pachter L (2023). Voyager: geospatial spatial omics. R package version 1.0.8, https://github.com/pachterlab/voyager.","code":"@Manual{,   title = {Voyager: From geospatial to spatial omics},   author = {Lambda Moses and Kayla Jackson and Lior Pachter},   year = {2023},   note = {R package version 1.0.8},   url = {https://github.com/pachterlab/voyager}, }"},{"path":"https://pachterlab.github.io/voyager/reference/ElbowPlot.html","id":null,"dir":"Reference","previous_headings":"","what":"Plot the elbow plot or scree plot for PCA — ElbowPlot","title":"Plot the elbow plot or scree plot for PCA — ElbowPlot","text":"Apparently, apparent way plot PC elbow plot extracting variance explained attribute dimred slot, even OSCA book makes elbow plot way, find kind cumbersome compared Seurat. writing function make elbow plot SCE less cumbersome.","code":""},{"path":"https://pachterlab.github.io/voyager/reference/ElbowPlot.html","id":"ref-usage","dir":"Reference","previous_headings":"","what":"Usage","title":"Plot the elbow plot or scree plot for PCA — ElbowPlot","text":"","code":"ElbowPlot(sce, ndims = 20, reduction = \"PCA\")"},{"path":"https://pachterlab.github.io/voyager/reference/ElbowPlot.html","id":"arguments","dir":"Reference","previous_headings":"","what":"Arguments","title":"Plot the elbow plot or scree plot for PCA — ElbowPlot","text":"sce SingleCellExperiment object, anything inherits SingleCellExperiment. ndims Number PCs plot. reduction Name dimension reduction use. must attribute called \"percentVar\". Defaults \"PCA\".","code":""},{"path":"https://pachterlab.github.io/voyager/reference/ElbowPlot.html","id":"value","dir":"Reference","previous_headings":"","what":"Value","title":"Plot the elbow plot or scree plot for PCA — ElbowPlot","text":"ggplot object. y axis percentage variance explained.","code":""},{"path":"https://pachterlab.github.io/voyager/reference/ElbowPlot.html","id":"ref-examples","dir":"Reference","previous_headings":"","what":"Examples","title":"Plot the elbow plot or scree plot for PCA — ElbowPlot","text":"","code":"library(SFEData) library(scater) #> Loading required package: SingleCellExperiment #> Loading required package: SummarizedExperiment #> Loading required package: MatrixGenerics #> Loading required package: matrixStats #>  #> Attaching package: ‘MatrixGenerics’ #> The following objects are masked from ‘package:matrixStats’: #>  #>     colAlls, colAnyNAs, colAnys, colAvgsPerRowSet, colCollapse, #>     colCounts, colCummaxs, colCummins, colCumprods, colCumsums, #>     colDiffs, colIQRDiffs, colIQRs, colLogSumExps, colMadDiffs, #>     colMads, colMaxs, colMeans2, colMedians, colMins, colOrderStats, #>     colProds, colQuantiles, colRanges, colRanks, colSdDiffs, colSds, #>     colSums2, colTabulates, colVarDiffs, colVars, colWeightedMads, #>     colWeightedMeans, colWeightedMedians, colWeightedSds, #>     colWeightedVars, rowAlls, rowAnyNAs, rowAnys, rowAvgsPerColSet, #>     rowCollapse, rowCounts, rowCummaxs, rowCummins, rowCumprods, #>     rowCumsums, rowDiffs, rowIQRDiffs, rowIQRs, rowLogSumExps, #>     rowMadDiffs, rowMads, rowMaxs, rowMeans2, rowMedians, rowMins, #>     rowOrderStats, rowProds, rowQuantiles, rowRanges, rowRanks, #>     rowSdDiffs, rowSds, rowSums2, rowTabulates, rowVarDiffs, rowVars, #>     rowWeightedMads, rowWeightedMeans, rowWeightedMedians, #>     rowWeightedSds, rowWeightedVars #> Loading required package: GenomicRanges #> Loading required package: stats4 #> Loading required package: BiocGenerics #>  #> Attaching package: ‘BiocGenerics’ #> The following objects are masked from ‘package:stats’: #>  #>     IQR, mad, sd, var, xtabs #> The following objects are masked from ‘package:base’: #>  #>     Filter, Find, Map, Position, Reduce, anyDuplicated, aperm, append, #>     as.data.frame, basename, cbind, colnames, dirname, do.call, #>     duplicated, eval, evalq, get, grep, grepl, intersect, is.unsorted, #>     lapply, mapply, match, mget, order, paste, pmax, pmax.int, pmin, #>     pmin.int, rank, rbind, rownames, sapply, setdiff, sort, table, #>     tapply, union, unique, unsplit, which.max, which.min #> Loading required package: S4Vectors #>  #> Attaching package: ‘S4Vectors’ #> The following objects are masked from ‘package:base’: #>  #>     I, expand.grid, unname #> Loading required package: IRanges #> Loading required package: GenomeInfoDb #> Loading required package: Biobase #> Welcome to Bioconductor #>  #>     Vignettes contain introductory material; view with #>     'browseVignettes()'. To cite Bioconductor, see #>     'citation(\"Biobase\")', and for packages 'citation(\"pkgname\")'. #>  #> Attaching package: ‘Biobase’ #> The following object is masked from ‘package:MatrixGenerics’: #>  #>     rowMedians #> The following objects are masked from ‘package:matrixStats’: #>  #>     anyMissing, rowMedians #> Loading required package: scuttle #> Loading required package: ggplot2 sfe <- McKellarMuscleData(\"small\") #> snapshotDate(): 2022-10-31 #> see ?SFEData and browseVignettes('SFEData') for documentation #> downloading 1 resources #> retrieving 1 resource #> loading from cache #> require(“SpatialFeatureExperiment”) sfe <- runPCA(sfe, ncomponents = 10, exprs_values = \"counts\") ElbowPlot(sfe, ndims = 10)"},{"path":"https://pachterlab.github.io/voyager/reference/calculateUnivariate.html","id":null,"dir":"Reference","previous_headings":"","what":"Univariate spatial stiatistics — calculateUnivariate","title":"Univariate spatial stiatistics — calculateUnivariate","text":"functions compute univariate spatial statistics, global local, matrices, data frames, SFE objects. SFE objects, statistics can computed numeric columns colData, colGeometries, annotGeometries, results stored within SFE object. calculateMoransI runMoransI convenience wrappers calculateUnivariate runUnivariate respectively.","code":""},{"path":"https://pachterlab.github.io/voyager/reference/calculateUnivariate.html","id":"ref-usage","dir":"Reference","previous_headings":"","what":"Usage","title":"Univariate spatial stiatistics — calculateUnivariate","text":"","code":"# S4 method for ANY calculateUnivariate(   x,   listw,   type = c(\"moran\", \"geary\", \"moran.mc\", \"geary.mc\", \"moran.test\", \"geary.test\",     \"globalG.test\", \"sp.correlogram\", \"moran.plot\", \"localmoran\", \"localmoran_perm\",     \"localC\", \"localC_perm\", \"localG\", \"localG_perm\", \"LOSH\", \"LOSH.mc\", \"LOSH.cs\",     \"gwss\"),   BPPARAM = SerialParam(),   zero.policy = NULL,   returnDF = TRUE,   p.adjust.method = \"BH\",   ... )  # S4 method for SpatialFeatureExperiment calculateUnivariate(   x,   type,   features = NULL,   colGraphName = 1L,   sample_id = NULL,   exprs_values = \"logcounts\",   BPPARAM = SerialParam(),   zero.policy = NULL,   returnDF = TRUE,   include_self = FALSE,   p.adjust.method = \"BH\",   ... )  # S4 method for ANY calculateMoransI(x, ..., BPPARAM = SerialParam(), zero.policy = NULL)  # S4 method for SpatialFeatureExperiment calculateMoransI(   x,   features = NULL,   colGraphName = 1L,   sample_id = NULL,   exprs_values = \"logcounts\",   BPPARAM = SerialParam(),   zero.policy = NULL,   returnDF = TRUE,   include_self = FALSE,   p.adjust.method = \"BH\",   ... )  colDataUnivariate(   x,   type,   features,   colGraphName = 1L,   sample_id = NULL,   BPPARAM = SerialParam(),   zero.policy = NULL,   include_self = FALSE,   p.adjust.method = \"BH\",   ... )  colDataMoransI(   x,   features,   colGraphName = 1L,   sample_id = NULL,   BPPARAM = SerialParam(),   zero.policy = NULL,   include_self = FALSE,   p.adjust.method = \"BH\",   ... )  colGeometryUnivariate(   x,   type,   features,   colGeometryName = 1L,   colGraphName = 1L,   sample_id = NULL,   BPPARAM = SerialParam(),   zero.policy = NULL,   include_self = FALSE,   p.adjust.method = \"BH\",   ... )  colGeometryMoransI(   x,   features,   colGeometryName = 1L,   colGraphName = 1L,   sample_id = NULL,   BPPARAM = SerialParam(),   zero.policy = NULL,   include_self = FALSE,   p.adjust.method = \"BH\",   ... )  annotGeometryUnivariate(   x,   type,   features,   annotGeometryName = 1L,   annotGraphName = 1L,   sample_id = NULL,   BPPARAM = SerialParam(),   zero.policy = NULL,   include_self = FALSE,   p.adjust.method = \"BH\",   ... )  annotGeometryMoransI(   x,   features,   annotGeometryName = 1L,   annotGraphName = 1L,   sample_id = NULL,   BPPARAM = SerialParam(),   zero.policy = NULL,   include_self = FALSE,   p.adjust.method = \"BH\",   ... )  runUnivariate(   x,   type,   features = NULL,   colGraphName = 1L,   sample_id = NULL,   exprs_values = \"logcounts\",   BPPARAM = SerialParam(),   zero.policy = NULL,   include_self = FALSE,   p.adjust.method = \"BH\",   ... )  runMoransI(   x,   features = NULL,   colGraphName = 1L,   sample_id = NULL,   exprs_values = \"logcounts\",   BPPARAM = SerialParam(),   zero.policy = NULL,   include_self = FALSE,   p.adjust.method = \"BH\",   ... )"},{"path":"https://pachterlab.github.io/voyager/reference/calculateUnivariate.html","id":"arguments","dir":"Reference","previous_headings":"","what":"Arguments","title":"Univariate spatial stiatistics — calculateUnivariate","text":"x numeric matrix whose rows features/genes, SpatialFeatureExperiment (SFE) object matrix assay. listw Weighted neighborhood graph spdep listw object. type integer specifying index string specifying name *Geometry query replace. missing, first item *Geometries returned replaced. BPPARAM BiocParallelParam object specifying whether computing metric numerous genes shall parallelized. zero.policy default NULL, use global option value; TRUE assign zero lagged value zones without neighbours, FALSE assign NA returnDF Logical, results added SFE object, whether results formatted DataFrame. p.adjust.method Method correct multiple testing, passed p.adjustSP. Methods allowed p.adjust.methods. ... arguments passed S4 method (convenience wrappers like calculateMoransI) method used compute metrics specified argument type (general functions like calculateUnivariate). See documentation spdep package latter. features Genes (calculate* SFE method run*) numeric columns colData(x) (colData*) colGeometry (colGeometry*) annotGeometry (annotGeometry*) univariate metric computed. Default NULL. NULL, metric computed genes values assay specified argument exprs_values. can parallelized argument BPPARAM. genes, column \"symbol\" present rowData row names SFE object Ensembl IDs, gene symbol can used converted IDs behind scene. However, one symbol matches multiple IDs, warning given first match used. Internally, results always stored Ensembl ID rather symbol. colGraphName Name listw graph SFE object corresponds entities represented columns gene count matrix. Use colGraphNames look names available graphs cells/spots. Note multiple sample_ids, assumed graph name. sample_id Sample(s) SFE object whose cells/spots use. Can \"\" compute metric samples; metric computed separately sample. exprs_values Integer scalar string indicating assay x contains expression values. include_self Logical, whether spatial neighborhood graph include edges location . Getis-Ord Gi* localG localG_perm, used method. colGeometryName Name colGeometry sf data frame whose numeric columns interest used compute metric. Use colGeometryNames look names sf data frames associated cells/spots. annotGeometryName Name annotGeometry sf data frame whose numeric columns interest used compute metric. Use annotGeometryNames look names sf data frames associated annotations. annotGraphName Name listw graph SFE object corresponds annotGeometry interest. Use annotGraphNames look names available annotation graphs.","code":""},{"path":"https://pachterlab.github.io/voyager/reference/calculateUnivariate.html","id":"value","dir":"Reference","previous_headings":"","what":"Value","title":"Univariate spatial stiatistics — calculateUnivariate","text":"calculateUnivariate, returnDF = TRUE,  DataFrame, otherwise list element results   feature. run*, SpatialFeatureExperiment object   results added. See Details results stored.","code":""},{"path":"https://pachterlab.github.io/voyager/reference/calculateUnivariate.html","id":"details","dir":"Reference","previous_headings":"","what":"Details","title":"Univariate spatial stiatistics — calculateUnivariate","text":"univariate methods package spdep supported . methods global, meaning returning one result spatial locations dataset: moran, geary, moran.mc, geary.mc, moran.test, geary.test, globalG.test, sp.correlogram. following methods local, meaning location results: moran.plot, localmoran, localmoran_perm, localC, localC_perm, localG, localG_perm, LOSH, LOSH.mc, LOSH.cs. GWmodel::gwss method supported soon, supported yet. Global results genes stored rowData. colGeometry annotGeometry, results added attribute data frame called featureData, DataFrame analogous rowData gene count matrix. New column names featureData follow rules rowData. colData, results can accessed colFeatureData function. Local results stored field localResults field SFE object, can accessed localResults localResult. results p-values, -log10 p Benjamin-Hochberg corrected -log10 p added. Note multiple testing correction, p.adjustSP used.","code":""},{"path":"https://pachterlab.github.io/voyager/reference/calculateUnivariate.html","id":"ref-examples","dir":"Reference","previous_headings":"","what":"Examples","title":"Univariate spatial stiatistics — calculateUnivariate","text":"","code":"library(SpatialFeatureExperiment) library(SingleCellExperiment) library(SFEData) sfe <- McKellarMuscleData(\"small\") #> snapshotDate(): 2022-10-31 #> see ?SFEData and browseVignettes('SFEData') for documentation #> loading from cache colGraph(sfe, \"visium\") <- findVisiumGraph(sfe) features_use <- rownames(sfe)[1:5]  # Moran's I moran_results <- calculateMoransI(sfe,     features = features_use,     colGraphName = \"visium\",     exprs_values = \"counts\" )  # This does not advocate for computing Moran's I on raw counts. # Just an example for function usage.  sfe <- runMoransI(sfe,     features = features_use, colGraphName = \"visium\",     exprs_values = \"counts\" ) # Look at the results head(rowData(sfe)) #> DataFrame with 6 rows and 8 columns #>                               Ensembl      symbol            type       means #>                           <character> <character>     <character>   <numeric> #> ENSMUSG00000025902 ENSMUSG00000025902       Sox17 Gene Expression 0.007612179 #> ENSMUSG00000096126 ENSMUSG00000096126     Gm22307 Gene Expression 0.000200321 #> ENSMUSG00000033845 ENSMUSG00000033845      Mrpl15 Gene Expression 0.075921474 #> ENSMUSG00000025903 ENSMUSG00000025903      Lypla1 Gene Expression 0.057491987 #> ENSMUSG00000033813 ENSMUSG00000033813       Tcea1 Gene Expression 0.052283654 #> ENSMUSG00000002459 ENSMUSG00000002459       Rgs20 Gene Expression 0.000200321 #>                           vars       cv2 moran_Vis5A   K_Vis5A #>                      <numeric> <numeric>   <numeric> <numeric> #> ENSMUSG00000025902 0.008757912  151.1411  -0.0424335  13.32749 #> ENSMUSG00000096126 0.000200321 4992.0000         NaN       NaN #> ENSMUSG00000033845 0.114250804   19.8212   0.2485804   5.41594 #> ENSMUSG00000025903 0.080645121   24.3985   0.0070062   9.46309 #> ENSMUSG00000033813 0.073603279   26.9256   0.1592157   8.51384 #> ENSMUSG00000002459 0.000200321 4992.0000          NA        NA  # Local Moran's I sfe <- runUnivariate(sfe,     type = \"localmoran\", features = features_use,     colGraphName = \"visium\", exprs_values = \"counts\" ) head(localResult(sfe, \"localmoran\", features_use[1])) #>                           Ii         E.Ii     Var.Ii       Z.Ii Pr(z != E(Ii)) #> AAATTACCTATCGATG -0.02897069 -0.001345388 0.01609308 -0.2177647     0.82761246 #> AACATATCAACTGGTG -0.29141104 -0.001345388 0.01609308 -2.2865292     0.02222332 #> AAGATTGGCGGAACGT  0.10224949 -0.001345388 0.01958757  0.7401981     0.45917982 #> AAGGGACAGATTCTGT -0.02897069 -0.001345388 0.01609308 -0.2177647     0.82761246 #> AATATCGAGGGTTCTC  0.10224949 -0.001345388 0.01609308  0.8166176     0.41414701 #> AATGATGATACGCTAT  0.10224949 -0.001345388 0.01609308  0.8166176     0.41414701 #>                      mean   median    pysal    -log10p -log10p_adj #> AAATTACCTATCGATG Low-High Low-High Low-High 0.08217298   0.0000000 #> AACATATCAACTGGTG Low-High Low-High Low-High 1.65319110   0.8080931 #> AAGATTGGCGGAACGT  Low-Low  Low-Low  Low-Low 0.33801720   0.0000000 #> AAGGGACAGATTCTGT Low-High Low-High Low-High 0.08217298   0.0000000 #> AATATCGAGGGTTCTC  Low-Low  Low-Low  Low-Low 0.38284547   0.0000000 #> AATGATGATACGCTAT  Low-Low  Low-Low  Low-Low 0.38284547   0.0000000  # For colData sfe <- colDataUnivariate(sfe,     type = \"localmoran\", features = \"nCounts\",     colGraphName = \"visium\" ) head(localResult(sfe, \"localmoran\", \"nCounts\")) #>                           Ii          E.Ii      Var.Ii       Z.Ii #> AAATTACCTATCGATG  0.53682603 -0.0073375879 0.087243111  1.8423152 #> AACATATCAACTGGTG  0.20017125 -0.0008174853 0.009783652  2.0319883 #> AAGATTGGCGGAACGT  0.13533683 -0.0002992400 0.004361215  2.0538630 #> AAGGGACAGATTCTGT  0.67946203 -0.0182482408 0.214584793  1.5061757 #> AATATCGAGGGTTCTC -0.01287299 -0.0009633914 0.011528171 -0.1109218 #> AATGATGATACGCTAT  0.15331553 -0.0306802864 0.356207210  0.3082880 #>                  Pr(z != E(Ii))      mean    median     pysal    -log10p #> AAATTACCTATCGATG     0.06542906 High-High High-High High-High 1.18422931 #> AACATATCAACTGGTG     0.04215484 High-High High-High High-High 1.37515260 #> AAGATTGGCGGAACGT     0.03998896 High-High  Low-High High-High 1.39805992 #> AAGGGACAGATTCTGT     0.13202207 High-High High-High High-High 0.87935347 #> AATATCGAGGGTTCTC     0.91167838  High-Low  High-Low  High-Low 0.04015835 #> AATGATGATACGCTAT     0.75786321 High-High  High-Low High-High 0.12040917 #>                  -log10p_adj #> AAATTACCTATCGATG  0.33913127 #> AACATATCAACTGGTG  0.53005456 #> AAGATTGGCGGAACGT  0.61990867 #> AAGGGACAGATTCTGT  0.03425543 #> AATATCGAGGGTTCTC  0.00000000 #> AATGATGATACGCTAT  0.00000000  # For annotGeometries annotGraph(sfe, \"myofiber_tri2nb\") <-     findSpatialNeighbors(sfe,         type = \"myofiber_simplified\", MARGIN = 3L,         method = \"tri2nb\", dist_type = \"idw\",         zero.policy = TRUE     ) sfe <- annotGeometryUnivariate(sfe,     type = \"localG\", features = \"area\",     annotGraphName = \"myofiber_tri2nb\",     annotGeometryName = \"myofiber_simplified\",     zero.policy = TRUE ) head(localResult(sfe, \"localG\", \"area\",     annotGeometryName = \"myofiber_simplified\" )) #> [1] -2.3083710 -0.8140180  0.0508039 -0.1700897  0.1547597 -0.3688569"},{"path":"https://pachterlab.github.io/voyager/reference/clusterCorrelograms.html","id":null,"dir":"Reference","previous_headings":"","what":"Find clusters of correlogram patterns — clusterCorrelograms","title":"Find clusters of correlogram patterns — clusterCorrelograms","text":"Cluster correlograms find patterns length scales spatial autocorrelation. correlograms clustered must computed method number lags.","code":""},{"path":"https://pachterlab.github.io/voyager/reference/clusterCorrelograms.html","id":"ref-usage","dir":"Reference","previous_headings":"","what":"Usage","title":"Find clusters of correlogram patterns — clusterCorrelograms","text":"","code":"clusterCorrelograms(   sfe,   features,   BLUSPARAM,   sample_id = NULL,   method = \"I\",   colGeometryName = NULL,   annotGeometryName = NULL,   show_symbol = TRUE )"},{"path":"https://pachterlab.github.io/voyager/reference/clusterCorrelograms.html","id":"arguments","dir":"Reference","previous_headings":"","what":"Arguments","title":"Find clusters of correlogram patterns — clusterCorrelograms","text":"sfe SpatialFeatureExperiment object correlograms computed features interest. features Features whose correlograms cluster. BLUSPARAM BlusterParam object specifying algorithm use. sample_id Sample(s) SFE object whose cells/spots use. Can \"\" compute metric samples; metric computed separately sample. method \"corr\" correlation, \"\" Moran's , \"C\" Geary's C colGeometryName Name colGeometry look features. annotGeometryName Name annotGeometry look features. show_symbol Logical, whether show gene symbol instead Ensembl ID supplied.","code":""},{"path":"https://pachterlab.github.io/voyager/reference/clusterCorrelograms.html","id":"value","dir":"Reference","previous_headings":"","what":"Value","title":"Find clusters of correlogram patterns — clusterCorrelograms","text":"DataFrame 3 columns: feature features, cluster factor cluster membership features within sample, sample_id sample.","code":""},{"path":"https://pachterlab.github.io/voyager/reference/clusterCorrelograms.html","id":"ref-examples","dir":"Reference","previous_headings":"","what":"Examples","title":"Find clusters of correlogram patterns — clusterCorrelograms","text":"","code":"library(SpatialFeatureExperiment) library(SFEData) library(bluster) sfe <- McKellarMuscleData(\"small\") #> snapshotDate(): 2022-10-31 #> see ?SFEData and browseVignettes('SFEData') for documentation #> loading from cache colGraph(sfe, \"visium\") <- findVisiumGraph(sfe) inds <- c(1, 3, 4, 5) sfe <- runUnivariate(sfe,     type = \"sp.correlogram\",     features = rownames(sfe)[inds],     exprs_values = \"counts\", order = 5 ) clust <- clusterCorrelograms(sfe,     features = rownames(sfe)[inds],     BLUSPARAM = KmeansParam(2) )"},{"path":"https://pachterlab.github.io/voyager/reference/clusterMoranPlot.html","id":null,"dir":"Reference","previous_headings":"","what":"Find clusters on the Moran plot — clusterMoranPlot","title":"Find clusters on the Moran plot — clusterMoranPlot","text":"Moran plot plots value location x axis, average neighbors locations y axis. Sometimes clusters can seen Moran plot, indicating different types neighborhoods.","code":""},{"path":"https://pachterlab.github.io/voyager/reference/clusterMoranPlot.html","id":"ref-usage","dir":"Reference","previous_headings":"","what":"Usage","title":"Find clusters on the Moran plot — clusterMoranPlot","text":"","code":"clusterMoranPlot(   sfe,   features,   BLUSPARAM,   sample_id = NULL,   colGeometryName = NULL,   annotGeometryName = NULL,   show_symbol = TRUE )"},{"path":"https://pachterlab.github.io/voyager/reference/clusterMoranPlot.html","id":"arguments","dir":"Reference","previous_headings":"","what":"Arguments","title":"Find clusters on the Moran plot — clusterMoranPlot","text":"sfe SpatialFeatureExperiment object Moran plot computed feature interest. Moran plot feature computed feature sample_id, calculated stored rowData. See calculateUnivariate. features Features whose Moran plot cluster. Features whose Moran plots computed skipped, warning. BLUSPARAM BlusterParam object specifying algorithm use. sample_id Sample(s) SFE object whose cells/spots use. Can \"\" compute metric samples; metric computed separately sample. colGeometryName Name colGeometry look features. annotGeometryName Name annotGeometry look features. show_symbol Logical, whether show gene symbol instead Ensembl ID supplied.","code":""},{"path":"https://pachterlab.github.io/voyager/reference/clusterMoranPlot.html","id":"value","dir":"Reference","previous_headings":"","what":"Value","title":"Find clusters on the Moran plot — clusterMoranPlot","text":"DataFrame column factor cluster   membership feature. column names features.","code":""},{"path":"https://pachterlab.github.io/voyager/reference/clusterMoranPlot.html","id":"ref-examples","dir":"Reference","previous_headings":"","what":"Examples","title":"Find clusters on the Moran plot — clusterMoranPlot","text":"","code":"library(SpatialFeatureExperiment) library(SingleCellExperiment) library(SFEData) library(bluster) sfe <- McKellarMuscleData(\"small\") #> snapshotDate(): 2022-10-31 #> see ?SFEData and browseVignettes('SFEData') for documentation #> loading from cache colGraph(sfe, \"visium\") <- findVisiumGraph(sfe) # Compute moran plot sfe <- runUnivariate(sfe,     type = \"moran.plot\", features = rownames(sfe)[1],     exprs_values = \"counts\" ) clusts <- clusterMoranPlot(sfe, rownames(sfe)[1],     BLUSPARAM = KmeansParam(2) )"},{"path":"https://pachterlab.github.io/voyager/reference/colFeatureData.html","id":null,"dir":"Reference","previous_headings":"","what":"Get metadata of colData and rowData — colFeatureData","title":"Get metadata of colData and rowData — colFeatureData","text":"Results spatial analyses columns colData rowData stored int_metadata(sfe), internal metadata. function allows users access results.","code":""},{"path":"https://pachterlab.github.io/voyager/reference/colFeatureData.html","id":"ref-usage","dir":"Reference","previous_headings":"","what":"Usage","title":"Get metadata of colData and rowData — colFeatureData","text":"","code":"colFeatureData(sfe)  rowFeatureData(sfe)"},{"path":"https://pachterlab.github.io/voyager/reference/colFeatureData.html","id":"arguments","dir":"Reference","previous_headings":"","what":"Arguments","title":"Get metadata of colData and rowData — colFeatureData","text":"sfe SFE object.","code":""},{"path":"https://pachterlab.github.io/voyager/reference/colFeatureData.html","id":"value","dir":"Reference","previous_headings":"","what":"Value","title":"Get metadata of colData and rowData — colFeatureData","text":"DataFrame.","code":""},{"path":"https://pachterlab.github.io/voyager/reference/colFeatureData.html","id":"ref-examples","dir":"Reference","previous_headings":"","what":"Examples","title":"Get metadata of colData and rowData — colFeatureData","text":"","code":"library(SpatialFeatureExperiment) library(SingleCellExperiment) library(SFEData) sfe <- McKellarMuscleData(\"small\") #> snapshotDate(): 2022-10-31 #> see ?SFEData and browseVignettes('SFEData') for documentation #> loading from cache colGraph(sfe, \"visium\") <- findVisiumGraph(sfe) # Moran's I for colData sfe <- colDataMoransI(sfe, \"nCounts\") colFeatureData(sfe) #> DataFrame with 12 rows and 2 columns #>           moran_Vis5A   K_Vis5A #>             <numeric> <numeric> #> barcode            NA        NA #> col                NA        NA #> row                NA        NA #> x                  NA        NA #> y                  NA        NA #> ...               ...       ... #> sample_id          NA        NA #> nCounts      0.675416   1.67027 #> nGenes             NA        NA #> prop_mito          NA        NA #> in_tissue          NA        NA"},{"path":"https://pachterlab.github.io/voyager/reference/ditto_colors.html","id":null,"dir":"Reference","previous_headings":"","what":"Colorblind friendly palette from dittoSeq — ditto_colors","title":"Colorblind friendly palette from dittoSeq — ditto_colors","text":"Just get palette without install dependencies dittoSeq.","code":""},{"path":"https://pachterlab.github.io/voyager/reference/ditto_colors.html","id":"ref-usage","dir":"Reference","previous_headings":"","what":"Usage","title":"Colorblind friendly palette from dittoSeq — ditto_colors","text":"","code":"ditto_colors"},{"path":"https://pachterlab.github.io/voyager/reference/ditto_colors.html","id":"format","dir":"Reference","previous_headings":"","what":"Format","title":"Colorblind friendly palette from dittoSeq — ditto_colors","text":"character vector hex colors palette. 40 colors.","code":""},{"path":"https://pachterlab.github.io/voyager/reference/ditto_colors.html","id":"source","dir":"Reference","previous_headings":"","what":"Source","title":"Colorblind friendly palette from dittoSeq — ditto_colors","text":"dittoSeq package.","code":""},{"path":"https://pachterlab.github.io/voyager/reference/getDivergeRange.html","id":null,"dir":"Reference","previous_headings":"","what":"Get beginning and end of palette to center a divergent palette — getDivergeRange","title":"Get beginning and end of palette to center a divergent palette — getDivergeRange","text":"title self-explanatory.","code":""},{"path":"https://pachterlab.github.io/voyager/reference/getDivergeRange.html","id":"ref-usage","dir":"Reference","previous_headings":"","what":"Usage","title":"Get beginning and end of palette to center a divergent palette — getDivergeRange","text":"","code":"getDivergeRange(values, diverge_center = 0)"},{"path":"https://pachterlab.github.io/voyager/reference/getDivergeRange.html","id":"arguments","dir":"Reference","previous_headings":"","what":"Arguments","title":"Get beginning and end of palette to center a divergent palette — getDivergeRange","text":"values Numeric vector colored. diverge_center Value center , defaults 0.","code":""},{"path":"https://pachterlab.github.io/voyager/reference/getDivergeRange.html","id":"value","dir":"Reference","previous_headings":"","what":"Value","title":"Get beginning and end of palette to center a divergent palette — getDivergeRange","text":"numeric vector length 2, first element beginning, second end. values 0 1.","code":""},{"path":"https://pachterlab.github.io/voyager/reference/getDivergeRange.html","id":"ref-examples","dir":"Reference","previous_headings":"","what":"Examples","title":"Get beginning and end of palette to center a divergent palette — getDivergeRange","text":"","code":"v <- rnorm(10) getDivergeRange(v, diverge_center = 0) #> [1] 0.1176166 1.0000000"},{"path":"https://pachterlab.github.io/voyager/reference/moranPlot.html","id":null,"dir":"Reference","previous_headings":"","what":"Use ggplot to plot the moran.plot results — moranPlot","title":"Use ggplot to plot the moran.plot results — moranPlot","text":"function uses ggplot2 plot Moran plot. plot aesthetically pleasing base R version implemented spdep. addition, contours plotted show point density plot, points can colored variable, clusters. contours may also filled influential points plotted. filled, viridis E option used.","code":""},{"path":"https://pachterlab.github.io/voyager/reference/moranPlot.html","id":"ref-usage","dir":"Reference","previous_headings":"","what":"Usage","title":"Use ggplot to plot the moran.plot results — moranPlot","text":"","code":"moranPlot(   sfe,   feature,   graphName = 1L,   sample_id = NULL,   contour_color = \"cyan\",   color_by = NULL,   colGeometryName = NULL,   annotGeometryName = NULL,   plot_singletons = TRUE,   binned = FALSE,   filled = FALSE,   divergent = FALSE,   diverge_center = NULL,   show_symbol = TRUE,   bins = 100,   binwidth = NULL,   hex = FALSE,   plot_influential = TRUE,   ... )"},{"path":"https://pachterlab.github.io/voyager/reference/moranPlot.html","id":"arguments","dir":"Reference","previous_headings":"","what":"Arguments","title":"Use ggplot to plot the moran.plot results — moranPlot","text":"sfe SpatialFeatureExperiment object. feature Name one variable show plot. converted sentence case x axis lower case y axis appended \"Spatially lagged\". One feature time since colors color_by may specific feature (e.g. clusterMoranPlot). graphName Name colGraph annotGraph, spatial neighborhood graph used compute Moran plot. determine points singletons plot differently plot. sample_id One sample_id sample whose graph plot. contour_color Color point density contours, can changed contours stand points. color_by Variable color points . can name column colData, gene, name column colGeometry specified colGeometryName. can vector length number cells/spots sample_id interest. colGeometryName Name colGeometry sf data frame whose numeric columns interest used compute metric. Use colGeometryNames look names sf data frames associated cells/spots. annotGeometryName Name annotGeometry SFE object, annotate gene expression plot. plot_singletons Logical, whether plot items spatial neighbors. binned Logical, whether plot 2D histograms. argument precedence filled. filled Logical, whether plot filled contours non-influential points plot influential points points. divergent Logical, whether divergent palette used. diverge_center divergent = TRUE, center palette diverge. NULL, centering. show_symbol Logical, whether show human readable gene symbol plot instead Ensembl IDs row names Ensembl IDs. must column rowData(sfe) called \"symbol\" work. bins Numeric vector giving number bins vertical horizontal directions. Set 100 default. binwidth Numeric vector giving bin width vertical horizontal directions. Overrides bins set. hex Logical, whether use hexagon rather rectangular bins. Requires hexbin package. plot_influential Logical, whether plot influential points different palette binned = TRUE. ... arguments pass geom_density2d.","code":""},{"path":"https://pachterlab.github.io/voyager/reference/moranPlot.html","id":"value","dir":"Reference","previous_headings":"","what":"Value","title":"Use ggplot to plot the moran.plot results — moranPlot","text":"ggplot object.","code":""},{"path":"https://pachterlab.github.io/voyager/reference/moranPlot.html","id":"ref-examples","dir":"Reference","previous_headings":"","what":"Examples","title":"Use ggplot to plot the moran.plot results — moranPlot","text":"","code":"library(SpatialFeatureExperiment) library(SingleCellExperiment) library(SFEData) library(bluster) library(scater) sfe <- McKellarMuscleData(\"full\") #> snapshotDate(): 2022-10-31 #> see ?SFEData and browseVignettes('SFEData') for documentation #> downloading 1 resources #> retrieving 1 resource #> loading from cache sfe <- sfe[, colData(sfe)$in_tissue] sfe <- logNormCounts(sfe) colGraph(sfe, \"visium\") <- findVisiumGraph(sfe) sfe <- runUnivariate(sfe, type = \"moran.plot\", features = \"Myh1\") clust <- clusterMoranPlot(sfe, \"Myh1\", BLUSPARAM = KmeansParam(2)) moranPlot(sfe, \"Myh1\", graphName = \"visium\", color_by = clust[, 1])"},{"path":"https://pachterlab.github.io/voyager/reference/plotCellBin2D.html","id":null,"dir":"Reference","previous_headings":"","what":"Plot cell density as 2D histogram — plotCellBin2D","title":"Plot cell density as 2D histogram — plotCellBin2D","text":"function plots cell density histological space 2D histograms, especially helpful larger smFISH-based datasets.","code":""},{"path":"https://pachterlab.github.io/voyager/reference/plotCellBin2D.html","id":"ref-usage","dir":"Reference","previous_headings":"","what":"Usage","title":"Plot cell density as 2D histogram — plotCellBin2D","text":"","code":"plotCellBin2D(sfe, bins = 200, binwidth = NULL, hex = FALSE)"},{"path":"https://pachterlab.github.io/voyager/reference/plotCellBin2D.html","id":"arguments","dir":"Reference","previous_headings":"","what":"Arguments","title":"Plot cell density as 2D histogram — plotCellBin2D","text":"sfe SpatialFeatureExperiment object. bins Numeric vector giving number bins vertical horizontal directions. Set 100 default. binwidth Numeric vector giving bin width vertical horizontal directions. Overrides bins set. hex Logical, whether use hexagon rather rectangular bins. Requires hexbin package.","code":""},{"path":"https://pachterlab.github.io/voyager/reference/plotCellBin2D.html","id":"value","dir":"Reference","previous_headings":"","what":"Value","title":"Plot cell density as 2D histogram — plotCellBin2D","text":"ggplot object.","code":""},{"path":"https://pachterlab.github.io/voyager/reference/plotCellBin2D.html","id":"ref-examples","dir":"Reference","previous_headings":"","what":"Examples","title":"Plot cell density as 2D histogram — plotCellBin2D","text":"","code":"library(SFEData) sfe <- HeNSCLCData() #> snapshotDate(): 2022-10-31 #> see ?SFEData and browseVignettes('SFEData') for documentation #> downloading 1 resources #> retrieving 1 resource #> loading from cache plotCellBin2D(sfe)"},{"path":"https://pachterlab.github.io/voyager/reference/plotColDataBin2D.html","id":null,"dir":"Reference","previous_headings":"","what":"Plot colData and rowData with 2D histograms — plotColDataBin2D","title":"Plot colData and rowData with 2D histograms — plotColDataBin2D","text":"avoid overplotting large datasets. 2D histogram informative point density plot scatter plot many points plotted effectively form solid block.","code":""},{"path":"https://pachterlab.github.io/voyager/reference/plotColDataBin2D.html","id":"ref-usage","dir":"Reference","previous_headings":"","what":"Usage","title":"Plot colData and rowData with 2D histograms — plotColDataBin2D","text":"","code":"plotColDataBin2D(   sfe,   x,   y,   subset = NULL,   bins = 100,   binwidth = NULL,   hex = FALSE,   name_true = NULL,   name_false = NULL )  plotRowDataBin2D(   sfe,   x,   y,   subset = NULL,   bins = 100,   binwidth = NULL,   hex = FALSE,   name_true = NULL,   name_false = NULL )"},{"path":"https://pachterlab.github.io/voyager/reference/plotColDataBin2D.html","id":"arguments","dir":"Reference","previous_headings":"","what":"Arguments","title":"Plot colData and rowData with 2D histograms — plotColDataBin2D","text":"sfe SpatialFeatureExperiment object. x Name column colData rowData plot x axis plot. y Name column colData rowData plot y axis plot. subset Name logical column colData rowData, indicating cells genes plot different palette. Since 2D histogram effectively opaque heatmap, use argument unless two groups largely non-overlapping variables plotted. bins Numeric vector giving number bins vertical horizontal directions. Set 100 default. binwidth Numeric vector giving bin width vertical horizontal directions. Overrides bins set. hex Logical, whether use hexagon rather rectangular bins. Requires hexbin package. name_true Character, name show legend cells genes indicated TRUE subset argument. name_false Character, name show legend cells genes indicated FALSE subset argument.","code":""},{"path":"https://pachterlab.github.io/voyager/reference/plotColDataBin2D.html","id":"value","dir":"Reference","previous_headings":"","what":"Value","title":"Plot colData and rowData with 2D histograms — plotColDataBin2D","text":"ggplot object","code":""},{"path":"https://pachterlab.github.io/voyager/reference/plotColDataBin2D.html","id":"ref-examples","dir":"Reference","previous_headings":"","what":"Examples","title":"Plot colData and rowData with 2D histograms — plotColDataBin2D","text":"","code":"library(SFEData) sfe <- McKellarMuscleData() #> snapshotDate(): 2022-10-31 #> see ?SFEData and browseVignettes('SFEData') for documentation #> loading from cache sfe <- sfe[, sfe$in_tissue] plotColDataBin2D(sfe, \"nCounts\", \"nGenes\")"},{"path":"https://pachterlab.github.io/voyager/reference/plotColDataHistogram.html","id":null,"dir":"Reference","previous_headings":"","what":"Plot histograms for colData and rowData columns — plotColDataHistogram","title":"Plot histograms for colData and rowData columns — plotColDataHistogram","text":"Plot histograms colData rowData columns","code":""},{"path":"https://pachterlab.github.io/voyager/reference/plotColDataHistogram.html","id":"ref-usage","dir":"Reference","previous_headings":"","what":"Usage","title":"Plot histograms for colData and rowData columns — plotColDataHistogram","text":"","code":"plotColDataHistogram(   sfe,   feature,   fill_by = NULL,   subset = NULL,   bins = 100,   binwidth = NULL,   scales = \"free\",   ncol = 1,   position = \"identity\" )  plotRowDataHistogram(   sfe,   feature,   fill_by = NULL,   subset = NULL,   bins = 100,   binwidth = NULL,   scales = \"free\",   ncol = 1,   position = \"identity\" )"},{"path":"https://pachterlab.github.io/voyager/reference/plotColDataHistogram.html","id":"arguments","dir":"Reference","previous_headings":"","what":"Arguments","title":"Plot histograms for colData and rowData columns — plotColDataHistogram","text":"sfe SpatialFeatureExperiment object. feature Names columns colData rowData plot. multiple features specified, plotted separate facets. fill_by Name categorical column colData rowData fill histogram. subset Name logical column plot subset data. bins Numeric vector giving number bins vertical horizontal directions. Set 100 default. binwidth Numeric vector giving bin width vertical horizontal directions. Overrides bins set. scales scales fixed (\"fixed\", default), free (\"free\"), free one dimension (\"free_x\", \"free_y\")? ncol Number columns facetting. position Position adjustment, either string naming adjustment (e.g. \"jitter\" use position_jitter), result call position adjustment function. Use latter need change settings adjustment.","code":""},{"path":"https://pachterlab.github.io/voyager/reference/plotColDataHistogram.html","id":"value","dir":"Reference","previous_headings":"","what":"Value","title":"Plot histograms for colData and rowData columns — plotColDataHistogram","text":"ggplot object","code":""},{"path":"https://pachterlab.github.io/voyager/reference/plotColDataHistogram.html","id":"ref-examples","dir":"Reference","previous_headings":"","what":"Examples","title":"Plot histograms for colData and rowData columns — plotColDataHistogram","text":"","code":"library(SFEData) sfe <- McKellarMuscleData() #> snapshotDate(): 2022-10-31 #> see ?SFEData and browseVignettes('SFEData') for documentation #> loading from cache plotColDataHistogram(sfe, c(\"nCounts\", \"nGenes\"), fill_by = \"in_tissue\",                      bins = 50)  plotColDataHistogram(sfe, \"nCounts\", subset = \"in_tissue\")  sfe2 <- sfe[, sfe$in_tissue] plotColDataHistogram(sfe2, c(\"nCounts\", \"nGenes\"), bins = 50)"},{"path":"https://pachterlab.github.io/voyager/reference/plotColGraph.html","id":null,"dir":"Reference","previous_headings":"","what":"Plot spatial graphs — plotColGraph","title":"Plot spatial graphs — plotColGraph","text":"ggplot version spdep::plot.nb, reducing boilerplate SFE objects.","code":""},{"path":"https://pachterlab.github.io/voyager/reference/plotColGraph.html","id":"ref-usage","dir":"Reference","previous_headings":"","what":"Usage","title":"Plot spatial graphs — plotColGraph","text":"","code":"plotColGraph(   sfe,   colGraphName = 1L,   colGeometryName = NULL,   sample_id = NULL,   weights = FALSE,   segment_size = 0.5,   geometry_size = 0.5,   ncol = NULL )  plotAnnotGraph(   sfe,   annotGraphName = 1L,   annotGeometryName = 1L,   sample_id = NULL,   weights = FALSE,   segment_size = 0.5,   geometry_size = 0.5,   ncol = NULL )"},{"path":"https://pachterlab.github.io/voyager/reference/plotColGraph.html","id":"arguments","dir":"Reference","previous_headings":"","what":"Arguments","title":"Plot spatial graphs — plotColGraph","text":"sfe SpatialFeatureExperiment object. colGraphName Name graph associated columns gene count matrix plotted. colGeometryName Name colGeometry sf data frame whose numeric columns interest used compute metric. Use colGeometryNames look names sf data frames associated cells/spots. sample_id Sample(s) SFE object whose cells/spots use. Can \"\" compute metric samples; metric computed separately sample. weights Whether plot weights. TRUE, transparency (alpha) segments represent edge weights. segment_size Thickness segments represent graph edges. geometry_size Point size (POINT geometries) line thickness (LINESTRING POLYGON) plot geometry background. ncol Number columns plotting multiple features. Defaults NULL, means using logic facet_wrap, used patchwork's wrap_plots default. annotGraphName Name annotation graph plot. annotGeometryName Name annotGeometry, associated graph specified annotGraphName, spatial coordinates graph nodes context.","code":""},{"path":"https://pachterlab.github.io/voyager/reference/plotColGraph.html","id":"value","dir":"Reference","previous_headings":"","what":"Value","title":"Plot spatial graphs — plotColGraph","text":"ggplot2 object.","code":""},{"path":"https://pachterlab.github.io/voyager/reference/plotColGraph.html","id":"ref-examples","dir":"Reference","previous_headings":"","what":"Examples","title":"Plot spatial graphs — plotColGraph","text":"","code":"library(SpatialFeatureExperiment) library(SFEData) library(sf) #> Linking to GEOS 3.10.2, GDAL 3.4.2, PROJ 8.2.1; sf_use_s2() is TRUE sfe <- McKellarMuscleData(\"small\") #> snapshotDate(): 2022-10-31 #> see ?SFEData and browseVignettes('SFEData') for documentation #> loading from cache colGraph(sfe, \"visium\") <- findVisiumGraph(sfe) plotColGraph(sfe, colGraphName = \"visium\", colGeometryName = \"spotPoly\")  # Make the myofiber segmentations a valid POLYGON geometry ag <- annotGeometry(sfe, \"myofiber_simplified\") ag <- st_buffer(ag, 0) ag <- ag[!st_is_empty(ag), ] annotGeometry(sfe, \"myofiber_simplified\") <- ag annotGraph(sfe, \"myofibers\") <-     findSpatialNeighbors(sfe,         type = \"myofiber_simplified\", MARGIN = 3,         method = \"tri2nb\", dist_type = \"idw\"     ) plotAnnotGraph(sfe,     annotGraphName = \"myofibers\",     annotGeometryName = \"myofiber_simplified\",     weights = TRUE )"},{"path":"https://pachterlab.github.io/voyager/reference/plotCorrelogram.html","id":null,"dir":"Reference","previous_headings":"","what":"Plot correlogram — plotCorrelogram","title":"Plot correlogram — plotCorrelogram","text":"Use ggplot2 plot correlograms computed runUnivariate, pulling results rowData. Correlograms multiple genes error bars can plotted, can colored numeric categorical column rowData vector length nrow SFE object. coloring useful correlograms clustered show types length scales patterns decay spatial autocorrelation. method = \"\", error bars twice standard deviation estimated Moran's value.","code":""},{"path":"https://pachterlab.github.io/voyager/reference/plotCorrelogram.html","id":"ref-usage","dir":"Reference","previous_headings":"","what":"Usage","title":"Plot correlogram — plotCorrelogram","text":"","code":"plotCorrelogram(   sfe,   features,   sample_id = NULL,   method = \"I\",   color_by = NULL,   facet_by = c(\"sample_id\", \"features\"),   ncol = NULL,   colGeometryName = NULL,   annotGeometryName = NULL,   plot_signif = TRUE,   p_adj_method = \"BH\",   divergent = FALSE,   diverge_center = NULL,   show_symbol = TRUE )"},{"path":"https://pachterlab.github.io/voyager/reference/plotCorrelogram.html","id":"arguments","dir":"Reference","previous_headings":"","what":"Arguments","title":"Plot correlogram — plotCorrelogram","text":"sfe SpatialFeatureExperiment object. features Features plot, must rownames gene count matrix, colnames colData colGeometry. sample_id Sample(s) SFE object whose cells/spots use. Can \"\" compute metric samples; metric computed separately sample. method \"corr\" correlation, \"\" Moran's , \"C\" Geary's C color_by Name column rowData(sfe) featureData colData (see colFeatureData), colGeometry, annotGeometry color correlogram feature. Alternatively, vector length features. facet_by Whether facet sample_id (default) features. facetting sample_id, different features plotted facet comparison. facetting features, different samples compared feature. Ignored one sample specified. ncol Number columns facetting. colGeometryName Name colGeometry sf data frame whose numeric columns interest used compute metric. Use colGeometryNames look names sf data frames associated cells/spots. annotGeometryName Name annotGeometry SFE object, annotate gene expression plot. plot_signif Logical, whether plot significance symbols: p < 0.001: ***, p < 0.01: **, p < 0.05 *, p < 0.1: ., otherwise symbol. p-values two sided, based assumption estimated Moran's normally distributed mean randomized version data. mean variance come moran.test Moran's geary.test Geary's C. Take results grain salt data normally distributed. p_adj_method Multiple testing correction method p.adjust, correct multiple testing (number lags times number features) Moran's estimates plot_signif = TRUE. divergent Logical, whether divergent palette used. diverge_center divergent = TRUE, center palette diverge. NULL, centering. show_symbol Logical, whether show human readable gene symbol plot instead Ensembl IDs row names Ensembl IDs. must column rowData(sfe) called \"symbol\" work.","code":""},{"path":"https://pachterlab.github.io/voyager/reference/plotCorrelogram.html","id":"value","dir":"Reference","previous_headings":"","what":"Value","title":"Plot correlogram — plotCorrelogram","text":"ggplot object.","code":""},{"path":"https://pachterlab.github.io/voyager/reference/plotCorrelogram.html","id":"ref-examples","dir":"Reference","previous_headings":"","what":"Examples","title":"Plot correlogram — plotCorrelogram","text":"","code":"library(SpatialFeatureExperiment) library(SFEData) library(bluster) library(scater) sfe <- McKellarMuscleData(\"small\") #> snapshotDate(): 2022-10-31 #> see ?SFEData and browseVignettes('SFEData') for documentation #> loading from cache sfe <- logNormCounts(sfe) colGraph(sfe, \"visium\") <- findVisiumGraph(sfe) inds <- c(1, 3, 4, 5) features <- rownames(sfe)[inds] sfe <- runUnivariate(sfe,     type = \"sp.correlogram\", features = features,     exprs_values = \"counts\", order = 5 ) clust <- clusterCorrelograms(sfe,     features = features,     BLUSPARAM = KmeansParam(2) ) # Color by features plotCorrelogram(sfe, features)  # Color by something else plotCorrelogram(sfe, features, color_by = clust$cluster)  # Facet by features plotCorrelogram(sfe, features, facet_by = \"features\")"},{"path":"https://pachterlab.github.io/voyager/reference/plotDimLoadings.html","id":null,"dir":"Reference","previous_headings":"","what":"Plot top PC loadings of genes — plotDimLoadings","title":"Plot top PC loadings of genes — plotDimLoadings","text":"Just like Seurat's VizDimLoadings function. found equivalent SCE find useful. trying reproduce Seurat function exactly. instance, like Seurat imposes ggplot theme, like cowplot theme. Maybe rewrite base R now using Tidyverse.","code":""},{"path":"https://pachterlab.github.io/voyager/reference/plotDimLoadings.html","id":"ref-usage","dir":"Reference","previous_headings":"","what":"Usage","title":"Plot top PC loadings of genes — plotDimLoadings","text":"","code":"plotDimLoadings(   sce,   dims = 1:4,   nfeatures = 10,   show_symbol = TRUE,   symbol_col = \"symbol\",   reduction = \"PCA\",   balanced = TRUE,   ncol = 2 )"},{"path":"https://pachterlab.github.io/voyager/reference/plotDimLoadings.html","id":"arguments","dir":"Reference","previous_headings":"","what":"Arguments","title":"Plot top PC loadings of genes — plotDimLoadings","text":"sce SingleCellExperiment object, anything inherits SingleCellExperiment. dims Numeric vector specifying PCs plot. nfeatures Number genes plot. show_symbol Logical; row names matrix Ensembl accessions, indicate whether show human readable gene symbols plot instead. Ignored column specified symbol_col absent rowData. symbol_col row names gene expression matrix Ensembl accessions avoid ambiguity analysis. found rowData, rownames gene count matrix used. reduction Name dimension reduction use. must attribute called \"percentVar\". Defaults \"PCA\". balanced Return equal number genes + - scores. FALSE, returns top genes ranked scores absolute values. ncol Number columns facetted plot.","code":""},{"path":"https://pachterlab.github.io/voyager/reference/plotDimLoadings.html","id":"value","dir":"Reference","previous_headings":"","what":"Value","title":"Plot top PC loadings of genes — plotDimLoadings","text":"ggplot object. Loadings different PCs plotted different   facets one ggplot object returned.","code":""},{"path":"https://pachterlab.github.io/voyager/reference/plotDimLoadings.html","id":"ref-examples","dir":"Reference","previous_headings":"","what":"Examples","title":"Plot top PC loadings of genes — plotDimLoadings","text":"","code":"library(SFEData) library(scater) sfe <- McKellarMuscleData(\"small\") #> snapshotDate(): 2022-10-31 #> see ?SFEData and browseVignettes('SFEData') for documentation #> loading from cache sfe <- runPCA(sfe, ncomponents = 10, exprs_values = \"counts\") plotDimLoadings(sfe, dims = 1:2)"},{"path":"https://pachterlab.github.io/voyager/reference/plotLocalResult.html","id":null,"dir":"Reference","previous_headings":"","what":"Plot local results — plotLocalResult","title":"Plot local results — plotLocalResult","text":"Plot results local spatial analyses space, local Getis-Ord Gi* values.","code":""},{"path":"https://pachterlab.github.io/voyager/reference/plotLocalResult.html","id":"ref-usage","dir":"Reference","previous_headings":"","what":"Usage","title":"Plot local results — plotLocalResult","text":"","code":"plotLocalResult(   sfe,   type,   features,   attribute = NULL,   sample_id = NULL,   colGeometryName = NULL,   annotGeometryName = NULL,   ncol = NULL,   ncol_sample = NULL,   annot_aes = list(),   annot_fixed = list(),   aes_use = c(\"fill\", \"color\", \"shape\", \"linetype\"),   divergent = FALSE,   diverge_center = NULL,   annot_divergent = FALSE,   annot_diverge_center = NULL,   size = 0,   shape = 16,   linetype = 1,   alpha = 1,   color = NA,   fill = \"gray80\",   show_symbol = TRUE,   scattermore = FALSE,   pointsize = 0,   ... )"},{"path":"https://pachterlab.github.io/voyager/reference/plotLocalResult.html","id":"arguments","dir":"Reference","previous_headings":"","what":"Arguments","title":"Plot local results — plotLocalResult","text":"sfe SpatialFeatureExperiment object. type local spatial results. Use localResultNames see types results already calculated. features Character vector vectors. see features results given type, see localResultFeatures. attribute field local results type features. result feature vector, argument ignored. result data frame matrix, column name result, \"Ii\" local Moran's . local spatial analysis method, default attribute. See Details. Use localResultAttrs. sample_id Sample(s) SFE object whose cells/spots use. Can \"\" compute metric samples; metric computed separately sample. colGeometryName Name colGeometry sf data frame whose numeric columns interest used compute metric. Use colGeometryNames look names sf data frames associated cells/spots. annotGeometryName Name annotGeometry SFE object, annotate gene expression plot. ncol Number columns plotting multiple features. Defaults NULL, means using logic facet_wrap, used patchwork's wrap_plots default. ncol_sample plotting multiple samples facets, many columns facets. distinct ncols, multiple features. plotting multiple features multiple samples, result multi-panel plot panel plot feature facetted samples. annot_aes named list plotting parameters annotation sf data frame. names geom (ggplot2, color fill), values column names annotation sf data frame. Tidyeval supported. annot_fixed Similar annot_aes, fixed aesthetic settings, color = \"gray\". defaults relevant defaults function. aes_use Aesthetic use discrete variables. continuous variables, always \"fill\" polygons point shapes 21-25. discrete variables, can fill, color, shape, linetype, whenever applicable. specified value changed applicable equivalent. example, geometry point \"linetype\" specified, \"shaped\" used instead. divergent Logical, whether divergent palette used. diverge_center divergent = TRUE, center palette diverge. NULL, centering. annot_divergent Just divergent, annotGeometry case different. annot_diverge_center Just diverge_center, annotGeometry case different. size Fixed size points width lines, including outlines polygons. polygons, defaults 0, meaning outlines. points lines, defaults 0.5. Ignored size_by specified. shape Fixed shape points, ignored shape_by specified applicable. linetype Fixed line type, ignored linetype_by specified applicable. alpha Transparency. color Fixed color colGeometry color_by specified applicable, annotGeometry annot_color_by specified applicable. fill Similar color, fill. show_symbol Logical, whether show human readable gene symbol plot instead Ensembl IDs row names Ensembl IDs. must column rowData(sfe) called \"symbol\" work. scattermore Logical, whether use scattermore package greatly speed plotting numerous points. used POINT colGeometries. geometry POINT, centroids used. Recommended plotting hundreds thousands cells cell polygons seen plotted due large number cells small plot size plotting multiple panels multiple features. pointsize Radius rasterized point scattermore. Default 0 single pixels (fastest). ... arguments passed wrap_plots.","code":""},{"path":"https://pachterlab.github.io/voyager/reference/plotLocalResult.html","id":"value","dir":"Reference","previous_headings":"","what":"Value","title":"Plot local results — plotLocalResult","text":"ggplot2 object plotting one feature. patchwork object plotting multiple features.","code":""},{"path":"https://pachterlab.github.io/voyager/reference/plotLocalResult.html","id":"details","dir":"Reference","previous_headings":"","what":"Details","title":"Plot local results — plotLocalResult","text":"Many local spatial analyses return data frame matrix results, whose columns can statistic interest location, variance, expected value permutation, p-value, etc. attribute argument specifies column use multiple columns. defaults local method supported package mean: localmoran localmoran_perm Ii, local Moran's statistic location. localC_perm localC, local Geary C statistic location. localG localG_perm localG, local Getis-Ord Gi Gi* statistic. include_self = TRUE calculateUnivariate runUnivariate called, Gi*. Otherwise Gi. LOSH LOSH.mc Hi, local spatial heteroscedasticity moran.plot wx, average value neighbor location. Moran plot best plotted scatter plot wx vs x. See moranPlot. local methods listed return vectors results. instance, localC returns vector default, local Geary's C statistic.","code":""},{"path":"https://pachterlab.github.io/voyager/reference/plotLocalResult.html","id":"note","dir":"Reference","previous_headings":"","what":"Note","title":"Plot local results — plotLocalResult","text":"function shares internals   plotSpatialFeature, important differences.   plotSpatialFeature, annotGeometry indeed   used annotation protagonist colGeometry, since   easy directly use ggplot2 plot data   annotGeometry sf data frames overlaying   annotGeometry colGeometry involves complicated code.   contrast, function, local results annotGeometry can   plotted separately without anything related colGeometry. Note   annotGeometry local results plotted without   colGeometry, annot_* arguments ignored. Use   arguments aesthetics colGeometry.","code":""},{"path":"https://pachterlab.github.io/voyager/reference/plotLocalResult.html","id":"ref-examples","dir":"Reference","previous_headings":"","what":"Examples","title":"Plot local results — plotLocalResult","text":"","code":"library(SpatialFeatureExperiment) library(SFEData) library(scater) sfe <- McKellarMuscleData(\"small\") #> snapshotDate(): 2022-10-31 #> see ?SFEData and browseVignettes('SFEData') for documentation #> loading from cache colGraph(sfe, \"visium\") <- findVisiumGraph(sfe) feature_use <- rownames(sfe)[1] sfe <- logNormCounts(sfe) sfe <- runUnivariate(sfe, \"localmoran\", feature_use) # Which types of results are available? localResultNames(sfe) #> [1] \"localmoran\" # Which features for localmoran? localResultFeatures(sfe, \"localmoran\") #> [1] \"ENSMUSG00000025902\" # Which columns does the localmoran results have? localResultAttrs(sfe, \"localmoran\", feature_use) #>  [1] \"Ii\"             \"E.Ii\"           \"Var.Ii\"         \"Z.Ii\"           #>  [5] \"Pr(z != E(Ii))\" \"mean\"           \"median\"         \"pysal\"          #>  [9] \"-log10p\"        \"-log10p_adj\"    plotLocalResult(sfe, \"localmoran\", feature_use, \"Ii\",     colGeometryName = \"spotPoly\" )   # For annotGeometry # Make sure it's type POLYGON annotGeometry(sfe, \"myofiber_simplified\") <-     sf::st_buffer(annotGeometry(sfe, \"myofiber_simplified\"), 0) annotGraph(sfe, \"poly2nb_myo\") <-     findSpatialNeighbors(sfe,         type = \"myofiber_simplified\", MARGIN = 3,         method = \"poly2nb\", zero.policy = TRUE     ) sfe <- annotGeometryUnivariate(sfe, \"localmoran\",     features = \"area\",     annotGraphName = \"poly2nb_myo\",     annotGeometryName = \"myofiber_simplified\",     zero.policy = TRUE ) plotLocalResult(sfe, \"localmoran\", \"area\", \"Ii\",     annotGeometryName = \"myofiber_simplified\",     size = 0.3, color = \"cyan\" )  plotLocalResult(sfe, \"localmoran\", \"area\", \"Z.Ii\",     annotGeometryName = \"myofiber_simplified\" )  # don't use annot_* arguments when annotGeometry is plotted without colGeometry"},{"path":"https://pachterlab.github.io/voyager/reference/plotMoranMC.html","id":null,"dir":"Reference","previous_headings":"","what":"Plot Moran/Geary monte carlo results — plotMoranMC","title":"Plot Moran/Geary monte carlo results — plotMoranMC","text":"Plot simulations density plot histogram compared observed Moran's Geary's C, ggplot2 looks nicer. Unlike plotting function spdep, function can also plot feature different samples facets plot different features samples together comparison.","code":""},{"path":"https://pachterlab.github.io/voyager/reference/plotMoranMC.html","id":"ref-usage","dir":"Reference","previous_headings":"","what":"Usage","title":"Plot Moran/Geary monte carlo results — plotMoranMC","text":"","code":"plotMoranMC(   sfe,   features,   sample_id = NULL,   facet_by = c(\"sample_id\", \"features\"),   ncol = NULL,   colGeometryName = NULL,   annotGeometryName = NULL,   ptype = c(\"density\", \"histogram\", \"freqpoly\"),   show_symbol = TRUE,   ... )"},{"path":"https://pachterlab.github.io/voyager/reference/plotMoranMC.html","id":"arguments","dir":"Reference","previous_headings":"","what":"Arguments","title":"Plot Moran/Geary monte carlo results — plotMoranMC","text":"sfe SpatialFeatureExperiment object. features Features plot, must rownames gene count matrix, colnames colData colGeometry. sample_id Sample(s) SFE object whose cells/spots use. Can \"\" compute metric samples; metric computed separately sample. facet_by Whether facet sample_id (default) features. facetting sample_id, different features plotted facet comparison. facetting features, different samples compared feature. Ignored one sample specified. ncol Number columns facetting. colGeometryName Name colGeometry sf data frame whose numeric columns interest used compute metric. Use colGeometryNames look names sf data frames associated cells/spots. annotGeometryName Name annotGeometry SFE object, annotate gene expression plot. ptype Plot type, one \"density\", \"histogram\", \"freqpoly\". show_symbol Logical, whether show human readable gene symbol plot instead Ensembl IDs row names Ensembl IDs. must column rowData(sfe) called \"symbol\" work. ... arguments passed geom_density, geom_histogram, geom_freqpoly, depending ptype.","code":""},{"path":"https://pachterlab.github.io/voyager/reference/plotMoranMC.html","id":"value","dir":"Reference","previous_headings":"","what":"Value","title":"Plot Moran/Geary monte carlo results — plotMoranMC","text":"ggplot2 object.","code":""},{"path":"https://pachterlab.github.io/voyager/reference/plotMoranMC.html","id":"ref-examples","dir":"Reference","previous_headings":"","what":"Examples","title":"Plot Moran/Geary monte carlo results — plotMoranMC","text":"","code":"library(SpatialFeatureExperiment) library(SFEData) sfe <- McKellarMuscleData(\"small\") #> snapshotDate(): 2022-10-31 #> see ?SFEData and browseVignettes('SFEData') for documentation #> loading from cache colGraph(sfe, \"visium\") <- findVisiumGraph(sfe) sfe <- colDataUnivariate(sfe, type = \"moran.mc\", \"nCounts\", nsim = 100) plotMoranMC(sfe, \"nCounts\")"},{"path":"https://pachterlab.github.io/voyager/reference/plotSpatialFeature.html","id":null,"dir":"Reference","previous_headings":"","what":"Plot gene expression in space — plotSpatialFeature","title":"Plot gene expression in space — plotSpatialFeature","text":"Unlike Seurat ggspavis, plotting functions package uses geom_sf whenever applicable.","code":""},{"path":"https://pachterlab.github.io/voyager/reference/plotSpatialFeature.html","id":"ref-usage","dir":"Reference","previous_headings":"","what":"Usage","title":"Plot gene expression in space — plotSpatialFeature","text":"","code":"plotSpatialFeature(   sfe,   features,   colGeometryName = 1L,   sample_id = NULL,   ncol = NULL,   ncol_sample = NULL,   annotGeometryName = NULL,   annot_aes = list(),   annot_fixed = list(),   exprs_values = \"logcounts\",   aes_use = c(\"fill\", \"color\", \"shape\", \"linetype\"),   divergent = FALSE,   diverge_center = NA,   annot_divergent = FALSE,   annot_diverge_center = NA,   size = 0,   shape = 16,   linetype = 1,   alpha = 1,   color = NA,   fill = \"gray80\",   show_symbol = TRUE,   scattermore = FALSE,   pointsize = 0,   ... )"},{"path":"https://pachterlab.github.io/voyager/reference/plotSpatialFeature.html","id":"arguments","dir":"Reference","previous_headings":"","what":"Arguments","title":"Plot gene expression in space — plotSpatialFeature","text":"sfe SpatialFeatureExperiment object. features Features plot, must rownames gene count matrix, colnames colData colGeometry. colGeometryName Name colGeometry sf data frame whose numeric columns interest used compute metric. Use colGeometryNames look names sf data frames associated cells/spots. sample_id Sample(s) SFE object whose cells/spots use. Can \"\" compute metric samples; metric computed separately sample. ncol Number columns plotting multiple features. Defaults NULL, means using logic facet_wrap, used patchwork's wrap_plots default. ncol_sample plotting multiple samples facets, many columns facets. distinct ncols, multiple features. plotting multiple features multiple samples, result multi-panel plot panel plot feature facetted samples. annotGeometryName Name annotGeometry SFE object, annotate gene expression plot. annot_aes named list plotting parameters annotation sf data frame. names geom (ggplot2, color fill), values column names annotation sf data frame. Tidyeval supported. annot_fixed Similar annot_aes, fixed aesthetic settings, color = \"gray\". defaults relevant defaults function. exprs_values Integer scalar string indicating assay x contains expression values. aes_use Aesthetic use discrete variables. continuous variables, always \"fill\" polygons point shapes 21-25. discrete variables, can fill, color, shape, linetype, whenever applicable. specified value changed applicable equivalent. example, geometry point \"linetype\" specified, \"shaped\" used instead. divergent Logical, whether divergent palette used. diverge_center divergent = TRUE, center palette diverge. NULL, centering. annot_divergent Just divergent, annotGeometry case different. annot_diverge_center Just diverge_center, annotGeometry case different. size Fixed size points width lines, including outlines polygons. polygons, defaults 0, meaning outlines. points lines, defaults 0.5. Ignored size_by specified. shape Fixed shape points, ignored shape_by specified applicable. linetype Fixed line type, ignored linetype_by specified applicable. alpha Transparency. color Fixed color colGeometry color_by specified applicable, annotGeometry annot_color_by specified applicable. fill Similar color, fill. show_symbol Logical, whether show human readable gene symbol plot instead Ensembl IDs row names Ensembl IDs. must column rowData(sfe) called \"symbol\" work. scattermore Logical, whether use scattermore package greatly speed plotting numerous points. used POINT colGeometries. geometry POINT, centroids used. Recommended plotting hundreds thousands cells cell polygons seen plotted due large number cells small plot size plotting multiple panels multiple features. pointsize Radius rasterized point scattermore. Default 0 single pixels (fastest). ... arguments passed wrap_plots.","code":""},{"path":"https://pachterlab.github.io/voyager/reference/plotSpatialFeature.html","id":"value","dir":"Reference","previous_headings":"","what":"Value","title":"Plot gene expression in space — plotSpatialFeature","text":"ggplot2 object plotting one feature. patchwork object plotting multiple features.","code":""},{"path":"https://pachterlab.github.io/voyager/reference/plotSpatialFeature.html","id":"details","dir":"Reference","previous_headings":"","what":"Details","title":"Plot gene expression in space — plotSpatialFeature","text":"documentation function, \"feature\" can gene (whatever entity corresponds rows gene count matrix), column colData, column colGeometry sf data frame specified colGeometryName argument. continuous variables, Blues palette colorbrewer used divergent = FALSE, roma palette scico package divergent = TRUE. discrete variables, dittoSeq palette used. defaults colorblind friendly. annotation, PuRd colorbrewer palette used continuous variables end dittoSeq palette used discrete variables.","code":""},{"path":"https://pachterlab.github.io/voyager/reference/plotSpatialFeature.html","id":"ref-examples","dir":"Reference","previous_headings":"","what":"Examples","title":"Plot gene expression in space — plotSpatialFeature","text":"","code":"library(SFEData) library(sf) sfe <- McKellarMuscleData(\"small\") #> snapshotDate(): 2022-10-31 #> see ?SFEData and browseVignettes('SFEData') for documentation #> loading from cache # features can be genes or colData or colGeometry columns plotSpatialFeature(sfe, c(\"nCounts\", rownames(sfe)[1]),     exprs_values = \"counts\",     colGeometryName = \"spotPoly\",     annotGeometryName = \"tissueBoundary\" )  # Change fixed aesthetics plotSpatialFeature(sfe, \"nCounts\",     colGeometryName = \"spotPoly\",     annotGeometryName = \"tissueBoundary\",     annot_fixed = list(color = \"blue\", size = 0.3, fill = NA),     alpha = 0.7 )  # Make the myofiber segmentations a valid POLYGON geometry ag <- annotGeometry(sfe, \"myofiber_simplified\") ag <- st_buffer(ag, 0) ag <- ag[!st_is_empty(ag), ] annotGeometry(sfe, \"myofiber_simplified\") <- ag # Also plot an annotGeometry variable plotSpatialFeature(sfe, \"nCounts\",     colGeometryName = \"spotPoly\",     annotGeometryName = \"myofiber_simplified\",     annot_aes = list(fill = \"area\") )"},{"path":"https://pachterlab.github.io/voyager/reference/spatialReducedDim.html","id":null,"dir":"Reference","previous_headings":"","what":"Plot dimension reduction components in space — spatialReducedDim","title":"Plot dimension reduction components in space — spatialReducedDim","text":"plotting value projection gene expression cell principal component space. present, function work 3D array geographically weighted PCA (GWPCA), future version deal GWPCA results.","code":""},{"path":"https://pachterlab.github.io/voyager/reference/spatialReducedDim.html","id":"ref-usage","dir":"Reference","previous_headings":"","what":"Usage","title":"Plot dimension reduction components in space — spatialReducedDim","text":"","code":"spatialReducedDim(   sfe,   dimred,   ncomponents,   colGeometryName = 1L,   sample_id = NULL,   ncol = NULL,   ncol_sample = NULL,   annotGeometryName = NULL,   annot_aes = list(),   annot_fixed = list(),   exprs_values = \"logcounts\",   aes_use = c(\"fill\", \"color\", \"shape\", \"linetype\"),   divergent = FALSE,   diverge_center = NULL,   annot_divergent = FALSE,   annot_diverge_center = NULL,   size = 0,   shape = 16,   linetype = 1,   alpha = 1,   color = NA,   fill = \"gray80\",   scattermore = FALSE,   pointsize = 0,   ... )"},{"path":"https://pachterlab.github.io/voyager/reference/spatialReducedDim.html","id":"arguments","dir":"Reference","previous_headings":"","what":"Arguments","title":"Plot dimension reduction components in space — spatialReducedDim","text":"sfe SpatialFeatureExperiment object. dimred string integer scalar indicating reduced dimension result reducedDims(sfe) plot. ncomponents numeric scalar indicating number dimensions plot, starting first dimension. Alternatively, numeric vector specifying dimensions plotted. colGeometryName Name colGeometry sf data frame whose numeric columns interest used compute metric. Use colGeometryNames look names sf data frames associated cells/spots. sample_id Sample(s) SFE object whose cells/spots use. Can \"\" compute metric samples; metric computed separately sample. ncol Number columns plotting multiple features. Defaults NULL, means using logic facet_wrap, used patchwork's wrap_plots default. ncol_sample plotting multiple samples facets, many columns facets. distinct ncols, multiple features. plotting multiple features multiple samples, result multi-panel plot panel plot feature facetted samples. annotGeometryName Name annotGeometry SFE object, annotate gene expression plot. annot_aes named list plotting parameters annotation sf data frame. names geom (ggplot2, color fill), values column names annotation sf data frame. Tidyeval supported. annot_fixed Similar annot_aes, fixed aesthetic settings, color = \"gray\". defaults relevant defaults function. exprs_values Integer scalar string indicating assay x contains expression values. aes_use Aesthetic use discrete variables. continuous variables, always \"fill\" polygons point shapes 21-25. discrete variables, can fill, color, shape, linetype, whenever applicable. specified value changed applicable equivalent. example, geometry point \"linetype\" specified, \"shaped\" used instead. divergent Logical, whether divergent palette used. diverge_center divergent = TRUE, center palette diverge. NULL, centering. annot_divergent Just divergent, annotGeometry case different. annot_diverge_center Just diverge_center, annotGeometry case different. size Fixed size points width lines, including outlines polygons. polygons, defaults 0, meaning outlines. points lines, defaults 0.5. Ignored size_by specified. shape Fixed shape points, ignored shape_by specified applicable. linetype Fixed line type, ignored linetype_by specified applicable. alpha Transparency. color Fixed color colGeometry color_by specified applicable, annotGeometry annot_color_by specified applicable. fill Similar color, fill. scattermore Logical, whether use scattermore package greatly speed plotting numerous points. used POINT colGeometries. geometry POINT, centroids used. Recommended plotting hundreds thousands cells cell polygons seen plotted due large number cells small plot size plotting multiple panels multiple features. pointsize Radius rasterized point scattermore. Default 0 single pixels (fastest). ... arguments passed wrap_plots.","code":""},{"path":"https://pachterlab.github.io/voyager/reference/spatialReducedDim.html","id":"value","dir":"Reference","previous_headings":"","what":"Value","title":"Plot dimension reduction components in space — spatialReducedDim","text":"plotSpatialFeature. ggplot2 object   plotting one component. patchwork object plotting multiple   components.","code":""},{"path":[]},{"path":"https://pachterlab.github.io/voyager/reference/spatialReducedDim.html","id":"ref-examples","dir":"Reference","previous_headings":"","what":"Examples","title":"Plot dimension reduction components in space — spatialReducedDim","text":"","code":"library(SFEData) library(scater) sfe <- McKellarMuscleData(\"small\") #> snapshotDate(): 2022-10-31 #> see ?SFEData and browseVignettes('SFEData') for documentation #> loading from cache sfe <- logNormCounts(sfe) sfe <- runPCA(sfe, ncomponents = 2) spatialReducedDim(sfe, \"PCA\", 2, \"spotPoly\",     annotGeometryName = \"tissueBoundary\",     divergent = TRUE, diverge_center = 0 )  # Basically PC1 separates spots not on tissue from those on tissue."},{"path":"https://pachterlab.github.io/voyager/news/index.html","id":"version-108","dir":"Changelog","previous_headings":"","what":"Version 1.0.8","title":"Version 1.0.8","text":"Flipped divergent palettes warm color means high value.","code":""},{"path":"https://pachterlab.github.io/voyager/news/index.html","id":"version-107","dir":"Changelog","previous_headings":"","what":"Version 1.0.7","title":"Version 1.0.7","text":"Fixed bug assigning local results sample colData, colGeometry, annotGeometry.","code":""},{"path":"https://pachterlab.github.io/voyager/news/index.html","id":"version-105","dir":"Changelog","previous_headings":"","what":"Version 1.0.5","title":"Version 1.0.5","text":"Removed aes_string(), deprecated. Fixed bug show_symbol = TRUE “symbol” column absent rowData.","code":""},{"path":"https://pachterlab.github.io/voyager/news/index.html","id":"version-100","dir":"Changelog","previous_headings":"","what":"Version 1.0.0","title":"Version 1.0.0","text":"First version Bioconductor Univariate local global spatial statistics based spdep Plotting functions: gene expression metadata space, results local spatial analyses, plot dimension reductions space, plot correlograms Monte Carlo simulation results","code":""}]
